<!DOCTYPE html>
<html lang="zh-CN">
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="description" content="描述啊">
  <meta name="keywords" content="undefined">
  
    <link rel="icon" href="">
  
    
  <title>配置二：登录 | LeoChan&#39;s 个人博客</title>
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.20/jquery.fancybox.min.css" />
</head>

<body>
  <header>
  <div class="header-container">
    <a class='logo' href="/">
      <span>LeoChan's 个人博客</span>
    </a>
    <ul class="right-header">
      
        <li class="nav-item">
          
            <a href="/" class="item-link">首页</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/about" class="item-link">关于</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/archives" class="item-link">归档</a>
          
        </li>
      
        <li class="nav-item">
          
            <a href="/tags" class="item-link">标签</a>
          
        </li>
      
    </ul>
  </div>
</header>

  <main id='post'>
  <div class="content">
    <article>
        <section class="content markdown-body">
          <h1>配置二：登录</h1>
          <div class='post-meta'>
            <i class="fa fa-calendar" aria-hidden="true"></i> <time>2017年08月15日</time>
            
              | <i class="fa fa-folder-open-o" aria-hidden="true"></i> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>/ <a class="article-category-link" href="/categories/Spring/Security/">Security</a>
  </div>



            
            
          </div>
          <h2 id="form-login元素介绍"><a href="#form-login元素介绍" class="headerlink" title="form-login元素介绍"></a>form-login元素介绍</h2><p>http元素下的form-login元素是用来定义表单登录信息的。当我们什么属性都不指定的时候Spring Security会为我们生成一个默认的登录页面。如果不想使用默认的登录页面，我们可以指定自己的登录页面。</p>
<h3 id="1-使用自定义登录页面"><a href="#1-使用自定义登录页面" class="headerlink" title="1.使用自定义登录页面"></a>1.使用自定义登录页面</h3><p> 自定义登录页面是通过login-page属性来指定的。提到login-page我们不得不提另外几个属性：</p>
<ul>
<li>username-parameter：表示登录时用户名使用的是哪个参数，默认是“j_username”。</li>
<li>password-parameter：表示登录时密码使用的是哪个参数，默认是“j_password”。</li>
<li>login-processing-url：表示登录时提交的地址，默认是“/j-spring-security-check”。这个只是Spring Security用来标记登录页面使用的提交地址，真正关于登录这个请求是不需要用户自己处理的。<br>所以，我们可以通过如下定义使Spring Security在需要用户登录时跳转到我们自定义的登录页面。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;security:http auto-config=&quot;true&quot;&gt;</div><div class="line">  &lt;security:form-login login-page=&quot;/login.jsp&quot;</div><div class="line">     login-processing-url=&quot;/login.do&quot; username-parameter=&quot;username&quot;</div><div class="line">     password-parameter=&quot;password&quot; /&gt;</div><div class="line">  &lt;!-- 表示匿名用户可以访问 --&gt;</div><div class="line">  &lt;security:intercept-url pattern=&quot;/login.jsp&quot; access=&quot;IS_AUTHENTICATED_ANONYMOUSLY&quot;/&gt;</div><div class="line">  &lt;security:intercept-url pattern=&quot;/**&quot; access=&quot;ROLE_USER&quot; /&gt;</div><div class="line">&lt;/security:http&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>需要注意的是，我们之前配置的是所有的请求都需要ROLE_USER权限，这意味着我们自定义的“/login.jsp”也需要该权限，这样就会形成一个死循环了。解决办法是我们需要给“/login.jsp”放行。通过指定“/login.jsp”的访问权限为“IS_AUTHENTICATED_ANONYMOUSLY”或“ROLE_ANONYMOUS”可以达到这一效果。此外，我们也可以通过指定一个http元素的安全性为none来达到相同的效果。如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;security:http security=&quot;none&quot; pattern=&quot;/login.jsp&quot; /&gt;</div><div class="line">&lt;security:http auto-config=&quot;true&quot;&gt;</div><div class="line">  &lt;security:form-login login-page=&quot;/login.jsp&quot;</div><div class="line">     login-processing-url=&quot;/login.do&quot; username-parameter=&quot;username&quot;</div><div class="line">     password-parameter=&quot;password&quot; /&gt;</div><div class="line">  &lt;security:intercept-url pattern=&quot;/**&quot; access=&quot;ROLE_USER&quot; /&gt;</div><div class="line">&lt;/security:http&gt;</div></pre></td></tr></table></figure></p>
<p>它们两者的区别是前者将进入Spring Security定义的一系列用于安全控制的filter，而后者不会。当指定一个http元素的security属性为none时，表示其对应pattern的filter链为空。从3.1开始，Spring Security允许我们定义多个http元素以满足针对不同的pattern请求使用不同的filter链。当为指定pattern属性时表示对应的http元素定义将对所有的请求发生作用。<br>根据上面的配置，我们自定义的登录页面的内容应该是这样子的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&lt;form action=&quot;login.do&quot; method=&quot;post&quot;&gt;</div><div class="line">  &lt;table&gt;</div><div class="line">     &lt;tr&gt;</div><div class="line">        &lt;td&gt;用户名：&lt;/td&gt;</div><div class="line">        &lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;username&quot;/&gt;&lt;/td&gt;</div><div class="line">     &lt;/tr&gt;</div><div class="line">     &lt;tr&gt;</div><div class="line">        &lt;td&gt;密码：&lt;/td&gt;</div><div class="line">        &lt;td&gt;&lt;input type=&quot;password&quot; name=&quot;password&quot;/&gt;&lt;/td&gt;</div><div class="line">     &lt;/tr&gt;</div><div class="line">     &lt;tr&gt;</div><div class="line">        &lt;td colspan=&quot;2&quot; align=&quot;center&quot;&gt;</div><div class="line">            &lt;input type=&quot;submit&quot; value=&quot;登录&quot;/&gt;</div><div class="line">            &lt;input type=&quot;reset&quot; value=&quot;重置&quot;/&gt;</div><div class="line">        &lt;/td&gt;</div><div class="line">     &lt;/tr&gt;</div><div class="line">  &lt;/table&gt;</div><div class="line">&lt;/form&gt;</div></pre></td></tr></table></figure></p>
<h3 id="2-指定登录后的页面"><a href="#2-指定登录后的页面" class="headerlink" title="2.指定登录后的页面"></a>2.指定登录后的页面</h3><h4 id="通过default-target-url指定"><a href="#通过default-target-url指定" class="headerlink" title="通过default-target-url指定"></a>通过default-target-url指定</h4><p>默认情况下，我们在登录成功后会返回到原本受限制的页面。但如果用户是直接请求登录页面，登录成功后应该跳转到哪里呢？默认情况下它会跳转到当前应用的根路径，即欢迎页面。通过指定form-login元素的default-target-url属性，我们可以让用户在直接登录后跳转到指定的页面。如果想让用户不管是直接请求登录页面，还是通过Spring Security引导过来的，登录之后都跳转到指定的页面，我们可以通过指定form-login元素的always-use-default-target属性为true来达到这一效果。</p>
<h4 id="通过authentication-success-handler-ref指定"><a href="#通过authentication-success-handler-ref指定" class="headerlink" title="通过authentication-success-handler-ref指定"></a>通过authentication-success-handler-ref指定</h4><p>authentication-success-handler-ref对应一个AuthencticationSuccessHandler实现类的引用。如果指定了authentication-success-handler-ref，登录认证成功后会调用指定AuthenticationSuccessHandler的onAuthenticationSuccess方法。我们需要在该方法体内对认证成功做一个处理，然后返回对应的认证成功页面。使用了authentication-success-handler-ref之后认证成功后的处理就由指定的AuthenticationSuccessHandler来处理，之前的那些default-target-url之类的就都不起作用了。<br>以下是自定义的一个AuthenticationSuccessHandler的实现类。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">publicclass AuthenticationSuccessHandlerImpl implements</div><div class="line">      AuthenticationSuccessHandler &#123;</div><div class="line"> </div><div class="line">   publicvoid onAuthenticationSuccess(HttpServletRequest request,</div><div class="line">         HttpServletResponse response, Authentication authentication)</div><div class="line">         throws IOException, ServletException &#123;</div><div class="line">      response.sendRedirect(request.getContextPath());</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其对应使用authentication-success-handler-ref属性的配置是这样的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;security:http auto-config=&quot;true&quot;&gt;</div><div class="line">  &lt;security:form-login login-page=&quot;/login.jsp&quot;</div><div class="line">     login-processing-url=&quot;/login.do&quot; username-parameter=&quot;username&quot;</div><div class="line">     password-parameter=&quot;password&quot;</div><div class="line">     authentication-success-handler-ref=&quot;authSuccess&quot;/&gt;</div><div class="line">  &lt;!-- 表示匿名用户可以访问 --&gt;</div><div class="line">  &lt;security:intercept-url pattern=&quot;/login.jsp&quot;</div><div class="line">     access=&quot;IS_AUTHENTICATED_ANONYMOUSLY&quot; /&gt;</div><div class="line">  &lt;security:intercept-url pattern=&quot;/**&quot; access=&quot;ROLE_USER&quot; /&gt;</div><div class="line">&lt;/security:http&gt;</div><div class="line">&lt;!-- 认证成功后的处理类 --&gt;</div><div class="line">&lt;bean id=&quot;authSuccess&quot; class=&quot;com.xxx.AuthenticationSuccessHandlerImpl&quot;/&gt;</div></pre></td></tr></table></figure></p>
<h3 id="3-指定登录失败后的页面"><a href="#3-指定登录失败后的页面" class="headerlink" title="3.指定登录失败后的页面"></a>3.指定登录失败后的页面</h3><p> 除了可以指定登录认证成功后的页面和对应的AuthenticationSuccessHandler之外，form-login同样允许我们指定认证失败后的页面和对应认证失败后的处理器AuthenticationFailureHandler。</p>
<h4 id="通过authentication-failure-url指定"><a href="#通过authentication-failure-url指定" class="headerlink" title="通过authentication-failure-url指定"></a>通过authentication-failure-url指定</h4><p>默认情况下登录失败后会返回登录页面，我们也可以通过form-login元素的authentication-failure-url来指定登录失败后的页面。需要注意的是登录失败后的页面跟登录页面一样也是需要配置成在未登录的情况下可以访问，否则登录失败后请求失败页面时又会被Spring Security重定向到登录页面。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;security:http auto-config=&quot;true&quot;&gt;</div><div class="line">  &lt;security:form-login login-page=&quot;/login.jsp&quot;</div><div class="line">     login-processing-url=&quot;/login.do&quot; username-parameter=&quot;username&quot;</div><div class="line">     password-parameter=&quot;password&quot;</div><div class="line">     authentication-failure-url=&quot;/login_failure.jsp&quot;</div><div class="line">     /&gt;</div><div class="line">  &lt;!-- 表示匿名用户可以访问 --&gt;</div><div class="line">  &lt;security:intercept-url pattern=&quot;/login*.jsp*&quot;</div><div class="line">     access=&quot;IS_AUTHENTICATED_ANONYMOUSLY&quot; /&gt;</div><div class="line">  &lt;security:intercept-url pattern=&quot;/**&quot; access=&quot;ROLE_USER&quot; /&gt;</div><div class="line">&lt;/security:http&gt;</div></pre></td></tr></table></figure></p>
<h4 id="通过authentication-failure-handler-ref指定"><a href="#通过authentication-failure-handler-ref指定" class="headerlink" title="通过authentication-failure-handler-ref指定"></a>通过authentication-failure-handler-ref指定</h4><p>类似于authentication-success-handler-ref，authentication-failure-handler-ref对应一个用于处理认证失败的AuthenticationFailureHandler实现类。指定了该属性，Spring Security在认证失败后会调用指定AuthenticationFailureHandler的onAuthenticationFailure方法对认证失败进行处理，此时authentication-failure-url属性将不再发生作用。</p>
<h2 id="http-basic"><a href="#http-basic" class="headerlink" title="http-basic"></a>http-basic</h2><p>之前介绍的都是基于form-login的表单登录，其实Spring Security还支持弹窗进行认证。通过定义http元素下的http-basic元素可以达到这一效果。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;security:http auto-config=&quot;true&quot;&gt;</div><div class="line">  &lt;security:http-basic/&gt;</div><div class="line">  &lt;security:intercept-url pattern=&quot;/**&quot; access=&quot;ROLE_USER&quot; /&gt;</div><div class="line">&lt;/security:http&gt;</div></pre></td></tr></table></figure></p>
<p>此时，如果我们访问受Spring Security保护的资源时，系统将会弹出一个窗口来要求我们进行登录认证。效果如下：<br><img src="http://dl2.iteye.com/upload/attachment/0103/0663/b54058fa-adcc-3182-9e5c-456bf2658b1f.png" alt="image"><br>当然此时我们的表单登录也还是可以使用的，只不过当我们访问受包含资源的时候Spring Security不会自动跳转到登录页面。这就需要我们自己去请求登录页面进行登录。    </p>
<p>需要注意的是当我们同时定义了http-basic和form-login元素时，form-login将具有更高的优先级。即在需要认证的时候Spring Security将引导我们到登录页面，而不是弹出一个窗口。</p>

        </section>
    </article>
    
        
  </div>
  <aside>
    
    <div class="toc-container">
        <h1>目录</h1>
        <div class="content">
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#form-login元素介绍"><span class="toc-number">1.</span> <span class="toc-text">form-login元素介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-使用自定义登录页面"><span class="toc-number">1.1.</span> <span class="toc-text">1.使用自定义登录页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-指定登录后的页面"><span class="toc-number">1.2.</span> <span class="toc-text">2.指定登录后的页面</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#通过default-target-url指定"><span class="toc-number">1.2.1.</span> <span class="toc-text">通过default-target-url指定</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#通过authentication-success-handler-ref指定"><span class="toc-number">1.2.2.</span> <span class="toc-text">通过authentication-success-handler-ref指定</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-指定登录失败后的页面"><span class="toc-number">1.3.</span> <span class="toc-text">3.指定登录失败后的页面</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#通过authentication-failure-url指定"><span class="toc-number">1.3.1.</span> <span class="toc-text">通过authentication-failure-url指定</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#通过authentication-failure-handler-ref指定"><span class="toc-number">1.3.2.</span> <span class="toc-text">通过authentication-failure-handler-ref指定</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#http-basic"><span class="toc-number">2.</span> <span class="toc-text">http-basic</span></a></li></ol>
        </div>
    </div>
    
  </aside>
</main>



  <footer>
  <div class="copyright">
    <div>
      &copy; 2018 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a>&nbsp
    </div>
    <div>
      Theme by <a href="https://github.com/lewis-geek/hexo-theme-Aath" target="_blank">Aath</a>
    </div>
  </div>
</footer>


<script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script src="/lib/in-view.min.js"></script>
<script src="/lib/lodash.min.js"></script>
<script>
  var isDown = true
  var oldY = 0
  inView.offset(50)

  document.body.addEventListener('touchstart', function(){});
  
  window.addEventListener('scroll', _.throttle(e => {
    var currentY = window.scrollY
    if((oldY - currentY) < 0) {
      isDown = true
    } else {
      isDown = false
    }
    oldY = currentY
  }, 250))

  $("article img").each(function() {
      var strA = "<a data-fancybox='gallery' href='" + this.src + "'></a>";
      $(this).wrapAll(strA);
  });

  $('.toc-link').each(function() {
      var href = $(this).attr("href");
      
      inView(href).on('exit', () => {
        if (isDown) {
          handleActive(href)
        }
      })

      inView(href).on('enter', () => {
        if (!isDown) {
          handleActive(href)
        }
      })

      this.onclick = function(e) {
        var pos = $(href).offset().top - 10;
        $("html,body").animate({scrollTop: pos}, 300);
        setTimeout(() => {
          handleActive(href)
        }, 350)
        return false
      }
  })

  function handleActive(href) {
    document.querySelectorAll('.toc-link').forEach(elm => {
      elm.classList.remove('active')
    })
    document.querySelector(".toc [href='"+ href +"']").classList.add('active')
  }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.20/jquery.fancybox.min.js"></script>


</body>
</html>
