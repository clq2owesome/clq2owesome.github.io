<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>LeoChan&#39;s 个人博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="描述啊">
<meta property="og:type" content="website">
<meta property="og:title" content="LeoChan&#39;s 个人博客">
<meta property="og:url" content="http://yoursite.com/page/6/index.html">
<meta property="og:site_name" content="LeoChan&#39;s 个人博客">
<meta property="og:description" content="描述啊">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LeoChan&#39;s 个人博客">
<meta name="twitter:description" content="描述啊">
  
    <link rel="alternate" href="/atom.xml" title="LeoChan&#39;s 个人博客" type="application/atom+xml">
  
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" integrity="sha384-XdYbMnZ/QjLh6iI4ogqCTaIjrFk87ip+ekIjefZch0Y+PvJ8CDYtEs1ipDmPorQ+" crossorigin="anonymous">

  <link rel="stylesheet" href="/css/styles.css">
  

</head>

<body>
  <nav class="navbar navbar-inverse">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#main-menu-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="main-menu-navbar">
      <ul class="nav navbar-nav">
        
          <li><a class=""
                 href="/index.html">Home</a></li>
        
          <li><a class=""
                 href="/archives/">Archives</a></li>
        
      </ul>

      <!--
      <ul class="nav navbar-nav navbar-right">
        
          <li><a href="/atom.xml" title="RSS Feed"><i class="fa fa-rss"></i></a></li>
        
      </ul>
      -->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

  <div class="container">
    <div class="blog-header">
  <h1 class="blog-title">LeoChan&#39;s 个人博客</h1>
  
    <p class="lead blog-description">技术都是通用的，重要的是是否具有自主解决问题的能力！</p>
  
</div>

    <div class="row">
        <div class="col-sm-8 blog-main">
          
  
    <article id="post-Spring/Application Event/mq+spring event实现跨系统异步事件机制" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/19/Spring/Application Event/mq+spring event实现跨系统异步事件机制/">mq+spring event实现跨系统异步事件机制</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/07/19/Spring/Application Event/mq+spring event实现跨系统异步事件机制/" class="article-date"><time datetime="2017-07-19T02:09:45.000Z" itemprop="datePublished">2017-07-19</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a> / <a class="article-category-link" href="/categories/Spring/Application-Event/">Application Event</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h2><p>思路：生成spring event-》发布到mq队列-》mq队列监听到事件，解析和发布spring event到applicationContext-》spring事件监听器捕抓到事件，进行逻辑处理</p>
<h3 id="配置事件发送service"><a href="#配置事件发送service" class="headerlink" title="配置事件发送service"></a>配置事件发送service</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">public abstract interface AppEventSendingService &#123;</div><div class="line">  public abstract void send(BaseAppEvent&lt;?&gt; paramBaseAppEvent);</div><div class="line">  </div><div class="line">  public abstract void sendAfterCommit(BaseAppEvent&lt;?&gt; paramBaseAppEvent);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="配置事件发送service实现类"><a href="#配置事件发送service实现类" class="headerlink" title="配置事件发送service实现类"></a>配置事件发送service实现类</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">public class AppEventSendingServiceImpl implements AppEventSendingService, InitializingBean &#123;</div><div class="line">	private static final Logger logger = LoggerFactory.getLogger(AppEventSendingServiceImpl.class);</div><div class="line">	AppEventMessageSender sender;</div><div class="line"></div><div class="line">	public void setSender(AppEventMessageSender sender) &#123;</div><div class="line">		this.sender = sender;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void send(BaseAppEvent&lt;?&gt; appEvent) &#123;</div><div class="line">		logger.info(&quot;AppEventSendingServiceImpl.send  start&quot;);</div><div class="line">		this.sender.send(appEvent);</div><div class="line">		logger.info(&quot;AppEventSendingServiceImpl.send  end&quot;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">    //事务提交后触发</div><div class="line">	public void sendAfterCommit(BaseAppEvent&lt;?&gt; appEvent) &#123;</div><div class="line">		try &#123;</div><div class="line">			logger.info(&quot;sending &#123;&#125;&quot;, appEvent);</div><div class="line">			SpringTxUtils.registerSynchronization(new AppEventSendingSynchronization(appEvent, this.sender));</div><div class="line">		&#125; catch (Exception e) &#123;</div><div class="line">			logger.error(&quot;[MessageSendingService error] - &quot; + appEvent, e);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void afterPropertiesSet() throws Exception &#123;</div><div class="line">		Assert.notNull(this.sender);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="定义基础事件"><a href="#定义基础事件" class="headerlink" title="定义基础事件"></a>定义基础事件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">public class BaseAppEvent&lt;T&gt; extends ApplicationEvent &#123;</div><div class="line">	private static final long serialVersionUID = -4328665988986363581L;</div><div class="line">	private T payload;</div><div class="line"></div><div class="line">	public BaseAppEvent(Object source) &#123;</div><div class="line">		super(source);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public T getPayload() &#123;</div><div class="line">		return (T) this.payload;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void setPayload(T payload) &#123;</div><div class="line">		this.payload = payload;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="mq-sender：用于将spring-event发送到mq队列中，实现跨系统"><a href="#mq-sender：用于将spring-event发送到mq队列中，实现跨系统" class="headerlink" title="mq sender：用于将spring event发送到mq队列中，实现跨系统"></a>mq sender：用于将spring event发送到mq队列中，实现跨系统</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">public class AppEventMessageSender &#123;</div><div class="line"></div><div class="line">    private static final Logger logger = LoggerFactory.getLogger(AppEventMessageSender.class);</div><div class="line">    </div><div class="line">	private Queue queue;</div><div class="line"></div><div class="line">	private JmsTemplate jmsTemplate;</div><div class="line">	</div><div class="line">	public void setQueue(Queue queue) &#123;</div><div class="line">		this.queue = queue;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void setJmsTemplate(JmsTemplate jmsTemplate) &#123;</div><div class="line">		this.jmsTemplate = jmsTemplate;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void send(final BaseAppEvent&lt;?&gt; event) &#123;</div><div class="line">		logger.info(&quot;sending event message: &#123;&#125;&quot;, event);</div><div class="line">		if(event == null) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">		jmsTemplate.send(queue, new MessageCreator() &#123;</div><div class="line">			@Override</div><div class="line">			public Message createMessage(Session session) throws JMSException &#123;</div><div class="line">				return session.createObjectMessage(event);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="事务工具类"><a href="#事务工具类" class="headerlink" title="事务工具类"></a>事务工具类</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">public class SpringTxUtils &#123;</div><div class="line">	public static void registerSynchronization(TransactionSynchronization transactionSynchronization) &#123;</div><div class="line">		TransactionSynchronizationManager.registerSynchronization(transactionSynchronization);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="AppEventSendingSynchronization-用于事物提交后再发送事件"><a href="#AppEventSendingSynchronization-用于事物提交后再发送事件" class="headerlink" title="AppEventSendingSynchronization:用于事物提交后再发送事件"></a>AppEventSendingSynchronization:用于事物提交后再发送事件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">public class AppEventSendingSynchronization extends TransactionSynchronizationAdapter &#123;</div><div class="line"></div><div class="line">    private static final Logger logger = LoggerFactory.getLogger(AppEventSendingSynchronization.class);</div><div class="line"></div><div class="line">    private final BaseAppEvent&lt;?&gt; appEvent;</div><div class="line">    private final AppEventMessageSender sender;</div><div class="line"></div><div class="line">    public AppEventSendingSynchronization(BaseAppEvent&lt;?&gt; appEvent, AppEventMessageSender sender) &#123;</div><div class="line">        this.appEvent = appEvent;</div><div class="line">        this.sender = sender;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void afterCommit() &#123;</div><div class="line">        if (sender == null) &#123;</div><div class="line">        	logger.error(&quot;sender is null, msg &#123;&#125; not sended.&quot;, appEvent);</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        try &#123;</div><div class="line">            sender.send(appEvent);</div><div class="line">        &#125; catch (Exception e) &#123;</div><div class="line">        	logger.error(&quot;[ Event Sending Failed ]:&quot; + appEvent, e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="mq事件监听器，用于解析和发布spring-event事件"><a href="#mq事件监听器，用于解析和发布spring-event事件" class="headerlink" title="mq事件监听器，用于解析和发布spring event事件"></a>mq事件监听器，用于解析和发布spring event事件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">public class AppEventMessageListener implements MessageListener, ApplicationContextAware &#123;</div><div class="line"></div><div class="line">	private static final Logger logger = LoggerFactory.getLogger(AppEventMessageListener.class);</div><div class="line"></div><div class="line">	private ApplicationContext context;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public void setApplicationContext(ApplicationContext applicationContext) throws BeansException &#123;</div><div class="line">		this.context = applicationContext;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public void onMessage(Message message) &#123;</div><div class="line">		if (message instanceof ObjectMessage) &#123;</div><div class="line">			try &#123;</div><div class="line">				Object event = (Object) ((ObjectMessage) message).getObject();</div><div class="line">				if (!BaseAppEvent.class.isAssignableFrom(event.getClass())) &#123;</div><div class="line">					logger.warn(&quot;not an application event: &#123;&#125;&quot;, event);</div><div class="line">					return;</div><div class="line">				&#125;</div><div class="line">				context.publishEvent((BaseAppEvent&lt;?&gt;) event);</div><div class="line">			&#125; catch (Exception ex) &#123;</div><div class="line">				logger.error(&quot;error publishing event&quot;, ex);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="mq-xml配置"><a href="#mq-xml配置" class="headerlink" title="mq xml配置"></a>mq xml配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&lt;amq:connectionFactory id=&quot;amqConnectionFactory&quot;</div><div class="line">		brokerURL=&quot;$&#123;activemq.brokerURL&#125;&quot; userName=&quot;$&#123;activemq.username&#125;&quot;</div><div class="line">		password=&quot;$&#123;activemq.password&#125;&quot; /&gt;</div><div class="line">		</div><div class="line">	&lt;bean id=&quot;connectionFactory&quot;</div><div class="line">		class=&quot;org.springframework.jms.connection.CachingConnectionFactory&quot;&gt;</div><div class="line">		&lt;constructor-arg ref=&quot;amqConnectionFactory&quot; /&gt;</div><div class="line">		&lt;property name=&quot;sessionCacheSize&quot; value=&quot;100&quot; /&gt;</div><div class="line">	&lt;/bean&gt;</div><div class="line"></div><div class="line">	&lt;bean id=&quot;jmsQueueTemplate&quot; class=&quot;org.springframework.jms.core.JmsTemplate&quot;&gt;</div><div class="line">		&lt;constructor-arg ref=&quot;connectionFactory&quot; /&gt;</div><div class="line">		&lt;property name=&quot;pubSubDomain&quot; value=&quot;false&quot; /&gt;</div><div class="line">	&lt;/bean&gt;</div><div class="line"></div><div class="line">    &lt;!-- CLQ专用的Application Event队列 --&gt;</div><div class="line">    &lt;amq:queue id=&quot;CLQ_APP_EVENT_QUEUE&quot; physicalName=&quot;clq.app.event.queue&quot; /&gt;</div></pre></td></tr></table></figure>
<h3 id="mq-sender-xml"><a href="#mq-sender-xml" class="headerlink" title="mq sender xml"></a>mq sender xml</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;appEventSendingService&quot; class=&quot;com.clq.base.service.impl.AppEventSendingServiceImpl&quot;&gt;</div><div class="line">	&lt;property name=&quot;sender&quot;&gt;</div><div class="line">		&lt;bean class=&quot;com.clq.base.mq.sender.AppEventMessageSender&quot;&gt;</div><div class="line">			&lt;property name=&quot;queue&quot; ref=&quot;CLQ_APP_EVENT_QUEUE&quot; /&gt;</div><div class="line">			&lt;property name=&quot;jmsTemplate&quot; ref=&quot;jmsQueueTemplate&quot; /&gt;</div><div class="line">		&lt;/bean&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
<h3 id="mq-listener-xml"><a href="#mq-listener-xml" class="headerlink" title="mq listener xml"></a>mq listener xml</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;appEventMessageListener&quot;</div><div class="line">		class=&quot;com.clq.base.mq.listener.AppEventMessageListener&quot;&gt;</div><div class="line">	&lt;/bean&gt;</div><div class="line"></div><div class="line">&lt;jms:listener-container destination-type=&quot;queue&quot;</div><div class="line">	container-type=&quot;default&quot; connection-factory=&quot;connectionFactory&quot;</div><div class="line">	acknowledge=&quot;auto&quot;&gt;</div><div class="line">	&lt;jms:listener destination=&quot;clq.app.event.queue&quot; ref=&quot;appEventMessageListener&quot; /&gt;</div><div class="line">&lt;/jms:listener-container&gt;</div></pre></td></tr></table></figure>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="定义数据载体payload"><a href="#定义数据载体payload" class="headerlink" title="定义数据载体payload"></a>定义数据载体payload</h3><p>用于事件传播数据载体<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public class EmailPL implements Serializable &#123;</div><div class="line">	private static final long serialVersionUID = 1L;</div><div class="line">	private String sendTo;</div><div class="line">	private String subject;</div><div class="line">	private String body;</div><div class="line"></div><div class="line">    //getter and setter</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="定义事件"><a href="#定义事件" class="headerlink" title="定义事件"></a>定义事件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public class EmailEvent extends BaseAppEvent&lt;EmailPL&gt; &#123;</div><div class="line">	private static final long serialVersionUID = 1L;</div><div class="line"></div><div class="line">	public EmailEvent(Object source) &#123;</div><div class="line">		super(source);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="发送事件"><a href="#发送事件" class="headerlink" title="发送事件"></a>发送事件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">@Resource(name=&quot;appEventSendingService&quot;)</div><div class="line">AppEventSendingService appEventSendingService;</div><div class="line"></div><div class="line">//method</div><div class="line">EmailPL emailPL = new EmailPL();</div><div class="line">emailPL.setSendTo(&quot;收件人&quot;);</div><div class="line">emailPL.setSubject(&quot;主题&quot;);</div><div class="line">emailPL.setBody(&quot;内容&quot;);</div><div class="line">EmailEvent emailEvent = new EmailEvent(this);</div><div class="line">emailEvent.setPayload(emailPL);</div><div class="line">this.appEventSendingService.send(emailEvent);</div></pre></td></tr></table></figure>
<h3 id="Spring-event监听器"><a href="#Spring-event监听器" class="headerlink" title="Spring event监听器"></a>Spring event监听器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">@Component</div><div class="line">public class EmailListener implements ApplicationListener&lt;EmailEvent&gt; &#123;</div><div class="line">	private static Logger logger = Logger.getLogger(EmailListener.class);</div><div class="line">	@Resource</div><div class="line">	EmailService emailService;</div><div class="line"></div><div class="line">	public void onApplicationEvent(EmailEvent event) &#123;</div><div class="line">		logger.info(&quot;EmailListener start&#123;&#125;&quot;);</div><div class="line">		EmailPL payLoad = (EmailPL) event.getPayload();</div><div class="line">		String sendTo = payLoad.getSendTo();</div><div class="line">		String subject = payLoad.getSubject();</div><div class="line">		String body = payLoad.getBody();</div><div class="line">		try &#123;</div><div class="line">			//逻辑处理</div><div class="line">		&#125; catch (MessagingException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		logger.info(&quot;EmailListener end&#123;&#125;&quot;);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/07/19/Spring/Application Event/mq+spring event实现跨系统异步事件机制/" data-id="cj5nivvf00039fyfyx1svmdd8" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-Spring/JPA/Cascade和orphanRemoval" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/19/Spring/JPA/Cascade和orphanRemoval/">Cascade和orphanRemoval</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/07/19/Spring/JPA/Cascade和orphanRemoval/" class="article-date"><time datetime="2017-07-19T02:09:45.000Z" itemprop="datePublished">2017-07-19</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a> / <a class="article-category-link" href="/categories/Spring/JPA/">JPA</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Cascade"><a href="#Cascade" class="headerlink" title="Cascade"></a>Cascade</h2><p>对于关联实体而言，Hibernate默认不会启用级联操作，当父对象被保存时，他关联的子实体不会被保存。为了启用不同持久化操作的级联行为，Hibernate定了如下级联风格：</p>
<ul>
<li><code>CascadeType.ALL</code>:指定Hibernate将所有的持久化操作都级联到关联实体。</li>
<li><code>CascadeType.MERGE</code>:指定Hibernate将级联更新操作都级联到关联实体。</li>
<li><code>CascadeType.PERSIST</code>:指定Hibernate将级联保存操作都级联到关联实体。</li>
<li><code>CascadeType.REFRESH</code>:指定Hibernate将级联同步操作都级联到关联实体。</li>
<li><code>CascadeType.REMOVE</code>:指定Hibernate将级联移除持久化操作都级联到关联实体。</li>
</ul>
<p>对于级联的设定，Hibernate有如下建议</p>
<ol>
<li>在@ManyToOne中指定级联没有什么意义。级联通常在@OneToOne和@OneToMany关系中，因为级联操作应该是由主表记录传播到从表记录，通常从表记录不应该传播到主表记录。</li>
<li>如果从表记录被完全限制在主表记录之内，则可以指定cascade=Cascade.ALL,再配合orphanRemoval=true级联策略，将从表实体的生命周期完全交给主表实体管理。</li>
<li>如果经常在某个事务中同时使用主表实体和从表实体，则可以考虑cascade={CascadeType.PERSIST,CascadeType.MERGE}级联策略。</li>
</ol>
<h2 id="orphanRemoval"><a href="#orphanRemoval" class="headerlink" title="orphanRemoval"></a>orphanRemoval</h2><p>只适用于@OneToMany,@OneToOne<br>Hibernate还支持一个特殊的级联策略：删除孤儿对象<br>该策略只能对应当前实体1的一端，且底层数据表为主表时有效。对于启用了roaphanRemoval策略的级联操作而言，当程序通过主表实体切断与从表实体的关联关系时-虽然此时主表实体对应的记录并没有删除，但由于从表实体失去了对主表实体的引用，因此这些从表实体成为了“孤儿”，hibernate会自动删除这些记录。</p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/07/19/Spring/JPA/Cascade和orphanRemoval/" data-id="cj5nivvf1003bfyfynbwlj6f2" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-Spring/JPA/GeneratedValue主键生成策略" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/19/Spring/JPA/GeneratedValue主键生成策略/">GeneratedValue主键生成策略</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/07/19/Spring/JPA/GeneratedValue主键生成策略/" class="article-date"><time datetime="2017-07-19T02:09:45.000Z" itemprop="datePublished">2017-07-19</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a> / <a class="article-category-link" href="/categories/Spring/JPA/">JPA</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="GeneratedValue-主键的产生策略，通过strategy属性指定。"><a href="#GeneratedValue-主键的产生策略，通过strategy属性指定。" class="headerlink" title="@GeneratedValue:主键的产生策略，通过strategy属性指定。"></a>@GeneratedValue:主键的产生策略，通过strategy属性指定。</h2><p>主键产生策略通过GenerationType来指定。GenerationType是一个枚举，它定义了主键产生策略的类型。</p>
<ol>
<li>AUTO　自动选择一个最适合底层数据库的主键生成策略。如MySQL会自动对应auto increment。这个是默认选项，即如果只写@GeneratedValue，等价于@GeneratedValue(strategy=GenerationType.AUTO)。</li>
<li>IDENTITY　表自增长字段，Oracle不支持这种方式。</li>
<li>SEQUENCE　通过序列产生主键，MySQL不支持这种方式。</li>
<li>TABLE　通过表产生主键，框架借由表模拟序列产生主键，使用该策略可以使应用更易于数据库移植。不同的JPA实现商生成的表名是不同的，如 OpenJPA生成openjpa_sequence_table表，Hibernate生成一个hibernate_sequences表，而TopLink则生成sequence表。这些表都具有一个序列名和对应值两个字段，如SEQ_NAME和SEQ_COUNT。</li>
</ol>
<p>在我们的应用中，一般选用@GeneratedValue(strategy=GenerationType.AUTO)这种方式，自动选择主键生成策略，以适应不同的数据库移植。</p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/07/19/Spring/JPA/GeneratedValue主键生成策略/" data-id="cj5nivvf2003efyfye97gfzg6" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-Spring/JPA/JPA 2.0 锁机制" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/19/Spring/JPA/JPA 2.0 锁机制/">JPA 2.0 锁机制</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/07/19/Spring/JPA/JPA 2.0 锁机制/" class="article-date"><time datetime="2017-07-19T02:09:45.000Z" itemprop="datePublished">2017-07-19</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a> / <a class="article-category-link" href="/categories/Spring/JPA/">JPA</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <p>锁是处理数据库事务并发的一种技术，当两个或更多数据库事务并发地访问相同数据时，锁可以保证同一时间只有一个事务可以修改数据。  </p>
<p>锁的方法通常有两种：<strong>乐观锁</strong>和<strong>悲观锁</strong>。</p>
<p>乐观锁认为多个并发事务之间很少出现冲突，也就是说不会经常出现同一时间读取或修改相同数据，在乐观锁中，其目标是让并发事务自由地同时得到处理，而不是发现或预防冲突。两个事务在同一时刻可以访问相同的数据，但为了预防冲突，需要对数据执行一次检查，检查自上次读取数据以来发生的任何变化。<br>悲观锁认为事务会经常发生冲突，在悲观锁中，读取数据的事务会锁定数据，在前面的事务提交之前，其它事务都不能修改数据。</p>
<h3 id="乐观锁的工作原理"><a href="#乐观锁的工作原理" class="headerlink" title="乐观锁的工作原理"></a>乐观锁的工作原理</h3><p>乐观锁基于的假设是实际中冲突很少发生，即使发生，抛出一个错误也比想办法避免它们更容易接受和简单。在乐观锁中，允许一个事务正确完成，但另一个事务需要抛出异常并回滚，并且必须被重新执行或者丢弃。<br>我们以Adam和Barbara为例，下面是一个使用乐观锁可能发生的情形：<br>1.Adam的事务读取数据 X<br>2.Barbara的事务读取数据 X<br>3.Adam的事务修改数据 X，并将其修改为 XA<br>4.Adam的事务写入数据 XA<br>5.Barbara的事务修改数据 X，并将其修改为 XB<br>6.Barbara的事务试图写入数据 XB，但是收到一个错误<br>7.Barbara需要读取数据 XA（或者重新开始一个新的事务）<br>8.Barbara的事务修改数据 XA，并将其修改为 XAB<br>9.Barbara的事务写入数据 XAB     </p>
<p>如你所见，Barbara被强制要求检查Adam的修改，并且她可以选择继续修改Adam的结果并保存（合并修改）。最后的数据将同时包括Adam和Barbara的修改。<br>乐观锁完全由JPA控制。它需要在DB表中额外存储一个版本号列。它完全依靠于底层用来存储关系型数据的DB引擎来工作。</p>
<h3 id="悲观锁的工作原理"><a href="#悲观锁的工作原理" class="headerlink" title="悲观锁的工作原理"></a>悲观锁的工作原理</h3><p>对于某些人来说，悲观锁更容易接受。当事务需要修改一个可能被其他事务同时修改的实体时，事务会发起一个命令将实体锁住。所有的锁会持续到事务结束后再自动释放。<br>使用悲观锁的情形可能如下所示：<br>1.Adam的事务读取数据 X<br>2.Adam的事务锁住 X<br>3.Barbara的事务希望读取数据 X，但是因为 X 已经被锁住，只好等待<br>4.Adam的事务修改数据 X，并将其修改为 XA<br>5.Adam的事务写入数据 XA<br>6.Barbara的事务读取数据 XA<br>7.Barbara的事务修改数据  XA，并将其修改为 XAB<br>8.Barbara的事务写入数据 XAB </p>
<p>如你所见，Barbara又一次被强制的写入 XAB，同时也包含了Adam的修改。但是，这个方案与乐观锁完全不同——Barbara需要等待Adam的事务完成以后才能够读取数据。更甚的是，为了让该场景正确工作，我们需要在两个事务中都手动发起一个lock命令。（因为我们并不确定那个事务先运行，所以两个事务都需要在修改数据前先进行锁定）虽然乐观锁要为每个实体增加一个版本列，比悲观锁工作略多，但是之后我们不需要再在事务中发起锁操作了。JPA会自动完成所有的检查，我们只需要处理可能的异常即可。    </p>
<p><strong>悲观锁使用底层数据库提供的锁机制来锁住表中已有的记录</strong>。JPA需要知道如何触发这些锁，并且尚不能完全支持某些数据库。</p>
<h3 id="JPA1-0-锁机制"><a href="#JPA1-0-锁机制" class="headerlink" title="JPA1.0 锁机制"></a>JPA1.0 锁机制</h3><p>JPA 1.0只支持乐观锁，你可以使用EntityManager类的lock()方法指定锁模式的值，可以是READ或WRITE，如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">EntityManager em = ... ;</div><div class="line">em.lock(p1, READ);</div></pre></td></tr></table></figure></p>
<p>对于READ锁模式，JPA实体管理器在事务提交前都会锁定实体，检查实体的版本属性确定实体自上次被读取以来是否有更新，如果版本属性被更新了，实体管理器会抛出一个OptimisticLockException异常，并回滚事务。<br>对于WRITE锁模式，实体管理器执行和READ锁模式相同的乐观锁操作，但它也会更新实体的版本列。 </p>
<h3 id="JPA2-0锁机制"><a href="#JPA2-0锁机制" class="headerlink" title="JPA2.0锁机制"></a>JPA2.0锁机制</h3><p>JPA 2.0增加了6种新的锁模式，其中两个是乐观锁。JPA 2.0也允许悲观锁，并增加了3种悲观锁，第6种锁模式是无锁。<br>下面是新增的两个乐观锁模式： </p>
<ol>
<li><strong>OPTIMISTIC</strong>：它和READ锁模式相同，JPA 2.0仍然支持READ锁模式，但明确指出在新应用程序中推荐使用OPTIMISTIC。 </li>
<li><strong>OPTIMISTIC_FORCE_INCREMENT</strong>：它和WRITE锁模式相同，JPA 2.0仍然支持WRITE锁模式，但明确指出在新应用程序中推荐使用OPTIMISTIC_FORCE_INCREMENT。 </li>
</ol>
<p>下面是新增的三个悲观锁模式： </p>
<ol>
<li><strong>PESSIMISTIC_READ</strong>：只要事务读实体，实体管理器就锁定实体，直到事务完成锁才会解开，当你想使用重复读语义查询数据时使用这种锁模式，换句话说就是，当你想确保数据在连续读期间不被修改，这种锁模式不会阻碍其它事务读取数据。 </li>
<li><strong>PESSIMISTIC_WRITE</strong>：只要事务更新实体，实体管理器就会锁定实体，这种锁模式强制尝试修改实体数据的事务串行化，当多个并发更新事务出现更新失败几率较高时使用这种锁模式。 </li>
<li><strong>PESSIMISTIC_FORCE_INCREMENT</strong>：当事务读实体时，实体管理器就锁定实体，当事务结束时会增加实体的版本属性，即使实体没有修改。<br>你也可以指定新的锁模式NONE，在这种情况下表示没有锁发生。 </li>
</ol>
<h3 id="LockModeType类型"><a href="#LockModeType类型" class="headerlink" title="LockModeType类型"></a>LockModeType类型</h3><h4 id="JPA-2-0"><a href="#JPA-2-0" class="headerlink" title="JPA 2.0"></a>JPA 2.0</h4><table>
<thead>
<tr>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>NONE</td>
<td>没有锁</td>
</tr>
<tr>
<td>OPTIMISTIC</td>
<td>乐观锁，类似于READ</td>
</tr>
<tr>
<td>OPTIMISTIC_FORCE_INCREMENT</td>
<td>乐观锁，类似于WRITE</td>
</tr>
<tr>
<td>PESSIMISTIC_READ</td>
<td>悲观读锁（Pessimistic read lock）</td>
</tr>
<tr>
<td>PESSIMISTIC_WRITE</td>
<td>悲观写锁（Pessimistic write lock）</td>
</tr>
<tr>
<td>PESSIMISTIC_FORCE_INCREMENT</td>
<td>悲观写锁，事务结束后会增加版本号（Pessimistic write lock, with version update）</td>
</tr>
</tbody>
</table>
<h4 id="JPA-1-0"><a href="#JPA-1-0" class="headerlink" title="JPA 1.0"></a>JPA 1.0</h4><table>
<thead>
<tr>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>READ</td>
<td>乐观读锁</td>
</tr>
<tr>
<td>WRITE</td>
<td>乐观写锁</td>
</tr>
</tbody>
</table>
<p>@Version 注解用于支持乐观锁版本控制。</p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/07/19/Spring/JPA/JPA 2.0 锁机制/" data-id="cj5nivvf4003gfyfyjvq678hw" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-Spring/JPA/JPA高级查询" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/19/Spring/JPA/JPA高级查询/">JPA高级查询</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/07/19/Spring/JPA/JPA高级查询/" class="article-date"><time datetime="2017-07-19T02:09:45.000Z" itemprop="datePublished">2017-07-19</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a> / <a class="article-category-link" href="/categories/Spring/JPA/">JPA</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="jpa几个重要的接口"><a href="#jpa几个重要的接口" class="headerlink" title="jpa几个重要的接口"></a>jpa几个重要的接口</h2><ul>
<li><strong>Repository</strong>：最顶层的接口，是一个空的接口，目的是为了统一所有Repository的类型，且能让组件扫描的时候自动识别。</li>
<li><strong>CrudRepository</strong> ：是Repository的子接口，提供CRUD的功能</li>
<li><strong>PagingAndSortingRepository</strong>：是CrudRepository的子接口，添加分页和排序的功能</li>
<li><strong>JpaRepository</strong>：是PagingAndSortingRepository的子接口，增加了一些实用的功能，比如：批量操作等。</li>
<li><strong>JpaSpecificationExecutor</strong>：用来做负责查询的接口</li>
<li><strong>Specification</strong>：是Spring Data JPA提供的一个查询规范，要做复杂的查询，只需围绕这个规范来设置查询条件即可</li>
</ul>
<h2 id="JpaRepository"><a href="#JpaRepository" class="headerlink" title="JpaRepository"></a>JpaRepository</h2><h3 id="基本功能"><a href="#基本功能" class="headerlink" title="基本功能"></a>基本功能</h3><p>JpaRepository的基本功能示范<br>具体的看代码演示<br>其中：Pageable接口的实现类是PageRequest，Page接口的实现类是PageImpl。<br>示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Page&lt;UserModel&gt; p =  ur.findAll(new PageRequest(0,2,new Sort(new Order(Direction. DESC,&quot;uuid&quot;))));</div><div class="line">System. out.println(&quot;list=&quot;+p.getContent());</div></pre></td></tr></table></figure></p>
<h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><p>直接在接口中定义查询方法，如果是符合规范的，可以不用写实现，目前支持的关键字写法如下：</p>
<table>
<thead>
<tr>
<th>关键字</th>
<th>事例</th>
<th>对应的sql语句</th>
</tr>
</thead>
<tbody>
<tr>
<td>And</td>
<td>findByLastnameAndFirstname</td>
<td>where x.lastname = ?1 and x.firstname = ?2</td>
</tr>
<tr>
<td>Or</td>
<td>findByLastnameOrFirstname</td>
<td>where x.lastname = ?1 or x.firstname = ?2</td>
</tr>
<tr>
<td>Between</td>
<td>findByStartDateBetween</td>
<td>where x.startDate between 1? and ?2</td>
</tr>
<tr>
<td>LessThan</td>
<td>findByAgeLessThan</td>
<td>where x.age &lt; ?1</td>
</tr>
<tr>
<td>GreaterThan</td>
<td>findByAgeGreaterThan</td>
<td>where x.age &gt; ?1</td>
</tr>
<tr>
<td>After</td>
<td>findByStartDateAfter</td>
<td>where x.startDate &gt; ?1</td>
</tr>
<tr>
<td>Before</td>
<td>findByStartDateBefore</td>
<td>where x.startDate &lt; ?1</td>
</tr>
<tr>
<td>IsNull</td>
<td>findByAgeIsNull</td>
<td>where x.age is null</td>
</tr>
<tr>
<td>Like</td>
<td>findByFirstnameLike</td>
<td>where x.firstname like ?1</td>
</tr>
<tr>
<td>Containing</td>
<td>findByFirstnameContaining</td>
<td>where  x.firstname like + “%” + ?1 +”%”</td>
</tr>
<tr>
<td>OrderBy</td>
<td>findByAgeOrderByLastnameDesc</td>
<td>where  x.age = ?1 order by x.lastname desc</td>
</tr>
<tr>
<td>Not</td>
<td>findByLastnameNot</td>
<td>where  x.age &lt;&gt; ?1</td>
</tr>
<tr>
<td>In</td>
<td>findByAgeIn(Collection<age> ages)</age></td>
<td>where  x.age in ?1</td>
</tr>
<tr>
<td>NotIn</td>
<td>findByAgeNotIn(Collection<age> ages)</age></td>
<td>where  x.age not in ?1</td>
</tr>
</tbody>
</table>
<p>Spring Data JPA框架在进行方法名解析时，会先把方法名多余的前缀截取掉，比如 find、findBy、read、readBy、get、getBy，然后对剩下部分进行解析。<br>假如创建如下的查询：findByUserDepUuid()，框架在解析该方法时，首先剔除 findBy，然后对剩下的属性进行解析，假设查询实体为Doc</p>
<ol>
<li>先判断 userDepUuid （根据 POJO 规范，首字母变为小写）是否为查询实体的一个属性，如果是，则表示根据该属性进行查询；如果没有该属性，继续第二步；</li>
<li>从右往左截取第一个大写字母开头的字符串此处为Uuid），然后检查剩下的字符串是否为查询实体的一个属性，如果是，则表示根据该属性进行查询；如果没有该属性，则重复第二步，继续从右往左截取；最后假设user为查询实体的一个属性；</li>
<li>接着处理剩下部分（DepUuid），先判断 user 所对应的类型是否有depUuid属性，如果有，则表示该方法最终是根据 “ Doc.user.depUuid” 的取值进行查询；否则继续按照步骤 2 的规则从右往左截取，最终表示根据 “Doc.user.dep.uuid” 的值进行查询。</li>
<li>可能会存在一种特殊情况，比如 Doc包含一个 user 的属性，也有一个 userDep 属性，此时会存在混淆。可以明确在属性之间加上 “_” 以显式表达意图，比如 “findByUser_DepUuid()” 或者 “findByUserDep_uuid()”<br>特殊的参数： 还可以直接在方法的参数上加入分页或排序的参数，比如：<br>Page<usermodel> findByName(String name, Pageable pageable);<br>List<usermodel> findByName(String name, Sort sort);</usermodel></usermodel></li>
</ol>
<p>也可以使用JPA的NamedQueries，方法如下：</p>
<ol>
<li><p>在实体类上使用@NamedQuery，示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@NamedQuery(name = &quot;UserModel.findByAge&quot;,query = &quot;select o from UserModel o where o.age &gt;= ?1&quot;)</div></pre></td></tr></table></figure>
</li>
<li><p>在自己实现的DAO的Repository接口里面定义一个同名的方法，示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public List&lt;UserModel&gt; findByAge(int age);</div></pre></td></tr></table></figure>
</li>
<li><p>然后就可以使用了，Spring会先找是否有同名的NamedQuery，如果有，那么就不会按照接口定义的方法来解析。</p>
</li>
</ol>
<h3 id="使用-Query"><a href="#使用-Query" class="headerlink" title="使用@Query"></a>使用@Query</h3><p>可以在自定义的查询方法上使用@Query来指定该方法要执行的查询语句，比如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">@Query(&quot;select o from UserModel o where o.uuid=?1&quot;)</div><div class="line">public List&lt;UserModel&gt; findByUuidOrAge(int uuid);</div></pre></td></tr></table></figure></p>
<p>注意：</p>
<ol>
<li>方法的参数个数必须和@Query里面需要的参数个数一致</li>
<li>如果是like，后面的参数需要前面或者后面加“%”   </li>
</ol>
<p>比如下面都对<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">@Query(&quot;select o from UserModel o where o.name like ?1%&quot;)</div><div class="line">public List&lt;UserModel&gt; findByUuidOrAge(String name);</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">@Query(&quot;select o from UserModel o where o.name like %?1&quot;)</div><div class="line">public List&lt;UserModel&gt; findByUuidOrAge(String name);</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">@Query(&quot;select o from UserModel o where o.name like %?1%&quot;)</div><div class="line">public List&lt;UserModel&gt; findByUuidOrAge(String name);</div></pre></td></tr></table></figure>
<p>当然，这样在传递参数值的时候就可以不加‘%’了，当然加了也不会错 </p>
<p>还可以使用@Query来指定本地查询，只要设置nativeQuery为true，比如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">@Query(value=&quot;select * from tbl_user where name like %?1&quot; ,nativeQuery=true)</div><div class="line">public List&lt;UserModel&gt; findByUuidOrAge(String name);</div></pre></td></tr></table></figure></p>
<p>注意：当前版本的本地查询不支持翻页和动态的排序</p>
<p>使用命名化参数，使用@Param即可，比如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">@Query(value=&quot;select o from UserModel o where o.name like %:nn&quot;)</div><div class="line">public List&lt;UserModel&gt; findByUuidOrAge(@Param(&quot;nn&quot;) String name);</div></pre></td></tr></table></figure></p>
<p>同样支持更新类的Query语句，添加@Modifying即可，比如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@Modifying</div><div class="line">@Query(value=&quot;update UserModel o set o.name=:newName where o.name like %:nn&quot;)</div><div class="line">public int findByUuidOrAge(@Param(&quot;nn&quot;) String name,@Param(&quot;newName&quot;) String newName);</div></pre></td></tr></table></figure></p>
<p>注意：</p>
<ol>
<li>方法的返回值应该是int，表示更新语句所影响的行数</li>
<li>在调用的地方必须加事务，没有事务不能正常执行</li>
</ol>
<h3 id="JpaRepository的查询顺序"><a href="#JpaRepository的查询顺序" class="headerlink" title="JpaRepository的查询顺序"></a>JpaRepository的查询顺序</h3><p>Spring Data JPA 在为接口创建代理对象时，如果发现同时存在多种上述情况可用，它该优先采用哪种策略呢？</p>
<p><jpa:repositories> 提供了 query-lookup-strategy 属性，用以指定查找的顺序。它有如下三个取值：</jpa:repositories></p>
<ol>
<li><strong>create-if-not-found</strong>：如果方法通过@Query指定了查询语句，则使用该语句实现查询；如果没有，则查找是否定义了符合条件的命名查询，如果找到，则使用该命名查询；如果两者都没有找到，则通过解析方法名字来创建查询。这是 query-lookup-strategy 属性的默认值</li>
<li><strong>create</strong>：通过解析方法名字来创建查询。即使有符合的命名查询，或者方法通过 @Query指定的查询语句，都将会被忽略</li>
<li><strong>use-declared-query</strong>：如果方法通过@Query指定了查询语句，则使用该语句实现查询；如果没有，则查找是否定义了符合条件的命名查询，如果找到，则使用该命名查询；如果两者都没有找到，则抛出异常</li>
</ol>
<h3 id="客户化扩展JpaRepository"><a href="#客户化扩展JpaRepository" class="headerlink" title="客户化扩展JpaRepository"></a>客户化扩展JpaRepository</h3><p>如果你不想暴露那么多的方法，可以自己订制自己的Repository，还可以在自己的Repository里面添加自己使用的公共方法<br>当然更灵活的是自己写一个实现类，来实现自己需要的方法    </p>
<ol>
<li>写一个与接口同名的类，加上后缀为Impl，这个在前面xml里面配置过，可以自动被扫描到。这个类不需要实现任何接口。</li>
<li>在接口中加入自己需要的方法，比如：<br>public Page<object[]> getByCondition(UserQueryModel u);</object[]></li>
<li>在实现类中，去实现这个方法就好了，会被自动找到</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public class UserRepositoryImpl &#123;  </div><div class="line">	@PersistenceContext  </div><div class="line">	private EntityManager em;   </div><div class="line">	  </div><div class="line">	public Page&lt;Object[]&gt; getByCondition(UserQueryModel u)&#123;  </div><div class="line">		String hql = &quot;select o.uuid,o.name from UserModel o where 1=1 and o.uuid=:uuid&quot;;  </div><div class="line">		Query q = em.createQuery(hql);  </div><div class="line">		q.setParameter(&quot;uuid&quot;, u.getUuid());          </div><div class="line">		q.setFirstResult(0);  </div><div class="line">		q.setMaxResults(1);       </div><div class="line">		Page&lt;Object[]&gt; page = new PageImpl&lt;Object[]&gt;(q.getResultList(),new PageRequest(0,1),3);   </div><div class="line">		return page;  </div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Specifications"><a href="#Specifications" class="headerlink" title="Specifications"></a>Specifications</h2><p>Spring Data JPA支持JPA2.0的Criteria查询，相应的接口是==JpaSpecificationExecutor==。<br>Criteria 查询：是一种类型安全和更面向对象的查询</p>
<p>这个接口基本是围绕着Specification接口来定义的， Specification接口中只定义了如下一个方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Predicate toPredicate(Root&lt;T&gt; root, CriteriaQuery&lt;?&gt; query, CriteriaBuilder cb);</div></pre></td></tr></table></figure></p>
<p>要理解这个方法，以及正确的使用它，就需要对JPA2.0的Criteria查询有一个足够的熟悉和理解，因为这个方法的参数和返回值都是JPA标准里面定义的对象。</p>
<h3 id="Criteria查询基本概念"><a href="#Criteria查询基本概念" class="headerlink" title="Criteria查询基本概念"></a>Criteria查询基本概念</h3><p>Criteria 查询是以元模型的概念为基础的，元模型是为具体持久化单元的受管实体定义的，这些实体可以是实体类，嵌入类或者映射的父类。<br>CriteriaQuery接口：代表一个specific的顶层查询对象，它包含着查询的各个部分，比如：select 、from、where、group by、order by等<br>注意：CriteriaQuery对象只对实体类型或嵌入式类型的Criteria查询起作用</p>
<p>Root接口：代表Criteria查询的根对象，Criteria查询的查询根定义了实体类型，能为将来导航获得想要的结果，它与SQL查询中的FROM子句类似<br>1：Root实例是类型化的，且定义了查询的FROM子句中能够出现的类型。<br>2：查询根实例能通过传入一个实体类型给 AbstractQuery.from方法获得。<br>3：Criteria查询，可以有多个查询根。<br>4：AbstractQuery是CriteriaQuery 接口的父类，它提供得到查询根的方法。</p>
<p>CriteriaBuilder接口：用来构建CritiaQuery的构建器对象<br>Predicate：一个简单或复杂的谓词类型，其实就相当于条件或者是条件组合。    </p>
<p>基本对象的构建<br>1：通过EntityManager的getCriteriaBuilder或EntityManagerFactory的getCriteriaBuilder方法可以得到CriteriaBuilder对象<br>2：通过调用CriteriaBuilder的createQuery或createTupleQuery方法可以获得CriteriaQuery的实例<br>3：通过调用CriteriaQuery的from方法可以获得Root实例    </p>
<p>过滤条件<br>1：过滤条件会被应用到SQL语句的FROM子句中。在criteria 查询中，查询条件通过Predicate或Expression实例应用到CriteriaQuery对象上。<br>2：这些条件使用 CriteriaQuery .where 方法应用到CriteriaQuery 对象上<br>3：CriteriaBuilder也作为Predicate实例的工厂，通过调用CriteriaBuilder 的条件方法（ equal，notEqual， gt， ge，lt， le，between，like等）创建Predicate对象。<br>4：复合的Predicate 语句可以使用CriteriaBuilder的and, or, and, not 方法构建。</p>
<p>构建简单的Predicate示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Predicate p1=cb.like(root.get(“name”).as(String.class), “%”+uqm.getName()+“%”);</div><div class="line">Predicate p2=cb.equal(root.get(&quot;uuid&quot;).as(Integer.class), uqm.getUuid());</div><div class="line">Predicate p3=cb.gt(root.get(&quot;age&quot;).as(Integer.class), uqm.getAge());</div></pre></td></tr></table></figure></p>
<p>构建组合的Predicate示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Predicate p = cb.and(p3,cb.or(p1,p2));</div></pre></td></tr></table></figure></p>
<p>当然也可以形如前面动态拼接查询语句的方式，比如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Specification&lt;UserModel&gt; spec = new Specification&lt;UserModel&gt;() &#123;  </div><div class="line">	public Predicate toPredicate(Root&lt;UserModel&gt; root,  CriteriaQuery&lt;?&gt; query, CriteriaBuilder cb)&#123;  </div><div class="line">	List&lt;Predicate&gt; list = new ArrayList&lt;Predicate&gt;();  </div><div class="line">	          </div><div class="line">	if(um.getName()!=null &amp;&amp; um.getName().trim().length()&gt;0)&#123;  </div><div class="line">		list.add(cb.like(root.get(&quot;name&quot;).as(String.class), &quot;%&quot;+um.getName()+&quot;%&quot;));  </div><div class="line">	&#125;  </div><div class="line">	</div><div class="line">	if(um.getUuid()&gt;0)&#123;  </div><div class="line">		list.add(cb.equal(root.get(&quot;uuid&quot;).as(Integer.class), um.getUuid()));  </div><div class="line">	&#125;  </div><div class="line">		Predicate[] p = new Predicate[list.size()];  </div><div class="line">		return cb.and(list.toArray(p));  </div><div class="line">	&#125;  </div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>也可以使用CriteriaQuery来得到最后的Predicate，示例如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">Specification&lt;UserModel&gt; spec = new Specification&lt;UserModel&gt;() &#123;  </div><div class="line">	public Predicate toPredicate(Root&lt;UserModel&gt; root,  CriteriaQuery&lt;?&gt; query, CriteriaBuilder cb) &#123;  </div><div class="line">		Predicate p1 = cb.like(root.get(&quot;name&quot;).as(String.class), &quot;%&quot;+um.getName()+&quot;%&quot;);  </div><div class="line">		Predicate p2 = cb.equal(root.get(&quot;uuid&quot;).as(Integer.class), um.getUuid());  </div><div class="line">		Predicate p3 = cb.gt(root.get(&quot;age&quot;).as(Integer.class), um.getAge());  </div><div class="line">		//把Predicate应用到CriteriaQuery中去,因为还可以给CriteriaQuery添加其他的功能，比如排序、分组啥的  </div><div class="line">		query.where(cb.and(p3,cb.or(p1,p2)));  </div><div class="line">		//添加排序的功能  </div><div class="line">		query.orderBy(cb.desc(root.get(&quot;uuid&quot;).as(Integer.class)));  </div><div class="line">	     </div><div class="line">		return query.getRestriction();  </div><div class="line">	&#125;  </div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/07/19/Spring/JPA/JPA高级查询/" data-id="cj5nivvf5003jfyfy1t9xppid" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-Spring/JPA/Specification实例" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/19/Spring/JPA/Specification实例/">Specification实例</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/07/19/Spring/JPA/Specification实例/" class="article-date"><time datetime="2017-07-19T02:09:45.000Z" itemprop="datePublished">2017-07-19</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a> / <a class="article-category-link" href="/categories/Spring/JPA/">JPA</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="事例一"><a href="#事例一" class="headerlink" title="事例一"></a>事例一</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Specification&lt;UserModel&gt; spec = new Specification&lt;UserModel&gt;() &#123;  </div><div class="line">    public Predicate toPredicate(Root&lt;UserModel&gt; root,  </div><div class="line">            CriteriaQuery&lt;?&gt; query, CriteriaBuilder cb) &#123;  </div><div class="line">        List&lt;Predicate&gt; list = new ArrayList&lt;Predicate&gt;();  </div><div class="line">              </div><div class="line">        if(um.getName()!=null &amp;&amp; um.getName().trim().length()&gt;0)&#123;  </div><div class="line">            list.add(cb.like(root.get(&quot;name&quot;).as(String.class), &quot;%&quot;+um.getName()+&quot;%&quot;));  </div><div class="line">        &#125;  </div><div class="line">        if(um.getUuid()&gt;0)&#123;  </div><div class="line">            list.add(cb.equal(root.get(&quot;uuid&quot;).as(Integer.class), um.getUuid()));  </div><div class="line">        &#125;  </div><div class="line">        Predicate[] p = new Predicate[list.size()];  </div><div class="line">        return cb.and(list.toArray(p));  </div><div class="line">    &#125;  </div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="事例二"><a href="#事例二" class="headerlink" title="事例二"></a>事例二</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">Specification&lt;UserModel&gt; spec = new Specification&lt;UserModel&gt;() &#123;  </div><div class="line">    public Predicate toPredicate(Root&lt;UserModel&gt; root,  </div><div class="line">            CriteriaQuery&lt;?&gt; query, CriteriaBuilder cb) &#123;  </div><div class="line">        Predicate p1 = cb.like(root.get(&quot;name&quot;).as(String.class), &quot;%&quot;+um.getName()+&quot;%&quot;);  </div><div class="line">        Predicate p2 = cb.equal(root.get(&quot;uuid&quot;).as(Integer.class), um.getUuid());  </div><div class="line">        Predicate p3 = cb.gt(root.get(&quot;age&quot;).as(Integer.class), um.getAge());  </div><div class="line">        //把Predicate应用到CriteriaQuery中去,因为还可以给CriteriaQuery添加其他的功能，比如排序、分组啥的  </div><div class="line">        query.where(cb.and(p3,cb.or(p1,p2)));  </div><div class="line">        //添加排序的功能  </div><div class="line">        query.orderBy(cb.desc(root.get(&quot;uuid&quot;).as(Integer.class)));  </div><div class="line">          </div><div class="line">        return query.getRestriction();  </div><div class="line">    &#125;  </div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="事例三"><a href="#事例三" class="headerlink" title="事例三"></a>事例三</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public Predicate toPredicate(Root&lt;ExpressOrderEntity&gt; root, CriteriaQuery&lt;?&gt; query, CriteriaBuilder cb) &#123;</div><div class="line">    </div><div class="line">    List&lt;Predicate&gt; conditions = new ArrayList&lt;Predicate&gt;();</div><div class="line">    </div><div class="line">    //改为由店铺获取，为了子帐号和主帐号可以互相看到对方的订单</div><div class="line">    Predicate p1 = cb.equal(root.get(ExpressOrderEntity_.shop), shopEntity);</div><div class="line">    conditions.add(p1);</div><div class="line"></div><div class="line">    if (searchType != ExpressOrderConstants.APP_SEARCH_ALL) &#123;</div><div class="line">        In&lt;Byte&gt; in = cb.in(root.get(ExpressOrderEntity_.status));</div><div class="line">        Byte[] status = getOrderStatus(searchType);</div><div class="line">        for (Byte b : status) &#123;</div><div class="line">            in.value(b);</div><div class="line">        &#125;</div><div class="line">        conditions.add(in);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //根据id降序排序</div><div class="line">    Order idOrder = cb.desc(root.get(ExpressOrderEntity_.id));</div><div class="line"></div><div class="line">    return query.where(conditions.toArray(new Predicate[conditions.size()])).orderBy(idOrder).getRestriction();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="实例四"><a href="#实例四" class="headerlink" title="实例四"></a>实例四</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public Predicate toPredicate(Root&lt;AppBannerEntity&gt; root, CriteriaQuery&lt;?&gt; query, CriteriaBuilder cb) &#123;</div><div class="line">	Predicate enabled = cb.equal(root.get(AppBannerEntity_.isEnabled), true);</div><div class="line">	Join&lt;AppBannerEntity, AppBannerTypeEntity&gt; typeJoin = root.join(AppBannerEntity_.appBannerType);</div><div class="line">	Predicate bannerPd = typeJoin.get(AppBannerTypeEntity_.type).in(types);</div><div class="line">	Predicate notExpired = cb.greaterThan(root.get(AppBannerEntity_.expireTime), new Date());</div><div class="line">	return cb.and(enabled, bannerPd, notExpired);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="实例五：多对多关联查询"><a href="#实例五：多对多关联查询" class="headerlink" title="实例五：多对多关联查询"></a>实例五：多对多关联查询</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">List&lt;BusinessCircleEntity&gt; entities = businessCircleJpaRepository.findAll(new Specification&lt;BusinessCircleEntity&gt;() &#123;</div><div class="line">			</div><div class="line">    @Override</div><div class="line">    public Predicate toPredicate(Root&lt;BusinessCircleEntity&gt; root, CriteriaQuery&lt;?&gt; query, CriteriaBuilder cb) &#123;</div><div class="line">    	List&lt;Predicate&gt; conditions = new ArrayList&lt;Predicate&gt;();</div><div class="line">    	Join&lt;BusinessCircleEntity, MarketEntity&gt; market=root.joinList(BusinessCircleEntity_.listOfMarket.getName());</div><div class="line">    	Join&lt;MarketEntity, ProductCategoryEntity&gt; productCategory = market.joinList(MarketEntity_.listOfProductCategory.getName());</div><div class="line">    	</div><div class="line">    	Predicate p1 = cb.equal(productCategory.get(ProductCategoryEntity_.id), categoryId); </div><div class="line">    	conditions.add(p1);</div><div class="line">    	</div><div class="line">    	Predicate p2 = cb.equal(root.get(BusinessCircleEntity_.city), cityEntity); </div><div class="line">    	conditions.add(p2);</div><div class="line">    	</div><div class="line">    	return query.where(conditions.toArray(new Predicate[conditions.size()])).getRestriction();</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="实例六：多对多关联查询"><a href="#实例六：多对多关联查询" class="headerlink" title="实例六：多对多关联查询"></a>实例六：多对多关联查询</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">List&lt;MarketEntity&gt; entities = marketJpaRepository.findList(new Specification&lt;MarketEntity&gt;() &#123;</div><div class="line">			</div><div class="line">	@Override</div><div class="line">	public Predicate toPredicate(Root&lt;MarketEntity&gt; root, CriteriaQuery&lt;?&gt; query, CriteriaBuilder cb) &#123;</div><div class="line">		List&lt;Predicate&gt; conditions = new ArrayList&lt;Predicate&gt;();</div><div class="line">		Join&lt;MarketEntity, ProductCategoryEntity&gt; productCategory = root.joinList(MarketEntity_.listOfProductCategory.getName());</div><div class="line">		Join&lt;MarketEntity, BusinessCircleEntity&gt; businessCircle = root.join(MarketEntity_.businessCircle);</div><div class="line">		</div><div class="line">		Predicate p1 = cb.equal(productCategory.get(ProductCategoryEntity_.id), categoryId); </div><div class="line">		conditions.add(p1);</div><div class="line">		</div><div class="line">		Predicate p2 = cb.equal(businessCircle.get(BusinessCircleEntity_.city), cityEntity); </div><div class="line">		conditions.add(p2);</div><div class="line">		</div><div class="line">		return query.where(conditions.toArray(new Predicate[conditions.size()])).getRestriction();</div><div class="line">	&#125;</div><div class="line">&#125;, start, limit);</div></pre></td></tr></table></figure>
      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/07/19/Spring/JPA/Specification实例/" data-id="cj5nivvf6003lfyfysqhvyyjs" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-Spring/JPA/利用hibernate实现" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/19/Spring/JPA/利用hibernate实现/">利用hibernate实现</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/07/19/Spring/JPA/利用hibernate实现/" class="article-date"><time datetime="2017-07-19T02:09:45.000Z" itemprop="datePublished">2017-07-19</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a> / <a class="article-category-link" href="/categories/Spring/JPA/">JPA</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="依赖包"><a href="#依赖包" class="headerlink" title="依赖包"></a>依赖包</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&lt;!--  spring data jpa --&gt;</div><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-data-jpa&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;$&#123;spring-data-jpa.version&#125;&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div><div class="line"></div><div class="line">&lt;dependency&gt;</div><div class="line">	&lt;groupId&gt;org.hibernate&lt;/groupId&gt;</div><div class="line">	&lt;artifactId&gt;hibernate-entitymanager&lt;/artifactId&gt; </div><div class="line">	&lt;version&gt;5.1.0.Final&lt;/version&gt;</div><div class="line">&lt;/dependency&gt; </div><div class="line">	</div><div class="line">&lt;!-- Auditing依赖 --&gt;</div><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-aspects&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;$&#123;spring.version&#125;&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div><div class="line">&lt;!-- Auditing依赖 --&gt;</div><div class="line">	</div><div class="line">&lt;dependency&gt;</div><div class="line">   &lt;groupId&gt;javax.el&lt;/groupId&gt;</div><div class="line">   &lt;artifactId&gt;javax.el-api&lt;/artifactId&gt;</div><div class="line">   &lt;version&gt;2.2.4&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div><div class="line"> &lt;!--  spring data jpa --&gt;</div></pre></td></tr></table></figure>
<h2 id="支持annotation"><a href="#支持annotation" class="headerlink" title="支持annotation"></a>支持annotation</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;tx:annotation-driven /&gt;</div></pre></td></tr></table></figure>
<h2 id="配置Repository路径"><a href="#配置Repository路径" class="headerlink" title="配置Repository路径"></a>配置Repository路径</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;jpa:repositories base-package=&quot;com.lhc.repository&quot;     /&gt;</div></pre></td></tr></table></figure>
<ul>
<li>默认的事务管理类为<code>transactionManager</code>  </li>
<li>默认的实体管理工厂为<code>entityManagerFactory</code>  </li>
</ul>
<p>可以在配置文件中指定事务管理类和实体管理工厂<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;jpa:repositories base-package=&quot;com.lhc.repository&quot;   entity-manager-factory-ref=&quot;entityManagerFactory&quot;</div><div class="line">   transaction-manager-ref=&quot;transactionManager&quot;  /&gt;</div></pre></td></tr></table></figure></p>
<h2 id="配置transactionManager"><a href="#配置transactionManager" class="headerlink" title="配置transactionManager"></a>配置transactionManager</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;transactionManager&quot; class=&quot;org.springframework.orm.jpa.JpaTransactionManager&quot;&gt;</div><div class="line">	&lt;property name=&quot;entityManagerFactory&quot; ref=&quot;entityManagerFactory&quot; /&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
<h2 id="配置JPA实体管理工厂（entityManagerFactory），此处Hibernate的实现"><a href="#配置JPA实体管理工厂（entityManagerFactory），此处Hibernate的实现" class="headerlink" title="配置JPA实体管理工厂（entityManagerFactory），此处Hibernate的实现"></a>配置JPA实体管理工厂（entityManagerFactory），此处Hibernate的实现</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;entityManagerFactory&quot;</div><div class="line">	class=&quot;org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean&quot;&gt;</div><div class="line">	&lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;</div><div class="line">	&lt;property name=&quot;jpaVendorAdapter&quot;&gt;</div><div class="line">		&lt;bean class=&quot;org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter&quot;&gt;</div><div class="line">			&lt;property name=&quot;database&quot; value=&quot;MYSQL&quot; /&gt;</div><div class="line">			&lt;property name=&quot;databasePlatform&quot; value=&quot;org.hibernate.dialect.MySQLDialect&quot; /&gt;</div><div class="line">			&lt;property name=&quot;showSql&quot; value=&quot;true&quot; /&gt;</div><div class="line">			&lt;property name=&quot;generateDdl&quot; value=&quot;false&quot; /&gt;</div><div class="line">		&lt;/bean&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;property name=&quot;packagesToScan&quot; value=&quot;com.lhc.entity.jpa&quot; /&gt;</div><div class="line">	&lt;property name=&quot;jpaProperties&quot;&gt;</div><div class="line">		&lt;props&gt;</div><div class="line">			&lt;prop key=&quot;hibernate.dialect&quot;&gt;org.hibernate.dialect.MySQL5InnoDBDialect&lt;/prop&gt;</div><div class="line">			&lt;prop key=&quot;hibernate.format_sql&quot;&gt;false&lt;/prop&gt;</div><div class="line">			&lt;!-- &lt;prop key=&quot;hibernate.cache.use_query_cache&quot;&gt;true&lt;/prop&gt;</div><div class="line">			&lt;prop key=&quot;hibernate.cache.use_second_level_cache&quot;&gt;true&lt;/prop&gt;</div><div class="line">			&lt;prop key=&quot;hibernate.cache.region.factory_class&quot;&gt;org.hibernate.cache.ehcache.EhCacheRegionFactory</div><div class="line">			&lt;/prop&gt; --&gt;</div><div class="line">			&lt;prop key=&quot;javax.persistence.sharedCache.mode&quot;&gt;ENABLE_SELECTIVE&lt;/prop&gt;</div><div class="line">			&lt;prop key=&quot;hibernate.generate_statistics&quot;&gt;false&lt;/prop&gt;</div><div class="line">			&lt;prop key=&quot;hibernate.use_sql_comments&quot;&gt;false&lt;/prop&gt;</div><div class="line">			&lt;!-- &lt;prop key=&quot;hibernate.hbm2ddl.auto&quot; &gt;update&lt;/prop&gt; --&gt; </div><div class="line">		&lt;/props&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
<h2 id="配置审计（即新建实体时自动插入创建人，创建事件，更新实体时自动插入更新人，更新时间）"><a href="#配置审计（即新建实体时自动插入创建人，创建事件，更新实体时自动插入更新人，更新时间）" class="headerlink" title="配置审计（即新建实体时自动插入创建人，创建事件，更新实体时自动插入更新人，更新时间）"></a>配置审计（即新建实体时自动插入创建人，创建事件，更新实体时自动插入更新人，更新时间）</h2><h3 id="Entity配置Listener"><a href="#Entity配置Listener" class="headerlink" title="Entity配置Listener"></a>Entity配置Listener</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@EntityListeners(AuditingEntityListener.class)</div></pre></td></tr></table></figure>
<h3 id="Entity添加相应注解"><a href="#Entity添加相应注解" class="headerlink" title="Entity添加相应注解"></a>Entity添加相应注解</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">@CreatedBy</div><div class="line">@Column(name=&quot;created_by&quot;)</div><div class="line">private Integer createdBy;</div><div class="line"></div><div class="line">@CreatedDate</div><div class="line">@Temporal(TemporalType.TIMESTAMP)</div><div class="line">@Column(name=&quot;created_date&quot;)</div><div class="line">private Date createdDate;</div><div class="line"></div><div class="line">@LastModifiedBy</div><div class="line">@Column(name=&quot;modified_by&quot;)</div><div class="line">private Integer modifiedBy;</div><div class="line"></div><div class="line">@LastModifiedDate</div><div class="line">@Temporal(TemporalType.TIMESTAMP)</div><div class="line">@Column(name=&quot;modified_date&quot;)</div><div class="line">private Date modifiedDate;</div></pre></td></tr></table></figure>
<h3 id="实现AuditorAware接口"><a href="#实现AuditorAware接口" class="headerlink" title="实现AuditorAware接口"></a>实现AuditorAware<t>接口</t></h3><p>以下采用spring security实现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">public class SpringSecurityAuditorAware implements AuditorAware&lt;Integer&gt; &#123;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public Integer getCurrentAuditor() &#123;</div><div class="line"></div><div class="line">		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</div><div class="line"></div><div class="line">		if (authentication == null || !authentication.isAuthenticated()) &#123;</div><div class="line">			return 0;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		AdminDetails adminDetails = (AdminDetails) authentication.getPrincipal();</div><div class="line">		if(null == adminDetails) &#123;</div><div class="line">			return 0;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		return adminDetails.getId();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="xml配置"><a href="#xml配置" class="headerlink" title="xml配置"></a>xml配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;springSecurityAuditorAware&quot; class=&quot;com.lhc.security.SpringSecurityAuditorAware&quot; /&gt;</div><div class="line">&lt;jpa:auditing auditor-aware-ref=&quot;springSecurityAuditorAware&quot; /&gt;</div></pre></td></tr></table></figure>
      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/07/19/Spring/JPA/利用hibernate实现/" data-id="cj5nivvf7003ofyfyu1vvyw4n" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-Spring/JPA/对应关系映射配置" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/19/Spring/JPA/对应关系映射配置/">对应关系映射配置</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/07/19/Spring/JPA/对应关系映射配置/" class="article-date"><time datetime="2017-07-19T02:09:45.000Z" itemprop="datePublished">2017-07-19</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a> / <a class="article-category-link" href="/categories/Spring/JPA/">JPA</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="ManyToMany"><a href="#ManyToMany" class="headerlink" title="ManyToMany"></a>ManyToMany</h2><p>主控方配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">@ManyToMany(targetEntity=SysRoleEntity.class, fetch=FetchType.LAZY)</div><div class="line">@JoinTable(name=&quot;sys_admin_role&quot;, </div><div class="line">  joinColumns=@JoinColumn(name=&quot;admin_id&quot;, referencedColumnName=&quot;id&quot;),</div><div class="line">  inverseJoinColumns=@JoinColumn(name=&quot;role_id&quot;, referencedColumnName=&quot;id&quot;)</div><div class="line"> ) </div><div class="line">private List&lt;SysRoleEntity&gt; listOfSysRole;</div></pre></td></tr></table></figure></p>
<p>被动方配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">@ManyToMany(mappedBy=&quot;listOfSysRole&quot;, targetEntity=SysAdminEntity.class)</div><div class="line">private List&lt;SysAdminEntity&gt; listOfSysAdmin;</div></pre></td></tr></table></figure></p>
<h2 id="ManyToOne-And-OneToMany"><a href="#ManyToOne-And-OneToMany" class="headerlink" title="ManyToOne And OneToMany"></a>ManyToOne And OneToMany</h2><p>主控方配置：一般是多的一方为主控<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@ManyToOne</div><div class="line">@JoinColumn(name=&quot;role_id&quot;, referencedColumnName=&quot;id&quot;)</div><div class="line">private SysRoleEntity sysRole;</div></pre></td></tr></table></figure></p>
<p>被动方配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">@OneToMany(mappedBy=&quot;sysRole&quot;, targetEntity=SysAuthorityEntity.class)</div><div class="line">private List&lt;SysAuthorityEntity&gt; listOfsysAuthority;</div></pre></td></tr></table></figure></p>
<h2 id="OneToOne"><a href="#OneToOne" class="headerlink" title="OneToOne"></a>OneToOne</h2><p>主控方配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@OneToOne(fetch=FetchType.LAZY)</div><div class="line">@JoinColumn(name=&quot;code_id&quot;, referencedColumnName=&quot;id&quot;)</div><div class="line">private CodeEntity codeEntity;</div></pre></td></tr></table></figure></p>
<p>被动方配置:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">@OneToOne(mappedBy=&quot;codeEntity&quot;, targetEntity=OddsEntity.class, fetch=FetchType.LAZY)</div><div class="line">private OddsEntity oddsEntity;</div></pre></td></tr></table></figure></p>

      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/07/19/Spring/JPA/对应关系映射配置/" data-id="cj5nivvf8003qfyfym8ases96" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-GitHub/安装gogs本地git服务器" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/19/GitHub/安装gogs本地git服务器/">安装gogs本地git服务器</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/07/19/GitHub/安装gogs本地git服务器/" class="article-date"><time datetime="2017-07-19T02:09:45.000Z" itemprop="datePublished">2017-07-19</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Github/">Github</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="gogs首页"><a href="#gogs首页" class="headerlink" title="gogs首页"></a>gogs首页</h2><p><a href="https://gogs.io/" target="_blank" rel="external">https://gogs.io/</a></p>
<h2 id="下载二进制包"><a href="#下载二进制包" class="headerlink" title="下载二进制包"></a>下载二进制包</h2><p><a href="https://gogs.io/docs/installation/install_from_binary.html" target="_blank" rel="external">https://gogs.io/docs/installation/install_from_binary.html</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">进入解压目录：</div><div class="line">执行命令 ./gogs web</div></pre></td></tr></table></figure></p>
<p>目录运行地址：<br><a href="http://localhost:3000/" target="_blank" rel="external">http://localhost:3000/</a></p>
<p>登录地址：<a href="http://localhost:3000/user/login" target="_blank" rel="external">http://localhost:3000/user/login</a></p>
<p>帐号：<code>root</code>      密码：<code>clq</code></p>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">进入go目录：/usr/local/Cellar/gogs</div><div class="line">执行命令./gogs web</div></pre></td></tr></table></figure>
<h2 id="后台运行"><a href="#后台运行" class="headerlink" title="后台运行"></a>后台运行</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">进入go目录：/usr/local/Cellar/gogs</div><div class="line">执行命令 nohup ./gogs web &amp;</div></pre></td></tr></table></figure>
      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/07/19/GitHub/安装gogs本地git服务器/" data-id="cj5nivvbx0000fyfyg7ok74nt" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  
    <article id="post-Spring/Security/获取所有登录用户" class="article article-type-post" itemscope itemprop="blogPost">

  <header class="article-header">
    
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/07/19/Spring/Security/获取所有登录用户/">获取所有登录用户</a>
    </h1>
  


  </header>

  <div class="article-meta">
    <div class="article-datetime">
  <a href="/2017/07/19/Spring/Security/获取所有登录用户/" class="article-date"><time datetime="2017-07-19T02:09:45.000Z" itemprop="datePublished">2017-07-19</time></a>
</div>

    
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a> / <a class="article-category-link" href="/categories/Spring/Security/">Security</a>
  </div>


  </div>
  <div class="article-inner">

    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="web-xml"><a href="#web-xml" class="headerlink" title="web.xml"></a>web.xml</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;listener&gt;</div><div class="line">    &lt;listener-class&gt;</div><div class="line">      org.springframework.security.web.session.HttpSessionEventPublisher</div><div class="line">    &lt;/listener-class&gt;</div><div class="line">&lt;/listener&gt;</div></pre></td></tr></table></figure>
<h2 id="security-xml"><a href="#security-xml" class="headerlink" title="security.xml"></a>security.xml</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;http&gt;</div><div class="line">    &lt;session-management &gt;</div><div class="line">    	&lt;concurrency-control max-sessions=&quot;1&quot; session-registry-ref=&quot;sessionRegistry&quot;</div><div class="line">    	expired-url=&quot;/admin/none/session_expired.jsp&quot; /&gt; </div><div class="line">    &lt;/session-management&gt;</div><div class="line">&lt;/http&gt;</div><div class="line"></div><div class="line">&lt;beans:bean id=&quot;sessionRegistry&quot; class=&quot;org.springframework.security.core.session.SessionRegistryImpl&quot; /&gt;</div></pre></td></tr></table></figure>
<h2 id="java中使用"><a href="#java中使用" class="headerlink" title="java中使用"></a>java中使用</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sessionRegistry.getAllPrincipals()</div></pre></td></tr></table></figure>
      
    </div>

    
      

    

    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/07/19/Spring/Security/获取所有登录用户/" data-id="cj5nivvfa003vfyfyny7kf6s2" class="article-share-link">
        <i class="fa fa-share"></i> Share
      </a>
      
      

    </footer>
  </div>
  
</article>



  


  <div id="page-nav">
    <nav><ul class="pagination"><li><a class="page-prev" rel="prev" href="/page/5/"><i class="fa fa-chevron-left"></i> Prev</a></li><li><a class="page-number" href="/">1</a></li><li class="disabled"><span class="page-space">&hellip;</span></li><li><a class="page-number" href="/page/4/">4</a></li><li><a class="page-number" href="/page/5/">5</a></li><li class="active"><span class="page-number">6</span></li><li><a class="page-number" href="/page/7/">7</a></li><li><a class="page-number" href="/page/8/">8</a></li><li class="disabled"><span class="page-space">&hellip;</span></li><li><a class="page-number" href="/page/10/">10</a></li><li><a class="page-next" rel="next" href="/page/7/">Next <i class="fa fa-chevron-right"></i></a></li></ul></nav>
  </div>



        </div>
        <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
          
  <div class="sidebar-module sidebar-module-inset">
  <h4>About</h4>
  <p>该博客内的文章是博主在日常工作或者学习中总结出来，部分内容来自网络.</p>

</div>


  
  <div class="sidebar-module">
    <h4>Categories</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Eclipse/">Eclipse</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Github/">Github</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Java/">Java</a><span class="sidebar-module-list-count">32</span><ul class="sidebar-module-list-child"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Java/Cookie/">Cookie</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Java/JavaMail/">JavaMail</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Java/安全相关/">安全相关</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Java/数据类型/">数据类型</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Java/日记/">日记</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Java/线程/">线程</a><span class="sidebar-module-list-count">16</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Java/队列/">队列</a><span class="sidebar-module-list-count">5</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Java/集合/">集合</a><span class="sidebar-module-list-count">3</span></li></ul></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Linux/">Linux</a><span class="sidebar-module-list-count">7</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Maven/">Maven</a><span class="sidebar-module-list-count">9</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Spring/">Spring</a><span class="sidebar-module-list-count">32</span><ul class="sidebar-module-list-child"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Spring/Application-Event/">Application Event</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Spring/JPA/">JPA</a><span class="sidebar-module-list-count">7</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Spring/Security/">Security</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Spring/Task/">Task</a><span class="sidebar-module-list-count">3</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Spring/spring-MVC/">spring MVC</a><span class="sidebar-module-list-count">17</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Spring/spring-data-redis/">spring data redis</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/Spring/基础/">基础</a><span class="sidebar-module-list-count">2</span></li></ul></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/服务器相关/">服务器相关</a><span class="sidebar-module-list-count">16</span><ul class="sidebar-module-list-child"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/服务器相关/Hessian/">Hessian</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/服务器相关/Hudson-Jenkins/">Hudson & Jenkins</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/服务器相关/Tomcat/">Tomcat</a><span class="sidebar-module-list-count">2</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/服务器相关/red5/">red5</a><span class="sidebar-module-list-count">1</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/服务器相关/redis/">redis</a><span class="sidebar-module-list-count">9</span></li><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/categories/服务器相关/resin/">resin</a><span class="sidebar-module-list-count">2</span></li></ul></li></ul>
  </div>



  


  

  
  <div class="sidebar-module">
    <h4>Archives</h4>
    <ul class="sidebar-module-list"><li class="sidebar-module-list-item"><a class="sidebar-module-list-link" href="/archives/2017/07/">七月 2017</a><span class="sidebar-module-list-count">98</span></li></ul>
  </div>



  
  <div class="sidebar-module">
    <h4>Recents</h4>
    <ul class="sidebar-module-list">
      
        <li>
          <a href="/2017/07/19/Spring/Spring Data Redis/配置/">配置</a>
        </li>
      
        <li>
          <a href="/2017/07/19/Java/集合/集合遍历/">集合遍历</a>
        </li>
      
        <li>
          <a href="/2017/07/19/Linux/activemq安装和配置/">activemq安装和配置</a>
        </li>
      
        <li>
          <a href="/2017/07/19/Linux/apt-get常用命令/">apt-get常用命令</a>
        </li>
      
        <li>
          <a href="/2017/07/19/Linux/mysql安装/">mysql安装</a>
        </li>
      
    </ul>
  </div>



        </div>
    </div>
  </div>
  <footer class="blog-footer">
  <div class="container">
    <div id="footer-info" class="inner">
      &copy; 2017 LeoChan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

  

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js" integrity="sha384-8gBf6Y4YYq7Jx97PIqmTwLPin4hxIzQw5aDmUg/DDhul9fFpbbLcLh3nTIIDJKhx" crossorigin="anonymous"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>



<script src="/js/script.js"></script>

</body>
</html>
