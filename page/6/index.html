<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>LeoChan&#39;s 个人博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="描述啊">
<meta property="og:type" content="website">
<meta property="og:title" content="LeoChan&#39;s 个人博客">
<meta property="og:url" content="https://clq2owesome.github.io/page/6/index.html">
<meta property="og:site_name" content="LeoChan&#39;s 个人博客">
<meta property="og:description" content="描述啊">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LeoChan&#39;s 个人博客">
<meta name="twitter:description" content="描述啊">
  
    <link rel="alternate" href="/atom.xml" title="LeoChan&#39;s 个人博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">LeoChan&#39;s 个人博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">技术都是通用的，重要的是是否具有自主解决问题的能力！</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://clq2owesome.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Java/基础/面向对象7大原则" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/27/Java/基础/面向对象7大原则/" class="article-date">
  <time datetime="2017-08-27T02:09:45.000Z" itemprop="datePublished">2017-08-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java/">Java</a>►<a class="article-category-link" href="/categories/Java/基础/">基础</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/27/Java/基础/面向对象7大原则/">面向对象7大原则</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>七大原则总脉络图：<br><img src="http://my.csdn.net/uploads/201205/15/1337080249_5362.jpg" alt="image">  </p>
<ol>
<li><p><strong>单一职责原则</strong>（Single Responsibility Principle）  </p>
<p> 可以降低类的复杂度，一个类只负责一项职责，其逻辑肯定要比负责多项职责简单的多；提高类的可读性，提高系统的可维护性；变更引起的风险降低，变更是必然的，如果单一职责原则遵守的好，当修改一个功能时，可以显著降低对其他功能的影响。需要说明的一点是单一职责原则不只是面向对象编程思想所特有的，只要是模块化的程序设计，都适用单一职责原则。</p>
</li>
<li><p><strong>里氏替换原则</strong>（Liskov Substitution Principle）    </p>
<p> 里氏替换原则告诉我们，在软件中将一个基类对象替换成它的子类对象，程序将不会产生任何错误和异常，反过来则不成立，如果一个软件实体使用的是一个子类对象的话，那么它不一定能够使用基类对象。里氏替换原则是实现开闭原则的重要方式之一，由于使用基类对象的地方都可以使用子类对象，因此在程序中尽量使用基类类型来对对象进行定义，而在运行时再确定其子类类型，用子类对象来替换父类对象。  </p>
<p> 使用里氏替换原则时需要注意，子类的所有方法必须在父类中声明，或子类必须实现父类中声明的所有方法。尽量把父类设计为抽象类或者接口，让子类继承父类或实现父接口，并实现在父类中声明的方法，运行时，子类实例替换父类实例，我们可以很方便地扩展系统的功能，同时无须修改原有子类的代码，增加新的功能可以通过增加一个新的子类来实现。  </p>
<p> 从大局看Java的多态就属于这个原则。</p>
</li>
<li><p><strong>依赖倒置原则</strong>（Dependence Inversion Principle）  </p>
<p> 具体依赖抽象，上层依赖下层。假设B是较A低的模块，但B需要使用到A的功能，这个时候，B不应当直接使用A中的具体类；而应当由B定义一抽象接口，并由A来实现这个抽象接口，B只使用这个抽象接口；这样就达到了依赖倒置的目的，B也解除了对A的依赖，反过来是A依赖于B定义的抽象接口。通过上层模块难以避免依赖下层模块，假如B也直接依赖A的实现，那么就可能造成循环依赖。</p>
<p> 采用依赖倒置原则可以减少类间的耦合性，提高系统的稳定性，减少并行开发引起的风险，提高代码的可读性和可维护性。</p>
<p> 从大局看Java的多态就属于这个原则。</p>
</li>
<li><p><strong>接口隔离原则</strong>（Interface Segregation Principle） </p>
<p> 建立单一接口，不要建立庞大的接口，尽量细化接口，接口中的方法尽量少。也就是要为各个类建立专用的接口，而不要试图去建立一个很庞大的接口供所有依赖它的类去调用。依赖几个专用的接口要比依赖一个综合的接口更灵活。接口是设计时对外部设定的约定，通过分散定义多个接口，可以预防外来变更的扩散，提高系统的灵活性和可维护性。</p>
<p> 从大局来说Java的接口可以实现多继承就是接口隔离原则的基础保障。</p>
</li>
<li><p><strong>迪米特法则</strong>（Law Of Demeter）   </p>
<p> 类与类之间的关系越密切，耦合度也就越来越大，只有尽量降低类与类之间的耦合才符合设计模式；对于被依赖的类来说，无论逻辑多复杂都要尽量封装在类的内部；每个对象都会与其他对象有耦合关系，我们称出现成员变量、方法参数、方法返回值中的类为直接的耦合依赖，而出现在局部变量中的类则不是直接耦合依赖，也就是说，不是直接耦合依赖的类最好不要作为局部变量的形式出现在类的内部。</p>
<p> 一个对象对另一个对象知道的越少越好，即一个软件实体应当尽可能少的与其他实体发生相互作用，在一个类里能少用多少其他类就少用多少，尤其是局部变量的依赖类，能省略尽量省略。同时如果两个类不必彼此直接通信，那么这两个类就不应当发生直接的相互作用。如果其中一个类需要调用另一个类的某一方法的话，可以通过第三者转发这个调用。</p>
</li>
<li><p><strong>开闭原则</strong>（Open Close Principle）</p>
<p> 开放封闭原则主要体现在对扩展开放、对修改封闭，意味着有新的需求或变化时，可以对现有代码进行扩展，以适应新的情况。软件需求总是变化的，世界上没有一个软件的是不变的，因此对软件设计人员来说，必须在不需要对原有系统进行修改的情况下，实现灵活的系统扩展。</p>
<p> 可以通过Template Method模式和Strategy模式进行重构，实现对修改封闭，对扩展开放的设计思路。<br> 封装变化，是实现开放封闭原则的重要手段，对于经常发生变化的状态，一般将其封装为一个抽象，拒绝滥用抽象，只将经常变化的部分进行抽象。</p>
</li>
<li><p><strong>组合/聚合复用原则</strong>（Composite/Aggregate Reuse Principle CARP）  </p>
<p> 其实整个设计模式就是在讲如何类与类之间的组合/聚合。在一个新的对象里面通过关联关系（包括组合关系和聚合关系）使用一些已有的对象，使之成为新对象的一部分，新对象通过委派调用已有对象的方法达到复用其已有功能的目的。也就是，要尽量使用类的合成复用，尽量不要使用继承。</p>
<p> 如果为了复用，便使用继承的方式将两个不相干的类联系在一起，违反里氏代换原则，哪是生搬硬套，忽略了继承了缺点。继承复用破坏数据封装性，将基类的实现细节全部暴露给了派生类，基类的内部细节常常对派生类是透明的，白箱复用；虽然简单，但不安全，不能在程序的运行过程中随便改变；基类的实现发生了改变，派生类的实现也不得不改变；从基类继承而来的派生类是静态的，不可能在运行时间内发生改变，因此没有足够的灵活性。</p>
<p> 组合/聚合复用原则可以使系统更加灵活，类与类之间的耦合度降低，一个类的变化对其他类造成的影响相对较少，因此一般首选使用组合/聚合来实现复用；其次才考虑继承，在使用继承时，需要严格遵循里氏代换原则，有效使用继承会有助于对问题的理解，降低复杂度，而滥用继承反而会增加系统构建和维护的难度以及系统的复杂度，因此需要慎重使用继承复用。</p>
</li>
</ol>
<p>　</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://clq2owesome.github.io/2017/08/27/Java/基础/面向对象7大原则/" data-id="cjei8ydgd004s7oble8c08oi9" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Java/基础/重载与重写" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/16/Java/基础/重载与重写/" class="article-date">
  <time datetime="2017-08-16T02:09:45.000Z" itemprop="datePublished">2017-08-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java/">Java</a>►<a class="article-category-link" href="/categories/Java/基础/">基础</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/16/Java/基础/重载与重写/">重载与重写</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="重载-overloading"><a href="#重载-overloading" class="headerlink" title="重载 overloading"></a>重载 overloading</h2><ol>
<li>方法重载是让类以统一的方式处理不同类型数据的一种手段。多个同名函数同时存在，具有不同的参数个数/类型。重载是一个类中多态性的一种表现。</li>
<li>Java的方法重载，就是在类中可以创建多个方法，它们具有相同的名字，但具有不同的参数和不同的定义。调用方法时通过传递给它们的不同参数个数和参数类型给它们的不同参数个数和参数类型给它们的不同参数个数和参数类型来决定具体使用哪个方法,这就是多态性。</li>
<li>重载的时候，方法名要一样，但是参数类型和个数不一样，返回值类型可以相同也可以不相同。无法以返回型别作为重载函数的区分标准。</li>
</ol>
<h3 id="规则："><a href="#规则：" class="headerlink" title="规则："></a>规则：</h3><ol>
<li>必须具有不同的参数列表；</li>
<li>可以有相同的返回类型，只要参数列表不同就可以了；</li>
<li>可以有不同的访问修饰符；</li>
<li>可以抛出不同的异常；</li>
</ol>
<h2 id="重写overriding"><a href="#重写overriding" class="headerlink" title="重写overriding"></a>重写overriding</h2><ol>
<li>父类与子类之间的多态性，对父类的函数进行重新定义。如果在子类中定义某方法与其父类有相同的名称和参数，我们说该方法被重写(Overriding)。在Java中，子类可继承父类中的方法，而不需要重新编写相同的方法。但有时子类并不想原封不动地继承父类的方法，而是想作一定的修改，这就需要采用方法的重写。方法重写又称方法覆盖。</li>
<li>若子类中的方法与父类中的某一方法具有相同的方法名、返回类型和参数表，则新方法将覆盖原有的方法。如需父类中原有的方法，可使用super关键字，该关键字引用了当前类的父类。</li>
<li>子类函数的访问修饰权限不能小于父类的</li>
</ol>
<h3 id="规则：-1"><a href="#规则：-1" class="headerlink" title="规则："></a>规则：</h3><ol>
<li>参数列表必须完全与被重写的方法相同，否则不能称其为重写而是重载。</li>
<li>返回的类型必须一直与被重写的方法的返回类型相同，否则不能称其为重写而是重载。</li>
<li>访问修饰符的限制一定要大于被重写方法的访问修饰符（public&gt;protected&gt;default&gt;private）</li>
<li>重写方法一定不能抛出新的检查异常或者比被重写方法申明更加宽泛的检查型异常。例如：<br>父类的一个方法申明了一个检查异常IOException，在重写这个方法是就不能抛出Exception,只能抛出IOException的子类异常，可以抛出非检查异常。</li>
</ol>
<p>　　</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://clq2owesome.github.io/2017/08/16/Java/基础/重载与重写/" data-id="cjei8ydgg00507oblpw0ic2g0" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Java/基础/java动态代理" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/16/Java/基础/java动态代理/" class="article-date">
  <time datetime="2017-08-16T02:09:45.000Z" itemprop="datePublished">2017-08-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java/">Java</a>►<a class="article-category-link" href="/categories/Java/基础/">基础</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/16/Java/基础/java动态代理/">java动态代理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="class文件简介及加载"><a href="#class文件简介及加载" class="headerlink" title="class文件简介及加载"></a>class文件简介及加载</h2><p> Java编译器编译好Java文件之后，产生.class 文件在磁盘中。这种class文件是二进制文件，内容是只有JVM虚拟机能够识别的机器码。JVM虚拟机读取字节码文件，取出二进制数据，加载到内存中，解析.class 文件内的信息，生成对应的 Class对象:<br><img src="http://img.blog.csdn.net/20140427155129031" alt="image"></p>
<h3 id="在运行期的代码中生成二进制字节码"><a href="#在运行期的代码中生成二进制字节码" class="headerlink" title="在运行期的代码中生成二进制字节码"></a>在运行期的代码中生成二进制字节码</h3><p>由于JVM通过字节码的二进制信息加载类的，那么，如果我们在运行期系统中，遵循Java编译系统组织.class文件的格式和结构，生成相应的二进制数据，然后再把这个二进制数据加载转换成对应的类，这样，就完成了在代码中，动态创建一个类的能力了。<br><img src="http://img.blog.csdn.net/20140427160344203?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbHVhbmxvdWlz/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="image"> </p>
<h4 id="在运行时期可以按照Java虚拟机规范对class文件的组织规则生成对应的二进制字节码。当前有很多开源框架可以完成这些功能，如ASM，Javassist。"><a href="#在运行时期可以按照Java虚拟机规范对class文件的组织规则生成对应的二进制字节码。当前有很多开源框架可以完成这些功能，如ASM，Javassist。" class="headerlink" title="在运行时期可以按照Java虚拟机规范对class文件的组织规则生成对应的二进制字节码。当前有很多开源框架可以完成这些功能，如ASM，Javassist。"></a>在运行时期可以按照Java虚拟机规范对class文件的组织规则生成对应的二进制字节码。当前有很多开源框架可以完成这些功能，如ASM，Javassist。</h4><p>ASM 是一个 Java 字节码操控框架。它能够以二进制形式修改已有类或者动态生成类。ASM 可以直接产生二进制 class 文件，也可以在类被加载入 Java 虚拟机之前动态改变类行为。ASM 从类文件中读入信息后，能够改变类行为，分析类信息，甚至能够根据用户要求生成新类。  </p>
<p><strong>不过ASM在创建class字节码的过程中，操纵的级别是底层JVM的汇编指令级别，这要求ASM使用者要对class组织结构和JVM汇编指令有一定的了解。</strong></p>
<h4 id="Java字节码生成开源框架介绍–Javassist："><a href="#Java字节码生成开源框架介绍–Javassist：" class="headerlink" title="Java字节码生成开源框架介绍–Javassist："></a>Java字节码生成开源框架介绍–Javassist：</h4><p>Javassist是一个开源的分析、编辑和创建Java字节码的类库。是由东京工业大学的数学和计算机科学系的 Shigeru Chiba （千叶 滋）所创建的。它已加入了开放源代码JBoss 应用服务器项目,通过使用Javassist对字节码操作为JBoss实现动态AOP框架。javassist是jboss的一个子项目，其主要的优点，在于简单，而且快速。直接使用java编码的形式，而不需要了解虚拟机指令，就能动态改变类的结构，或者动态生成类。</p>
<h2 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h2><p>代理模式上，基本上有Subject角色，RealSubject角色，Proxy角色。其中：Subject角色负责定义RealSubject和Proxy角色应该实现的接口；RealSubject角色用来真正完成业务服务功能；Proxy角色负责将自身的Request请求，调用realsubject 对应的request功能来实现业务功能，自己不真正做业务。   <img src="http://img.blog.csdn.net/20140526164603234?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbHVhbmxvdWlz/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="image"><br>上面的这幅代理结构图是典型的静态的代理模式：<br><strong>当在代码阶段规定这种代理关系，Proxy类通过编译器编译成class文件，当系统运行时，此class已经存在了。这种静态的代理模式固然在访问无法访问的资源，增强现有的接口业务功能方面有很大的优点，但是大量使用这种静态代理，会使我们系统内的类的规模增大，并且不易维护；并且由于Proxy和RealSubject的功能 本质上是相同的，Proxy只是起到了中介的作用，这种代理在系统中的存在，导致系统结构比较臃肿和松散。</strong>  </p>
<p>为了解决这个问题，就有了动态地创建Proxy的想法：在运行状态中，需要代理的地方，根据Subject 和RealSubject，动态地创建一个Proxy，用完之后，就会销毁，这样就可以避免了Proxy 角色的class在系统中冗杂的问题了。</p>
<h2 id="JDK动态代理"><a href="#JDK动态代理" class="headerlink" title="JDK动态代理"></a>JDK动态代理</h2><p>仔细思考代理模式中的代理Proxy角色。Proxy角色在执行代理业务的时候，无非是在调用真正业务之前或者之后做一些“额外”业务。<br><img src="http://img.blog.csdn.net/20140603152131484?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMDM0OTE2OQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="image"><br>有上图可以看出，代理类处理的逻辑很简单：<strong>在调用某个方法前及方法后做一些额外的业务</strong>。换一种思路就是：<strong>在触发（invoke）真实角色的方法之前或者之后做一些额外的业务</strong>。那么，为了构造出具有通用性和简单性的代理类，可以将所有的触发真实角色动作交给一个触发的管理器，让这个管理器统一地管理触发。这种管理器就是InvocationHandler。<br>动态代理模式的结构跟上面的静态代理模式稍微有所不同，多引入了一个InvocationHandler角色。    </p>
<p>动态代理工作的基本模式就是将自己的方法功能的实现交给 InvocationHandler角色，外界对Proxy角色中的每一个方法的调用，Proxy角色都会交给InvocationHandler来处理，而InvocationHandler则调用具体对象角色的方法。如下图所示：<br><img src="http://img.blog.csdn.net/20140515134257500?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbHVhbmxvdWlz/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="image"><br>在这种模式之中：代理Proxy 和RealSubject 应该实现相同的功能，这一点相当重要。（我这里说的功能，可以理解为某个类的public方法）  </p>
<p>在面向对象的编程之中，如果我们想要约定Proxy 和RealSubject可以实现相同的功能，有两种方式：</p>
<ol>
<li>JDK动态代理模式：就是定义一个功能接口，然后让Proxy 和RealSubject来实现这个接口。</li>
<li>CGLIB模式：通过继承。因为如果Proxy 继承自RealSubject，这样Proxy则拥有了RealSubject的功能，Proxy还可以通过重写RealSubject中的方法，来实现多态。</li>
</ol>
<p>Java 动态代理机制的一些特点：</p>
<ol>
<li>包：如果所代理的接口都是 public 的，那么它将被定义在顶层包（即包路径为空），如果所代理的接口中有非 public 的接口（因为接口不能被定义为 protect 或 private，所以除 public 之外就是默认的 package 访问级别），那么它将被定义在该接口所在包（假设代理了 com.ibm.developerworks 包中的某非 public 接口 A，那么新生成的代理类所在的包就是 com.ibm.developerworks），这样设计的目的是为了最大程度的保证动态代理类不会因为包管理的问题而无法被成功定义并访问；</li>
<li>类名：格式是“$ProxyN”，其中 N 是一个逐一递增的阿拉伯数字，代表 Proxy 类第 N 次生成的动态代理类，值得注意的一点是，并不是每次调用 Proxy 的静态方法创建动态代理类都会使得 N 值增加，原因是如果对同一组接口（包括接口排列的顺序相同）试图重复创建动态代理类，它会很聪明地返回先前已经创建好的代理类的类对象，而不会再尝试去创建一个全新的代理类，这样可以节省不必要的代码重复生成，提高了代理类的创建效率。</li>
<li>要注意不能有重复的接口，以避免动态代理类代码生成时的编译错误。</li>
<li>这些接口对于类装载器必须可见，否则类装载器将无法链接它们，将会导致类定义失败。再次，需被代理的所有非public的接口必须在同一个包中，否则代理类生成也会失败。</li>
<li>接口的数目不能超过 65535，这是 JVM 设定的限制。</li>
</ol>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><h4 id="目标接口TargetInterface"><a href="#目标接口TargetInterface" class="headerlink" title="目标接口TargetInterface"></a>目标接口TargetInterface</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public interface TargetInterface &#123; </div><div class="line">    public int targetMethodA(int number); </div><div class="line">    public int targetMethodB(int number); </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="实现该接口的委托类ConcreteClass"><a href="#实现该接口的委托类ConcreteClass" class="headerlink" title="实现该接口的委托类ConcreteClass"></a>实现该接口的委托类ConcreteClass</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">public class ConcreteClass implements TargetInterface&#123; </div><div class="line"> </div><div class="line">    public int targetMethodA(int number) &#123; </div><div class="line">        System.out.println(&quot;开始调用目标类的方法targetMethodA...&quot;); </div><div class="line">        System.out.println(&quot;操作-打印数字:&quot;+number); </div><div class="line">        System.out.println(&quot;结束调用目标类的方法targetMethodA...&quot;); </div><div class="line">        return number; </div><div class="line">    &#125; </div><div class="line"> </div><div class="line">    public int targetMethodB(int number)&#123; </div><div class="line">        System.out.println(&quot;开始调用目标类的方法targetMethodB...&quot;); </div><div class="line">        System.out.println(&quot;操作-打印数字:&quot;+number); </div><div class="line">        System.out.println(&quot;结束调用目标类的方法targetMethodB...&quot;); </div><div class="line">        return number; </div><div class="line">    &#125; </div><div class="line"> </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>很简单，一个普通的类，实现了目标接口。</p>
<h4 id="代理处理器类ProxyHandler"><a href="#代理处理器类ProxyHandler" class="headerlink" title="代理处理器类ProxyHandler"></a>代理处理器类ProxyHandler</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">public class ProxyHandler implements InvocationHandler&#123; </div><div class="line">    private Object concreteClass; </div><div class="line"> </div><div class="line">    public ProxyHandler(Object concreteClass)&#123; </div><div class="line">        this.concreteClass=concreteClass; </div><div class="line">    &#125; </div><div class="line"> </div><div class="line">    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; </div><div class="line">        System.out.println(&quot;proxy:&quot;+proxy.getClass().getName()); </div><div class="line">        System.out.println(&quot;method:&quot;+method.getName()); </div><div class="line">        System.out.println(&quot;args:&quot;+args[0].getClass().getName());  </div><div class="line">        System.out.println(&quot;Before invoke method...&quot;); </div><div class="line">        Object object=method.invoke(concreteClass, args);//普通的Java反射代码,通过反射执行某个类的某方法 </div><div class="line"></div><div class="line">        System.out.println(&quot;After invoke method...&quot;); </div><div class="line">        return object; </div><div class="line">    &#125; </div><div class="line"> </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该类实现了Java反射包中的InvocationHandler接口。代理实例调用方法时，将对方法调用指派到它的代理处理器程序的invoke方法中。invoke方法内部实现预处理，对委托类方法调用，事后处理等逻辑。</p>
<h4 id="测试类"><a href="#测试类" class="headerlink" title="测试类"></a>测试类</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">public class DynamicProxyExample &#123; </div><div class="line">    public static void main(String[] args)&#123; </div><div class="line">        ConcreteClass c = new ConcreteClass();//元对象(被代理对象) </div><div class="line">        InvocationHandler ih = new ProxyHandler(c);//代理实例的调用处理程序。 </div><div class="line">        //创建一个实现业务接口的代理类,用于访问业务类(见代理模式)。 </div><div class="line">        //返回一个指定接口的代理类实例，该接口可以将方法调用指派到指定的调用处理程序，如ProxyHandler。 </div><div class="line">        TargetInterface targetInterface = (TargetInterface)Proxy.newProxyInstance(c.getClass().getClassLoader(),c.getClass().getInterfaces(),ih); </div><div class="line">        //调用代理类方法,Java执行InvocationHandler接口的方法. </div><div class="line">        int i = targetInterface.targetMethodA(5); </div><div class="line">        System.out.println(i); </div><div class="line">        System.out.println(); </div><div class="line">        int j = targetInterface.targetMethodB(15); </div><div class="line">        System.out.println(j); </div><div class="line">    &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先创建委托类对象，将其以构造函数传入代理处理器，代理处理器ProxyHandler中会以Java反射方式调用该委托类对应的方法。然后使用Java反射机制中的Proxy.newProxyInstance方式创建一个代理类实例，创建该实例需要指定该实例的类加载器，需要实现的接口(即目标接口)，以及处理代理实例接口调用的处理器。<br>最后，调用代理类目标接口方法时，会自动将其转发到代理处理器中的invoke方法内，invoke方法内部实现预处理，对委托类方法调用，事后处理等逻辑。</p>
<h2 id="CGlib（Code-Generation-Library）动态代理"><a href="#CGlib（Code-Generation-Library）动态代理" class="headerlink" title="CGlib（Code Generation Library）动态代理"></a>CGlib（Code Generation Library）动态代理</h2><p>CGLIB（Code Generation Library），是一个强大的，高性能，高质量的Code生成类库，它可以在运行期扩展Java类与实现Java接口。</p>
<p>JDK中提供的生成动态代理类的机制有个鲜明的特点是： <strong>某个类必须有实现的接口，而生成的代理类也只能代理某个类接口定义的方法</strong><br>如果某个类没有实现接口，那么这个类就不能同JDK产生动态代理了！<br>此时，cglib可以通过继承的方式实现动态代理。</p>
<p>使用CGLib实现动态代理，完全不受代理类必须实现接口的限制，而且CGLib底层采用ASM字节码生成框架，使用字节码技术生成代理类，比使用Java反射效率要高。唯一需要注意的是，CGLib不能对声明为final的方法进行代理，因为CGLib原理是动态生成被代理类的子类。</p>
<p>cglib 创建某个类A的动态代理类的模式是：</p>
<ol>
<li>查找A上的所有非final 的public类型的方法定义；</li>
<li>将这些方法的定义转换成字节码；</li>
<li>将组成的字节码转换成相应的代理的class对象；</li>
<li>实现 MethodInterceptor接口，用来处理 对代理类上所有方法的请求（这个接口和JDK动态代理InvocationHandler的功能和角色是一样的）</li>
</ol>
<h4 id="实例-1"><a href="#实例-1" class="headerlink" title="实例"></a>实例</h4><h5 id="被代理类-首先，定义一个类，该类没有实现任何接口。"><a href="#被代理类-首先，定义一个类，该类没有实现任何接口。" class="headerlink" title="被代理类:首先，定义一个类，该类没有实现任何接口。"></a>被代理类:首先，定义一个类，该类没有实现任何接口。</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public class ConcreteClassNoInterface &#123; </div><div class="line">    public String getConcreteMethodA(String str)&#123; </div><div class="line">        System.out.println(&quot;ConcreteMethod A ... &quot;+str); </div><div class="line">        return str; </div><div class="line">    &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="拦截器：定义一个拦截器。在调用目标方法时，CGLib会回调MethodInterceptor接口方法拦截，来实现你自己的代理逻辑，类似于JDK中的InvocationHandler接口。"><a href="#拦截器：定义一个拦截器。在调用目标方法时，CGLib会回调MethodInterceptor接口方法拦截，来实现你自己的代理逻辑，类似于JDK中的InvocationHandler接口。" class="headerlink" title="拦截器：定义一个拦截器。在调用目标方法时，CGLib会回调MethodInterceptor接口方法拦截，来实现你自己的代理逻辑，类似于JDK中的InvocationHandler接口。"></a>拦截器：定义一个拦截器。在调用目标方法时，CGLib会回调MethodInterceptor接口方法拦截，来实现你自己的代理逻辑，类似于JDK中的InvocationHandler接口。</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public class ConcreteClassInterceptor implements MethodInterceptor&#123; </div><div class="line">    public Object intercept(Object obj, Method method, Object[] arg, MethodProxy proxy) throws Throwable &#123; </div><div class="line">        System.out.println(&quot;Before:&quot;+method); </div><div class="line">        Object object=proxy.invokeSuper(obj, arg); </div><div class="line">        System.out.println(&quot;After:&quot;+method); </div><div class="line">        return object; </div><div class="line">    &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>参数：  </p>
<ul>
<li>Object为由CGLib动态生成的代理类实例</li>
<li>Method为上文中实体类所调用的被代理的方法引用</li>
<li>Object[]为参数值列表，MethodProxy为生成的代理类对方法的代理引用。</li>
<li>proxy.invokeSuper(obj,arg)：调用代理类实例上的proxy方法的父类方法（即实体类ConcreteClassNoInterface中对应的方法）</li>
<li>返回：从代理实例的方法调用返回的值。</li>
</ul>
<h5 id="生成动态代理类"><a href="#生成动态代理类" class="headerlink" title="生成动态代理类"></a>生成动态代理类</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Enhancer enhancer=new Enhancer(); </div><div class="line">enhancer.setSuperclass(ConcreteClassNoInterface.class); </div><div class="line">enhancer.setCallback(new ConcreteClassInterceptor()); </div><div class="line">ConcreteClassNoInterface ccni = (ConcreteClassNoInterface)enhancer.create();</div></pre></td></tr></table></figure>
<p>这里Enhancer类是CGLib中的一个字节码增强器，它可以方便的对你想要处理的类进行扩展。<br>首先将被代理类ConcreteClassNoInterface设置成父类，然后设置拦截器ConcreteClassInterceptor，最后执行enhancer.create()动态生成一个代理类，并从Object强制转型成父类型ConcreteClassNoInterface。<br>最后，在代理类上调用方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ccni.getConcreteMethodA(&quot;haha&quot;);</div></pre></td></tr></table></figure></p>
<p>调用getConcreteMethodA()是在拦截器中的intercept方法中调用的，在调用前后，进行了一些逻辑处理，这里只是简单的打印了一些语句</p>
<p>　　</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://clq2owesome.github.io/2017/08/16/Java/基础/java动态代理/" data-id="cjei8ydg2003z7oblbztj16cm" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Spring/Security/配置一：配置文件" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/15/Spring/Security/配置一：配置文件/" class="article-date">
  <time datetime="2017-08-15T02:09:45.000Z" itemprop="datePublished">2017-08-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>►<a class="article-category-link" href="/categories/Spring/Security/">Security</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/15/Spring/Security/配置一：配置文件/">配置一：配置文件</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="配置文件（applicationContext-security-xml）"><a href="#配置文件（applicationContext-security-xml）" class="headerlink" title="配置文件（applicationContext-security.xml）"></a>配置文件（applicationContext-security.xml）</h2><p>首先我们为Spring Security专门建立一个Spring的配置文件，该文件就专门用来作为Spring Security的配置。使用Spring Security我们需要引入Spring Security的NameSpace。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">	<span class="attr">xmlns:security</span>=<span class="string">"http://www.springframework.org/schema/security"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></div><div class="line">	http://www.springframework.org/schema/beans/spring-beans-4.1.xsd</div><div class="line">	http://www.springframework.org/schema/jdbc</div><div class="line">	http://www.springframework.org/schema/jdbc/spring-jdbc-4.1.xsd</div><div class="line">	http://www.springframework.org/schema/security</div><div class="line">	http://www.springframework.org/schema/security/spring-security-4.0.xsd"&gt;</div></pre></td></tr></table></figure></p>
<p>Spring Security命名空间的引入可以简化我们的开发，它涵盖了大部分Spring Security常用的功能。它的设计是基于框架内大范围的依赖的，可以被划分为以下几块。</p>
<ul>
<li>Web/Http 安全：这是最复杂的部分。通过建立filter和相关的service bean来实现框架的认证机制。当访问受保护的URL时会将用户引入登录界面或者是错误提示界面。</li>
<li>业务对象或者方法的安全：控制方法访问权限的。</li>
<li>AuthenticationManager：处理来自于框架其他部分的认证请求。</li>
<li>AccessDecisionManager：为Web或方法的安全提供访问决策。会注册一个默认的，但是我们也可以通过普通bean注册的方式使用自定义的AccessDecisionManager。</li>
<li>AuthenticationProvider：AuthenticationManager是通过它来认证用户的。</li>
<li>UserDetailsService：跟AuthenticationProvider关系密切，用来获取用户信息的。</li>
</ul>
<p>引入了Spring Security的NameSpace之后我们就可以使用该命名空间下的元素来配置Spring Security了。首先我们来定义一个http元素，security只是我们使用命名空间的一个前缀。http元素是用于定义Web相关权限控制的。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:http</span> <span class="attr">auto-config</span>=<span class="string">"true"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">"/**"</span> <span class="attr">access</span>=<span class="string">"ROLE_USER"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">security:http</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>如上定义中，intercept-url定义了一个权限控制的规则。pattern属性表示我们将对哪些url进行权限控制，其也可以是一个正则表达式，如上的写法表示我们将对所有的URL进行权限控制；access属性表示在请求对应的URL时需要什么权限，默认配置时它应该是一个以逗号分隔的角色列表，请求的用户只需拥有其中的一个角色就能成功访问对应的URL。这里的“ROLE_USER”表示请求的用户应当具有ROLE<em>USER角色。“ROLE</em>”前缀是一个提示Spring使用基于角色的检查的标记。<br> 有了权限控制的规则了后，接下来我们需要定义一个AuthenticationManager用于认证。我们先来看如下定义：<br> <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"> <span class="tag">&lt;<span class="name">security:authentication-manager</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">security:authentication-provider</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">security:user-service</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">security:user</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">password</span>=<span class="string">"user"</span> <span class="attr">authorities</span>=<span class="string">"ROLE_USER"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">security:user</span> <span class="attr">name</span>=<span class="string">"admin"</span> <span class="attr">password</span>=<span class="string">"admin"</span> <span class="attr">authorities</span>=<span class="string">"ROLE_USER, ROLE_ADMIN"</span>/&gt;</span></div><div class="line">         <span class="tag">&lt;/<span class="name">security:user-service</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">security:authentication-provider</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">security:authentication-manager</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>  authentication-manager元素指定了一个AuthenticationManager，其需要一个AuthenticationProvider（对应authentication-provider元素）来进行真正的认证，默认情况下authentication-provider对应一个DaoAuthenticationProvider，其需要UserDetailsService（对应user-service元素）来获取用户信息UserDetails（对应user元素）。这里我们只是简单的使用user元素来定义用户，而实际应用中这些信息通常都是需要从数据库等地方获取的，这个将放到后续再讲。我们可以看到通过user元素我们可以指定user对应的用户名、密码和拥有的权限。user-service还支持通过properties文件来指定用户信息，如：<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;security:user-service properties=&quot;/WEB-INF/config/users.properties&quot;/&gt;</div><div class="line">其中属性文件应遵循如下格式：</div><div class="line">username=password,grantedAuthority[,grantedAuthority][,enabled|disabled]</div><div class="line">所以，对应上面的配置文件，我们的users.properties文件的内容应该如下所示：</div><div class="line">#username=password,grantedAuthority[,grantedAuthority][,enabled|disabled]</div><div class="line">user=user,ROLE_USER</div><div class="line">admin=admin,ROLE_USER,ROLE_ADMIN</div></pre></td></tr></table></figure></p>
<h2 id="在web-xml中的配置"><a href="#在web-xml中的配置" class="headerlink" title="在web.xml中的配置"></a>在web.xml中的配置</h2><p>  之后我们告诉Spring加载这个配置文件。通常，我们可以在web.xml文件中通过context-param把它指定为Spring的初始配置文件，也可以在对应Spring的初始配置文件中引入它。这里我们采用前者。<br>  <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>/WEB-INF/config/applicationContext.xml,/WEB-INF/config/spring-security.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></div><div class="line"></div><div class="line"> <span class="tag">&lt;<span class="name">listener</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>  Spring的配置文件是通过对应的ContextLoaderListener来加载和初始化的，上述代码中的applicationContext.xml文件就是对应的Spring的配置文件，如果没有可以不用配置。接下来我们还需要在web.xml中定义一个filter用来拦截需要交给Spring Security处理的请求，需要注意的是该filter一定要定义在其它如SpringMVC等拦截请求之前。这里我们将拦截所有的请求，具体做法如下所示：<br>  <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>springSecurityFilterChain<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>springSecurityFilterChain<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>接下来可以启动我们的应用，然后在浏览器中访问我们的主页。你会看到如下页面。<br><img src="http://dl2.iteye.com/upload/attachment/0103/0351/ad5156ab-b922-3fd0-af21-12b7c01e717f.png" alt="image"><br>因为我们的spring-security.xml文件中配置好了所有的请求都需要“ROLE_USER”权限，所以当我们在请求主页的时候，Spring Security发现我们还没有登录，Spring会引导我们到登录界面。使用正确的用户名和密码（如上面配置的user/user或admin/admin）登录后，如果符合对应的权限我们就可以访问主页了，否则将出现403（禁止访问）界面。<br>可能你会奇怪，我们没有建立上面的登录页面，为什么Spring Security会跳到上面的登录页面呢？  这是我们设置http的auto-config=”true”时Spring Security自动为我们生成的。<br>当指定http元素的auto-config=”true”时，就相当于如下内容的简写。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:http</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:form-login</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:http-basic</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:logout</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">security:http</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这些元素负责建立表单登录、基本的认证和登出处理。它们都可以通过指定对应的属性来改变它们的行为。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://clq2owesome.github.io/2017/08/15/Spring/Security/配置一：配置文件/" data-id="cjei8ydi2008u7obladyd6pch" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Spring/Security/配置十：退出登录" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/15/Spring/Security/配置十：退出登录/" class="article-date">
  <time datetime="2017-08-15T02:09:45.000Z" itemprop="datePublished">2017-08-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>►<a class="article-category-link" href="/categories/Spring/Security/">Security</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/15/Spring/Security/配置十：退出登录/">配置十：退出登录</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&emsp;&emsp;要实现退出登录的功能我们需要在http元素下定义logout元素，这样Spring Security将自动为我们添加用于处理退出登录的过滤器LogoutFilter到FilterChain。当我们指定了http元素的auto-config属性为true时logout定义是会自动配置的，此时我们默认退出登录的URL为“/j_spring_security_logout”，可以通过logout元素的logout-url属性来改变退出登录的默认地址。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:logout</span> <span class="attr">logout-url</span>=<span class="string">"/logout.do"</span>/&gt;</span></div></pre></td></tr></table></figure>
<p>此外，我们还可以给logout指定如下属性：</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>invalidate-session</td>
<td>表示是否要在退出登录后让当前session失效，默认为true。</td>
</tr>
<tr>
<td>delete-cookies</td>
<td>指定退出登录后需要删除的cookie名称，多个cookie之间以逗号分隔。</td>
</tr>
<tr>
<td>logout-success-url</td>
<td>指定成功退出登录后要重定向的URL。需要注意的是对应的URL应当是不需要登录就可以访问的。</td>
</tr>
<tr>
<td>success-handler-ref</td>
<td>指定用来处理成功退出登录的LogoutSuccessHandler的引用。</td>
</tr>
</tbody>
</table>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://clq2owesome.github.io/2017/08/15/Spring/Security/配置十：退出登录/" data-id="cjei8ydiy00a37oblybi0102j" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Spring/Security/配置四：认证过程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/15/Spring/Security/配置四：认证过程/" class="article-date">
  <time datetime="2017-08-15T02:09:45.000Z" itemprop="datePublished">2017-08-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>►<a class="article-category-link" href="/categories/Spring/Security/">Security</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/15/Spring/Security/配置四：认证过程/">配置四：认证过程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="认证过程"><a href="#认证过程" class="headerlink" title="认证过程"></a>认证过程</h2><ol>
<li>用户使用用户名和密码进行登录。</li>
<li>Spring Security将获取到的用户名和密码封装成一个实现了Authentication接口的UsernamePasswordAuthenticationToken。</li>
<li>将上述产生的token对象传递给AuthenticationManager进行登录认证。</li>
<li>AuthenticationManager认证成功后将会返回一个封装了用户权限等信息的Authentication对象。</li>
<li>通过调用SecurityContextHolder.getContext().setAuthentication(…)将AuthenticationManager返回的Authentication对象赋予给当前的SecurityContext。</li>
</ol>
<p>&emsp;&emsp;上述介绍的就是Spring Security的认证过程。在认证成功后，用户就可以继续操作去访问其它受保护的资源了，但是在访问的时候将会使用保存在SecurityContext中的Authentication对象进行相关的权限鉴定。</p>
<h2 id="Web应用的认证过程"><a href="#Web应用的认证过程" class="headerlink" title="Web应用的认证过程"></a>Web应用的认证过程</h2><p>&emsp;&emsp;如果用户直接访问登录页面，那么认证过程跟上节描述的基本一致，只是在认证完成后将跳转到指定的成功页面，默认是应用的根路径。如果用户直接访问一个受保护的资源，那么认证过程将如下：  </p>
<ol>
<li>引导用户进行登录，通常是重定向到一个基于form表单进行登录的页面，具体视配置而定。</li>
<li>用户输入用户名和密码后请求认证，后台还是会像上节描述的那样获取用户名和密码封装成一个UsernamePasswordAuthenticationToken对象，然后把它传递给AuthenticationManager进行认证。</li>
<li>如果认证失败将继续执行步骤1，如果认证成功则会保存返回的Authentication到SecurityContext，然后默认会将用户重定向到之前访问的页面。</li>
<li>用户登录认证成功后再次访问之前受保护的资源时就会对用户进行权限鉴定，如不存在对应的访问权限，则会返回403错误码。  </li>
</ol>
<p>&emsp;&emsp;在上述步骤中将有很多不同的类参与，但其中主要的参与者是ExceptionTranslationFilter。</p>
<h2 id="ExceptionTranslationFilter"><a href="#ExceptionTranslationFilter" class="headerlink" title="ExceptionTranslationFilter"></a>ExceptionTranslationFilter</h2><p>&emsp;&emsp;ExceptionTranslationFilter是用来处理来自AbstractSecurityInterceptor抛出的AuthenticationException和AccessDeniedException的。AbstractSecurityInterceptor是Spring Security用于拦截请求进行权限鉴定的，其拥有两个具体的子类，拦截方法调用的MethodSecurityInterceptor和拦截URL请求的FilterSecurityInterceptor。当ExceptionTranslationFilter捕获到的是AuthenticationException时将调用AuthenticationEntryPoint引导用户进行登录；如果捕获的是AccessDeniedException，但是用户还没有通过认证，则调用AuthenticationEntryPoint引导用户进行登录认证，否则将返回一个表示不存在对应权限的403错误码。</p>
<h2 id="在request之间共享SecurityContext"><a href="#在request之间共享SecurityContext" class="headerlink" title="在request之间共享SecurityContext"></a>在request之间共享SecurityContext</h2><p>&emsp;&emsp;可能你早就有这么一个疑问了，既然SecurityContext是存放在ThreadLocal中的，而且在每次权限鉴定的时候都是从ThreadLocal中获取SecurityContext中对应的Authentication所拥有的权限，并且不同的request是不同的线程，为什么每次都可以从ThreadLocal中获取到当前用户对应的SecurityContext呢？在Web应用中这是通过SecurityContextPersistentFilter实现的，默认情况下其会在每次请求开始的时候从session中获取SecurityContext，然后把它设置给SecurityContextHolder，在请求结束后又会将SecurityContextHolder所持有的SecurityContext保存在session中，并且清除SecurityContextHolder所持有的SecurityContext。这样当我们第一次访问系统的时候，SecurityContextHolder所持有的SecurityContext肯定是空的，待我们登录成功后，SecurityContextHolder所持有的SecurityContext就不是空的了，且包含有认证成功的Authentication对象，待请求结束后我们就会将SecurityContext存在session中，等到下次请求的时候就可以从session中获取到该SecurityContext并把它赋予给SecurityContextHolder了，由于SecurityContextHolder已经持有认证过的Authentication对象了，所以下次访问的时候也就不再需要进行登录认证了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://clq2owesome.github.io/2017/08/15/Spring/Security/配置四：认证过程/" data-id="cjei8ydiz00a67obl213dro8i" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Java/基础/java异常" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/15/Java/基础/java异常/" class="article-date">
  <time datetime="2017-08-15T02:09:45.000Z" itemprop="datePublished">2017-08-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java/">Java</a>►<a class="article-category-link" href="/categories/Java/基础/">基础</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/15/Java/基础/java异常/">java异常</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>　　异常分类</p>
<p><img src="http://diycode.b0.upaiyun.com/photo/2016/ecb86e28e5df3a76a107f50d989f6123.png" alt="image"></p>
<h4 id="Throwable"><a href="#Throwable" class="headerlink" title="Throwable"></a>Throwable</h4><p>Throwable 类是 Java 语言中所有错误或异常的超类。只有当对象是此类（或其子类之一）的实例时，才能通过 Java 虚拟机或者 Java throw 语句抛出。类似地，只有此类或其子类之一才可以是 catch 子句中的参数类型。</p>
<h4 id="Error（错误）"><a href="#Error（错误）" class="headerlink" title="Error（错误）"></a>Error（错误）</h4><p>表示程序无法处理的错误，一般与程序员的执行操作无关。理论上这些错误是不允许发生的，如果发生，也不应该试图通过程序去处理，所以Error不是try-catch的处理对象，而JVM一般的处理方式是终止发生错误的线程。</p>
<h4 id="Exception（异常）"><a href="#Exception（异常）" class="headerlink" title="Exception（异常）"></a>Exception（异常）</h4><p>Java的异常分为两种</p>
<ul>
<li>checked Exception:检查型异常 或者 编译时异常，也叫非运行时异常</li>
<li>unchecked Exception, RuntimeException：不检查异常，也叫运行时异常</li>
</ul>
<p>运行时异常都是RuntimeException类及其子类异常，如NullPointerException、IndexOutOfBoundsException等，这些异常是不检查异常，程序中可以选择捕获处理，也可以不处理。这些异常一般是由程序逻辑错误引起的，程序应该从逻辑角度尽可能避免这类异常的发生。</p>
<p>非运行时异常是RuntimeException以外的异常，类型上都属于Exception类及其子类。从程序语法角度讲是必须进行处理的异常，如果不处理，程序就不能编译通过。如IOException、SQLException等以及用户自定义的Exception异常，一般情况下不自定义检查异常。</p>
<p>java认为checked异常都是可以再编译阶段被处理的异常，所以它强制程序处理所有的checked异常，而Runtime异常无须处理，java程序必须显式处理checked异常，如果程序没有处理，则在编译时会发生错误，无法通过编译。</p>
<p>Java异常机制主要依赖于try、catch、finally、throw、throws五个关键字。</p>
<ol>
<li><p><code>try</code>：它里面放置可能引发异常的代码</p>
</li>
<li><p><code>catch</code>：后面对应异常类型和一个代码块，用于表明该catch块用于处理这种类型的代码块，可以有多个catch块。</p>
</li>
<li><p><code>finally</code>：主要用于回收在try块里打开的物力资源（如数据库连接、网络连接和磁盘文件），异常机制总是保证finally块总是被执行。</p>
</li>
</ol>
<p>finally的作用：</p>
<ul>
<li>无论try所指定的程序块中是否抛出异常，也无论catch语句的异常类型是否与所抛弃的异常的类型一致，finally中的代码一定会得到执行</li>
<li>finally语句为异常处理提供一个统一的出口，使得在控制流程转到程序的其他部分以前，能够对程序的状态作统一的管理</li>
<li>通常再finally语句中可以进行资源的清楚工作，如关闭打开的文件，删除临时文件等</li>
</ul>
<p>当在try块或catch块中遇到return语句时，finally语句块将在方法返回之前被执行。<br>在以下4种特殊情况下，finally块不会被执行：<br>1）在finally语句块中抛出了异常且未处理。<br>2）在前面的代码中用了System.exit()退出程序。<br>3）程序所在的线程死亡。<br>4）CPU出现异常被关闭。  </p>
<ol>
<li><p><code>throw</code>：用于抛出一个实际的异常，可以单独作为语句使用，抛出一个具体的异常对象。</p>
</li>
<li><p><code>throws</code>：用在方法头部中，用于声明该方法可能抛出的异常。</p>
</li>
</ol>
<h5 id="异常执行步骤"><a href="#异常执行步骤" class="headerlink" title="异常执行步骤"></a>异常执行步骤</h5><ol>
<li><p>如果执行try块中的业务逻辑代码时出现异常，系统自动生成一个异常对象，该异常对象被提交给java运行环境，这个过程称为<strong>抛出（throw）异常</strong>。</p>
</li>
<li><p>当java运行环境收到异常对象时，会寻找能处理该异常对象的catch块，如果找到合适的cathc块并把该异常对象交给catch块处理，那这个过程称为<strong>捕获（catch）异常</strong>；如果java运行时环境找不到捕获异常的catch块，则运行时环境终止，jav程序也将退出。</p>
</li>
</ol>
<h5 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h5><ol>
<li><p>不管程序代码块是否处于try块中，甚至包括catch块中代码，只要执行该代码时出现了异常，系统都会自动生成一个异常对象，如果程序没有为这段代码定义任何catch块，java运行环境肯定找不到处理该异常的catch块，程序肯定在此退出。</p>
</li>
<li><p>try块后可以有多个catch块，try块后使用多个catch块是为了针对不同异常类提供的不同的异常处理方式。当系统发生不同意外情况时，系统会生成不同的异常对象，java运行时就会根据该异常对象所属的异常类来决定使用哪个catch块来处理该异常。</p>
</li>
<li><p>通常情况下，如果try块被执行一次，则try块后只有一个catch块会被执行，绝不可能有多个catch块被执行，除非在循环中使用类continue开始下一次循环，下一次循环又重新运行了try块，这才可能导致多个catch块被执行。</p>
</li>
<li><p>异常捕获顺序是从上到下的，所以一般将异常范围小放在前面，进行异常捕获时，一定要记住先捕获小的异常，再捕获大的异常。</p>
</li>
<li><p>只有try块石必须的，也就是说如果没有try块，则不可能有后面的catch块和finally块，catch块和finally块都是可选的，但catch块和finally块至少出现其中之一，也可以同时出现</p>
</li>
<li><p>使用throws声明抛出异常时有一个限制：就是方法重写时的“两小”中的一条规则：子类方法声明抛出的异常类型应该是父类方法声明抛出的异常类型的子类或或相等，子类方法中不允许比父类方法声明抛出更多异常。即如果子类抛出的异常是父类抛出的异常的父类，那么程序无法通过编译。</p>
</li>
</ol>
<h4 id="常见的运行时异常"><a href="#常见的运行时异常" class="headerlink" title="常见的运行时异常"></a>常见的运行时异常</h4><p>NullPointerException(空指针)，ArrayIndexOutOfBoundsException(数组下标越界),IndexOutOfBoundsException(索引越界异常),NumberFormatException(数字格式异常),IllegalArgumentException(方法参数错误)</p>
<h4 id="常见的非运行时异常"><a href="#常见的非运行时异常" class="headerlink" title="常见的非运行时异常"></a>常见的非运行时异常</h4><p>IOException(输入输出异常),SQLException(SQL异常)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://clq2owesome.github.io/2017/08/15/Java/基础/java异常/" data-id="cjei8ydg400447oblubmdxpeu" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Spring/Security/配置十四：权限鉴定基础" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/15/Spring/Security/配置十四：权限鉴定基础/" class="article-date">
  <time datetime="2017-08-15T02:09:45.000Z" itemprop="datePublished">2017-08-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>►<a class="article-category-link" href="/categories/Spring/Security/">Security</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/15/Spring/Security/配置十四：权限鉴定基础/">配置十四：权限鉴定基础</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&emsp;&emsp;Spring Security的权限鉴定是由AccessDecisionManager接口负责的。具体来说是由其中的decide()方法负责，其定义如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">decide</span><span class="params">(Authentication authentication, Object object, Collection&lt;ConfigAttribute&gt; configAttributes)</span></span></div><div class="line">        <span class="keyword">throws</span> AccessDeniedException, InsufficientAuthenticationException;</div></pre></td></tr></table></figure>
<p>&emsp;&emsp; 如你所见，该方法接收三个参数，第一个参数是包含当前用户信息的Authentication对象；第二个参数表示当前正在请求的受保护的对象，基本上来说是MethodInvocation（使用AOP）、JoinPoint（使用Aspectj）和FilterInvocation（Web请求）三种类型；第三个参数表示与当前正在访问的受保护对象的配置属性，如一个角色列表。</p>
<p>一. <strong>Spring Security的AOP Advice思想</strong><br>&emsp;&emsp;对于使用AOP而言，我们可以使用几种不同类型的advice：before、after、throws和around。其中around advice是非常实用的，通过它我们可以控制是否要执行方法、是否要修改方法的返回值，以及是否要抛出异常。Spring Security在对方法调用和Web请求时也是使用的around advice的思想。在方法调用时，可以使用标准的Spring AOP来达到around advice的效果，而在进行Web请求时是通过标准的Filter来达到around advice的效果。<br>&emsp;&emsp;对于大部分人而言都比较喜欢对Service层的方法调用进行权限控制，因为我们的主要业务逻辑都是在Service层进行实现的。如果你只是想保护Service层的方法，那么使用Spring AOP就可以了。如果你需要直接保护领域对象，那么你可以考虑使用Aspectj。<br>&emsp;&emsp;你可以选择使用Aspectj或Spring AOP对方法调用进行鉴权，或者选择使用Filter对Web请求进行鉴权。当然，你也可以选择使用这三种方式的任意组合进行鉴权。通常的做法是使用Filter对Web请求进行一个比较粗略的鉴权，辅以使用Spring AOP对Service层的方法进行较细粒度的鉴权。  </p>
<p>二. <strong>AbstractSecurityInterceptor</strong><br>&emsp;&emsp;AbstractSecurityInterceptor是一个实现了对受保护对象的访问进行拦截的抽象类，其中有几个比较重要的方法。beforeInvocation()方法实现了对访问受保护对象的权限校验，内部用到了AccessDecisionManager和AuthenticationManager；finallyInvocation()方法用于实现受保护对象请求完毕后的一些清理工作，主要是如果在beforeInvocation()中改变了SecurityContext，则在finallyInvocation()中需要将其恢复为原来的SecurityContext，该方法的调用应当包含在子类请求受保护资源时的finally语句块中；afterInvocation()方法实现了对返回结果的处理，在注入了AfterInvocationManager的情况下默认会调用其decide()方法。AbstractSecurityInterceptor只是提供了这几种方法，并且包含了默认实现，具体怎么调用将由子类负责。每一种受保护对象都拥有继承自AbstractSecurityInterceptor的拦截器类， MethodSecurityInterceptor将用于调用受保护的方法，而FilterSecurityInterceptor将用于受保护的Web请求。它们在处理受保护对象的请求时都具有一致的逻辑，具体的逻辑如下。</p>
<ol>
<li>先将正在请求调用的受保护对象传递给beforeInvocation()方法进行权限鉴定。</li>
<li>权限鉴定失败就直接抛出异常了。</li>
<li>鉴定成功将尝试调用受保护对象，调用完成后，不管是成功调用，还是抛出异常，都将执行finallyInvocation()。</li>
<li>如果在调用受保护对象后没有抛出异常，则调用afterInvocation()。</li>
</ol>
<p>以下是MethodSecurityInterceptor在进行方法调用的一段核心代码。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(MethodInvocation mi)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">    InterceptorStatusToken token = <span class="keyword">super</span>.beforeInvocation(mi);</div><div class="line"></div><div class="line">    Object result;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        result = mi.proceed();</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="keyword">super</span>.finallyInvocation(token);</div><div class="line">    &#125;</div><div class="line">    returnsuper.afterInvocation(token, result);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>三. <strong>ConfigAttribute</strong><br>&emsp;&emsp;AbstractSecurityInterceptor的beforeInvocation()方法内部在进行鉴权的时候使用的是注入的AccessDecisionManager的decide()方法进行的。如前所述，decide()方法是需要接收一个受保护对象对应的ConfigAttribute集合的。一个ConfigAttribute可能只是一个简单的角色名称，具体将视AccessDecisionManager的实现者而定。AbstractSecurityInterceptor将使用一个SecurityMetadataSource对象来获取与受保护对象关联的ConfigAttribute集合，具体SecurityMetadataSource将由子类实现提供。ConfigAttribute将通过注解的形式定义在受保护的方法上，或者通过access属性定义在受保护的URL上。例如我们常见的<code>&lt;intercept-url pattern=”/**” access=”ROLE_USER,ROLE_ADMIN”/&gt;</code>就表示将ConfigAttribute ROLE_USER和ROLE_ADMIN应用在所有的URL请求上。对于默认的AccessDecisionManager的实现，上述配置意味着用户所拥有的权限中只要拥有一个GrantedAuthority与这两个ConfigAttribute中的一个进行匹配则允许进行访问。当然，严格的来说ConfigAttribute只是一个简单的配置属性而已，具体的解释将由AccessDecisionManager来决定。  </p>
<p>四. <strong>RunAsManager</strong><br>&emsp;&emsp;在某些情况下你可能会想替换保存在SecurityContext中的Authentication。这可以通过RunAsManager来实现的。在AbstractSecurityInterceptor的beforeInvocation()方法体中，在AccessDecisionManager鉴权成功后，将通过RunAsManager在现有Authentication基础上构建一个新的Authentication，如果新的Authentication不为空则将产生一个新的SecurityContext，并把新产生的Authentication存放在其中。这样在请求受保护资源时从SecurityContext中获取到的Authentication就是新产生的Authentication。待请求完成后会在finallyInvocation()中将原来的SecurityContext重新设置给SecurityContextHolder。AbstractSecurityInterceptor默认持有的是一个对RunAsManager进行空实现的NullRunAsManager。此外，Spring Security对RunAsManager有一个还有一个非空实现类RunAsManagerImpl，其在构造新的Authentication时是这样的逻辑：如果受保护对象对应的ConfigAttribute中拥有以“RUN<em>AS</em>”开头的配置属性，则在该属性前加上“ROLE_”，然后再把它作为一个GrantedAuthority赋给将要创建的Authentication（如ConfigAttribute中拥有一个“RUN_AS_ADMIN”的属性，则将构建一个“ROLE_RUN_AS_ADMIN”的GrantedAuthority），最后再利用原Authentication的principal、权限等信息构建一个新的Authentication进行返回；如果不存在任何以“RUN<em>AS</em>”开头的ConfigAttribute，则直接返回null。RunAsManagerImpl构建新的Authentication的核心代码如下所示。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Authentication <span class="title">buildRunAs</span><span class="params">(Authentication authentication, Object object, Collection&lt;ConfigAttribute&gt; attributes)</span> </span>&#123;</div><div class="line">    List&lt;GrantedAuthority&gt; newAuthorities = <span class="keyword">new</span> ArrayList&lt;GrantedAuthority&gt;();</div><div class="line">    <span class="keyword">for</span> (ConfigAttribute attribute : attributes) &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.supports(attribute)) &#123;</div><div class="line">            GrantedAuthority extraAuthority = <span class="keyword">new</span> SimpleGrantedAuthority(getRolePrefix() + attribute.getAttribute());</div><div class="line">            newAuthorities.add(extraAuthority);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (newAuthorities.size() == <span class="number">0</span>) &#123;</div><div class="line">        returnnull;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// Add existing authorities</span></div><div class="line">    newAuthorities.addAll(authentication.getAuthorities());</div><div class="line">    <span class="function">returnnew <span class="title">RunAsUserToken</span><span class="params">(<span class="keyword">this</span>.key, authentication.getPrincipal()</span>, authentication.<span class="title">getCredentials</span><span class="params">()</span>,</span></div><div class="line">            newAuthorities, authentication.<span class="title">getClass</span><span class="params">()</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>五. <strong>AfterInvocationManager</strong><br>&emsp;&emsp;在请求受保护的对象完成以后，可以通过afterInvocation()方法对返回值进行修改。AbstractSecurityInterceptor把对返回值进行修改的控制权交给其所持有的AfterInvocationManager了。AfterInvocationManager可以选择对返回值进行修改、不修改或抛出异常（如：后置权限鉴定不通过）。<br>以下是Spring Security官方文档提供的一张关于AbstractSecurityInterceptor相关关系的图。<br><img src="http://dl2.iteye.com/upload/attachment/0108/6539/0d401d99-d518-3cd7-8090-1616c3262442.png" alt="image"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://clq2owesome.github.io/2017/08/15/Spring/Security/配置十四：权限鉴定基础/" data-id="cjei8ydix00a17oblydztrapz" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Spring/Security/配置十六：基于表达式的权限控制" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/15/Spring/Security/配置十六：基于表达式的权限控制/" class="article-date">
  <time datetime="2017-08-15T02:09:45.000Z" itemprop="datePublished">2017-08-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>►<a class="article-category-link" href="/categories/Spring/Security/">Security</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/15/Spring/Security/配置十六：基于表达式的权限控制/">配置十六：基于表达式的权限控制</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&emsp;&emsp;Spring Security允许我们在定义URL访问或方法访问所应有的权限时使用Spring EL表达式，在定义所需的访问权限时如果对应的表达式返回结果为true则表示拥有对应的权限，反之则无。Spring Security可用表达式对象的基类是SecurityExpressionRoot，其为我们提供了如下在使用Spring EL表达式对URL或方法进行权限控制时通用的内置表达式。</p>
<table>
<thead>
<tr>
<th>表达式</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>hasRole([role])</td>
<td>当前用户是否拥有指定角色。</td>
</tr>
<tr>
<td>hasAnyRole([role1,role2])</td>
<td>多个角色是一个以逗号进行分隔的字符串。如果当前用户拥有指定角色中的任意一个则返回true。</td>
</tr>
<tr>
<td>hasAuthority([auth])</td>
<td>等同于hasRole</td>
</tr>
<tr>
<td>hasAnyAuthority([auth1,auth2])</td>
<td>等同于hasAnyRole</td>
</tr>
<tr>
<td>Principle</td>
<td>代表当前用户的principle对象</td>
</tr>
<tr>
<td>authentication</td>
<td>直接从SecurityContext获取的当前Authentication对象</td>
</tr>
<tr>
<td>permitAll</td>
<td>总是返回true，表示允许所有的</td>
</tr>
<tr>
<td>denyAll</td>
<td>总是返回false，表示拒绝所有的</td>
</tr>
<tr>
<td>isAnonymous()</td>
<td>当前用户是否是一个匿名用户</td>
</tr>
<tr>
<td>isRememberMe()</td>
<td>表示当前用户是否是通过Remember-Me自动登录的</td>
</tr>
<tr>
<td>isAuthenticated()</td>
<td>表示当前用户是否已经登录认证成功了。</td>
</tr>
<tr>
<td>isFullyAuthenticated()</td>
<td>如果当前用户既不是一个匿名用户，同时又不是通过Remember-Me自动登录的，则返回true。</td>
</tr>
</tbody>
</table>
<p>一. <strong>通过表达式控制URL权限</strong><br>&emsp;&emsp;URL的访问权限是通过http元素下的intercept-url元素进行定义的，其access属性用来定义访问配置属性。默认情况下该属性值只能是以字符串进行分隔的字符串列表，且每一个元素都对应着一个角色，因为默认使用的是RoleVoter。通过设置http元素的use-expressions=”true”可以启用intercept-url元素的access属性对Spring EL表达式的支持，use-expressions的值默认为false。启用access属性对Spring EL表达式的支持后每个access属性值都应该是一个返回结果为boolean类型的表达式，当表达式返回结果为true时表示当前用户拥有访问权限。此外WebExpressionVoter将加入AccessDecisionManager的AccessDecisionVoter列表，所以如果不使用NameSpace时应当手动添加WebExpressionVoter到AccessDecisionVoter。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:http</span> <span class="attr">use-expressions</span>=<span class="string">"true"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">security:form-login</span>/&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">security:logout</span>/&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">"/**"</span> <span class="attr">access</span>=<span class="string">"hasRole('ROLE_USER')"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">security:http</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;在上述配置中我们定义了只有拥有ROLE_USER角色的用户才能访问系统。<br>&emsp;&emsp;使用表达式控制URL权限使用的表达式对象类是继承自SecurityExpressionRoot的WebSecurityExpressionRoot类。其相比基类而言新增了一个表达式hasIpAddress。hasIpAddress可用来限制只有指定IP或指定范围内的IP才可以访问。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:http</span> <span class="attr">use-expressions</span>=<span class="string">"true"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">security:form-login</span>/&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">security:logout</span>/&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">"/**"</span> <span class="attr">access</span>=<span class="string">"hasRole('ROLE_USER') and hasIpAddress('10.10.10.3')"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">security:http</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;在上面的配置中我们限制了只有IP为”10.10.10.3”，且拥有ROLE_USER角色的用户才能访问。hasIpAddress是通过Ip地址或子网掩码来进行匹配的。如果要设置10.10.10下所有的子网都可以使用，那么我们对应的hasIpAddress的参数应为“10.10.10.n/24”，其中n可以是合法IP内的任意值。具体规则可以参照hasIpAddress()表达式用于比较的IpAddressMatcher的matches方法源码。以下是IpAddressMatcher的源码。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.springframework.security.web.util;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> java.net.InetAddress;</div><div class="line"><span class="keyword">import</span> java.net.UnknownHostException;</div><div class="line"><span class="keyword">import</span> java.util.Arrays;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</div><div class="line"> </div><div class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</div><div class="line"> </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Matches a request based on IP Address or subnet mask matching against the remote address.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * Both IPv6 and IPv4 addresses are supported, but a matcher which is configured with an IPv4 address will</div><div class="line"> * never match a request which returns an IPv6 address, and vice-versa.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@author</span> Luke Taylor</div><div class="line"> * <span class="doctag">@since</span> 3.0.2</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">IpAddressMatcher</span> <span class="keyword">implements</span> <span class="title">RequestMatcher</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> nMaskBits;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InetAddress requiredAddress;</div><div class="line"> </div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Takes a specific IP address or a range specified using the</div><div class="line">     * IP/Netmask (e.g. 192.168.1.0/24 or 202.24.0.0/14).</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> ipAddress the address or range of addresses from which the request must come.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IpAddressMatcher</span><span class="params">(String ipAddress)</span> </span>&#123;</div><div class="line"> </div><div class="line">        <span class="keyword">if</span> (ipAddress.indexOf(<span class="string">'/'</span>) &gt; <span class="number">0</span>) &#123;</div><div class="line">            String[] addressAndMask = StringUtils.split(ipAddress, <span class="string">"/"</span>);</div><div class="line">            ipAddress = addressAndMask[<span class="number">0</span>];</div><div class="line">            nMaskBits = Integer.parseInt(addressAndMask[<span class="number">1</span>]);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            nMaskBits = -<span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">        requiredAddress = parseAddress(ipAddress);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> matches(request.getRemoteAddr());</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(String address)</span> </span>&#123;</div><div class="line">        InetAddress remoteAddress = parseAddress(address);</div><div class="line"> </div><div class="line">        <span class="keyword">if</span> (!requiredAddress.getClass().equals(remoteAddress.getClass())) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">        <span class="keyword">if</span> (nMaskBits &lt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> remoteAddress.equals(requiredAddress);</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">        <span class="keyword">byte</span>[] remAddr = remoteAddress.getAddress();</div><div class="line">        <span class="keyword">byte</span>[] reqAddr = requiredAddress.getAddress();</div><div class="line"> </div><div class="line">        <span class="keyword">int</span> oddBits = nMaskBits % <span class="number">8</span>;</div><div class="line">        <span class="keyword">int</span> nMaskBytes = nMaskBits/<span class="number">8</span> + (oddBits == <span class="number">0</span> ? <span class="number">0</span> : <span class="number">1</span>);</div><div class="line">        <span class="keyword">byte</span>[] mask = newbyte[nMaskBytes];</div><div class="line"> </div><div class="line">        Arrays.fill(mask, <span class="number">0</span>, oddBits == <span class="number">0</span> ? mask.length : mask.length - <span class="number">1</span>, (<span class="keyword">byte</span>)<span class="number">0xFF</span>);</div><div class="line"> </div><div class="line">        <span class="keyword">if</span> (oddBits != <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">int</span> finalByte = (<span class="number">1</span> &lt;&lt; oddBits) - <span class="number">1</span>;</div><div class="line">            finalByte &lt;&lt;= <span class="number">8</span>-oddBits;</div><div class="line">            mask[mask.length - <span class="number">1</span>] = (<span class="keyword">byte</span>) finalByte;</div><div class="line">        &#125;</div><div class="line"> </div><div class="line"> <span class="comment">//       System.out.println("Mask is " + new sun.misc.HexDumpEncoder().encode(mask));</span></div><div class="line"> </div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; mask.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> ((remAddr[i] &amp; mask[i]) != (reqAddr[i] &amp; mask[i])) &#123;</div><div class="line">                <span class="keyword">return</span> alse;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">private</span> InetAddress <span class="title">parseAddress</span><span class="params">(String address)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> InetAddress.getByName(address);</div><div class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</div><div class="line">            <span class="function">thrownew <span class="title">IllegalArgumentException</span><span class="params">(<span class="string">"Failed to parse address"</span> + address, e)</span></span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>二. <strong>通过表达式控制方法权限</strong><br>&emsp;&emsp;Spring Security中定义了四个支持使用表达式的注解，分别是@PreAuthorize、@PostAuthorize、@PreFilter和@PostFilter。其中前两者可以用来在方法调用前或者调用后进行权限检查，后两者可以用来对集合类型的参数或者返回值进行过滤。要使它们的定义能够对我们的方法的调用产生影响我们需要设置global-method-security元素的pre-post-annotations=”enabled”，默认为disabled。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:global-method-security</span> <span class="attr">pre-post-annotations</span>=<span class="string">"disabled"</span>/&gt;</span></div></pre></td></tr></table></figure></p>
<p>2.1 使用@PreAuthorize和@PostAuthorize进行访问控制<br>&emsp;&emsp;@PreAuthorize可以用来控制一个方法是否能够被调用。<br> <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"> <span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</div><div class="line"> </div><div class="line">   <span class="meta">@PreAuthorize</span>(<span class="string">"hasRole('ROLE_ADMIN')"</span>)</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addUser</span><span class="params">(User user)</span> </span>&#123;</div><div class="line">      System.out.println(<span class="string">"addUser................"</span> + user);</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">   <span class="meta">@PreAuthorize</span>(<span class="string">"hasRole('ROLE_USER') or hasRole('ROLE_ADMIN')"</span>)</div><div class="line">   <span class="function"><span class="keyword">public</span> User <span class="title">find</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">      System.out.println(<span class="string">"find user by id............."</span> + id);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;在上面的代码中我们定义了只有拥有角色ROLE_ADMIN的用户才能访问adduser()方法，而访问find()方法需要有ROLE_USER角色或ROLE_ADMIN角色。使用表达式时我们还可以在表达式中使用方法参数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</div><div class="line"> </div><div class="line">   <span class="comment">/**</span></div><div class="line">    * 限制只能查询Id小于10的用户</div><div class="line">    */</div><div class="line">   <span class="meta">@PreAuthorize</span>(<span class="string">"#id&lt;10"</span>)</div><div class="line">   <span class="function"><span class="keyword">public</span> User <span class="title">find</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">      System.out.println(<span class="string">"find user by id........."</span> + id);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">  </div><div class="line">   <span class="comment">/**</span></div><div class="line">    * 限制只能查询自己的信息</div><div class="line">    */</div><div class="line">   <span class="meta">@PreAuthorize</span>(<span class="string">"principal.username.equals(#username)"</span>)</div><div class="line">   <span class="function"><span class="keyword">public</span> User <span class="title">find</span><span class="params">(String username)</span> </span>&#123;</div><div class="line">      System.out.println(<span class="string">"find user by username......"</span> + username);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">   <span class="comment">/**</span></div><div class="line">    * 限制只能新增用户名称为abc的用户</div><div class="line">    */</div><div class="line">   <span class="meta">@PreAuthorize</span>(<span class="string">"#user.name.equals('abc')"</span>)</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(User user)</span> </span>&#123;</div><div class="line">      System.out.println(<span class="string">"addUser............"</span> + user);</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;在上面代码中我们定义了调用find(int id)方法时，只允许参数id小于10的调用；调用find(String username)时只允许username为当前用户的用户名；定义了调用add()方法时只有当参数user的name为abc时才可以调用。<br>&emsp;&emsp;有时候可能你会想在方法调用完之后进行权限检查，这种情况比较少，但是如果你有的话，Spring Security也为我们提供了支持，通过@PostAuthorize可以达到这一效果。使用@PostAuthorize时我们可以使用内置的表达式returnObject表示方法的返回值。我们来看下面这一段示例代码。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@PostAuthorize</span>(<span class="string">"returnObject.id%2==0"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> User <span class="title">find</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">  User user = <span class="keyword">new</span> User();</div><div class="line">  user.setId(id);</div><div class="line">  <span class="keyword">return</span> user;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;上面这一段代码表示将在方法find()调用完成后进行权限检查，如果返回值的id是偶数则表示校验通过，否则表示校验失败，将抛出AccessDeniedException。       需要注意的是@PostAuthorize是在方法调用完成后进行权限检查，它不能控制方法是否能被调用，只能在方法调用完成后检查权限决定是否要抛出AccessDeniedException。</p>
<p>2.2 使用@PreFilter和@PostFilter进行过滤<br>&emsp;&emsp;使用@PreFilter和@PostFilter可以对集合类型的参数或返回值进行过滤。使用@PreFilter和@PostFilter时，Spring Security将移除使对应表达式的结果为false的元素。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"> <span class="meta">@PostFilter</span>(<span class="string">"filterObject.id%2==0"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">findAll</span><span class="params">()</span> </span>&#123;</div><div class="line">  List&lt;User&gt; userList = <span class="keyword">new</span> ArrayList&lt;User&gt;();</div><div class="line">  User user;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++) &#123;</div><div class="line">     user = <span class="keyword">new</span> User();</div><div class="line">     user.setId(i);</div><div class="line">     userList.add(user);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> userList;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;上述代码表示将对返回结果中id不为偶数的user进行移除。filterObject是使用@PreFilter和@PostFilter时的一个内置表达式，表示集合中的当前对象。当@PreFilter标注的方法拥有多个集合类型的参数时，需要通过@PreFilter的filterTarget属性指定当前@PreFilter是针对哪个参数进行过滤的。如下面代码就通过filterTarget指定了当前@PreFilter是用来过滤参数ids的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@PreFilter(filterTarget=&quot;ids&quot;, value=&quot;filterObject%2==0&quot;)</div><div class="line">public void delete(List&lt;Integer&gt; ids, List&lt;String&gt; usernames) &#123;</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>2.3 使用hasPermission表达式<br>&emsp;&emsp;Spring Security为我们定义了hasPermission的两种使用方式，它们分别对应着PermissionEvaluator的两个不同的hasPermission()方法。Spring Security默认处理Web、方法的表达式处理器分别为DefaultWebSecurityExpressionHandler和DefaultMethodSecurityExpressionHandler，它们都继承自AbstractSecurityExpressionHandler，其所持有的PermissionEvaluator是DenyAllPermissionEvaluator，其对于所有的hasPermission表达式都将返回false。所以当我们要使用表达式hasPermission时，我们需要自已手动定义SecurityExpressionHandler对应的bean定义，然后指定其PermissionEvaluator为我们自己实现的PermissionEvaluator，然后通过global-method-security元素或http元素下的expression-handler元素指定使用的SecurityExpressionHandler为我们自己手动定义的那个bean。<br>&emsp;&emsp;接下来看一个自己实现PermissionEvaluator使用hasPermission()表达式的简单示例。<br>&emsp;&emsp;首先实现自己的PermissionEvaluator，如下所示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPermissionEvaluator</span> <span class="keyword">implements</span> <span class="title">PermissionEvaluator</span> </span>&#123;</div><div class="line"> </div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasPermission</span><span class="params">(Authentication authentication,</span></span></div><div class="line">         Object targetDomainObject, Object permission) &#123;</div><div class="line">      <span class="keyword">if</span> (<span class="string">"user"</span>.equals(targetDomainObject)) &#123;</div><div class="line">         <span class="keyword">return</span> <span class="keyword">this</span>.hasPermission(authentication, permission);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">   <span class="comment">/**</span></div><div class="line">    * 总是认为有权限</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasPermission</span><span class="params">(Authentication authentication,</span></span></div><div class="line">         Serializable targetId, String targetType, Object permission) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">  </div><div class="line">   <span class="comment">/**</span></div><div class="line">    * 简单的字符串比较，相同则认为有权限</div><div class="line">    */</div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasPermission</span><span class="params">(Authentication authentication, Object permission)</span> </span>&#123;</div><div class="line">      Collection&lt;? extends GrantedAuthority&gt; authorities = authentication.getAuthorities();</div><div class="line">      <span class="keyword">for</span> (GrantedAuthority authority : authorities) &#123;</div><div class="line">         <span class="keyword">if</span> (authority.getAuthority().equals(permission)) &#123;</div><div class="line">            returntrue;</div><div class="line">         &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;接下来在ApplicationContext中显示的配置一个将使用PermissionEvaluator的SecurityExpressionHandler实现类，然后指定其所使用的PermissionEvaluator为我们自己实现的那个。这里我们选择配置一个针对于方法调用使用的表达式处理器，DefaultMethodSecurityExpressionHandler，具体如下所示。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"expressionHandler"</span></span></div><div class="line">   <span class="attr">class</span>=<span class="string">"org.springframework.security.access.expression.method.DefaultMethodSecurityExpressionHandler"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"permissionEvaluator"</span> <span class="attr">ref</span>=<span class="string">"myPermissionEvaluator"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="comment">&lt;!-- 自定义的PermissionEvaluator实现 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"myPermissionEvaluator"</span> <span class="attr">class</span>=<span class="string">"com.xxx.MyPermissionEvaluator"</span>/&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;有了SecurityExpressionHandler之后，我们还要告诉Spring Security，在使用SecurityExpressionHandler时应该使用我们显示配置的那个，这样我们自定义的PermissionEvaluator才能起作用。因为我们上面定义的是针对于方法的SecurityExpressionHandler，所以我们要指定在进行方法权限控制时应该使用它来进行处理，同时注意设置pre-post-annotations=”true”以启用对支持使用表达式的@PreAuthorize等注解的支持。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:global-method-security</span></span></div><div class="line">      <span class="attr">pre-post-annotations</span>=<span class="string">"enabled"</span>&gt;</div><div class="line">      <span class="tag">&lt;<span class="name">security:expression-handler</span> <span class="attr">ref</span>=<span class="string">"expressionHandler"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">security:global-method-security</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;之后我们就可以在需要进行权限控制的方法上使用@PreAuthorize以及hasPermission()表达式进行权限控制了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</div><div class="line"> </div><div class="line">   <span class="comment">/**</span></div><div class="line">    * 将使用方法hasPermission(Authentication authentication,</div><div class="line">         Object targetDomainObject, Object permission)进行验证。</div><div class="line">    */</div><div class="line">   <span class="meta">@PreAuthorize</span>(<span class="string">"hasPermission('user', 'ROLE_USER')"</span>)</div><div class="line">   <span class="function"><span class="keyword">public</span> User <span class="title">find</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">  </div><div class="line">   <span class="comment">/**</span></div><div class="line">    * 将使用PermissionEvaluator的第二个方法，即hasPermission(Authentication authentication,</div><div class="line">         Serializable targetId, String targetType, Object permission)进行验证。</div><div class="line">    */</div><div class="line">   <span class="meta">@PreAuthorize</span>(<span class="string">"hasPermission('targetId','targetType','permission')"</span>)</div><div class="line">   <span class="function"><span class="keyword">public</span> User <span class="title">find</span><span class="params">(String username)</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">   <span class="meta">@PreAuthorize</span>(<span class="string">"hasPermission('user', 'ROLE_ADMIN')"</span>)</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(User user)</span> </span>&#123;</div><div class="line"> </div><div class="line">   &#125;</div><div class="line"> </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;在上面的配置中，find(int id)和add()方法将使用PermissionEvaluator中接收三个参数的hasPermission()方法进行验证，而find(String username)方法将使用四个参数的hasPermission()方法进行验证。因为hasPermission()表达式与PermissionEvaluator中hasPermission()方法的对应关系就是在hasPermission()表达式使用的参数基础上加上当前Authentication对象调用对应的hasPermission()方法进行验证。<br>&emsp;&emsp;其实Spring Security已经针对于ACL实现了一个AclPermissionEvaluator。关于ACL的内容将在后文进行介绍。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://clq2owesome.github.io/2017/08/15/Spring/Security/配置十六：基于表达式的权限控制/" data-id="cjei8ydiv009y7obl33hkjzot" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Spring/Security/实践运用整合" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/15/Spring/Security/实践运用整合/" class="article-date">
  <time datetime="2017-08-15T02:09:45.000Z" itemprop="datePublished">2017-08-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>►<a class="article-category-link" href="/categories/Spring/Security/">Security</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/15/Spring/Security/实践运用整合/">实践运用整合</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="添加相应的jar包"><a href="#添加相应的jar包" class="headerlink" title="添加相应的jar包"></a>添加相应的jar包</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&lt;!-- spring security start  --&gt;</div><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-security-config&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;4.0.3.RELEASE&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div><div class="line">    &lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-security-core&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;4.0.3.RELEASE&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-security-web&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;4.0.3.RELEASE&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div><div class="line">&lt;!-- spring security end  --&gt;</div></pre></td></tr></table></figure>
<h2 id="web-xml中添加相应过滤器"><a href="#web-xml中添加相应过滤器" class="headerlink" title="web.xml中添加相应过滤器"></a>web.xml中添加相应过滤器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;!-- Spring security过滤器，需要注意的是该filter一定要定义在其它如SpringMVC等拦截请求之前 --&gt;</div><div class="line">&lt;!-- Spring security start --&gt;</div><div class="line">&lt;filter&gt;</div><div class="line">	&lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;</div><div class="line">	&lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;/filter-class&gt;</div><div class="line">&lt;/filter&gt;</div><div class="line">&lt;filter-mapping&gt;</div><div class="line">	&lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;</div><div class="line">	&lt;url-pattern&gt;/*&lt;/url-pattern&gt;</div><div class="line">&lt;/filter-mapping&gt;</div><div class="line">&lt;!-- Spring security end  --&gt;</div></pre></td></tr></table></figure>
<p><strong>注意</strong>：filter-name一定要写成springSecurityFilterChain。在DelegatingFilterProxy类init时，会获取filter-name，然后通过filter-name去spring中获取代理的bean</p>
<h2 id="applicationContext-security-xml配置"><a href="#applicationContext-security-xml配置" class="headerlink" title="applicationContext-security.xml配置"></a>applicationContext-security.xml配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div></pre></td><td class="code"><pre><div class="line">&lt;beans:beans xmlns=&quot;http://www.springframework.org/schema/security&quot;</div><div class="line">	xmlns:beans=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div class="line">	xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans</div><div class="line">	http://www.springframework.org/schema/beans/spring-beans-4.1.xsd</div><div class="line">	http://www.springframework.org/schema/jdbc</div><div class="line">	http://www.springframework.org/schema/jdbc/spring-jdbc-4.1.xsd</div><div class="line">	http://www.springframework.org/schema/security</div><div class="line">	http://www.springframework.org/schema/security/spring-security-4.0.xsd&quot;&gt;</div><div class="line"></div><div class="line">	&lt;!-- 启用注解  --&gt;</div><div class="line">	&lt;global-method-security secured-annotations=&quot;enabled&quot;</div><div class="line">		jsr250-annotations=&quot;enabled&quot; pre-post-annotations=&quot;enabled&quot; /&gt;</div><div class="line"></div><div class="line"></div><div class="line">        &lt;!-- 配置不需要权限验证页面和资源 --&gt;</div><div class="line">	&lt;http pattern=&quot;/admin/login.jsp&quot; security=&quot;none&quot;/&gt;&lt;!--登录页面  --&gt;</div><div class="line">	&lt;http pattern=&quot;/admin/xx/**&quot; security=&quot;none&quot;/&gt;&lt;!--静态资源 --&gt;</div><div class="line">	&lt;http pattern=&quot;/admin/none/**&quot; security=&quot;none&quot;/&gt;</div><div class="line">	</div><div class="line">	&lt;http use-expressions=&quot;true&quot; pattern=&quot;/admin/**&quot;  </div><div class="line">	  entry-point-ref=&quot;authenticationProcessingFilterEntryPoint&quot; </div><div class="line">	  authentication-manager-ref=&quot;adminAuthenticationManager&quot;&gt;  </div><div class="line">	               </div><div class="line">		&lt;!-- 是否关闭csrf，spring security4默认为开启  --&gt;</div><div class="line">		&lt;csrf disabled=&quot;true&quot; /&gt; </div><div class="line">		</div><div class="line">		&lt;!-- 设置可以在iframe显示数据  --&gt;</div><div class="line">		&lt;headers&gt;</div><div class="line">	        &lt;frame-options policy=&quot;SAMEORIGIN&quot;/&gt;</div><div class="line">	    &lt;/headers&gt;</div><div class="line">	    </div><div class="line">	    &lt;port-mappings&gt;</div><div class="line">		     &lt;port-mapping http=&quot;8080&quot; https=&quot;9988&quot;/&gt;</div><div class="line">		&lt;/port-mappings&gt;</div><div class="line">	</div><div class="line">		&lt;!--  权限校验 --&gt;</div><div class="line">		&lt;intercept-url pattern=&quot;/admin/index.jsp&quot; access=&quot;hasAuthority(&apos;admin:role&apos;) or hasAuthority(&apos;SUPER_ADMIN&apos;)&quot; /&gt;</div><div class="line">		&lt;intercept-url pattern=&quot;/admin/menu/**&quot; access=&quot;hasAuthority(&apos;admin:role&apos;) or hasAuthority(&apos;SUPER_ADMIN&apos;)&quot; /&gt;</div><div class="line">		&lt;intercept-url pattern=&quot;/admin/pattern/**&quot; access=&quot;hasAuthority(&apos;admin:role&apos;) or hasAuthority(&apos;SUPER_ADMIN&apos;)&quot; /&gt;</div><div class="line">		&lt;intercept-url pattern=&quot;/admin/odds/**&quot; access=&quot;hasAuthority(&apos;admin:role&apos;) or hasAuthority(&apos;SUPER_ADMIN&apos;)&quot; /&gt;</div><div class="line">		&lt;intercept-url pattern=&quot;/admin/period/**&quot; access=&quot;hasAuthority(&apos;admin:role&apos;) or hasAuthority(&apos;SUPER_ADMIN&apos;)&quot; /&gt;</div><div class="line">		&lt;intercept-url pattern=&quot;/admin/code/**&quot; access=&quot;hasAuthority(&apos;admin:role&apos;) or hasAuthority(&apos;SUPER_ADMIN&apos;)&quot; /&gt;</div><div class="line">		&lt;intercept-url pattern=&quot;/admin/code/collection/**&quot; access=&quot;hasAuthority(&apos;admin:role&apos;) or hasAuthority(&apos;SUPER_ADMIN&apos;)&quot; /&gt;</div><div class="line">		&lt;intercept-url pattern=&quot;/admin/member/**&quot; access=&quot;hasAuthority(&apos;admin:role&apos;) or hasAuthority(&apos;SUPER_ADMIN&apos;)&quot; /&gt;</div><div class="line">		&lt;intercept-url pattern=&quot;/admin/statistics/**&quot; access=&quot;hasAuthority(&apos;admin:role&apos;) or hasAuthority(&apos;SUPER_ADMIN&apos;)&quot; /&gt;</div><div class="line">		&lt;intercept-url pattern=&quot;/admin/order/**&quot; access=&quot;hasAuthority(&apos;admin:role&apos;) or hasAuthority(&apos;SUPER_ADMIN&apos;)&quot; /&gt;</div><div class="line">	</div><div class="line">          </div><div class="line">                &lt;form-login login-page=&quot;/admin/login.jsp&quot;</div><div class="line">    	      	username-parameter=&quot;account&quot; password-parameter=&quot;pwd&quot; </div><div class="line">    	         login-processing-url=&quot;/admin/loginIn&quot; </div><div class="line">    	         authentication-success-handler-ref=&quot;authSuccess&quot;</div><div class="line">    	         authentication-failure-handler-ref=&quot;authFailure&quot;</div><div class="line">                /&gt;</div><div class="line">	       </div><div class="line">	       &lt;logout invalidate-session=&quot;true&quot; logout-url=&quot;/admin/loginOut&quot;</div><div class="line">			success-handler-ref=&quot;adminLogoutSuccessHandler&quot; delete-cookies=&quot;JSESSIONID&quot; /&gt;</div><div class="line">	       </div><div class="line">		      </div><div class="line">	      &lt;access-denied-handler ref=&quot;adminAccessDeniedHandler&quot; /&gt;</div><div class="line">		      </div><div class="line">		  &lt;!-- remember me功能 --&gt;</div><div class="line">    	  &lt;remember-me user-service-ref=&quot;adminDetailsService&quot; </div><div class="line">    			key=&quot;clq&quot; token-validity-seconds=&quot;18000&quot;</div><div class="line">    			remember-me-parameter=&quot;rememberMe&quot; token-repository-ref=&quot;adminTokenRepository&quot;/&gt;</div><div class="line">					</div><div class="line">		&lt;!-- 控制同时在线人数  --&gt;</div><div class="line">           &lt;session-management &gt;</div><div class="line">			&lt;concurrency-control max-sessions=&quot;1&quot; session-registry-ref=&quot;sessionRegistry&quot;</div><div class="line">			expired-url=&quot;/admin/none/session_expired.jsp&quot; /&gt; </div><div class="line">		&lt;/session-management&gt;</div><div class="line">			</div><div class="line">    &lt;/http&gt;  </div><div class="line">    </div><div class="line">    &lt;!-- 登录成功处理类 --&gt;</div><div class="line">    &lt;beans:bean id=&quot;authSuccess&quot; class=&quot;com.xx.security.admin.AuthenticationSuccessHandlerImpl&quot;&gt;&lt;/beans:bean&gt;</div><div class="line">    &lt;!--  登录失败处理类 --&gt;</div><div class="line">    &lt;beans:bean id=&quot;authFailure&quot; class=&quot;com.xx.security.admin.AuthenticationFailureHandlerImpl&quot;&gt;&lt;/beans:bean&gt;</div><div class="line">    &lt;!--  没有权限处理类 --&gt;</div><div class="line">    &lt;beans:bean id=&quot;adminAccessDeniedHandler&quot; class=&quot;com.xx.security.admin.AdminAccessDeniedHandler&quot;&gt;&lt;/beans:bean&gt;</div><div class="line">    &lt;!--  退出成功处理类 --&gt;</div><div class="line">    &lt;beans:bean id=&quot;adminLogoutSuccessHandler&quot; class=&quot;com.xx.security.admin.AdminLogoutSuccessHandler&quot;&gt;&lt;/beans:bean&gt;</div><div class="line">    </div><div class="line">    </div><div class="line">    &lt;authentication-manager id=&quot;adminAuthenticationManager&quot;&gt;  </div><div class="line">        &lt;authentication-provider ref=&quot;adminAuthenticationProvider&quot;&gt;  </div><div class="line">        &lt;/authentication-provider&gt;  </div><div class="line">    &lt;/authentication-manager&gt;</div><div class="line">    </div><div class="line">    &lt;beans:bean id=&quot;adminDetailsService&quot; class=&quot;com.xx.security.admin.AdminDetailsService&quot;&gt;&lt;/beans:bean&gt;</div><div class="line">    </div><div class="line">    &lt;beans:bean id=&quot;adminAuthenticationProvider&quot;  class=&quot;com.xx.security.admin.AdminAuthenticationProvider&quot;&gt;</div><div class="line">        &lt;beans:property name=&quot;userDetailsService&quot; ref=&quot;adminDetailsService&quot; /&gt;</div><div class="line">    &lt;/beans:bean&gt;  </div><div class="line">    </div><div class="line">    &lt;!-- AuthenticationEntryPoint，引导用户进行登录 --&gt;</div><div class="line">   &lt;beans:bean id=&quot;authenticationProcessingFilterEntryPoint&quot; class=&quot;org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint&quot;&gt;</div><div class="line">       &lt;beans:constructor-arg name=&quot;loginFormUrl&quot; value=&quot;/admin/login.jsp&quot;  /&gt;</div><div class="line">    &lt;/beans:bean&gt;</div><div class="line">    </div><div class="line">    &lt;beans:bean id=&quot;adminTokenRepository&quot;</div><div class="line">		class=&quot;com.xx.security.admin.AdminJdbcTokenRepositoryImpl&quot;&gt;</div><div class="line">		&lt;!-- 数据源 --&gt;</div><div class="line">		&lt;beans:property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;</div><div class="line">		&lt;!-- 是否在系统启动时创建持久化token的数据库表 --&gt;</div><div class="line">		&lt;beans:property name=&quot;createTableOnStartup&quot; value=&quot;false&quot; /&gt;</div><div class="line">	&lt;/beans:bean&gt;</div><div class="line">	</div><div class="line">  &lt;beans:bean id=&quot;sessionRegistry&quot; class=&quot;org.springframework.security.core.session.SessionRegistryImpl&quot; /&gt;</div><div class="line"></div><div class="line">&lt;/beans:beans&gt;</div></pre></td></tr></table></figure>
<h2 id="AdminDetails（权限实体"><a href="#AdminDetails（权限实体" class="headerlink" title="AdminDetails（权限实体)"></a>AdminDetails（权限实体)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">package com.xx.security.admin;</div><div class="line"></div><div class="line">import java.util.Collection;</div><div class="line">import org.springframework.security.core.GrantedAuthority;</div><div class="line">import org.springframework.security.core.userdetails.User;</div><div class="line"></div><div class="line">public class AdminDetails extends User &#123;</div><div class="line">	private static final long serialVersionUID = 1L;</div><div class="line">    </div><div class="line">	private Integer id;</div><div class="line">	private Byte enable;//是否可用：1:可用   -1:禁用</div><div class="line">	private Byte isSys;//是否是超级管理员：1:是  -1：否</div><div class="line"></div><div class="line">	public AdminDetails(String username, String password, boolean enabled, boolean accountNonExpired,</div><div class="line">			boolean credentialsNonExpired, boolean accountNonLocked, Collection&lt;? extends GrantedAuthority&gt; authorities,</div><div class="line">			Byte enable, Byte isSys, Integer id) &#123;</div><div class="line">		super(username, password, enabled, accountNonExpired, credentialsNonExpired, accountNonLocked, authorities);</div><div class="line"></div><div class="line">		this.id = id;</div><div class="line">		this.enable = enable;</div><div class="line">		this.isSys = isSys;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public AdminDetails(String username, String password, Collection&lt;? extends GrantedAuthority&gt; authorities,</div><div class="line">			Byte enable, Byte isSys, Integer id) &#123;</div><div class="line">		super(username, password, authorities);</div><div class="line"></div><div class="line">		this.id = id;</div><div class="line">		this.enable = enable;</div><div class="line">		this.isSys = isSys;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public Integer getId() &#123;</div><div class="line">		return id;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void setId(Integer id) &#123;</div><div class="line">		this.id = id;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public Byte getEnable() &#123;</div><div class="line">		return enable;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void setEnable(Byte enable) &#123;</div><div class="line">		this.enable = enable;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public Byte getIsSys() &#123;</div><div class="line">		return isSys;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void setIsSys(Byte isSys) &#123;</div><div class="line">		this.isSys = isSys;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="加载权限Service"><a href="#加载权限Service" class="headerlink" title="加载权限Service"></a>加载权限Service</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line">package com.xx.security.admin;</div><div class="line"></div><div class="line">import java.util.HashSet;</div><div class="line">import java.util.List;</div><div class="line">import java.util.Set;</div><div class="line"></div><div class="line">import javax.annotation.Resource;</div><div class="line"></div><div class="line">import org.slf4j.Logger;</div><div class="line">import org.slf4j.LoggerFactory;</div><div class="line">import org.springframework.security.core.authority.SimpleGrantedAuthority;</div><div class="line">import org.springframework.security.core.userdetails.UserDetails;</div><div class="line">import org.springframework.security.core.userdetails.UserDetailsService;</div><div class="line">import org.springframework.security.core.userdetails.UsernameNotFoundException;</div><div class="line">import org.springframework.transaction.annotation.Transactional;</div><div class="line">import org.springframework.util.Assert;</div><div class="line"></div><div class="line">import com.lhc.entity.jpa.SysAdminEntity;</div><div class="line">import com.lhc.entity.jpa.SysAuthorityEntity;</div><div class="line">import com.lhc.entity.jpa.SysRoleEntity;</div><div class="line">import com.lhc.repository.SysAdminJpaRepository;</div><div class="line">import com.lhc.security.constants.AdminSecurityConstant;</div><div class="line"></div><div class="line">@Transactional</div><div class="line">public class AdminDetailsService implements UserDetailsService &#123;</div><div class="line">	private static final Logger logger = LoggerFactory.getLogger(AdminDetailsService.class);</div><div class="line"></div><div class="line">	@Resource</div><div class="line">	SysAdminJpaRepository sysAdminJpaRepository;</div><div class="line">	</div><div class="line">	public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;</div><div class="line">		</div><div class="line">		    logger.info(&quot;loadUserByUsername start&quot;);</div><div class="line">		     logger.info(&quot;username: &#123;&#125;&quot;, username);</div><div class="line">		     </div><div class="line">		     SysAdminEntity sysAdminEntity = sysAdminJpaRepository.findByUsername(username);</div><div class="line">		     </div><div class="line">		     Assert.notNull(sysAdminEntity, &quot;[username:&quot; + username + &quot;] admin is not exist&quot;);</div><div class="line">		     /*if (null == sysAdminEntity) &#123;</div><div class="line">		    	 throw new UsernameNotFoundException(&quot;[username:&quot; + username + &quot;] admin is not exist&quot;);</div><div class="line">		     &#125;*/</div><div class="line">		     </div><div class="line">		     if (sysAdminEntity.getIsSys().equals(AdminSecurityConstant.SUPER_ADMIN_YES)) &#123;</div><div class="line">			      Set&lt;SimpleGrantedAuthority&gt; supuerAuthority = new HashSet&lt;SimpleGrantedAuthority&gt;();</div><div class="line">			      SimpleGrantedAuthority superAuth = new SimpleGrantedAuthority(&quot;SUPER_ADMIN&quot;);</div><div class="line">			      supuerAuthority.add(superAuth);</div><div class="line">			       </div><div class="line">			 </div><div class="line">			      AdminDetails adminDetails = new AdminDetails(sysAdminEntity.getUsername(), sysAdminEntity.getPassword(), </div><div class="line">			    		  true, true, true, true, supuerAuthority, sysAdminEntity.getEnable(), </div><div class="line">			    		  sysAdminEntity.getIsSys(),  sysAdminEntity.getId());</div><div class="line">			       </div><div class="line">			      logger.info(&quot;the loginer is super admin ,loadUserByUsername end&quot;);</div><div class="line">			      return adminDetails;</div><div class="line">		     &#125;</div><div class="line">		     </div><div class="line">		     List&lt;SysRoleEntity&gt; roleList = sysAdminEntity.getListOfSysRole();</div><div class="line">		     </div><div class="line">		     Assert.notEmpty(roleList, &quot;[username:&quot; + username + &quot;] admin has not roles&quot;);</div><div class="line">		    /*if ((null == roleList) || (roleList.size() == 0)) &#123;</div><div class="line">		    	throw new UsernameNotFoundException(&quot;[username:&quot; + username + &quot;] admin has not roles&quot;);</div><div class="line">		     &#125;*/</div><div class="line">		     </div><div class="line">		     Set&lt;SimpleGrantedAuthority&gt; authorities = new HashSet&lt;SimpleGrantedAuthority&gt;();</div><div class="line">		    SimpleGrantedAuthority auth = null;</div><div class="line">		     for (SysRoleEntity sysRoleEntity : roleList) &#123;</div><div class="line">			      if (sysRoleEntity.getEnable().equals(AdminSecurityConstant.ENABLE_YES)) &#123;</div><div class="line">			         </div><div class="line">				         List&lt;SysAuthorityEntity&gt; authList = sysRoleEntity.getListOfsysAuthority();</div><div class="line">				         for (SysAuthorityEntity sysAuthorityEntity : authList) &#123;</div><div class="line">					         auth = new SimpleGrantedAuthority(sysAuthorityEntity.getAuthMark());</div><div class="line">					         authorities.add(auth);</div><div class="line">				         &#125;</div><div class="line">			       &#125;</div><div class="line">		     &#125;</div><div class="line">		     </div><div class="line">		     Assert.notEmpty(authorities, &quot;[username:&quot; + username + &quot;] admin has not roles&quot;);</div><div class="line">		     /*if ((null == authorities) || (authorities.size() == 0)) &#123;</div><div class="line">		    	 throw new UsernameNotFoundException(&quot;[username:&quot; + username + &quot;] admin has not authorities&quot;);</div><div class="line">		     &#125;*/</div><div class="line">		     </div><div class="line">		     for (SimpleGrantedAuthority sga : authorities) &#123;</div><div class="line">		    	 System.out.println(&quot;登录用户所拥有的权限：&quot; + sga.getAuthority());</div><div class="line">		     &#125;</div><div class="line">		 </div><div class="line">		   AdminDetails adminDetails = new AdminDetails(sysAdminEntity.getUsername(), sysAdminEntity.getPassword(), </div><div class="line">				   true, true, true, true, authorities, sysAdminEntity.getEnable(), </div><div class="line">				   sysAdminEntity.getIsSys(),  sysAdminEntity.getId());</div><div class="line">		     </div><div class="line">		    logger.info(&quot;loadUserByUsername end&quot;);</div><div class="line">		    return adminDetails;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<h2 id="权限校验提供者（Provider）"><a href="#权限校验提供者（Provider）" class="headerlink" title="权限校验提供者（Provider）"></a>权限校验提供者（Provider）</h2><p>加载完权限后，在此校验<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">package com.xx.security.admin;</div><div class="line"></div><div class="line">import org.apache.commons.logging.Log;</div><div class="line">import org.apache.commons.logging.LogFactory;</div><div class="line">import org.springframework.security.authentication.BadCredentialsException;</div><div class="line">import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</div><div class="line">import org.springframework.security.authentication.dao.DaoAuthenticationProvider;</div><div class="line">import org.springframework.security.core.AuthenticationException;</div><div class="line">import org.springframework.security.core.userdetails.UserDetails;</div><div class="line"></div><div class="line">import com.lhc.security.constants.AdminSecurityConstant;</div><div class="line">import com.lhc.utils.EncryptUtil;</div><div class="line"></div><div class="line">public class AdminAuthenticationProvider extends DaoAuthenticationProvider &#123;</div><div class="line">	protected final Log logger = LogFactory.getLog(getClass());</div><div class="line"></div><div class="line">	protected void additionalAuthenticationChecks(UserDetails userDetails,</div><div class="line">			UsernamePasswordAuthenticationToken authentication) throws AuthenticationException &#123;</div><div class="line">		</div><div class="line">		this.logger.info(&quot;AdminAuthenticationProvider:&#123;&#125;  authenticate start&quot;);</div><div class="line">		AdminDetails adminDetails = (AdminDetails) userDetails;</div><div class="line"></div><div class="line">		if (authentication.getCredentials() == null) &#123;</div><div class="line">			this.logger.debug(&quot;Authentication failed: no credentials provided&quot;);</div><div class="line"></div><div class="line">			throw new BadCredentialsException(this.messages</div><div class="line">					.getMessage(&quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;, &quot;Bad credentials&quot;));</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		//获取登录密码</div><div class="line">		String presentedPassword = authentication.getCredentials().toString();</div><div class="line"></div><div class="line">		if (!EncryptUtil.match(presentedPassword, adminDetails.getPassword())) &#123;//校验密码是否一致</div><div class="line">			this.logger.debug(&quot;Authentication failed: password does not match stored value&quot;);</div><div class="line"></div><div class="line">			throw new BadCredentialsException(this.messages</div><div class="line">					.getMessage(&quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;, &quot;Bad credentials&quot;));</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		if (adminDetails.getEnable().equals(AdminSecurityConstant.ENABLE_NO)) &#123;</div><div class="line">			this.logger.error(&quot;Authentication failed: &quot; + adminDetails.getUsername() + &quot; is forbided&quot;);</div><div class="line"></div><div class="line">			throw new BadCredentialsException(</div><div class="line">					this.messages.getMessage(&quot;Authentication failed: &quot; + adminDetails.getUsername() + &quot; is forbided&quot;));</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		this.logger.info(&quot;AdminAuthenticationProvider:&#123;&#125;  authenticate end&quot;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public boolean supports(Class&lt;?&gt; authentication) &#123;</div><div class="line">		return authentication.equals(UsernamePasswordAuthenticationToken.class);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="验证成功处理类"><a href="#验证成功处理类" class="headerlink" title="验证成功处理类"></a>验证成功处理类</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">package com.xx.security.admin;</div><div class="line"></div><div class="line">import java.io.IOException;</div><div class="line">import java.util.Date;</div><div class="line"></div><div class="line">import javax.annotation.Resource;</div><div class="line">import javax.servlet.ServletException;</div><div class="line">import javax.servlet.http.HttpServletRequest;</div><div class="line">import javax.servlet.http.HttpServletResponse;</div><div class="line">import org.apache.commons.logging.Log;</div><div class="line">import org.apache.commons.logging.LogFactory;</div><div class="line">import org.springframework.security.core.Authentication;</div><div class="line">import org.springframework.security.web.DefaultRedirectStrategy;</div><div class="line">import org.springframework.security.web.RedirectStrategy;</div><div class="line">import org.springframework.security.web.authentication.AuthenticationSuccessHandler;</div><div class="line"></div><div class="line">import com.lhc.entity.jpa.MemberEntity;</div><div class="line">import com.lhc.entity.jpa.SysAdminEntity;</div><div class="line">import com.lhc.repository.SysAdminJpaRepository;</div><div class="line">import com.lhc.security.member.MemberDetails;</div><div class="line"></div><div class="line">public class AuthenticationSuccessHandlerImpl implements AuthenticationSuccessHandler &#123;</div><div class="line">	protected final Log logger = LogFactory.getLog(getClass());</div><div class="line">	private RedirectStrategy redirectStrategy = new DefaultRedirectStrategy();</div><div class="line">	private String defaultTargetUrl = &quot;/admin/index.jsp&quot;;</div><div class="line">	</div><div class="line">	@Resource</div><div class="line">	SysAdminJpaRepository sysAdminJpaRepository;</div><div class="line"></div><div class="line">	public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response,</div><div class="line">			Authentication authentication) throws IOException, ServletException &#123;</div><div class="line">		//这里处理验证成功后的逻辑</div><div class="line">			</div><div class="line">		if (response.isCommitted()) &#123;</div><div class="line">			this.logger.debug(&quot;Response has already been committed. Unable to redirect to &quot; + this.defaultTargetUrl);</div><div class="line">			return;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		//更新最后登录时间</div><div class="line">		Object principal = authentication.getPrincipal();</div><div class="line">		AdminDetails adminDetails = null;</div><div class="line">		if (principal instanceof AdminDetails) &#123;</div><div class="line">			adminDetails =  (AdminDetails) principal;</div><div class="line">			SysAdminEntity sysAdminEntity = sysAdminJpaRepository.findOne(adminDetails.getId());</div><div class="line">			sysAdminEntity.setLastLogin(new Date(System.currentTimeMillis()));</div><div class="line">			</div><div class="line">			sysAdminJpaRepository.save(sysAdminEntity);</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		this.logger.info(&quot;admin authentication success&quot;);</div><div class="line">		this.redirectStrategy.sendRedirect(request, response, this.defaultTargetUrl);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="验证失败处理类"><a href="#验证失败处理类" class="headerlink" title="验证失败处理类"></a>验证失败处理类</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">package com.xx.security.admin;</div><div class="line"></div><div class="line">import java.io.IOException;</div><div class="line">import javax.servlet.ServletException;</div><div class="line">import javax.servlet.http.HttpServletRequest;</div><div class="line">import javax.servlet.http.HttpServletResponse;</div><div class="line">import org.slf4j.Logger;</div><div class="line">import org.slf4j.LoggerFactory;</div><div class="line">import org.springframework.security.core.AuthenticationException;</div><div class="line">import org.springframework.security.web.authentication.AuthenticationFailureHandler;</div><div class="line"></div><div class="line">public class AuthenticationFailureHandlerImpl implements AuthenticationFailureHandler &#123;</div><div class="line">	private static final Logger logger = LoggerFactory.getLogger(AuthenticationFailureHandlerImpl.class);</div><div class="line"></div><div class="line">	public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response,</div><div class="line">			AuthenticationException exception) throws IOException, ServletException &#123;</div><div class="line">		//这里处理验证失败处理逻辑	</div><div class="line">		</div><div class="line">		logger.info(&quot;authentication failure&quot;);</div><div class="line">		response.sendError(401, &quot;Authentication Failed: &quot; + exception.getMessage());</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="没有权限处理类"><a href="#没有权限处理类" class="headerlink" title="没有权限处理类"></a>没有权限处理类</h2><p>与验证失败不同，此处是验证成功，但是没有操作权限<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">package com.xx.security.admin;</div><div class="line"></div><div class="line">import java.io.IOException;</div><div class="line"></div><div class="line">import javax.servlet.ServletException;</div><div class="line">import javax.servlet.http.HttpServletRequest;</div><div class="line">import javax.servlet.http.HttpServletResponse;</div><div class="line"></div><div class="line">import org.springframework.security.access.AccessDeniedException;</div><div class="line">import org.springframework.security.web.access.AccessDeniedHandler;</div><div class="line"></div><div class="line">public class AdminAccessDeniedHandler implements AccessDeniedHandler &#123;</div><div class="line">	public void handle(HttpServletRequest request, HttpServletResponse response,</div><div class="line">			AccessDeniedException accessDeniedException) throws IOException, ServletException &#123;</div><div class="line">		response.setHeader(&quot;Content-type&quot;, &quot;text/html;charset=UTF-8&quot;);</div><div class="line">		response.getWriter().print(&quot;您没有操作权限&quot;);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="退出登录处理类"><a href="#退出登录处理类" class="headerlink" title="退出登录处理类"></a>退出登录处理类</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">package com.xx.security.admin;</div><div class="line"></div><div class="line">import java.io.IOException;</div><div class="line">import javax.servlet.ServletException;</div><div class="line">import javax.servlet.http.HttpServletRequest;</div><div class="line">import javax.servlet.http.HttpServletResponse;</div><div class="line">import org.slf4j.Logger;</div><div class="line">import org.slf4j.LoggerFactory;</div><div class="line">import org.springframework.security.core.Authentication;</div><div class="line">import org.springframework.security.web.authentication.logout.LogoutSuccessHandler;</div><div class="line"></div><div class="line">public class AdminLogoutSuccessHandler implements LogoutSuccessHandler &#123;</div><div class="line">	private static final Logger logger = LoggerFactory.getLogger(AdminLogoutSuccessHandler.class);</div><div class="line"></div><div class="line">	public void onLogoutSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</div><div class="line">			throws IOException, ServletException &#123;</div><div class="line">		logger.info(&quot; logout success&quot;);</div><div class="line">		response.sendRedirect(&quot;http://admin.online.com/lhc/none/logout_success.jsp&quot;);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="密码工具"><a href="#密码工具" class="headerlink" title="密码工具"></a>密码工具</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">package com.xx.utils;</div><div class="line"></div><div class="line">import org.springframework.security.crypto.password.PasswordEncoder;</div><div class="line">import org.springframework.security.crypto.password.StandardPasswordEncoder;</div><div class="line"></div><div class="line">/**</div><div class="line"> *  密码处理工具</div><div class="line"> * @author clq</div><div class="line"> */</div><div class="line">public class EncryptUtil &#123;</div><div class="line">	private static final String SITE_WIDE_SECRET = &quot;clq&quot;;</div><div class="line">	private static final PasswordEncoder encoder = new StandardPasswordEncoder(SITE_WIDE_SECRET);</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * 加密</div><div class="line">	 * @param rawPassword</div><div class="line">	 * @return</div><div class="line">	 */</div><div class="line">	public static String encrypt(String rawPassword) &#123;</div><div class="line">		return encoder.encode(rawPassword);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	/**</div><div class="line">	 *  校验密码是否匹配</div><div class="line">	 * @param rawPassword 原始密码</div><div class="line">	 * @param password 加密后的密码</div><div class="line">	 * @return</div><div class="line">	 */</div><div class="line">	public static boolean match(String rawPassword, String password) &#123;</div><div class="line">		return encoder.matches(rawPassword, password);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public static void main(String[] args) &#123;</div><div class="line">		String s = &quot;123456&quot;;</div><div class="line">		String s1 = EncryptUtil.encrypt(s);</div><div class="line">		String s2 = EncryptUtil.encrypt(s);</div><div class="line">        System.out.println(s1);  </div><div class="line">        System.out.println(s2);  </div><div class="line">        System.out.println(match(s, s2));  </div><div class="line">        //但是把每次结果拿出来进行match，你会发现可以得到true。  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="获取登录信息工具类"><a href="#获取登录信息工具类" class="headerlink" title="获取登录信息工具类"></a>获取登录信息工具类</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">package com.xx.security.common;</div><div class="line"></div><div class="line">import org.springframework.data.domain.AuditorAware;</div><div class="line">import org.springframework.security.core.Authentication;</div><div class="line">import org.springframework.security.core.context.SecurityContextHolder;</div><div class="line">import org.springframework.stereotype.Component;</div><div class="line"></div><div class="line">import com.lhc.security.admin.AdminDetails;</div><div class="line">import com.lhc.security.member.MemberDetails;</div><div class="line"></div><div class="line">@Component(&quot;springSecurityAuditorAware&quot;)</div><div class="line">public class SpringSecurityAuditorAware implements AuditorAware&lt;Integer&gt; &#123;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public Integer getCurrentAuditor() &#123;</div><div class="line"></div><div class="line">		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</div><div class="line"></div><div class="line">		if (authentication == null || !authentication.isAuthenticated()) &#123;</div><div class="line">			return 0;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		Object principal = authentication.getPrincipal();</div><div class="line">		if (principal instanceof AdminDetails) &#123;</div><div class="line">			return ((AdminDetails)principal).getId();</div><div class="line">		&#125;</div><div class="line">		if (principal instanceof MemberDetails) &#123;</div><div class="line">			return ((MemberDetails)principal).getId();</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		return 0;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public AdminDetails getCurrentAdmin() &#123;</div><div class="line">		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</div><div class="line">		</div><div class="line">		if (authentication == null || !authentication.isAuthenticated()) &#123;</div><div class="line">			return null;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		Object principal = authentication.getPrincipal();</div><div class="line">		if (principal instanceof AdminDetails) &#123;</div><div class="line">			return ((AdminDetails)principal);</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		return null;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public MemberDetails getCurrentMember() &#123;</div><div class="line">		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</div><div class="line">		</div><div class="line">		if (authentication == null || !authentication.isAuthenticated()) &#123;</div><div class="line">			return null;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		Object principal = authentication.getPrincipal();</div><div class="line">		if (principal instanceof MemberDetails) &#123;</div><div class="line">			return ((MemberDetails)principal);</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		return null;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="数据库结构"><a href="#数据库结构" class="headerlink" title="数据库结构"></a>数据库结构</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">CREATE TABLE `sys_admin` (</div><div class="line">  `id` int(10) NOT NULL AUTO_INCREMENT COMMENT &apos;主键&apos;,</div><div class="line">  `name` varchar(50) DEFAULT NULL COMMENT &apos;用户名&apos;,</div><div class="line">  `username` varchar(50) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL COMMENT &apos;登录名&apos;,</div><div class="line">  `password` varchar(100) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL COMMENT &apos;密码&apos;,</div><div class="line">  `last_login` datetime DEFAULT NULL COMMENT &apos;最后登录时间&apos;,</div><div class="line">  `login_ip` varchar(20) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL COMMENT &apos;最后登录的ip&apos;,</div><div class="line">  `enable` int(2) DEFAULT &apos;1&apos; COMMENT &apos;是否可用：1:可用   0:禁用&apos;,</div><div class="line">  `is_sys` int(2) DEFAULT &apos;0&apos; COMMENT &apos;是否是超级管理员：1:是  0：否&apos;,</div><div class="line">  `created_date` datetime DEFAULT NULL COMMENT &apos;创建时间&apos;,</div><div class="line">  `created_by` int(10) DEFAULT &apos;0&apos; COMMENT &apos;创建人&apos;,</div><div class="line">  `modified_date` datetime DEFAULT NULL COMMENT &apos;更新时间&apos;,</div><div class="line">  `modified_by` int(10) DEFAULT &apos;0&apos; COMMENT &apos;更新人&apos;,</div><div class="line">  PRIMARY KEY (`id`)</div><div class="line">) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8;</div><div class="line"></div><div class="line">CREATE TABLE `sys_admin_role` (</div><div class="line">  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT &apos;主键&apos;,</div><div class="line">  `admin_id` int(10) NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;管理员id&apos;,</div><div class="line">  `role_id` int(10) NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;角色id&apos;,</div><div class="line">  PRIMARY KEY (`id`),</div><div class="line">  KEY `FK4k43lklts7m27m6gyy75qvg4h` (`role_id`),</div><div class="line">  KEY `FKcni2xdl3ht8u90us3wwscui99` (`admin_id`),</div><div class="line">  CONSTRAINT `FK4k43lklts7m27m6gyy75qvg4h` FOREIGN KEY (`role_id`) REFERENCES `sys_role` (`id`),</div><div class="line">  CONSTRAINT `FKcni2xdl3ht8u90us3wwscui99` FOREIGN KEY (`admin_id`) REFERENCES `sys_admin` (`id`)</div><div class="line">) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;</div><div class="line"></div><div class="line">CREATE TABLE `sys_authority` (</div><div class="line">  `id` int(10) NOT NULL AUTO_INCREMENT COMMENT &apos;主键&apos;,</div><div class="line">  `auth_mark` varchar(50) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL COMMENT &apos;权限标示&apos;,</div><div class="line">  `auth_name` varchar(50) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL COMMENT &apos;权限名称&apos;,</div><div class="line">  `auth_desc` varchar(100) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL COMMENT &apos;权限描述&apos;,</div><div class="line">  `enable` int(2) DEFAULT &apos;1&apos; COMMENT &apos;是否可用：1:可用  0:禁用&apos;,</div><div class="line">  `created_date` datetime DEFAULT NULL COMMENT &apos;创建时间&apos;,</div><div class="line">  `created_by` int(10) DEFAULT &apos;0&apos; COMMENT &apos;创建人&apos;,</div><div class="line">  `modified_date` datetime DEFAULT NULL COMMENT &apos;更新时间&apos;,</div><div class="line">  `modified_by` int(10) DEFAULT &apos;0&apos; COMMENT &apos;更新人&apos;,</div><div class="line">  PRIMARY KEY (`id`)</div><div class="line">) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8;</div><div class="line"></div><div class="line">CREATE TABLE `sys_role` (</div><div class="line">  `id` int(10) NOT NULL AUTO_INCREMENT COMMENT &apos;主键&apos;,</div><div class="line">  `role_name` varchar(50) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL COMMENT &apos;角色名称&apos;,</div><div class="line">  `role_desc` varchar(100) DEFAULT NULL COMMENT &apos;角色描述&apos;,</div><div class="line">  `enable` int(2) DEFAULT &apos;1&apos; COMMENT &apos;是否可用：1:可用  0:禁用&apos;,</div><div class="line">  `created_date` datetime DEFAULT NULL COMMENT &apos;创建时间&apos;,</div><div class="line">  `created_by` int(10) DEFAULT &apos;0&apos; COMMENT &apos;创建人&apos;,</div><div class="line">  `modified_date` datetime DEFAULT NULL COMMENT &apos;更新时间&apos;,</div><div class="line">  `modified_by` int(10) DEFAULT &apos;0&apos; COMMENT &apos;更新人&apos;,</div><div class="line">  PRIMARY KEY (`id`)</div><div class="line">) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8;</div><div class="line"></div><div class="line">CREATE TABLE `sys_role_authority` (</div><div class="line">  `id` int(10) NOT NULL AUTO_INCREMENT COMMENT &apos;主键&apos;,</div><div class="line">  `role_id` int(10) NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;角色主键&apos;,</div><div class="line">  `auth_id` int(10) NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;权限主键&apos;,</div><div class="line">  PRIMARY KEY (`id`)</div><div class="line">) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8;</div></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://clq2owesome.github.io/2017/08/15/Spring/Security/实践运用整合/" data-id="cjei8ydi1008s7obldg0w8mmd" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/5/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" href="/page/7/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Eclipse/">Eclipse</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Github/">Github</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/Cookie/">Cookie</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/JAXB/">JAXB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/JavaMail/">JavaMail</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/分布式/">分布式</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/加密解密／编码解码/">加密解密／编码解码</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/基础/">基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/数据类型/">数据类型</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/日记/">日记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/时间日期/">时间日期</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/线程/">线程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/网络NIO/">网络NIO</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/队列/">队列</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/集合/">集合</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Maven/">Maven</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/Application-Event/">Application Event</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/JPA/">JPA</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/Security/">Security</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/Spring-Boot/">Spring Boot</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/Spring-Session/">Spring Session</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/Task/">Task</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/spring-MVC/">spring MVC</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/spring-data-redis/">spring data redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/基础/">基础</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端技术相关/">前端技术相关</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/前端技术相关/forever/">forever</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端技术相关/javascript/">javascript</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库相关/">数据库相关</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/数据库相关/mysql/">mysql</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/服务器相关/">服务器相关</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/服务器相关/Hessian/">Hessian</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/服务器相关/Hudson-Jenkins/">Hudson & Jenkins</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/服务器相关/Memcached/">Memcached</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/服务器相关/Nginx/">Nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/服务器相关/Tomcat/">Tomcat</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/服务器相关/red5/">red5</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/服务器相关/redis/">redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/服务器相关/resin/">resin</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/正则表达式/">正则表达式</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/03/08/正则表达式/正则表达式/">正则表达式</a>
          </li>
        
          <li>
            <a href="/2018/02/25/Java/集合/Hashtable与ConcurrentHashMap区别/">Hashtable与ConcurrentHashMap区别</a>
          </li>
        
          <li>
            <a href="/2018/02/25/Java/分布式/分布式事务/">分布式事务</a>
          </li>
        
          <li>
            <a href="/2018/02/25/Java/分布式/分布式锁/">分布式锁</a>
          </li>
        
          <li>
            <a href="/2018/02/25/Java/集合/在List循环中删除元素/">在List循环中删除元素</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 LeoChan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>