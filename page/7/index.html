<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>LeoChan&#39;s 个人博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="描述啊">
<meta property="og:type" content="website">
<meta property="og:title" content="LeoChan&#39;s 个人博客">
<meta property="og:url" content="https://clq2owesome.github.io/page/7/index.html">
<meta property="og:site_name" content="LeoChan&#39;s 个人博客">
<meta property="og:description" content="描述啊">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LeoChan&#39;s 个人博客">
<meta name="twitter:description" content="描述啊">
  
    <link rel="alternate" href="/atom.xml" title="LeoChan&#39;s 个人博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">LeoChan&#39;s 个人博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">技术都是通用的，重要的是是否具有自主解决问题的能力！</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://clq2owesome.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Spring/Security/配置十：退出登录" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/15/Spring/Security/配置十：退出登录/" class="article-date">
  <time datetime="2017-08-15T02:09:45.000Z" itemprop="datePublished">2017-08-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>►<a class="article-category-link" href="/categories/Spring/Security/">Security</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/15/Spring/Security/配置十：退出登录/">配置十：退出登录</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&emsp;&emsp;要实现退出登录的功能我们需要在http元素下定义logout元素，这样Spring Security将自动为我们添加用于处理退出登录的过滤器LogoutFilter到FilterChain。当我们指定了http元素的auto-config属性为true时logout定义是会自动配置的，此时我们默认退出登录的URL为“/j_spring_security_logout”，可以通过logout元素的logout-url属性来改变退出登录的默认地址。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:logout</span> <span class="attr">logout-url</span>=<span class="string">"/logout.do"</span>/&gt;</span></div></pre></td></tr></table></figure>
<p>此外，我们还可以给logout指定如下属性：</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>invalidate-session</td>
<td>表示是否要在退出登录后让当前session失效，默认为true。</td>
</tr>
<tr>
<td>delete-cookies</td>
<td>指定退出登录后需要删除的cookie名称，多个cookie之间以逗号分隔。</td>
</tr>
<tr>
<td>logout-success-url</td>
<td>指定成功退出登录后要重定向的URL。需要注意的是对应的URL应当是不需要登录就可以访问的。</td>
</tr>
<tr>
<td>success-handler-ref</td>
<td>指定用来处理成功退出登录的LogoutSuccessHandler的引用。</td>
</tr>
</tbody>
</table>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://clq2owesome.github.io/2017/08/15/Spring/Security/配置十：退出登录/" data-id="cjei8qk8700ap6gblkedaanwh" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Spring/Security/配置十九：对Acl的支持" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/15/Spring/Security/配置十九：对Acl的支持/" class="article-date">
  <time datetime="2017-08-15T02:09:45.000Z" itemprop="datePublished">2017-08-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>►<a class="article-category-link" href="/categories/Spring/Security/">Security</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/15/Spring/Security/配置十九：对Acl的支持/">配置十九：对Acl的支持</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&emsp;&emsp;Acl的全称是Access Control List，俗称访问控制列表，是用以控制对象的访问权限的。其主要思想是将某个对象的某种权限授予给某个用户，或某种GrantedAuthority（可以简单的理解为某种角色），它们之间的关系都是多对多。如果某一个对象的某一操作是受保护的，那么在对该对象进行某种操作时就需要有对应的权限。</p>
<p>一. <strong>准备工作</strong><br>使用Spring Security的Acl功能需要引入Acl相关的jar包。如果我们的应用是使用Maven构建的，则可以在应用的pom.xml文件中加入如下依赖。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-acl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.security.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>此外，使用Spring Security的Acl时需要在数据库中建立四张表。在其官方文档中给出了一个基于数据库HSQLDB的建表语句。其脚本如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">create table acl_sid (</div><div class="line">  id bigint generated by default as identity(start with 100) not null primary key,</div><div class="line">  principal boolean not null,</div><div class="line">  sid varchar_ignorecase(100) not null,</div><div class="line">  constraint unique_uk_1 unique(sid,principal) );</div><div class="line"> </div><div class="line">create table acl_class (</div><div class="line">  id bigint generated by default as identity(start with 100) not null primary key,</div><div class="line">  class varchar_ignorecase(100) not null,</div><div class="line">  constraint unique_uk_2 unique(class) );</div><div class="line"> </div><div class="line">create table acl_object_identity (</div><div class="line">  id bigint generated by default as identity(start with 100) not null primary key,</div><div class="line">  object_id_class bigint not null,</div><div class="line">  object_id_identity bigint not null,</div><div class="line">  parent_object bigint,</div><div class="line">  owner_sid bigint not null,</div><div class="line">  entries_inheriting boolean not null,</div><div class="line">  constraint unique_uk_3 unique(object_id_class,object_id_identity),</div><div class="line">  constraint foreign_fk_1 foreign key(parent_object)references acl_object_identity(id),</div><div class="line">  constraint foreign_fk_2 foreign key(object_id_class)references acl_class(id),</div><div class="line">  constraint foreign_fk_3 foreign key(owner_sid)references acl_sid(id) );</div><div class="line"> </div><div class="line">create table acl_entry (</div><div class="line">  id bigint generated by default as identity(start with 100) not null primary key,</div><div class="line">  acl_object_identity bigint not null,ace_order int not null,sid bigint not null,</div><div class="line">  mask integer not null,granting boolean not null,audit_success boolean not null,</div><div class="line">  audit_failure boolean not null,</div><div class="line">  constraint unique_uk_4 unique(acl_object_identity,ace_order),</div><div class="line">  constraint foreign_fk_4 foreign key(acl_object_identity)</div><div class="line">      references acl_object_identity(id),</div><div class="line">  constraint foreign_fk_5 foreign key(sid) references acl_sid(id) );</div></pre></td></tr></table></figure></p>
<p>笔者使用的是Oracle数据库，其中没有boolean和主键自增功能，对于boolean类型都使用一位number表示。具体建表语句如下所示：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">create table acl_sid (</div><div class="line">  id number not null primary key,</div><div class="line">  principal number(1) not null,</div><div class="line">  sid varchar(100) not null,</div><div class="line">  constraint unique_uk_1 unique(sid,principal) );</div><div class="line"> </div><div class="line">create table acl_class (</div><div class="line">  id number not null primary key,</div><div class="line">  class varchar(100) not null,</div><div class="line">  constraint unique_uk_2 unique(class) );</div><div class="line"> </div><div class="line">create table acl_object_identity (</div><div class="line">  id number not null primary key,</div><div class="line">  object_id_class number not null,</div><div class="line">  object_id_identity number not null,</div><div class="line">  parent_object number,</div><div class="line">  owner_sid number not null,</div><div class="line">  entries_inheriting number(1) not null,</div><div class="line">  constraint unique_uk_3 unique(object_id_class,object_id_identity),</div><div class="line">  constraint foreign_fk_1 foreign key(parent_object)references acl_object_identity(id),</div><div class="line">  constraint foreign_fk_2 foreign key(object_id_class)references acl_class(id),</div><div class="line">  constraint foreign_fk_3 foreign key(owner_sid)references acl_sid(id) );</div><div class="line"> </div><div class="line">create table acl_entry (</div><div class="line">  id number not null primary key,</div><div class="line">  acl_object_identity number not null,ace_order int not null,sid number not null,</div><div class="line">  mask number(3) not null,granting number(1) not null,audit_success number(1) not null,</div><div class="line">  audit_failure number(1) not null,</div><div class="line">  constraint unique_uk_4 unique(acl_object_identity,ace_order),</div><div class="line">  constraint foreign_fk_4 foreign key(acl_object_identity)</div><div class="line">      references acl_object_identity(id),</div><div class="line">  constraint foreign_fk_5 foreign key(sid) references acl_sid(id) );</div><div class="line"> </div><div class="line"> 新增记录时用于生成主键的sequence定义为：</div><div class="line">  create or replace sequence seq_acl_sid start with 1 increment by 1;</div><div class="line">  create or replace sequence seq_acl_class start with 1 increment by 1;</div><div class="line">  create or replace sequence seq_acl_object_identity start with 1 increment by 1;</div><div class="line">  create or replace sequence seq_acl_entry start with 1 increment by 1;</div></pre></td></tr></table></figure></p>
<p>二. <strong>表功能介绍</strong><br>如上所示，Spring Security的Acl功能需要使用到四张数据库表，分别为acl_sid、acl_class、acl_object_identity和acl_entry。<br>2.1 <strong>表acl_sid</strong><br>表acl_sid的结构如下所示：</p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>number</td>
<td>主键</td>
</tr>
<tr>
<td>sid</td>
<td>varchar</td>
<td>字符串类型的sid</td>
</tr>
<tr>
<td>principal</td>
<td>boolean</td>
<td>是否用户</td>
</tr>
</tbody>
</table>
<p>表acl_sid是用来保存Sid的。对于Acl而言，有两种类型的Sid，一种是基于用户的Sid，叫PrincipalSid；另一种是基于GrantedAuthority的Sid，叫GrantedAuthoritySid。acl_sid表的sid字段存放的是用户名或者是GrantedAuthority的字符串表示。prinpal是用来区分对应的Sid是用户还是GrantedAuthority的。正如在前文所描述的那样，Acl中对象的权限是用来授予给Sid的，Sid有用户和GrantedAuthority之分，所以我们的对象权限是可以用来授予给用户或GrantedAuthority的。</p>
<p>2.2 <strong>表acl_class</strong><br>表acl_class的结构如下所示：<br>| 字段名   | 类型      | 说明        |<br>| —– | ——- | ——— |<br>| id    | number  | 主键        |<br>| class | varchar | 对象类型的全限定名 |<br>表acl_class是用来保存对象类型的，字段class中保存的是对应对象的全限定名。Acl需要使用它来区分不同的对象类型。</p>
<p>2.3 <strong>表acl_object_identity</strong><br>表acl_object_identity的结构如下：<br>| 字段名                | 类型      | 说明                                       |<br>| —————— | ——- | —————————————- |<br>| id                 | number  | 主键                                       |<br>| object_id_class    | number  | 关联acl_class，表示对象类型                       |<br>| object_id_identity | number  | 对象的主键，对于相同的class而言，其需要是唯一的。对象的主键默认需要是Long型，或者可以转换为Long型的对象，如Integer、Short等。 |<br>| parent_object      | number  | 父对象的id，关联acl_object_identity             |<br>| owner_sid          | number  | 拥有者的sid，关联acl_sid                        |<br>| entries_inheriting | boolean | 是否继承父对象的权限。打个比方，删除对象childObj需要有delete权限，用户A他没有childObj的delete权限，但是他有childObj的父对象parentObj的delete权限，当entries_inheriting为true时，用户A同样可以删除childObj。 |<br>表acl_object_identity是用来存放需要进行访问控制的对象的信息的。其保存的信息有对象的拥有者、对象的类型、对象的主键、对象的父对象和是否继承父对象的权限。</p>
<p>2.4 <strong>表acl_entry</strong><br>表acl_entry的结构如下：<br>| 字段名                 | 类型      | 说明                             |<br>| ——————- | ——- | —————————— |<br>| id                  | number  | 主键                             |<br>| acl_object_identity | number  | 对应acl_object_identity的id       |<br>| ace_order           | number  | 所属Acl的权限顺序                     |<br>| sid                 | number  | 对应acl_sid的id                   |<br>| mask                | number  | 权限对应的掩码                        |<br>| granting            | boolean | 是否授权                           |<br>| audit_success       | boolean | 暂未发现其作用，Acl中有一个更新其值的方法，但未见被调用。 |<br>| audit_failure       | boolean |                                |<br>表acl_entry是用于存放具体的权限信息的，从表结构我们也可以看出来，其描述的就是某个主体（Sid）对某个对象（acl_object_identity）是否（granting）拥有某种权限（mask）。当同一对象acl_object_identity在acl_entry表中拥有多条记录时，就会使用ace_order来标记对应的顺序，其对应于往Acl中插入AccessControlEntry时的位置，在进行权限判断时也是依靠ace_order的顺序来进行的，ace_order越小的越先进行判断。ace是Access Control Entry的简称。</p>
<p>三. <strong>Acl主要接口</strong><br>&emsp;&emsp;对于Acl而言，有两块比较核心的功能，一块是往对应的数据库表里面插数据，另一块是从数据库表里面取出对应的数据进行权限鉴定。要了解这些功能我们先来了解Acl中用到的主要接口。<br>3.1 <strong>Sid</strong>：可以用来表示一个principal，或者是一个GrantedAuthority。其对应的实现类有表示principal的PrincipalSid和表示GrantedAuthority的GrantedAuthoritySid。其信息会保存在acl_sid表中。<br>3.2  <strong>ObjectIdentity</strong>：ObjectIdentity表示Spring Security Acl中一个域对象，其默认实现类是ObjectIdentityImpl。ObjectIdentity并不是直接与acl_object_identity表相对应的，真正与acl_object_identity表直接相对应的是Acl。<br>3.3 <strong>Acl</strong>：每一个领域对象都会对应一个Acl，而且只会对应一个Acl。Acl是将Spring Security Acl中使用到的四个表串联起来的一个接口，其中会包含对象信息ObjectIdentity、对象的拥有者Sid和对象的访问控制信息AccessControlEntry。在Spring Security Acl中直接与acl_object_identity表相关联的是Acl接口，因为acl_object_identity表中的数据是通过保存Acl来进行的。一个Acl对应于一个ObjectIdentity，但是会包含有多个Sid和多个AccessControlEntry，即一个Acl表示所有Sid对一个ObjectIdentity的所有AccessControlEntry。Acl的默认实现类是AclImpl，该类实现Acl接口、MutableAcl接口、AuditableAcl接口和OwnershipAcl接口。<br>3.4 <strong>AccessControlEntry</strong>：一个AccessControlEntry表示一条访问控制信息，一个Acl中可以拥有多个AccessControlEntry。在Spring Security Acl中很多地方会使用ACE来简单的表示AccessControlEntry这个概念，比如insertAce其实表示的就是insert AccessControlEntry。每一个AccessControlEntry表示对应的Sid对于对应的对象ObjectIdentity是否被授权某一项权限Permission，是否被授权将使用granting进行区分。AccessControlEntry对应表acl_entry。<br>3.5 <strong>Permission</strong>：在Acl中使用一个bit掩码来表示一个Permission。Spring Security的Acl中默认使用的是BasePermission，其中已经定义了0-4五个bit掩码，分别对应于1、2、4、8、16，代表五种不同的Permission，分别是read (bit 0)、write (bit 1)、create (bit 2)、delete (bit 3)和administer (bit 4)。如果已经定义好的这五个bit掩码不能满足需求，我们可以对BasePermission进行扩展，也可以实现自己的Permission。Spring Security Acl默认的实现最多可以支持32个不同的掩码。<br>3.6 <strong>AclService</strong>：AclService是用来通过ObjectIdentity解析Acl的，其默认实现类是JdbcAclService。JdbcAclService底层操作是通过LookupStrategy来进行的，LookupStrategy的默认实现是BasicLookupStrategy。<br>3.7 <strong>MutableAclService</strong>：MutableAclService是用来对Acl进行持久化的，其默认实现类是JdbcMutableAclService。JdbcMutableAclService是继承自JdbcAclService的，所以我们可以同时通过JdbcMutableAclService对Acl进行读取和保存。如果我们希望自己来实现Acl信息的保存的话，我们也可以不使用该接口。</p>
<p>四. <strong>配置AclService</strong><br>&emsp;&emsp;AclService是使用Spring Security Acl功能的主入口。这里选择一个既可以从数据库读取Acl信息，又可以保存Acl信息到数据库的JdbcMutableAclService做示例。<br>&emsp;&emsp;JdbcMutableAclService只有一个构造方法，它接收三个参数，DataSource、LookupStrategy和AclCache。其对应配置信息如下所示：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"aclService"</span></span></div><div class="line">  <span class="attr">class</span>=<span class="string">"org.springframework.security.acls.jdbc.JdbcMutableAclService"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"lookupStrategy"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"aclCache"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;配置JdbcMutableAclService有一点需要注意的地方，那就是其在与数据库进行交互的时候所基于的脚本是本文开始部分我们提到的那些脚本。其对应的数据库表的主键是自增的，所以在保存Acl时所给出的脚本中没有新增主键id。比如在新增sid时默认使用的脚本是“insert into acl_sid (principal, sid) values (?, ?)”，显然对于使用Oracle数据库作为示例的我们来说这条SQL是有问题的，因为新增的时候主键不能为空，所以如果我们需要使用JdbcMutableAclService来创建Acl的话我们得给JdbcMutableAclService指定新增记录时使用的脚本。这里我们将在新增的时候从之前建立好的Sequence获取值作为主键，示例如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"aclService"</span></span></div><div class="line">  <span class="attr">class</span>=<span class="string">"org.springframework.security.acls.jdbc.JdbcMutableAclService"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"lookupStrategy"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"aclCache"</span> /&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 指定新增acl_sid的脚本 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"insertSidSql"</span></span></div><div class="line">     <span class="attr">value</span>=<span class="string">"insert into acl_sid(id, principal, sid) values (seq_acl_sid.nextval, ?, ?)"</span> /&gt;</div><div class="line">  <span class="comment">&lt;!-- 指定新增acl_class的脚本 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"insertClassSql"</span></span></div><div class="line">     <span class="attr">value</span>=<span class="string">"insert into acl_class(id, class) values (seq_acl_class.nextval, ?)"</span> /&gt;</div><div class="line">  <span class="comment">&lt;!-- 指定新增acl_object_identity的脚本 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"insertObjectIdentitySql"</span></span></div><div class="line">     <span class="attr">value</span>=<span class="string">"insert into acl_object_identity(id, object_id_class, object_id_identity, owner_sid, entries_inheriting) values(seq_acl_object_identity.nextval, ?, ?, ?, ?)"</span> /&gt;</div><div class="line">  <span class="comment">&lt;!-- 指定新增acl_entry的脚本 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"insertEntrySql"</span></span></div><div class="line">     <span class="attr">value</span>=<span class="string">"insert into acl_entry(id, acl_object_identity, ace_order, sid, mask, granting, audit_success, audit_failure) values (seq_acl_entry.nextval, ?, ?, ?, ?, ?, ?, ?)"</span> /&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;除了上述四个SQL之外，我们还需要指定两个属性对应的查询SQL，sidIdentityQuery和classIdentityQuery。因为JdbcMutableAclService在创建Acl时，如果当前用户在acl_sid表中不存在或当前对象类型在acl_class表中不存在，其会先将对应的信息存入acl_sid表和acl_class表，然后需要取出刚刚新增的acl_sid的主键和acl_class的主键以往acl_object_identity表中插入数据，对应acl_object_identity表中的owner_sid和object_id_class字段。这两个属性的默认值是“call identity()”，显然对于Oracle数据库来说这是行不通的，所以我们需要自己指定它们。这里我们通过对应Sequence的当前值来获取刚刚新增的记录的主键。如：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"aclService"</span></span></div><div class="line">  <span class="attr">class</span>=<span class="string">"org.springframework.security.acls.jdbc.JdbcMutableAclService"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"lookupStrategy"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"aclCache"</span> /&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 指定新增acl_sid的脚本 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"insertSidSql"</span></span></div><div class="line">     <span class="attr">value</span>=<span class="string">"insert into acl_sid(id, principal, sid) values (seq_acl_sid.nextval, ?, ?)"</span> /&gt;</div><div class="line">  <span class="comment">&lt;!-- 指定新增acl_class的脚本 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"insertClassSql"</span></span></div><div class="line">     <span class="attr">value</span>=<span class="string">"insert into acl_class(id, class) values (seq_acl_class.nextval, ?)"</span> /&gt;</div><div class="line">  <span class="comment">&lt;!-- 指定新增acl_object_identity的脚本 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"insertObjectIdentitySql"</span></span></div><div class="line">     <span class="attr">value</span>=<span class="string">"insert into acl_object_identity(id, object_id_class, object_id_identity, owner_sid, entries_inheriting) values(seq_acl_object_identity.nextval, ?, ?, ?, ?)"</span> /&gt;</div><div class="line">  <span class="comment">&lt;!-- 指定新增acl_entry的脚本 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"insertEntrySql"</span></span></div><div class="line">     <span class="attr">value</span>=<span class="string">"insert into acl_entry(id, acl_object_identity, ace_order, sid, mask, granting, audit_success, audit_failure) values (seq_acl_entry.nextval, ?, ?, ?, ?, ?, ?, ?)"</span> /&gt;</div><div class="line">  <span class="comment">&lt;!-- 查询刚刚新增的acl_sid的主键的SQL --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sidIdentityQuery"</span> <span class="attr">value</span>=<span class="string">"select seq_acl_sid.currval from dual"</span> /&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 查询刚刚新增的acl_class的主键的SQL --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"classIdentityQuery"</span> <span class="attr">value</span>=<span class="string">"select seq_acl_class.currval from dual"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>4.1 <strong>配置DataSource</strong><br>&emsp;&emsp;配置数据源这个没什么好说的，大家都见惯了，为保持文章的完整性，我这里还是把它列一下。直接上代码：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"> <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">"/WEB-INF/config/jdbc.properties"</span> /&gt;</span></div><div class="line"> </div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.apache.commons.dbcp2.BasicDataSource"</span></span></div><div class="line">  <span class="attr">destroy-method</span>=<span class="string">"close"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.driverClassName&#125;"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.url&#125;"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.username&#125;"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;jdbc.password&#125;"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>4.2 <strong>配置LookupStrategy</strong><br>&emsp;&emsp;LookupStrategy是用来通过ObjectIdentity解析为对应的Acl的。Spring Security Acl中的默认实现类是BasicLookupStrategy，其的构造需要接收四个参数。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"lookupStrategy"</span></span></div><div class="line">  <span class="attr">class</span>=<span class="string">"org.springframework.security.acls.jdbc.BasicLookupStrategy"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"aclCache"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"aclAuthorizationStrategy"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"grantingStrategy"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>4.3 <strong>配置AclAuthorizationStrategy</strong><br>&emsp;&emsp;aclAuthorizationStrategy是在构造Acl的实现类AclImpl时必须给定的一个参数，其会用来在对Acl进行某些操作时检查当前用户是否具有对应的权限。AclAuthorizationStrategy的默认实现类是AclAuthorizationStrategyImpl，其构造需要接收一个或三个GrantedAuthority参数，用来对Acl进行相关操作时所需要的权限，包括更改Acl对应对象的所有者需要的权限、更改Acl中包含的某个AccessControlEntry的audit信息（对应acl_entry表中的is_audit_success和is_audit_failure字段）需要的权限以及其它如增、删、改Acl中所包含的AccessControlEntry等需要的权限。这些权限的鉴定是我们在操作Acl时由Spring Security Acl内部进行判断的，我们只需要在这里定义就好。当Acl对应的所有者对Acl进行操作时，不管其是否拥有指定需要的权限，除了改变audit信息之外的所有操作默认都是被允许的。当只有一个参数时表示三者共用一个GrantedAuthority。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"aclAuthorizationStrategy"</span></span></div><div class="line">  <span class="attr">class</span>=<span class="string">"org.springframework.security.acls.domain.AclAuthorizationStrategyImpl"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">list</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.core.authority.SimpleGrantedAuthority"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"ROLE_ADMIN"</span> /&gt;</span><span class="comment">&lt;!-- 改变所有权需要的权限 --&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.core.authority.SimpleGrantedAuthority"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"gaModifyAuditing"</span> /&gt;</span><span class="comment">&lt;!-- 改变授权需要的权限 --&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.core.authority.SimpleGrantedAuthority"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"gaGeneralChanges"</span> /&gt;</span><span class="comment">&lt;!-- 改变其它信息所需要的权限 --&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>4.4 <strong>配置grantingStrategy</strong><br>&emsp;&emsp;grantingStrategy对应类型为PermissionGrantingStrategy接口，其中只定义了一个isGranted方法，用于判断基于指定的Permission列表和Sid列表指定的Acl是否被授予了访问权限。其默认实现类是DefaultPermissionGrantingStrategy。DefaultPermissionGrantingStrategy对于isGranted的实现逻辑是依次遍历Permission列表、Sid列表和Acl中包含的AccessControlEntry列表，找到第一个三者能够匹配的AccessControlEntry的isGranting（对应acl_entry表的granting字段）作为isGranted的返回结果。如果在当前Acl中没有找到匹配的AccessControlEntry，同时Acl对应的entriesInheriting为true时将继续使用父级的Acl进行匹配，并依次进行，如果都没有匹配到，则将抛出异常。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"grantingStrategy"</span></span></div><div class="line">   <span class="attr">class</span>=<span class="string">"org.springframework.security.acls.domain.DefaultPermissionGrantingStrategy"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.acls.domain.ConsoleAuditLogger"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>4.5 <strong>配置AclCache</strong><br>&emsp;&emsp;AclCache是用来缓存Acl信息的，Spring Security Acl中对于AclCache的默认实现是基于Ehcache的实现类EhCacheBasedAclCache。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"> <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"aclCache"</span></span></div><div class="line">  <span class="attr">class</span>=<span class="string">"org.springframework.security.acls.domain.EhCacheBasedAclCache"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"cache"</span> /&gt;</span><span class="comment">&lt;!-- 对应于Ehcache --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"grantingStrategy"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"aclAuthorizationStrategy"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- 定义一个Ehcache --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"cache"</span> <span class="attr">class</span>=<span class="string">"org.springframework.cache.ehcache.EhCacheFactoryBean"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cacheName"</span> <span class="attr">value</span>=<span class="string">"aclCache"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cacheManager"</span> <span class="attr">ref</span>=<span class="string">"aclCacheManager"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- 定义CacheManager --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"aclCacheManager"</span></span></div><div class="line">  <span class="attr">class</span>=<span class="string">"org.springframework.cache.ehcache.EhCacheManagerFactoryBean"</span>&gt;</div><div class="line">  <span class="comment">&lt;!-- 指定配置文件的位置 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"configLocation"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/config/ehcache.xml"</span> /&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 指定新建的CacheManager的名称 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cacheManagerName"</span> <span class="attr">value</span>=<span class="string">"aclCacheManager"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>为保持本文的完整性，这里贴出上述使用到的配置文件ehcache.xml的内容。具体如下所示：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">ehcache</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></div><div class="line">   <span class="attr">xsi:noNamespaceSchemaLocation</span>=<span class="string">"http://ehcache.org/ehcache.xsd"</span></div><div class="line">   <span class="attr">maxBytesLocalHeap</span>=<span class="string">"100M"</span>&gt;</div><div class="line"> </div><div class="line">   <span class="tag">&lt;<span class="name">diskStore</span> <span class="attr">path</span>=<span class="string">"d:\\ehcache"</span> /&gt;</span></div><div class="line"> </div><div class="line">   <span class="tag">&lt;<span class="name">defaultCache</span> <span class="attr">maxEntriesLocalHeap</span>=<span class="string">"200"</span> /&gt;</span></div><div class="line"> </div><div class="line">   <span class="tag">&lt;<span class="name">cache</span> <span class="attr">name</span>=<span class="string">"aclCache"</span> <span class="attr">maxBytesLocalHeap</span>=<span class="string">"50M"</span> <span class="attr">maxBytesLocalDisk</span>=<span class="string">"5G"</span></span></div><div class="line">      <span class="attr">timeToIdleSeconds</span>=<span class="string">"120"</span> <span class="attr">timeToLiveSeconds</span>=<span class="string">"600"</span> /&gt;</div><div class="line"> </div><div class="line"><span class="tag">&lt;/<span class="name">ehcache</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>关于Ehcache的更多内容不在本文讨论范围之内，有需要的读者可以参考官方文档，也可以参考我的另一个关于Ehcache的系列文章。<br>至此，关于AclService配置的内容就讲完了，AclService配置的完整内容如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"aclService"</span></span></div><div class="line">  <span class="attr">class</span>=<span class="string">"org.springframework.security.acls.jdbc.JdbcMutableAclService"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"lookupStrategy"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"aclCache"</span> /&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 指定新增acl_sid的脚本 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"insertSidSql"</span></span></div><div class="line">     <span class="attr">value</span>=<span class="string">"insert into acl_sid(id, principal, sid) values (seq_acl_sid.nextval, ?, ?)"</span> /&gt;</div><div class="line">  <span class="comment">&lt;!-- 指定新增acl_class的脚本 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"insertClassSql"</span></span></div><div class="line">     <span class="attr">value</span>=<span class="string">"insert into acl_class(id, class) values (seq_acl_class.nextval, ?)"</span> /&gt;</div><div class="line">  <span class="comment">&lt;!-- 指定新增acl_object_identity的脚本 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"insertObjectIdentitySql"</span></span></div><div class="line">     <span class="attr">value</span>=<span class="string">"insert into acl_object_identity(id, object_id_class, object_id_identity, owner_sid, entries_inheriting) values(seq_acl_object_identity.nextval, ?, ?, ?, ?)"</span> /&gt;</div><div class="line">  <span class="comment">&lt;!-- 指定新增acl_entry的脚本 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"insertEntrySql"</span></span></div><div class="line">     <span class="attr">value</span>=<span class="string">"insert into acl_entry(id, acl_object_identity, ace_order, sid, mask, granting, audit_success, audit_failure) values (seq_acl_entry.nextval, ?, ?, ?, ?, ?, ?, ?)"</span> /&gt;</div><div class="line">  <span class="comment">&lt;!-- 查询刚刚新增的acl_sid的主键的SQL --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"sidIdentityQuery"</span> <span class="attr">value</span>=<span class="string">"select seq_acl_sid.currval from dual"</span> /&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 查询刚刚新增的acl_class的主键的SQL --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"classIdentityQuery"</span> <span class="attr">value</span>=<span class="string">"select seq_acl_class.currval from dual"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"lookupStrategy"</span></span></div><div class="line">  <span class="attr">class</span>=<span class="string">"org.springframework.security.acls.jdbc.BasicLookupStrategy"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"aclCache"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"aclAuthorizationStrategy"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"grantingStrategy"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"aclCache"</span></span></div><div class="line">  <span class="attr">class</span>=<span class="string">"org.springframework.security.acls.domain.EhCacheBasedAclCache"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"cache"</span> /&gt;</span><span class="comment">&lt;!-- 对应于Ehcache --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"grantingStrategy"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"aclAuthorizationStrategy"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- 定义一个Ehcache --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"cache"</span> <span class="attr">class</span>=<span class="string">"org.springframework.cache.ehcache.EhCacheFactoryBean"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cacheName"</span> <span class="attr">value</span>=<span class="string">"aclCache"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cacheManager"</span> <span class="attr">ref</span>=<span class="string">"aclCacheManager"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- 定义CacheManager --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"aclCacheManager"</span></span></div><div class="line">  <span class="attr">class</span>=<span class="string">"org.springframework.cache.ehcache.EhCacheManagerFactoryBean"</span>&gt;</div><div class="line">  <span class="comment">&lt;!-- 指定配置文件的位置 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"configLocation"</span> <span class="attr">value</span>=<span class="string">"/WEB-INF/config/ehcache.xml"</span> /&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 指定新建的CacheManager的名称 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cacheManagerName"</span> <span class="attr">value</span>=<span class="string">"aclCacheManager"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"aclAuthorizationStrategy"</span></span></div><div class="line">  <span class="attr">class</span>=<span class="string">"org.springframework.security.acls.domain.AclAuthorizationStrategyImpl"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">list</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.core.authority.SimpleGrantedAuthority"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"ROLE_ADMIN"</span> /&gt;</span><span class="comment">&lt;!-- 改变所有权需要的权限 --&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.core.authority.SimpleGrantedAuthority"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"gaModifyAuditing"</span> /&gt;</span><span class="comment">&lt;!-- 改变授权需要的权限 --&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.core.authority.SimpleGrantedAuthority"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"gaGeneralChanges"</span> /&gt;</span><span class="comment">&lt;!-- 改变其它信息所需要的权限 --&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"grantingStrategy"</span></span></div><div class="line"><span class="attr">class</span>=<span class="string">"org.springframework.security.acls.domain.DefaultPermissionGrantingStrategy"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.acls.domain.ConsoleAuditLogger"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>五. <strong>使用AclService</strong><br>&emsp;&emsp;配置好AclService之后我们就可以使用该JdbcMutableAclService来创建、更新和查找Acl了。在Spring Security Acl中Acl接口的默认实现类是AclImpl，该类实现Acl接口、MutableAcl接口、AuditableAcl接口和OwnershipAcl接口，当有必要在这几种接口之间切换时可以任意切换。<br>5.1 <strong>创建Acl</strong><br>&emsp;&emsp;可以通过调用JdbcMutableAclService的createAcl()方法来创建一个Acl，其对应返回的是一个MutableAcl，该方法接收一个ObjectIdentity作为参数。在创建的时候如果ObjectIdentity对应的类型在acl_class表中不存在，则会把ObjectIdentity对应的类型添加到acl_class表中；如果当前用户对应的Sid在acl_sid表中不存在则会将其添加到acl_sid中。最后会将ObjectIdentity保存到acl_object_identity表中。正如在本文开始部分所描述的那样，一个Acl对应于一个ObjectIdentity，创建Acl就是创建ObjectIdentity的过程。在这三部分都完成之后，会重新从数据库查询出一个Acl，只是此时该Acl对应的AccessControlEntry列表为空。通常如果我们的对象是需要利用Acl进行访问控制的话，那么我们可以在创建该对象的时候一并创建该对象对应的Acl。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Autowired</span></div><div class="line"><span class="keyword">private</span> MutableAclService aclService;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addUser</span><span class="params">(User user)</span> </span>&#123;</div><div class="line">  ...</div><div class="line"> </div><div class="line">  <span class="comment">//1、构建一个ObjectIdentity</span></div><div class="line">  ObjectIdentity oi = <span class="keyword">new</span> ObjectIdentityImpl(User.class, user.getId());</div><div class="line"></div><div class="line">  <span class="comment">//2、创建一个Acl、此时会如果对应的信息不存在会依次创建，如当前用户对应的Sid、ObjectIdentity对应于acl_class表中的类型</span></div><div class="line">  <span class="comment">//最后是往acl_object_identity中插入对应的数据</span></div><div class="line">  MutableAcl acl = aclService.createAcl(oi);</div><div class="line"></div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ObjectIdentityImpl拥有多个构造方法，具体可以参考Spring Security的API文档。</p>
<p>5.2 <strong>查找Acl</strong><br>&emsp;&emsp;通过AclService的系列readAclById()方法可以通过给定的ObjectIdentity查找对应的Acl。此外通过findChildren()方法可以查找指定ObjectIdentity的子ObjectIdentity。关于这些方法的具体信息可以参考Spring Security的API文档。以下是一个简单的示例。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ObjectIdentity oi = <span class="keyword">new</span> ObjectIdentityImpl(User.class, user.getId());</div><div class="line"><span class="comment">//获取ObjectIdentity对应的Acl</span></div><div class="line">MutableAcl acl = (MutableAcl) aclService.readAclById(oi);</div></pre></td></tr></table></figure></p>
<p>5.3 <strong>更新Acl</strong><br>&emsp;&emsp;Acl的更新主要是对应AccessControlEntry的更新，即对AccessControlEntry的增、删、改；此外还包括对Acl对应的ObjectIdentity信息的变更，如更改所有者、父子关系等。<br>&emsp;&emsp; 如下是一些更新Acl的示例，需要注意的是在调用MutableAclService的updateAcl()方法将对应信息同步到数据库之前，对Acl所做的所有修改都只是在内存中的。使用updateAcl()更新Acl信息到数据库时，其底层实现会先将数据库中所有对应的AccessControlEntry都删除，然后再将内存中的AccessControlEntry列表保存到数据库中。以下是其实现代码。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> MutableAcl <span class="title">updateAcl</span><span class="params">(MutableAcl acl)</span> <span class="keyword">throws</span> NotFoundException </span>&#123;</div><div class="line">    Assert.notNull(acl.getId(), <span class="string">"Object Identity doesn't provide an identifier"</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Delete this ACL's ACEs in the acl_entry table</span></div><div class="line">    deleteEntries(retrieveObjectIdentityPrimaryKey(acl.getObjectIdentity()));</div><div class="line"></div><div class="line">    <span class="comment">// Create this ACL's ACEs in the acl_entry table</span></div><div class="line">    createEntries(acl);</div><div class="line"></div><div class="line">    <span class="comment">// Change the mutable columns in acl_object_identity</span></div><div class="line">    updateObjectIdentity(acl);</div><div class="line"></div><div class="line">    <span class="comment">// Clear the cache, including children</span></div><div class="line">    clearCacheIncludingChildren(acl.getObjectIdentity());</div><div class="line"></div><div class="line">    <span class="comment">// Retrieve the ACL via superclass (ensures cache registration, proper retrieval etc)</span></div><div class="line">    <span class="keyword">return</span> (MutableAcl) <span class="keyword">super</span>.readAclById(acl.getObjectIdentity());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>5.3.1 <strong>添加AccessControlEntry</strong><br>&emsp;&emsp;添加AccessControlEntry是通过MutableAcl的insertAce()方法进行的，该方法的定义如下所示：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">/**</span></div><div class="line">  *</div><div class="line">  * <span class="doctag">@param</span> atIndexLocation 添加的位置，对应于acl_entry表中的ace_order字段</div><div class="line">  * <span class="doctag">@param</span> permission 对应的Permission</div><div class="line">  * <span class="doctag">@param</span> sid 对应Sid</div><div class="line">  * <span class="doctag">@param</span> granting 是否赋予</div><div class="line">  */</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">insertAce</span><span class="params">(<span class="keyword">int</span> atIndexLocation, Permission permission, Sid sid, <span class="keyword">boolean</span> granting)</span></span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;参数atIndexLocation对应的是需要插入的AccessControlEntry在Acl对应的AccessControlEntry列表（java.util.List类型）中的位置，对应于acl_entry表中ace_order，而一个Acl代表其对应ObjectIdentity的所有关联Sid关联的所有AccessControlEntry，这个ace_order是在这个范围内的order。以下是一个添加AccessControlEntry的示例：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">MutableAcl acl = ...;</div><div class="line"> </div><div class="line"><span class="comment">//基于principal的Sid</span></div><div class="line">Sid sid = <span class="keyword">new</span> PrincipalSid(SecurityContextHolder.getContext().getAuthentication());</div><div class="line">Permission p = BasePermission.ADMINISTRATION;<span class="comment">//管理员权限</span></div><div class="line"><span class="comment">//将当前Acl的管理员权限赋予给指定的Sid</span></div><div class="line">acl.insertAce(acl.getEntries().size(), p, sid, <span class="keyword">true</span>);   <span class="comment">//添加AccessControlEntry到内存</span></div><div class="line"><span class="comment">//保存到数据库</span></div><div class="line">acl = aclService.updateAcl(acl);</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;上述的Sid，也可以是一个GrantedAuthoritySid，当把一个Acl的某Permission赋予给一个GrantedAuthoritySid时表示拥有该GrantedAuthority的用户都将拥有对应的Permission。如：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">MutableAcl acl = ...;</div><div class="line"> </div><div class="line"><span class="comment">//基于GrantedAuthority的Sid</span></div><div class="line">Sid sid = <span class="keyword">new</span> GrantedAuthoritySid(<span class="string">"ROLE_ADMIN"</span>);</div><div class="line">Permission p = BasePermission.ADMINISTRATION;<span class="comment">//管理员权限</span></div><div class="line"><span class="comment">//将当前Acl的管理员权限赋予给指定的Sid</span></div><div class="line">acl.insertAce(acl.getEntries().size(), p, sid, <span class="keyword">true</span>);   <span class="comment">//添加AccessControlEntry到内存</span></div><div class="line"><span class="comment">//保存到数据库</span></div><div class="line">acl = aclService.updateAcl(acl);</div></pre></td></tr></table></figure></p>
<p>5.3.2 <strong>删除AccessControlEntry</strong><br>&emsp;&emsp;通过调用MutableAcl的deleteAce(int aceIndex)方法可以删除Acl中指定位置的AccessControlEntry，aceIndex是从0开始的，底层是使用的List的remove(int index)方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ObjectIdentity oi = <span class="keyword">new</span> ObjectIdentityImpl(User.class, user.getId());</div><div class="line"><span class="comment">//获取ObjectIdentity对应的Acl</span></div><div class="line">MutableAcl acl = (MutableAcl) aclService.readAclById(oi);</div><div class="line">acl.deleteAce(<span class="number">0</span>);<span class="comment">//内存中删除第一个AccessControlEntry</span></div><div class="line">aclService.updateAcl(acl);<span class="comment">//同步到数据库</span></div></pre></td></tr></table></figure></p>
<p>5.3.3 <strong>更新AccessControlEntry</strong><br>&emsp;&emsp;通过MutableAcl的updateAce()可以更新指定位置的AccessControlEntry的Permission。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ObjectIdentity oi = <span class="keyword">new</span> ObjectIdentityImpl(User.class, user.getId());</div><div class="line"><span class="comment">//获取ObjectIdentity对应的Acl</span></div><div class="line">MutableAcl acl = (MutableAcl) aclService.readAclById(oi);</div><div class="line">acl.updateAce(<span class="number">0</span>, BasePermission.CREATE);<span class="comment">//内存中更新第一个AccessControlEntry对应的Permission</span></div><div class="line">aclService.updateAcl(acl);<span class="comment">//同步到数据库</span></div></pre></td></tr></table></figure></p>
<p>5.3.4 <strong>修改所有者</strong><br>&emsp;&emsp;可以通过Acl的getOwner()方法获取Acl对应ObjectIdentity的拥有者Sid。通过MutableAcl的setOwner()方法可以在内存中更新对应Acl的拥有者。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ObjectIdentity oi = <span class="keyword">new</span> ObjectIdentityImpl(User.class, user.getId());</div><div class="line"><span class="comment">//获取ObjectIdentity对应的Acl</span></div><div class="line">MutableAcl acl = (MutableAcl) aclService.readAclById(oi);</div><div class="line">acl.setOwner(<span class="keyword">new</span> PrincipalSid(<span class="string">"user"</span>));<span class="comment">//内存中更改拥有者</span></div><div class="line">aclService.updateAcl(acl);<span class="comment">//同步到数据库</span></div></pre></td></tr></table></figure></p>
<p>5.3.5 <strong>修改父Acl</strong><br>&emsp;&emsp;通过Acl的getParentAcl()方法可以获取到Acl对应ObjectIdentity对应的父ObjectIdentity对应的Acl。通过MutableAcl的setParent()方法可以在内存中修改Acl对应的父Acl，即修改Acl对应ObjectIdentity对应的父ObjectIdentity。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ObjectIdentity oi = <span class="keyword">new</span> ObjectIdentityImpl(User.class, user.getId());</div><div class="line"><span class="comment">//获取ObjectIdentity对应的Acl</span></div><div class="line">MutableAcl acl = (MutableAcl) aclService.readAclById(oi);</div><div class="line">Acl newParent = ...;<span class="comment">//以某种方式获取到Acl</span></div><div class="line">acl.setParent(newParent);<span class="comment">//内存中更改父Acl</span></div><div class="line">aclService.updateAcl(acl);<span class="comment">//同步到数据库</span></div></pre></td></tr></table></figure></p>
<p>5.3.6 <strong>修改继承策略</strong><br>&emsp;&emsp;通过Acl的isEntriesInheriting()可以获取到当前Acl对应ObjectIdentity的继承策略，创建Acl时该值默认为true。通过MutableAcl的setEntriesInheriting()方法可以在内存中修改该Acl对应ObjectIdentity的继承策略。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ObjectIdentity oi = new ObjectIdentityImpl(User.class, user.getId());</div><div class="line">//获取ObjectIdentity对应的Acl</div><div class="line">MutableAcl acl = (MutableAcl) aclService.readAclById(oi);</div><div class="line">acl.setEntriesInheriting(false);//内存中修改为不从父Acl继承AccessControlEntry</div><div class="line">aclService.updateAcl(acl);//同步到数据库</div></pre></td></tr></table></figure></p>
<p>5.4 <strong>删除Acl</strong><br>&emsp;&emsp;当我们删除对象的时候应该连同对应的Acl也一起删除。使用MutableAclService的deleteAcl(ObjectIdentity oi, boolean deleteChildren)方法可以删除指定ObjectIdentity对应的Acl，deleteChildren表示是否连同子ObjectIdentity对应的Acl也一起删除。deleteAcl将删除对应的ObjectIdentity，以及对应的AccessControlEntry，即其会删除acl_object_identity表和acl_entry表中与当前Acl对应的ObjectIdentity相关的记录。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ObjectIdentity objectIdentity = <span class="keyword">new</span> ObjectIdentityImpl(User.class, id);</div><div class="line">aclService.deleteAcl(objectIdentity, <span class="keyword">true</span>);</div></pre></td></tr></table></figure></p>
<p>六. <strong>注入到AclPermissionEvaluator</strong><br>&emsp;&emsp;AclPermissionEvaluator是PermissionEvaluator的一个实现类。在之前关于使用基于表达式的权限控制一文中有提到过，PermissionEvaluator是为表达式hasPermission提供支持的。此外，PermissionEvaluator还为标签accesscontrollist提供支持。本节将就使用AclPermissionEvaluator支持在方法上使用@PreAuthorize进行权限控制时使用表达式hasPermission做一个简单讲解。<br>&emsp;&emsp;AclPermissionEvaluator的构造需要接收一个AclService参数，在进行权限鉴定时其需要通过AclService获取到对应对象对应的Acl，然后判断该Acl中是否具有指定的Sid和指定的Permission。<br>&emsp;&emsp;对于方法使用hasPermission表达式进行权限鉴定时需要做两个事情，首先需要指定global-method-security的pre-post-annotations=”enabled”。其次需要手工定义DefaultMethodSecurityExpressionHandler并指定其permissionEvaluator为我们定义的AclPermissionEvaluator。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:global-method-security</span> <span class="attr">pre-post-annotations</span>=<span class="string">"enabled"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:expression-handler</span> <span class="attr">ref</span>=<span class="string">"expressionHandler"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">security:global-method-security</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"expressionHandler"</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.access.expression.method.DefaultMethodSecurityExpressionHandler"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"permissionEvaluator"</span> <span class="attr">ref</span>=<span class="string">"aclPermissionEvaluator"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"aclPermissionEvaluator"</span></span></div><div class="line">  <span class="attr">class</span>=<span class="string">"org.springframework.security.acls.AclPermissionEvaluator"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"aclService"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;定义后之后我们就可以在方法上使用@PreAuthorize和hasPermission表达式了。关于PermissionEvaluator和hasPermission的更多介绍可以参考《基于表达式的权限控制》一文。hasPermission有两种用法，一种是直接传一个对象和对应需要的权限，如hasPermission(object,permission)；另一种是传对象的id、对应类型和需要的权限，如hasPermission(targetId,targetType,permission)。传入的Permission是Spring Security Acl中的Permission接口实现类，而不是Spring Security的GrantedAuthority。传入的permission参数可以是一个Permission对象或Permission对象数组，也可以是一个整数或字符串。当传入的permission是整数或字符串时将由AclPermissionEvaluator的PermissionFactory进行解析，AclPermissionEvaluator默认拥有的PermissionFactory是DefaultPermissionFactory，其会将整形或字符串类型的permission解析成对应的BasePermission。如前所述，BasePermission中定义了五个BasePermission，其对应的名称和掩码分别为：READ (1)、WRITE (2)、CREATE (4)、DELETE (8)和ADMINISTER (16)。当permission使用字符串时我们只能使用这五种字符串，不区分大小写，表示当前用户或其所拥有的GrantedAuthority必须拥有指定对象的指定Permission才允许访问。但是当使用掩码时我们可以使用1、2、4、8和16。<br>&emsp;&emsp;接下来将简单的介绍一个使用@PreAuthorize和hasPermission表达式在方法上进行权限控制的示例。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">@PreAuthorize(&quot;hasPermission(#id, &apos;com.spring.security.entity.User&apos;, 1)&quot;)</div><div class="line">public User find(int id) &#123;</div><div class="line">  User user = new User();</div><div class="line">  user.setId(id);</div><div class="line">  return user;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;上述配置即表示调用find方法查看指定id对应的User对象时必须拥有掩码为1对应的Permission才行，或者在继续策略为true时拥有指定id父对象掩码为1对应的Permission也行。这时哪怕你是该User对象的拥有者，或者你拥有ADMINISTER权限，如果你没有对应的READ权限，你也不能访问该方法。如果觉得这种实现不符合你的要求，你可以实现自己的PermissionGrantingStrategy，然后将实现类bean注入到BasicLookupStrategy和EhcacheBasedAclCache中，这样在判断一个用户是否具有指定Acl的指定Permission时就可以使用自己的逻辑了。<br>&emsp;&emsp;上面的定义如果改成permission参数直接使用对象，可以这样定义：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@PreAuthorize</span>(<span class="string">"hasPermission(#id, 'com.spring.security.entity.User', T(org.springframework.security.acls.domain.BasePermission).READ)"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> User <span class="title">find</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">  User user = <span class="keyword">new</span> User();</div><div class="line">  user.setId(id);</div><div class="line">  <span class="keyword">return</span> user;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;当permission参数定义为一个Permission数组时，会根据顺序依次匹配当前用户在指定的Acl中是否拥有对应Permission的AccessControlEntry，如果拥有则以第一个匹配到的AccessControlEntry的granting属性作为判断结果，没有匹配到还可以根据继承策略决定是否利用父级Acl进行匹配，都没匹配到就会抛异常了。<br>&emsp;&emsp;默认使用的BasePermission中只定义了五种Permission，如果这不能满足你的要求，那么我们可以实现自己的Permission，然后把它们注册到DefaultPermissionFactory中，并手工将该DefaultPermissionFactory注入到AclPermissionEvaluator中。前文已经说过AclPermissionEvaluator中使用的PermissionFactory默认是DefaultPermissionFactory，DefaultPermissionFactory中默认只注册了BasePermission中对应的五种Permission。以下是一个扩展Permission的简单示例。<br>&emsp;&emsp;首先实现自己的Permission类，这里简单的定义一个自己的类，然后继承BasePermission类。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasePermissionExt</span> <span class="keyword">extends</span> <span class="title">BasePermission</span> </span>&#123;</div><div class="line"> </div><div class="line"><span class="comment">/**</span></div><div class="line">* serialVersionUID</div><div class="line">*/</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">BasePermissionExt</span><span class="params">(<span class="keyword">int</span> mask)</span> </span>&#123;</div><div class="line">  <span class="keyword">super</span>(mask);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">BasePermissionExt</span><span class="params">(<span class="keyword">int</span> mask, <span class="keyword">char</span> code)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(mask, code);</div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;然后在DefaultPermissionFactory中注册基于我们自己实现的Permission对象，并将该DefaultPermissionFactory注入到AclPermissionEvaluator中。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"aclPermissionEvaluator"</span></span></div><div class="line">  <span class="attr">class</span>=<span class="string">"org.springframework.security.acls.AclPermissionEvaluator"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"aclService"</span> /&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 手工注册DefaultPermissionFactory和其中的Permission --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"permissionFactory"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.acls.domain.DefaultPermissionFactory"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">map</span>&gt;</span></div><div class="line">               <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"READ"</span>&gt;</span></div><div class="line">                  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.xxx.spring.security.BasePermissionExt"</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"1"</span>/&gt;</span></div><div class="line">                  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">               <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></div><div class="line">               <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"WRITE"</span>&gt;</span></div><div class="line">                  <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"com.xxx.spring.security.BasePermissionExt"</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"2"</span>/&gt;</span></div><div class="line">                  <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">               <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">map</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>此外，还可以将我们的BasePermissionExt改成如下这样：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasePermissionExt</span> <span class="keyword">extends</span> <span class="title">BasePermission</span> </span>&#123;</div><div class="line"> </div><div class="line">   <span class="comment">/**</span></div><div class="line">    * serialVersionUID</div><div class="line">    */</div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> longserialVersionUID = <span class="number">1L</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Permission READ = <span class="keyword">new</span> BasePermissionExt(<span class="number">1</span> &lt;&lt; <span class="number">0</span>, <span class="string">'R'</span>); <span class="comment">// 1</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Permission WRITE = <span class="keyword">new</span> BasePermissionExt(<span class="number">1</span> &lt;&lt; <span class="number">1</span>, <span class="string">'W'</span>); <span class="comment">// 2</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Permission CREATE = <span class="keyword">new</span> BasePermissionExt(<span class="number">1</span> &lt;&lt; <span class="number">2</span>, <span class="string">'C'</span>); <span class="comment">// 4</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Permission DELETE = <span class="keyword">new</span> BasePermissionExt(<span class="number">1</span> &lt;&lt; <span class="number">3</span>, <span class="string">'D'</span>); <span class="comment">// 8</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Permission ADMINISTRATION = <span class="keyword">new</span> BasePermissionExt(<span class="number">1</span> &lt;&lt; <span class="number">4</span>, <span class="string">'A'</span>); <span class="comment">// 16</span></div><div class="line"> </div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">BasePermissionExt</span><span class="params">(<span class="keyword">int</span> mask)</span> </span>&#123;</div><div class="line">      <span class="keyword">super</span>(mask);</div><div class="line">   &#125;</div><div class="line">  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BasePermissionExt</span><span class="params">(<span class="keyword">int</span> mask, <span class="keyword">char</span> code)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(mask, code);</div><div class="line">    &#125;</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后通过传入Class参数来构造DefaultPermissionFactory。这个时候会将对应Class中所有类型为Permission的字段分别以字段名和字段值Permission对应的掩码为Key，以字段值Permission为Value进行注册。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"aclPermissionEvaluator"</span></span></div><div class="line">  <span class="attr">class</span>=<span class="string">"org.springframework.security.acls.AclPermissionEvaluator"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"aclService"</span> /&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 手工注册DefaultPermissionFactory和其中的Permission --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"permissionFactory"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.acls.domain.DefaultPermissionFactory"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"com.spring.security.BasePermissionExt"</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://clq2owesome.github.io/2017/08/15/Spring/Security/配置十九：对Acl的支持/" data-id="cjei8qk8000aa6gblr9vi0znx" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Spring/Security/配置十七：基于方法的权限控制" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/15/Spring/Security/配置十七：基于方法的权限控制/" class="article-date">
  <time datetime="2017-08-15T02:09:45.000Z" itemprop="datePublished">2017-08-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>►<a class="article-category-link" href="/categories/Spring/Security/">Security</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/15/Spring/Security/配置十七：基于方法的权限控制/">配置十七：基于方法的权限控制</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&emsp;&emsp;之前介绍的都是基于URL的权限控制，Spring Security同样支持对于方法的权限控制。可以通过intercept-methods对某个bean下面的方法进行权限控制，也可以通过pointcut对整个Service层的方法进行统一的权限控制，还可以通过注解定义对单独的某一个方法进行权限控制。</p>
<p>一. <strong>intercept-methods定义方法权限控制</strong><br>&emsp;&emsp;intercept-methods是需要定义在bean元素下的，通过它可以定义对当前的bean的某些方法进行权限控制，具体方法是使用其下的子元素protect进行定义的。protect元素需要指定两个属性，access和method，method表示需要拦截的方法名称，可以使用通配符，access表示执行对应的方法需要拥有的权限，多个权限之间可以使用逗号分隔。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"> <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"userService"</span> <span class="attr">class</span>=<span class="string">"com.xxx.service.impl.UserServiceImpl"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:intercept-methods</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">security:protect</span> <span class="attr">access</span>=<span class="string">"ROLE_USER"</span> <span class="attr">method</span>=<span class="string">"find*"</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">security:protect</span> <span class="attr">access</span>=<span class="string">"ROLE_ADMIN"</span> <span class="attr">method</span>=<span class="string">"add*"</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">security:protect</span> <span class="attr">access</span>=<span class="string">"ROLE_ADMIN"</span> <span class="attr">method</span>=<span class="string">"update*"</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">security:protect</span> <span class="attr">access</span>=<span class="string">"ROLE_ADMIN"</span> <span class="attr">method</span>=<span class="string">"delete*"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">security:intercept-methods</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;在上面的配置中表示在执行UserServiceImpl的方法名以find开始的方法时需要当前用户拥有ROLE_USER的权限，在执行方法名以add、update或delete开始的方法时需要拥有ROLE_ADMIN的权限。当访问被拒绝时还是交由ExceptionTranslationFilter处理，这也就意味着如果用户未登录则会引导用户进行登录，否则默认将返回403错误码到客户端。  </p>
<p>二. <strong>使用pointcut定义方法权限控制</strong><br>&emsp;&emsp;基于pointcut的方法权限控制是通过global-method-security下的protect-pointcut来定义的。可以在global-method-security元素下定义多个protect-pointcut以对不同的pointcut使用不同的权限控制。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:global-method-security</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:protect-pointcut</span> <span class="attr">access</span>=<span class="string">"ROLE_READ"</span> <span class="attr">expression</span>=<span class="string">"execution(* com.elim.*..*Service.find*(..))"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:protect-pointcut</span> <span class="attr">access</span>=<span class="string">"ROLE_WRITE"</span> <span class="attr">expression</span>=<span class="string">"execution(* com.elim.*..*Service.*(..))"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">security:global-method-security</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;上面的定义表示我们在执行com.elim包或其子包下任意以Service结尾的类，其方法名以find开始的所有方法时都需要用户拥有ROLE_READ的权限，对于com.elim包或其子包下任意以Service结尾的类的其它方法在执行时都需要ROLE_WRITE的权限。需要注意的是对应的类需要是定义在ApplicationContext中的bean才行。此外同对于URL的权限控制一样，当定义多个protect-pointcut时更具有特性的应当先定义，因为在pointcut匹配的时候是按照声明顺序进行匹配的，一旦匹配上了后续的将不再进行匹配了。</p>
<p>三. <strong>使用注解定义方法权限控制</strong><br>&emsp;&emsp;基于注解的方法权限控制也是需要通过global-method-security元素定义来进行启用的。Spring Security在方法的权限控制上支持三种类型的注解，JSR-250注解、@Secured注解和支持表达式的注解。这三种注解默认都是没有启用的，需要单独通过global-method-security元素的对应属性进行启用。</p>
<p>四. <strong>JSR-250注解</strong><br>&emsp;&emsp;要使用JSR-250注解，首先我们需要通过设置global-method-security元素的jsr250-annotation=”enabled”来启用基于JSR-250注解的支持，默认为disabled。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:global-method-security</span> <span class="attr">jsr250-annotations</span>=<span class="string">"enabled"</span>/&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;此外，还需要确保添加了jsr250-api到我们的类路径下。之后就可以在我们的Service方法上使用JSR-250注解进行权限控制了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="meta">@RolesAllowed</span>(<span class="string">"ROLE_ADMIN"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</div><div class="line"> </div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addUser</span><span class="params">(User user)</span> </span>&#123;</div><div class="line">      System.out.println(<span class="string">"addUser................"</span> + user);</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUser</span><span class="params">(User user)</span> </span>&#123;</div><div class="line">      System.out.println(<span class="string">"updateUser.............."</span> + user);</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">   <span class="meta">@RolesAllowed</span>(&#123;<span class="string">"ROLE_USER"</span>, <span class="string">"ROLE_ADMIN"</span>&#125;)</div><div class="line">   <span class="function"><span class="keyword">public</span> User <span class="title">find</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">      System.out.println(<span class="string">"find user by id............."</span> + id);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">      System.out.println(<span class="string">"delete user by id................"</span>);</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">   <span class="meta">@RolesAllowed</span>(<span class="string">"ROLE_USER"</span>)</div><div class="line">   <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">findAll</span><span class="params">()</span> </span>&#123;</div><div class="line">      System.out.println(<span class="string">"find all user..............."</span>);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;上面的代码表示执行UserServiceImpl里面所有的方法都需要角色ROLE_ADMIN，其中findAll()方法的执行需要ROLE_USER角色，而find()方法的执行对于ROLE_USER或者ROLE_ADMIN角色都可以。<br>&emsp;&emsp;顺便介绍一下JSR-250中对权限支持的注解。  </p>
<ol>
<li><strong>RolesAllowed</strong>表示访问对应方法时所应该具有的角色。其可以标注在类上，也可以标注在方法上，当标注在类上时表示其中所有方法的执行都需要对应的角色，当标注在方法上表示执行该方法时所需要的角色，当方法和类上都使用了@RolesAllowed进行标注，则方法上的@RolesAllowed将覆盖类上的@RolesAllowed，即方法上的@RolesAllowed将对当前方法起作用。@RolesAllowed的值是由角色名称组成的数组。</li>
<li><strong>PermitAll</strong>表示允许所有的角色进行访问，也就是说不进行权限控制。@PermitAll可以标注在方法上也可以标注在类上，当标注在方法上时则只对对应方法不进行权限控制，而标注在类上时表示对类里面所有的方法都不进行权限控制    （1）当@PermitAll标注在类上，而@RolesAllowed标注在方法上时则按照@RolesAllowed将覆盖@PermitAll，即需要@RolesAllowed对应的角色才能访问。  （2）当@RolesAllowed标注在类上，而@PermitAll标注在方法上时则对应的方法也是不进行权限控制的。  （3）当在方法上同时使用了@PermitAll和@RolesAllowed时先定义的将发生作用，而都定义在类上时则是反过来的，即后定义的将发生作用（这个没多大的实际意义，实际应用中不会有这样的定义）。</li>
<li><strong>DenyAll</strong>是和PermitAll相反的，表示无论什么角色都不能访问。@DenyAll只能定义在方法上。你可能会有疑问使用@DenyAll标注的方法无论拥有什么权限都不能访问，那还定义它干啥呢？使用@DenyAll定义的方法只是在我们的权限控制中不能访问，脱离了权限控制还是可以访问的。</li>
</ol>
<p>五. <strong>@Secured注解</strong><br>&emsp;&emsp;@Secured是由Spring Security定义的用来支持方法权限控制的注解。它的使用也是需要启用对应的支持才会生效的。通过设置global-method-security元素的secured-annotations=”enabled”可以启用Spring Security对使用@Secured注解标注的方法进行权限控制的支持，其值默认为disabled。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:global-method-security</span> <span class="attr">secured-annotations</span>=<span class="string">"enabled"</span>/&gt;</span></div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</div><div class="line"> </div><div class="line">   <span class="meta">@Secured</span>(<span class="string">"ROLE_ADMIN"</span>)</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addUser</span><span class="params">(User user)</span> </span>&#123;</div><div class="line">      System.out.println(<span class="string">"addUser................"</span> + user);</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">   <span class="meta">@Secured</span>(<span class="string">"ROLE_USER"</span>)</div><div class="line">   <span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">findAll</span><span class="params">()</span> </span>&#123;</div><div class="line">      System.out.println(<span class="string">"find all user..............."</span>);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp;&emsp;在上面的代码中我们使用@Secured定义了只有拥有ROLE_ADMIN角色的用户才能调用方法addUser()，只有拥有ROLE_USER角色的用户才能调用方法findAll()。</p>
<p>六. <strong>支持表达式的注解</strong><br>&emsp;&emsp;Spring Security中定义了四个支持使用表达式的注解，分别是@PreAuthorize、@PostAuthorize、@PreFilter和@PostFilter。其中前两者可以用来在方法调用前或者调用后进行权限检查，后两者可以用来对集合类型的参数或者返回值进行过滤。要使它们的定义能够对我们的方法的调用产生影响我们需要设置global-method-security元素的pre-post-annotations=”enabled”，默认为disabled。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:global-method-security</span> <span class="attr">pre-post-annotations</span>=<span class="string">"disabled"</span>/&gt;</span></div></pre></td></tr></table></figure></p>
<p>6.1 使用@PreAuthorize和@PostAuthorize进行访问控制<br>@PreAuthorize可以用来控制一个方法是否能够被调用。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Service</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</div><div class="line"> </div><div class="line">   <span class="meta">@PreAuthorize</span>(<span class="string">"hasRole('ROLE_ADMIN')"</span>)</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addUser</span><span class="params">(User user)</span> </span>&#123;</div><div class="line">      System.out.println(<span class="string">"addUser................"</span> + user);</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">   <span class="meta">@PreAuthorize</span>(<span class="string">"hasRole('ROLE_USER') or hasRole('ROLE_ADMIN')"</span>)</div><div class="line">   <span class="function"><span class="keyword">public</span> User <span class="title">find</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">      System.out.println(<span class="string">"find user by id............."</span> + id);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在上面的代码中我们定义了只有拥有角色ROLE_ADMIN的用户才能访问adduser()方法，而访问find()方法需要有ROLE_USER角色或ROLE_ADMIN角色。使用表达式时我们还可以在表达式中使用方法参数。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</div><div class="line"> </div><div class="line">   <span class="comment">/**</span></div><div class="line">    * 限制只能查询Id小于10的用户</div><div class="line">    */</div><div class="line">   <span class="meta">@PreAuthorize</span>(<span class="string">"#id&lt;10"</span>)</div><div class="line">   <span class="function"><span class="keyword">public</span> User <span class="title">find</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">      System.out.println(<span class="string">"find user by id........."</span> + id);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">  </div><div class="line">   <span class="comment">/**</span></div><div class="line">    * 限制只能查询自己的信息</div><div class="line">    */</div><div class="line">   <span class="meta">@PreAuthorize</span>(<span class="string">"principal.username.equals(#username)"</span>)</div><div class="line">   <span class="function"><span class="keyword">public</span> User <span class="title">find</span><span class="params">(String username)</span> </span>&#123;</div><div class="line">      System.out.println(<span class="string">"find user by username......"</span> + username);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">   <span class="comment">/**</span></div><div class="line">    * 限制只能新增用户名称为abc的用户</div><div class="line">    */</div><div class="line">   <span class="meta">@PreAuthorize</span>(<span class="string">"#user.name.equals('abc')"</span>)</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(User user)</span> </span>&#123;</div><div class="line">      System.out.println(<span class="string">"addUser............"</span> + user);</div><div class="line">   &#125;</div><div class="line"> </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;在上面代码中我们定义了调用find(int id)方法时，只允许参数id小于10的调用；调用find(String username)时只允许username为当前用户的用户名；定义了调用add()方法时只有当参数user的name为abc时才可以调用。<br>&emsp;&emsp;有时候可能你会想在方法调用完之后进行权限检查，这种情况比较少，但是如果你有的话，Spring Security也为我们提供了支持，通过@PostAuthorize可以达到这一效果。使用@PostAuthorize时我们可以使用内置的表达式returnObject表示方法的返回值。我们来看下面这一段示例代码。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@PostAuthorize</span>(<span class="string">"returnObject.id%2==0"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> User <span class="title">find</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">  User user = <span class="keyword">new</span> User();</div><div class="line">  user.setId(id);</div><div class="line">  <span class="keyword">return</span> user;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;上面这一段代码表示将在方法find()调用完成后进行权限检查，如果返回值的id是偶数则表示校验通过，否则表示校验失败，将抛出AccessDeniedException。       需要注意的是@PostAuthorize是在方法调用完成后进行权限检查，它不能控制方法是否能被调用，只能在方法调用完成后检查权限决定是否要抛出AccessDeniedException。<br>使用@PreFilter和@PostFilter进行过滤<br>6.2 使用@PreFilter和@PostFilter可以对集合类型的参数或返回值进行过滤。<br>使用@PreFilter和@PostFilter时，Spring Security将移除使对应表达式的结果为false的元素。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@PostFilter</span>(<span class="string">"filterObject.id%2==0"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">findAll</span><span class="params">()</span> </span>&#123;</div><div class="line">  List&lt;User&gt; userList = <span class="keyword">new</span> ArrayList&lt;User&gt;();</div><div class="line">  User user;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++) &#123;</div><div class="line">     user = <span class="keyword">new</span> User();</div><div class="line">     user.setId(i);</div><div class="line">     userList.add(user);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> userList;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;上述代码表示将对返回结果中id不为偶数的user进行移除。filterObject是使用@PreFilter和@PostFilter时的一个内置表达式，表示集合中的当前对象。当@PreFilter标注的方法拥有多个集合类型的参数时，需要通过@PreFilter的filterTarget属性指定当前@PreFilter是针对哪个参数进行过滤的。如下面代码就通过filterTarget指定了当前@PreFilter是用来过滤参数ids的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@PreFilter</span>(filterTarget=<span class="string">"ids"</span>, value=<span class="string">"filterObject%2==0"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(List&lt;Integer&gt; ids, List&lt;String&gt; usernames)</span> </span>&#123;</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>七. <strong>方法权限控制的拦截器</strong><br>&emsp;&emsp;关于方法权限控制，Spring Security提供了两类AbstractSecurityInterceptor，基于AOP Alliance的MethodSecurityInterceptor，和基于Aspectj继承自MethodSecurityInterceptor的AspectJMethodSecurityInterceptor。<br>7.1 <strong>MethodSecurityInterceptor</strong><br>&emsp;&emsp;当我们在使用基于NameSpace进行方法保护的配置时，Spring Security默认配置的就是MethodSecurityInterceptor。根据配置的不同，一个拦截器可能只是针对于一个bean，也可能是针对于多个bean的。MethodSecurityInterceptor使用一个MethodSecurityMetadataSource的实例来获取特定方法调用配置的ConfigAttribute。当我们在ApplicationContext配置文件中使用intercept-methods元素或protect-point元素定义需要保护的方法调用时，Spring Security内部默认会使用一个MapBasedMethodSecurityMetadataSource来保存在这些元素上定义的配置信息，保存的key是对应的方法名（可以是含有通配符的）。类似的使用JSR-250注解时将使用Jsr250MethodSecurityMetadataSource解析配置属性；使用@Secured注解时将使用SecuredAnnotationSecurityMetadataSource解析配置属性；使用pre-post-annotations时将使用PrePostAnnotationSecurityMetadataSource解析配置属性。<br>&emsp;&emsp;MethodSecurityInterceptor是实现了MethodInterceptor接口的，所以我们在使用Spring Aop时，可以自己配置一个MethodSecurityInterceptor的bean。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 自定义MethodSecurityInterceptor --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"methodSecurityInterceptor"</span></span></div><div class="line"><span class="attr">class</span>=<span class="string">"org.springframework.security.access.intercept.aopalliance.MethodSecurityInterceptor"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"authenticationManager"</span> <span class="attr">ref</span>=<span class="string">"authenticationManager"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"accessDecisionManager"</span> <span class="attr">ref</span>=<span class="string">"accessDecisionManager"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"afterInvocationManager"</span> <span class="attr">ref</span>=<span class="string">"afterInvocationManager"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"securityMetadataSource"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">security:method-security-metadata-source</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- 指定需要受保护的方法和需要的权限 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">security:protect</span> <span class="attr">method</span>=<span class="string">"com.xxx.service.UserService.find*"</span></span></div><div class="line">            <span class="attr">access</span>=<span class="string">"ROLE_USER"</span> /&gt;</div><div class="line">        <span class="tag">&lt;<span class="name">security:protect</span> <span class="attr">method</span>=<span class="string">"com.xxx.service.UserService.delete*"</span></span></div><div class="line">            <span class="attr">access</span>=<span class="string">"ROLE_ADMIN"</span> /&gt;</div><div class="line">     <span class="tag">&lt;/<span class="name">security:method-security-metadata-source</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;定义了MethodSecurityInterceptor以后，我们需要类似AOP配置那样，配置哪些该MethodInterceptor需要拦截哪些方法的执行。这种可选配置是很多种的，因为我们这里只是拦截UserService中的具体方法，所以就采用基于bean name的自动代理。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 基于bean的拦截 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.aop.framework.autoproxy.BeanNameAutoProxyCreator"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"interceptorNames"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">list</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>methodSecurityInterceptor<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"beanNames"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">list</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>userService<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>按照上面的配置，我们在访问UserService的find方法时就需要ROLE_USER的权限，而访问delete方法时则需要ROLE_ADMIN权限。</p>
<p>7.2 <strong>AspectJMethodSecurityInterceptor</strong><br>&emsp;&emsp;AspectJMethodSecurityInterceptor是继承自MethodSecurityInterceptor的，不同的是AspectJMethodSecurityInterceptor是用来支持AspectJ的JointPoint的，但在底层还是会把它封装成一个MethodInvocation进行调用。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://clq2owesome.github.io/2017/08/15/Spring/Security/配置十七：基于方法的权限控制/" data-id="cjei8qk7z00a86gbl5xxo69o5" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Spring/Security/配置十一：匿名认证" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/15/Spring/Security/配置十一：匿名认证/" class="article-date">
  <time datetime="2017-08-15T02:09:45.000Z" itemprop="datePublished">2017-08-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>►<a class="article-category-link" href="/categories/Spring/Security/">Security</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/15/Spring/Security/配置十一：匿名认证/">配置十一：匿名认证</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&emsp;&emsp;对于匿名访问的用户，Spring Security支持为其建立一个匿名的AnonymousAuthenticationToken存放在SecurityContextHolder中，这就是所谓的匿名认证。这样在以后进行权限认证或者做其它操作时我们就不需要再判断SecurityContextHolder中持有的Authentication对象是否为null了，而直接把它当做一个正常的Authentication进行使用就OK了。 </p>
<p>一. <strong>配置</strong><br>&emsp;&emsp;使用NameSpace时，http元素的使用默认就会启用对匿名认证的支持，不过我们也可以通过设置http元素下的anonymous元素的enabled属性为false停用对匿名认证的支持。以下是anonymous元素可以配置的属性，以及它们的默认值。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:anonymous</span> <span class="attr">enabled</span>=<span class="string">"true"</span> <span class="attr">key</span>=<span class="string">"doesNotMatter"</span> <span class="attr">username</span>=<span class="string">"anonymousUser"</span> <span class="attr">granted-authority</span>=<span class="string">"ROLE_ANONYMOUS"</span>/&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;key用于指定一个在AuthenticationFilter和AuthenticationProvider之间共享的值。username用于指定匿名用户所对应的用户名，granted-authority用于指定匿名用户所具有的权限。<br>&emsp;&emsp;与匿名认证相关的类有三个，AnonymousAuthenticationToken将作为一个Authentication的实例存放在SecurityContextHolder中；过滤器运行到AnonymousAuthenticationFilter时，如果SecurityContextHolder中持有的Authentication还是空的，则AnonymousAuthenticationFilter将创建一个AnonymousAuthenticationToken并存放在SecurityContextHolder中。最后一个相关的类是AnonymousAuthenticationProvider，其会添加到ProviderManager的AuthenticationProvider列表中，以支持对AnonymousAuthenticationToken的认证。AnonymousAuthenticationToken的认证是在AbstractSecurityInterceptor中的beforeInvocation()方法中进行的。使用http元素定义时这些bean都是会自动定义和添加的。如果需要手动定义这些bean的话，那么可以如下定义：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;anonymousAuthFilter&quot;</div><div class="line">   class=&quot;org.springframework.security.web.authentication.AnonymousAuthenticationFilter&quot;&gt;</div><div class="line">  &lt;property name=&quot;key&quot; value=&quot;doesNotMatter&quot; /&gt;</div><div class="line">  &lt;property name=&quot;userAttribute&quot; value=&quot;anonymousUser,ROLE_ANONYMOUS&quot; /&gt;</div><div class="line">&lt;/bean&gt;</div><div class="line"></div><div class="line">&lt;bean id=&quot;anonymousAuthenticationProvider&quot;</div><div class="line">class=&quot;org.springframework.security.authentication.AnonymousAuthenticationProvider&quot;&gt;</div><div class="line">  &lt;property name=&quot;key&quot; value=&quot;doesNotMatter&quot; /&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;key是在AnonymousAuthenticationProvider和AnonymousAuthenticationFilter之间共享的，它们必须保持一致，AnonymousAuthenticationProvider将使用本身拥有的key与传入的AnonymousAuthenticationToken的key作比较，相同则认为可以进行认证，否则将抛出异常BadCredentialsException。userAttribute属性是以usernameInTheAuthenticationToken,grantedAuthority[,grantedAuthority]的形式进行定义的。</p>
<p> 二. <strong>AuthenticationTrustResolver</strong><br> &emsp;&emsp; AuthenticationTrustResolver是一个接口，其中定义有两个方法，isAnonymous()和isRememberMe()，它们都接收一个Authentication对象作为参数。它有一个默认实现类AuthenticationTrustResolverImpl，Spring Security就是使用它来判断一个SecurityContextHolder持有的Authentication是否AnonymousAuthenticationToken或RememberMeAuthenticationToken。如当ExceptionTranslationFilter捕获到一个AccessDecisionManager后就会使用它来判断当前Authentication对象是否为一个AnonymousAuthenticationToken，如果是则交由AuthenticationEntryPoint处理，否则将返回403错误码。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://clq2owesome.github.io/2017/08/15/Spring/Security/配置十一：匿名认证/" data-id="cjei8qk7y00a56gbl1efjo9at" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Spring/Security/实践运用整合" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/15/Spring/Security/实践运用整合/" class="article-date">
  <time datetime="2017-08-15T02:09:45.000Z" itemprop="datePublished">2017-08-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>►<a class="article-category-link" href="/categories/Spring/Security/">Security</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/15/Spring/Security/实践运用整合/">实践运用整合</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="添加相应的jar包"><a href="#添加相应的jar包" class="headerlink" title="添加相应的jar包"></a>添加相应的jar包</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&lt;!-- spring security start  --&gt;</div><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-security-config&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;4.0.3.RELEASE&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div><div class="line">    &lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-security-core&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;4.0.3.RELEASE&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div><div class="line">&lt;dependency&gt;</div><div class="line">    &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;</div><div class="line">    &lt;artifactId&gt;spring-security-web&lt;/artifactId&gt;</div><div class="line">    &lt;version&gt;4.0.3.RELEASE&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div><div class="line">&lt;!-- spring security end  --&gt;</div></pre></td></tr></table></figure>
<h2 id="web-xml中添加相应过滤器"><a href="#web-xml中添加相应过滤器" class="headerlink" title="web.xml中添加相应过滤器"></a>web.xml中添加相应过滤器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&lt;!-- Spring security过滤器，需要注意的是该filter一定要定义在其它如SpringMVC等拦截请求之前 --&gt;</div><div class="line">&lt;!-- Spring security start --&gt;</div><div class="line">&lt;filter&gt;</div><div class="line">	&lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;</div><div class="line">	&lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;/filter-class&gt;</div><div class="line">&lt;/filter&gt;</div><div class="line">&lt;filter-mapping&gt;</div><div class="line">	&lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;</div><div class="line">	&lt;url-pattern&gt;/*&lt;/url-pattern&gt;</div><div class="line">&lt;/filter-mapping&gt;</div><div class="line">&lt;!-- Spring security end  --&gt;</div></pre></td></tr></table></figure>
<p><strong>注意</strong>：filter-name一定要写成springSecurityFilterChain。在DelegatingFilterProxy类init时，会获取filter-name，然后通过filter-name去spring中获取代理的bean</p>
<h2 id="applicationContext-security-xml配置"><a href="#applicationContext-security-xml配置" class="headerlink" title="applicationContext-security.xml配置"></a>applicationContext-security.xml配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div></pre></td><td class="code"><pre><div class="line">&lt;beans:beans xmlns=&quot;http://www.springframework.org/schema/security&quot;</div><div class="line">	xmlns:beans=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</div><div class="line">	xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans</div><div class="line">	http://www.springframework.org/schema/beans/spring-beans-4.1.xsd</div><div class="line">	http://www.springframework.org/schema/jdbc</div><div class="line">	http://www.springframework.org/schema/jdbc/spring-jdbc-4.1.xsd</div><div class="line">	http://www.springframework.org/schema/security</div><div class="line">	http://www.springframework.org/schema/security/spring-security-4.0.xsd&quot;&gt;</div><div class="line"></div><div class="line">	&lt;!-- 启用注解  --&gt;</div><div class="line">	&lt;global-method-security secured-annotations=&quot;enabled&quot;</div><div class="line">		jsr250-annotations=&quot;enabled&quot; pre-post-annotations=&quot;enabled&quot; /&gt;</div><div class="line"></div><div class="line"></div><div class="line">        &lt;!-- 配置不需要权限验证页面和资源 --&gt;</div><div class="line">	&lt;http pattern=&quot;/admin/login.jsp&quot; security=&quot;none&quot;/&gt;&lt;!--登录页面  --&gt;</div><div class="line">	&lt;http pattern=&quot;/admin/xx/**&quot; security=&quot;none&quot;/&gt;&lt;!--静态资源 --&gt;</div><div class="line">	&lt;http pattern=&quot;/admin/none/**&quot; security=&quot;none&quot;/&gt;</div><div class="line">	</div><div class="line">	&lt;http use-expressions=&quot;true&quot; pattern=&quot;/admin/**&quot;  </div><div class="line">	  entry-point-ref=&quot;authenticationProcessingFilterEntryPoint&quot; </div><div class="line">	  authentication-manager-ref=&quot;adminAuthenticationManager&quot;&gt;  </div><div class="line">	               </div><div class="line">		&lt;!-- 是否关闭csrf，spring security4默认为开启  --&gt;</div><div class="line">		&lt;csrf disabled=&quot;true&quot; /&gt; </div><div class="line">		</div><div class="line">		&lt;!-- 设置可以在iframe显示数据  --&gt;</div><div class="line">		&lt;headers&gt;</div><div class="line">	        &lt;frame-options policy=&quot;SAMEORIGIN&quot;/&gt;</div><div class="line">	    &lt;/headers&gt;</div><div class="line">	    </div><div class="line">	    &lt;port-mappings&gt;</div><div class="line">		     &lt;port-mapping http=&quot;8080&quot; https=&quot;9988&quot;/&gt;</div><div class="line">		&lt;/port-mappings&gt;</div><div class="line">	</div><div class="line">		&lt;!--  权限校验 --&gt;</div><div class="line">		&lt;intercept-url pattern=&quot;/admin/index.jsp&quot; access=&quot;hasAuthority(&apos;admin:role&apos;) or hasAuthority(&apos;SUPER_ADMIN&apos;)&quot; /&gt;</div><div class="line">		&lt;intercept-url pattern=&quot;/admin/menu/**&quot; access=&quot;hasAuthority(&apos;admin:role&apos;) or hasAuthority(&apos;SUPER_ADMIN&apos;)&quot; /&gt;</div><div class="line">		&lt;intercept-url pattern=&quot;/admin/pattern/**&quot; access=&quot;hasAuthority(&apos;admin:role&apos;) or hasAuthority(&apos;SUPER_ADMIN&apos;)&quot; /&gt;</div><div class="line">		&lt;intercept-url pattern=&quot;/admin/odds/**&quot; access=&quot;hasAuthority(&apos;admin:role&apos;) or hasAuthority(&apos;SUPER_ADMIN&apos;)&quot; /&gt;</div><div class="line">		&lt;intercept-url pattern=&quot;/admin/period/**&quot; access=&quot;hasAuthority(&apos;admin:role&apos;) or hasAuthority(&apos;SUPER_ADMIN&apos;)&quot; /&gt;</div><div class="line">		&lt;intercept-url pattern=&quot;/admin/code/**&quot; access=&quot;hasAuthority(&apos;admin:role&apos;) or hasAuthority(&apos;SUPER_ADMIN&apos;)&quot; /&gt;</div><div class="line">		&lt;intercept-url pattern=&quot;/admin/code/collection/**&quot; access=&quot;hasAuthority(&apos;admin:role&apos;) or hasAuthority(&apos;SUPER_ADMIN&apos;)&quot; /&gt;</div><div class="line">		&lt;intercept-url pattern=&quot;/admin/member/**&quot; access=&quot;hasAuthority(&apos;admin:role&apos;) or hasAuthority(&apos;SUPER_ADMIN&apos;)&quot; /&gt;</div><div class="line">		&lt;intercept-url pattern=&quot;/admin/statistics/**&quot; access=&quot;hasAuthority(&apos;admin:role&apos;) or hasAuthority(&apos;SUPER_ADMIN&apos;)&quot; /&gt;</div><div class="line">		&lt;intercept-url pattern=&quot;/admin/order/**&quot; access=&quot;hasAuthority(&apos;admin:role&apos;) or hasAuthority(&apos;SUPER_ADMIN&apos;)&quot; /&gt;</div><div class="line">	</div><div class="line">          </div><div class="line">                &lt;form-login login-page=&quot;/admin/login.jsp&quot;</div><div class="line">    	      	username-parameter=&quot;account&quot; password-parameter=&quot;pwd&quot; </div><div class="line">    	         login-processing-url=&quot;/admin/loginIn&quot; </div><div class="line">    	         authentication-success-handler-ref=&quot;authSuccess&quot;</div><div class="line">    	         authentication-failure-handler-ref=&quot;authFailure&quot;</div><div class="line">                /&gt;</div><div class="line">	       </div><div class="line">	       &lt;logout invalidate-session=&quot;true&quot; logout-url=&quot;/admin/loginOut&quot;</div><div class="line">			success-handler-ref=&quot;adminLogoutSuccessHandler&quot; delete-cookies=&quot;JSESSIONID&quot; /&gt;</div><div class="line">	       </div><div class="line">		      </div><div class="line">	      &lt;access-denied-handler ref=&quot;adminAccessDeniedHandler&quot; /&gt;</div><div class="line">		      </div><div class="line">		  &lt;!-- remember me功能 --&gt;</div><div class="line">    	  &lt;remember-me user-service-ref=&quot;adminDetailsService&quot; </div><div class="line">    			key=&quot;clq&quot; token-validity-seconds=&quot;18000&quot;</div><div class="line">    			remember-me-parameter=&quot;rememberMe&quot; token-repository-ref=&quot;adminTokenRepository&quot;/&gt;</div><div class="line">					</div><div class="line">		&lt;!-- 控制同时在线人数  --&gt;</div><div class="line">           &lt;session-management &gt;</div><div class="line">			&lt;concurrency-control max-sessions=&quot;1&quot; session-registry-ref=&quot;sessionRegistry&quot;</div><div class="line">			expired-url=&quot;/admin/none/session_expired.jsp&quot; /&gt; </div><div class="line">		&lt;/session-management&gt;</div><div class="line">			</div><div class="line">    &lt;/http&gt;  </div><div class="line">    </div><div class="line">    &lt;!-- 登录成功处理类 --&gt;</div><div class="line">    &lt;beans:bean id=&quot;authSuccess&quot; class=&quot;com.xx.security.admin.AuthenticationSuccessHandlerImpl&quot;&gt;&lt;/beans:bean&gt;</div><div class="line">    &lt;!--  登录失败处理类 --&gt;</div><div class="line">    &lt;beans:bean id=&quot;authFailure&quot; class=&quot;com.xx.security.admin.AuthenticationFailureHandlerImpl&quot;&gt;&lt;/beans:bean&gt;</div><div class="line">    &lt;!--  没有权限处理类 --&gt;</div><div class="line">    &lt;beans:bean id=&quot;adminAccessDeniedHandler&quot; class=&quot;com.xx.security.admin.AdminAccessDeniedHandler&quot;&gt;&lt;/beans:bean&gt;</div><div class="line">    &lt;!--  退出成功处理类 --&gt;</div><div class="line">    &lt;beans:bean id=&quot;adminLogoutSuccessHandler&quot; class=&quot;com.xx.security.admin.AdminLogoutSuccessHandler&quot;&gt;&lt;/beans:bean&gt;</div><div class="line">    </div><div class="line">    </div><div class="line">    &lt;authentication-manager id=&quot;adminAuthenticationManager&quot;&gt;  </div><div class="line">        &lt;authentication-provider ref=&quot;adminAuthenticationProvider&quot;&gt;  </div><div class="line">        &lt;/authentication-provider&gt;  </div><div class="line">    &lt;/authentication-manager&gt;</div><div class="line">    </div><div class="line">    &lt;beans:bean id=&quot;adminDetailsService&quot; class=&quot;com.xx.security.admin.AdminDetailsService&quot;&gt;&lt;/beans:bean&gt;</div><div class="line">    </div><div class="line">    &lt;beans:bean id=&quot;adminAuthenticationProvider&quot;  class=&quot;com.xx.security.admin.AdminAuthenticationProvider&quot;&gt;</div><div class="line">        &lt;beans:property name=&quot;userDetailsService&quot; ref=&quot;adminDetailsService&quot; /&gt;</div><div class="line">    &lt;/beans:bean&gt;  </div><div class="line">    </div><div class="line">    &lt;!-- AuthenticationEntryPoint，引导用户进行登录 --&gt;</div><div class="line">   &lt;beans:bean id=&quot;authenticationProcessingFilterEntryPoint&quot; class=&quot;org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint&quot;&gt;</div><div class="line">       &lt;beans:constructor-arg name=&quot;loginFormUrl&quot; value=&quot;/admin/login.jsp&quot;  /&gt;</div><div class="line">    &lt;/beans:bean&gt;</div><div class="line">    </div><div class="line">    &lt;beans:bean id=&quot;adminTokenRepository&quot;</div><div class="line">		class=&quot;com.xx.security.admin.AdminJdbcTokenRepositoryImpl&quot;&gt;</div><div class="line">		&lt;!-- 数据源 --&gt;</div><div class="line">		&lt;beans:property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;</div><div class="line">		&lt;!-- 是否在系统启动时创建持久化token的数据库表 --&gt;</div><div class="line">		&lt;beans:property name=&quot;createTableOnStartup&quot; value=&quot;false&quot; /&gt;</div><div class="line">	&lt;/beans:bean&gt;</div><div class="line">	</div><div class="line">  &lt;beans:bean id=&quot;sessionRegistry&quot; class=&quot;org.springframework.security.core.session.SessionRegistryImpl&quot; /&gt;</div><div class="line"></div><div class="line">&lt;/beans:beans&gt;</div></pre></td></tr></table></figure>
<h2 id="AdminDetails（权限实体"><a href="#AdminDetails（权限实体" class="headerlink" title="AdminDetails（权限实体)"></a>AdminDetails（权限实体)</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">package com.xx.security.admin;</div><div class="line"></div><div class="line">import java.util.Collection;</div><div class="line">import org.springframework.security.core.GrantedAuthority;</div><div class="line">import org.springframework.security.core.userdetails.User;</div><div class="line"></div><div class="line">public class AdminDetails extends User &#123;</div><div class="line">	private static final long serialVersionUID = 1L;</div><div class="line">    </div><div class="line">	private Integer id;</div><div class="line">	private Byte enable;//是否可用：1:可用   -1:禁用</div><div class="line">	private Byte isSys;//是否是超级管理员：1:是  -1：否</div><div class="line"></div><div class="line">	public AdminDetails(String username, String password, boolean enabled, boolean accountNonExpired,</div><div class="line">			boolean credentialsNonExpired, boolean accountNonLocked, Collection&lt;? extends GrantedAuthority&gt; authorities,</div><div class="line">			Byte enable, Byte isSys, Integer id) &#123;</div><div class="line">		super(username, password, enabled, accountNonExpired, credentialsNonExpired, accountNonLocked, authorities);</div><div class="line"></div><div class="line">		this.id = id;</div><div class="line">		this.enable = enable;</div><div class="line">		this.isSys = isSys;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public AdminDetails(String username, String password, Collection&lt;? extends GrantedAuthority&gt; authorities,</div><div class="line">			Byte enable, Byte isSys, Integer id) &#123;</div><div class="line">		super(username, password, authorities);</div><div class="line"></div><div class="line">		this.id = id;</div><div class="line">		this.enable = enable;</div><div class="line">		this.isSys = isSys;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public Integer getId() &#123;</div><div class="line">		return id;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void setId(Integer id) &#123;</div><div class="line">		this.id = id;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public Byte getEnable() &#123;</div><div class="line">		return enable;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void setEnable(Byte enable) &#123;</div><div class="line">		this.enable = enable;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public Byte getIsSys() &#123;</div><div class="line">		return isSys;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public void setIsSys(Byte isSys) &#123;</div><div class="line">		this.isSys = isSys;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="加载权限Service"><a href="#加载权限Service" class="headerlink" title="加载权限Service"></a>加载权限Service</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line">package com.xx.security.admin;</div><div class="line"></div><div class="line">import java.util.HashSet;</div><div class="line">import java.util.List;</div><div class="line">import java.util.Set;</div><div class="line"></div><div class="line">import javax.annotation.Resource;</div><div class="line"></div><div class="line">import org.slf4j.Logger;</div><div class="line">import org.slf4j.LoggerFactory;</div><div class="line">import org.springframework.security.core.authority.SimpleGrantedAuthority;</div><div class="line">import org.springframework.security.core.userdetails.UserDetails;</div><div class="line">import org.springframework.security.core.userdetails.UserDetailsService;</div><div class="line">import org.springframework.security.core.userdetails.UsernameNotFoundException;</div><div class="line">import org.springframework.transaction.annotation.Transactional;</div><div class="line">import org.springframework.util.Assert;</div><div class="line"></div><div class="line">import com.lhc.entity.jpa.SysAdminEntity;</div><div class="line">import com.lhc.entity.jpa.SysAuthorityEntity;</div><div class="line">import com.lhc.entity.jpa.SysRoleEntity;</div><div class="line">import com.lhc.repository.SysAdminJpaRepository;</div><div class="line">import com.lhc.security.constants.AdminSecurityConstant;</div><div class="line"></div><div class="line">@Transactional</div><div class="line">public class AdminDetailsService implements UserDetailsService &#123;</div><div class="line">	private static final Logger logger = LoggerFactory.getLogger(AdminDetailsService.class);</div><div class="line"></div><div class="line">	@Resource</div><div class="line">	SysAdminJpaRepository sysAdminJpaRepository;</div><div class="line">	</div><div class="line">	public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException &#123;</div><div class="line">		</div><div class="line">		    logger.info(&quot;loadUserByUsername start&quot;);</div><div class="line">		     logger.info(&quot;username: &#123;&#125;&quot;, username);</div><div class="line">		     </div><div class="line">		     SysAdminEntity sysAdminEntity = sysAdminJpaRepository.findByUsername(username);</div><div class="line">		     </div><div class="line">		     Assert.notNull(sysAdminEntity, &quot;[username:&quot; + username + &quot;] admin is not exist&quot;);</div><div class="line">		     /*if (null == sysAdminEntity) &#123;</div><div class="line">		    	 throw new UsernameNotFoundException(&quot;[username:&quot; + username + &quot;] admin is not exist&quot;);</div><div class="line">		     &#125;*/</div><div class="line">		     </div><div class="line">		     if (sysAdminEntity.getIsSys().equals(AdminSecurityConstant.SUPER_ADMIN_YES)) &#123;</div><div class="line">			      Set&lt;SimpleGrantedAuthority&gt; supuerAuthority = new HashSet&lt;SimpleGrantedAuthority&gt;();</div><div class="line">			      SimpleGrantedAuthority superAuth = new SimpleGrantedAuthority(&quot;SUPER_ADMIN&quot;);</div><div class="line">			      supuerAuthority.add(superAuth);</div><div class="line">			       </div><div class="line">			 </div><div class="line">			      AdminDetails adminDetails = new AdminDetails(sysAdminEntity.getUsername(), sysAdminEntity.getPassword(), </div><div class="line">			    		  true, true, true, true, supuerAuthority, sysAdminEntity.getEnable(), </div><div class="line">			    		  sysAdminEntity.getIsSys(),  sysAdminEntity.getId());</div><div class="line">			       </div><div class="line">			      logger.info(&quot;the loginer is super admin ,loadUserByUsername end&quot;);</div><div class="line">			      return adminDetails;</div><div class="line">		     &#125;</div><div class="line">		     </div><div class="line">		     List&lt;SysRoleEntity&gt; roleList = sysAdminEntity.getListOfSysRole();</div><div class="line">		     </div><div class="line">		     Assert.notEmpty(roleList, &quot;[username:&quot; + username + &quot;] admin has not roles&quot;);</div><div class="line">		    /*if ((null == roleList) || (roleList.size() == 0)) &#123;</div><div class="line">		    	throw new UsernameNotFoundException(&quot;[username:&quot; + username + &quot;] admin has not roles&quot;);</div><div class="line">		     &#125;*/</div><div class="line">		     </div><div class="line">		     Set&lt;SimpleGrantedAuthority&gt; authorities = new HashSet&lt;SimpleGrantedAuthority&gt;();</div><div class="line">		    SimpleGrantedAuthority auth = null;</div><div class="line">		     for (SysRoleEntity sysRoleEntity : roleList) &#123;</div><div class="line">			      if (sysRoleEntity.getEnable().equals(AdminSecurityConstant.ENABLE_YES)) &#123;</div><div class="line">			         </div><div class="line">				         List&lt;SysAuthorityEntity&gt; authList = sysRoleEntity.getListOfsysAuthority();</div><div class="line">				         for (SysAuthorityEntity sysAuthorityEntity : authList) &#123;</div><div class="line">					         auth = new SimpleGrantedAuthority(sysAuthorityEntity.getAuthMark());</div><div class="line">					         authorities.add(auth);</div><div class="line">				         &#125;</div><div class="line">			       &#125;</div><div class="line">		     &#125;</div><div class="line">		     </div><div class="line">		     Assert.notEmpty(authorities, &quot;[username:&quot; + username + &quot;] admin has not roles&quot;);</div><div class="line">		     /*if ((null == authorities) || (authorities.size() == 0)) &#123;</div><div class="line">		    	 throw new UsernameNotFoundException(&quot;[username:&quot; + username + &quot;] admin has not authorities&quot;);</div><div class="line">		     &#125;*/</div><div class="line">		     </div><div class="line">		     for (SimpleGrantedAuthority sga : authorities) &#123;</div><div class="line">		    	 System.out.println(&quot;登录用户所拥有的权限：&quot; + sga.getAuthority());</div><div class="line">		     &#125;</div><div class="line">		 </div><div class="line">		   AdminDetails adminDetails = new AdminDetails(sysAdminEntity.getUsername(), sysAdminEntity.getPassword(), </div><div class="line">				   true, true, true, true, authorities, sysAdminEntity.getEnable(), </div><div class="line">				   sysAdminEntity.getIsSys(),  sysAdminEntity.getId());</div><div class="line">		     </div><div class="line">		    logger.info(&quot;loadUserByUsername end&quot;);</div><div class="line">		    return adminDetails;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<h2 id="权限校验提供者（Provider）"><a href="#权限校验提供者（Provider）" class="headerlink" title="权限校验提供者（Provider）"></a>权限校验提供者（Provider）</h2><p>加载完权限后，在此校验<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">package com.xx.security.admin;</div><div class="line"></div><div class="line">import org.apache.commons.logging.Log;</div><div class="line">import org.apache.commons.logging.LogFactory;</div><div class="line">import org.springframework.security.authentication.BadCredentialsException;</div><div class="line">import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</div><div class="line">import org.springframework.security.authentication.dao.DaoAuthenticationProvider;</div><div class="line">import org.springframework.security.core.AuthenticationException;</div><div class="line">import org.springframework.security.core.userdetails.UserDetails;</div><div class="line"></div><div class="line">import com.lhc.security.constants.AdminSecurityConstant;</div><div class="line">import com.lhc.utils.EncryptUtil;</div><div class="line"></div><div class="line">public class AdminAuthenticationProvider extends DaoAuthenticationProvider &#123;</div><div class="line">	protected final Log logger = LogFactory.getLog(getClass());</div><div class="line"></div><div class="line">	protected void additionalAuthenticationChecks(UserDetails userDetails,</div><div class="line">			UsernamePasswordAuthenticationToken authentication) throws AuthenticationException &#123;</div><div class="line">		</div><div class="line">		this.logger.info(&quot;AdminAuthenticationProvider:&#123;&#125;  authenticate start&quot;);</div><div class="line">		AdminDetails adminDetails = (AdminDetails) userDetails;</div><div class="line"></div><div class="line">		if (authentication.getCredentials() == null) &#123;</div><div class="line">			this.logger.debug(&quot;Authentication failed: no credentials provided&quot;);</div><div class="line"></div><div class="line">			throw new BadCredentialsException(this.messages</div><div class="line">					.getMessage(&quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;, &quot;Bad credentials&quot;));</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		//获取登录密码</div><div class="line">		String presentedPassword = authentication.getCredentials().toString();</div><div class="line"></div><div class="line">		if (!EncryptUtil.match(presentedPassword, adminDetails.getPassword())) &#123;//校验密码是否一致</div><div class="line">			this.logger.debug(&quot;Authentication failed: password does not match stored value&quot;);</div><div class="line"></div><div class="line">			throw new BadCredentialsException(this.messages</div><div class="line">					.getMessage(&quot;AbstractUserDetailsAuthenticationProvider.badCredentials&quot;, &quot;Bad credentials&quot;));</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		if (adminDetails.getEnable().equals(AdminSecurityConstant.ENABLE_NO)) &#123;</div><div class="line">			this.logger.error(&quot;Authentication failed: &quot; + adminDetails.getUsername() + &quot; is forbided&quot;);</div><div class="line"></div><div class="line">			throw new BadCredentialsException(</div><div class="line">					this.messages.getMessage(&quot;Authentication failed: &quot; + adminDetails.getUsername() + &quot; is forbided&quot;));</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		this.logger.info(&quot;AdminAuthenticationProvider:&#123;&#125;  authenticate end&quot;);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public boolean supports(Class&lt;?&gt; authentication) &#123;</div><div class="line">		return authentication.equals(UsernamePasswordAuthenticationToken.class);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="验证成功处理类"><a href="#验证成功处理类" class="headerlink" title="验证成功处理类"></a>验证成功处理类</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">package com.xx.security.admin;</div><div class="line"></div><div class="line">import java.io.IOException;</div><div class="line">import java.util.Date;</div><div class="line"></div><div class="line">import javax.annotation.Resource;</div><div class="line">import javax.servlet.ServletException;</div><div class="line">import javax.servlet.http.HttpServletRequest;</div><div class="line">import javax.servlet.http.HttpServletResponse;</div><div class="line">import org.apache.commons.logging.Log;</div><div class="line">import org.apache.commons.logging.LogFactory;</div><div class="line">import org.springframework.security.core.Authentication;</div><div class="line">import org.springframework.security.web.DefaultRedirectStrategy;</div><div class="line">import org.springframework.security.web.RedirectStrategy;</div><div class="line">import org.springframework.security.web.authentication.AuthenticationSuccessHandler;</div><div class="line"></div><div class="line">import com.lhc.entity.jpa.MemberEntity;</div><div class="line">import com.lhc.entity.jpa.SysAdminEntity;</div><div class="line">import com.lhc.repository.SysAdminJpaRepository;</div><div class="line">import com.lhc.security.member.MemberDetails;</div><div class="line"></div><div class="line">public class AuthenticationSuccessHandlerImpl implements AuthenticationSuccessHandler &#123;</div><div class="line">	protected final Log logger = LogFactory.getLog(getClass());</div><div class="line">	private RedirectStrategy redirectStrategy = new DefaultRedirectStrategy();</div><div class="line">	private String defaultTargetUrl = &quot;/admin/index.jsp&quot;;</div><div class="line">	</div><div class="line">	@Resource</div><div class="line">	SysAdminJpaRepository sysAdminJpaRepository;</div><div class="line"></div><div class="line">	public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response,</div><div class="line">			Authentication authentication) throws IOException, ServletException &#123;</div><div class="line">		//这里处理验证成功后的逻辑</div><div class="line">			</div><div class="line">		if (response.isCommitted()) &#123;</div><div class="line">			this.logger.debug(&quot;Response has already been committed. Unable to redirect to &quot; + this.defaultTargetUrl);</div><div class="line">			return;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		//更新最后登录时间</div><div class="line">		Object principal = authentication.getPrincipal();</div><div class="line">		AdminDetails adminDetails = null;</div><div class="line">		if (principal instanceof AdminDetails) &#123;</div><div class="line">			adminDetails =  (AdminDetails) principal;</div><div class="line">			SysAdminEntity sysAdminEntity = sysAdminJpaRepository.findOne(adminDetails.getId());</div><div class="line">			sysAdminEntity.setLastLogin(new Date(System.currentTimeMillis()));</div><div class="line">			</div><div class="line">			sysAdminJpaRepository.save(sysAdminEntity);</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		this.logger.info(&quot;admin authentication success&quot;);</div><div class="line">		this.redirectStrategy.sendRedirect(request, response, this.defaultTargetUrl);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="验证失败处理类"><a href="#验证失败处理类" class="headerlink" title="验证失败处理类"></a>验证失败处理类</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">package com.xx.security.admin;</div><div class="line"></div><div class="line">import java.io.IOException;</div><div class="line">import javax.servlet.ServletException;</div><div class="line">import javax.servlet.http.HttpServletRequest;</div><div class="line">import javax.servlet.http.HttpServletResponse;</div><div class="line">import org.slf4j.Logger;</div><div class="line">import org.slf4j.LoggerFactory;</div><div class="line">import org.springframework.security.core.AuthenticationException;</div><div class="line">import org.springframework.security.web.authentication.AuthenticationFailureHandler;</div><div class="line"></div><div class="line">public class AuthenticationFailureHandlerImpl implements AuthenticationFailureHandler &#123;</div><div class="line">	private static final Logger logger = LoggerFactory.getLogger(AuthenticationFailureHandlerImpl.class);</div><div class="line"></div><div class="line">	public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response,</div><div class="line">			AuthenticationException exception) throws IOException, ServletException &#123;</div><div class="line">		//这里处理验证失败处理逻辑	</div><div class="line">		</div><div class="line">		logger.info(&quot;authentication failure&quot;);</div><div class="line">		response.sendError(401, &quot;Authentication Failed: &quot; + exception.getMessage());</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="没有权限处理类"><a href="#没有权限处理类" class="headerlink" title="没有权限处理类"></a>没有权限处理类</h2><p>与验证失败不同，此处是验证成功，但是没有操作权限<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">package com.xx.security.admin;</div><div class="line"></div><div class="line">import java.io.IOException;</div><div class="line"></div><div class="line">import javax.servlet.ServletException;</div><div class="line">import javax.servlet.http.HttpServletRequest;</div><div class="line">import javax.servlet.http.HttpServletResponse;</div><div class="line"></div><div class="line">import org.springframework.security.access.AccessDeniedException;</div><div class="line">import org.springframework.security.web.access.AccessDeniedHandler;</div><div class="line"></div><div class="line">public class AdminAccessDeniedHandler implements AccessDeniedHandler &#123;</div><div class="line">	public void handle(HttpServletRequest request, HttpServletResponse response,</div><div class="line">			AccessDeniedException accessDeniedException) throws IOException, ServletException &#123;</div><div class="line">		response.setHeader(&quot;Content-type&quot;, &quot;text/html;charset=UTF-8&quot;);</div><div class="line">		response.getWriter().print(&quot;您没有操作权限&quot;);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="退出登录处理类"><a href="#退出登录处理类" class="headerlink" title="退出登录处理类"></a>退出登录处理类</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">package com.xx.security.admin;</div><div class="line"></div><div class="line">import java.io.IOException;</div><div class="line">import javax.servlet.ServletException;</div><div class="line">import javax.servlet.http.HttpServletRequest;</div><div class="line">import javax.servlet.http.HttpServletResponse;</div><div class="line">import org.slf4j.Logger;</div><div class="line">import org.slf4j.LoggerFactory;</div><div class="line">import org.springframework.security.core.Authentication;</div><div class="line">import org.springframework.security.web.authentication.logout.LogoutSuccessHandler;</div><div class="line"></div><div class="line">public class AdminLogoutSuccessHandler implements LogoutSuccessHandler &#123;</div><div class="line">	private static final Logger logger = LoggerFactory.getLogger(AdminLogoutSuccessHandler.class);</div><div class="line"></div><div class="line">	public void onLogoutSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</div><div class="line">			throws IOException, ServletException &#123;</div><div class="line">		logger.info(&quot; logout success&quot;);</div><div class="line">		response.sendRedirect(&quot;http://admin.online.com/lhc/none/logout_success.jsp&quot;);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="密码工具"><a href="#密码工具" class="headerlink" title="密码工具"></a>密码工具</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">package com.xx.utils;</div><div class="line"></div><div class="line">import org.springframework.security.crypto.password.PasswordEncoder;</div><div class="line">import org.springframework.security.crypto.password.StandardPasswordEncoder;</div><div class="line"></div><div class="line">/**</div><div class="line"> *  密码处理工具</div><div class="line"> * @author clq</div><div class="line"> */</div><div class="line">public class EncryptUtil &#123;</div><div class="line">	private static final String SITE_WIDE_SECRET = &quot;clq&quot;;</div><div class="line">	private static final PasswordEncoder encoder = new StandardPasswordEncoder(SITE_WIDE_SECRET);</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * 加密</div><div class="line">	 * @param rawPassword</div><div class="line">	 * @return</div><div class="line">	 */</div><div class="line">	public static String encrypt(String rawPassword) &#123;</div><div class="line">		return encoder.encode(rawPassword);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	/**</div><div class="line">	 *  校验密码是否匹配</div><div class="line">	 * @param rawPassword 原始密码</div><div class="line">	 * @param password 加密后的密码</div><div class="line">	 * @return</div><div class="line">	 */</div><div class="line">	public static boolean match(String rawPassword, String password) &#123;</div><div class="line">		return encoder.matches(rawPassword, password);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public static void main(String[] args) &#123;</div><div class="line">		String s = &quot;123456&quot;;</div><div class="line">		String s1 = EncryptUtil.encrypt(s);</div><div class="line">		String s2 = EncryptUtil.encrypt(s);</div><div class="line">        System.out.println(s1);  </div><div class="line">        System.out.println(s2);  </div><div class="line">        System.out.println(match(s, s2));  </div><div class="line">        //但是把每次结果拿出来进行match，你会发现可以得到true。  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="获取登录信息工具类"><a href="#获取登录信息工具类" class="headerlink" title="获取登录信息工具类"></a>获取登录信息工具类</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">package com.xx.security.common;</div><div class="line"></div><div class="line">import org.springframework.data.domain.AuditorAware;</div><div class="line">import org.springframework.security.core.Authentication;</div><div class="line">import org.springframework.security.core.context.SecurityContextHolder;</div><div class="line">import org.springframework.stereotype.Component;</div><div class="line"></div><div class="line">import com.lhc.security.admin.AdminDetails;</div><div class="line">import com.lhc.security.member.MemberDetails;</div><div class="line"></div><div class="line">@Component(&quot;springSecurityAuditorAware&quot;)</div><div class="line">public class SpringSecurityAuditorAware implements AuditorAware&lt;Integer&gt; &#123;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	public Integer getCurrentAuditor() &#123;</div><div class="line"></div><div class="line">		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</div><div class="line"></div><div class="line">		if (authentication == null || !authentication.isAuthenticated()) &#123;</div><div class="line">			return 0;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		Object principal = authentication.getPrincipal();</div><div class="line">		if (principal instanceof AdminDetails) &#123;</div><div class="line">			return ((AdminDetails)principal).getId();</div><div class="line">		&#125;</div><div class="line">		if (principal instanceof MemberDetails) &#123;</div><div class="line">			return ((MemberDetails)principal).getId();</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		return 0;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public AdminDetails getCurrentAdmin() &#123;</div><div class="line">		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</div><div class="line">		</div><div class="line">		if (authentication == null || !authentication.isAuthenticated()) &#123;</div><div class="line">			return null;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		Object principal = authentication.getPrincipal();</div><div class="line">		if (principal instanceof AdminDetails) &#123;</div><div class="line">			return ((AdminDetails)principal);</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		return null;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public MemberDetails getCurrentMember() &#123;</div><div class="line">		Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</div><div class="line">		</div><div class="line">		if (authentication == null || !authentication.isAuthenticated()) &#123;</div><div class="line">			return null;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		Object principal = authentication.getPrincipal();</div><div class="line">		if (principal instanceof MemberDetails) &#123;</div><div class="line">			return ((MemberDetails)principal);</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		return null;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="数据库结构"><a href="#数据库结构" class="headerlink" title="数据库结构"></a>数据库结构</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">CREATE TABLE `sys_admin` (</div><div class="line">  `id` int(10) NOT NULL AUTO_INCREMENT COMMENT &apos;主键&apos;,</div><div class="line">  `name` varchar(50) DEFAULT NULL COMMENT &apos;用户名&apos;,</div><div class="line">  `username` varchar(50) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL COMMENT &apos;登录名&apos;,</div><div class="line">  `password` varchar(100) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL COMMENT &apos;密码&apos;,</div><div class="line">  `last_login` datetime DEFAULT NULL COMMENT &apos;最后登录时间&apos;,</div><div class="line">  `login_ip` varchar(20) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL COMMENT &apos;最后登录的ip&apos;,</div><div class="line">  `enable` int(2) DEFAULT &apos;1&apos; COMMENT &apos;是否可用：1:可用   0:禁用&apos;,</div><div class="line">  `is_sys` int(2) DEFAULT &apos;0&apos; COMMENT &apos;是否是超级管理员：1:是  0：否&apos;,</div><div class="line">  `created_date` datetime DEFAULT NULL COMMENT &apos;创建时间&apos;,</div><div class="line">  `created_by` int(10) DEFAULT &apos;0&apos; COMMENT &apos;创建人&apos;,</div><div class="line">  `modified_date` datetime DEFAULT NULL COMMENT &apos;更新时间&apos;,</div><div class="line">  `modified_by` int(10) DEFAULT &apos;0&apos; COMMENT &apos;更新人&apos;,</div><div class="line">  PRIMARY KEY (`id`)</div><div class="line">) ENGINE=InnoDB AUTO_INCREMENT=5 DEFAULT CHARSET=utf8;</div><div class="line"></div><div class="line">CREATE TABLE `sys_admin_role` (</div><div class="line">  `id` int(10) unsigned NOT NULL AUTO_INCREMENT COMMENT &apos;主键&apos;,</div><div class="line">  `admin_id` int(10) NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;管理员id&apos;,</div><div class="line">  `role_id` int(10) NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;角色id&apos;,</div><div class="line">  PRIMARY KEY (`id`),</div><div class="line">  KEY `FK4k43lklts7m27m6gyy75qvg4h` (`role_id`),</div><div class="line">  KEY `FKcni2xdl3ht8u90us3wwscui99` (`admin_id`),</div><div class="line">  CONSTRAINT `FK4k43lklts7m27m6gyy75qvg4h` FOREIGN KEY (`role_id`) REFERENCES `sys_role` (`id`),</div><div class="line">  CONSTRAINT `FKcni2xdl3ht8u90us3wwscui99` FOREIGN KEY (`admin_id`) REFERENCES `sys_admin` (`id`)</div><div class="line">) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8;</div><div class="line"></div><div class="line">CREATE TABLE `sys_authority` (</div><div class="line">  `id` int(10) NOT NULL AUTO_INCREMENT COMMENT &apos;主键&apos;,</div><div class="line">  `auth_mark` varchar(50) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL COMMENT &apos;权限标示&apos;,</div><div class="line">  `auth_name` varchar(50) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL COMMENT &apos;权限名称&apos;,</div><div class="line">  `auth_desc` varchar(100) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL COMMENT &apos;权限描述&apos;,</div><div class="line">  `enable` int(2) DEFAULT &apos;1&apos; COMMENT &apos;是否可用：1:可用  0:禁用&apos;,</div><div class="line">  `created_date` datetime DEFAULT NULL COMMENT &apos;创建时间&apos;,</div><div class="line">  `created_by` int(10) DEFAULT &apos;0&apos; COMMENT &apos;创建人&apos;,</div><div class="line">  `modified_date` datetime DEFAULT NULL COMMENT &apos;更新时间&apos;,</div><div class="line">  `modified_by` int(10) DEFAULT &apos;0&apos; COMMENT &apos;更新人&apos;,</div><div class="line">  PRIMARY KEY (`id`)</div><div class="line">) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8;</div><div class="line"></div><div class="line">CREATE TABLE `sys_role` (</div><div class="line">  `id` int(10) NOT NULL AUTO_INCREMENT COMMENT &apos;主键&apos;,</div><div class="line">  `role_name` varchar(50) CHARACTER SET utf8 COLLATE utf8_bin DEFAULT NULL COMMENT &apos;角色名称&apos;,</div><div class="line">  `role_desc` varchar(100) DEFAULT NULL COMMENT &apos;角色描述&apos;,</div><div class="line">  `enable` int(2) DEFAULT &apos;1&apos; COMMENT &apos;是否可用：1:可用  0:禁用&apos;,</div><div class="line">  `created_date` datetime DEFAULT NULL COMMENT &apos;创建时间&apos;,</div><div class="line">  `created_by` int(10) DEFAULT &apos;0&apos; COMMENT &apos;创建人&apos;,</div><div class="line">  `modified_date` datetime DEFAULT NULL COMMENT &apos;更新时间&apos;,</div><div class="line">  `modified_by` int(10) DEFAULT &apos;0&apos; COMMENT &apos;更新人&apos;,</div><div class="line">  PRIMARY KEY (`id`)</div><div class="line">) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8;</div><div class="line"></div><div class="line">CREATE TABLE `sys_role_authority` (</div><div class="line">  `id` int(10) NOT NULL AUTO_INCREMENT COMMENT &apos;主键&apos;,</div><div class="line">  `role_id` int(10) NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;角色主键&apos;,</div><div class="line">  `auth_id` int(10) NOT NULL DEFAULT &apos;0&apos; COMMENT &apos;权限主键&apos;,</div><div class="line">  PRIMARY KEY (`id`)</div><div class="line">) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8;</div></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://clq2owesome.github.io/2017/08/15/Spring/Security/实践运用整合/" data-id="cjei8qk7c009e6gblos3v0u7p" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Spring/Security/配置七：缓存UserDetails" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/15/Spring/Security/配置七：缓存UserDetails/" class="article-date">
  <time datetime="2017-08-15T02:09:45.000Z" itemprop="datePublished">2017-08-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>►<a class="article-category-link" href="/categories/Spring/Security/">Security</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/15/Spring/Security/配置七：缓存UserDetails/">配置七：缓存UserDetails</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&emsp;&emsp;Spring Security提供了一个实现了可以缓存UserDetails的UserDetailsService实现类，CachingUserDetailsService。该类的构造接收一个用于真正加载UserDetails的UserDetailsService实现类。当需要加载UserDetails时，其首先会从缓存中获取，如果缓存中没有对应的UserDetails存在，则使用持有的UserDetailsService实现类进行加载，然后将加载后的结果存放在缓存中。UserDetails与缓存的交互是通过UserCache接口来实现的。CachingUserDetailsService默认拥有UserCache的一个空实现引用，NullUserCache。以下是CachingUserDetailsService的类定义。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CachingUserDetailsService</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> UserCache userCache = <span class="keyword">new</span> NullUserCache();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserDetailsService delegate;</div><div class="line"> </div><div class="line">    CachingUserDetailsService(UserDetailsService delegate) &#123;</div><div class="line">        <span class="keyword">this</span>.delegate = delegate;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> UserCache <span class="title">getUserCache</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> userCache;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserCache</span><span class="params">(UserCache userCache)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.userCache = userCache;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> </span>&#123;</div><div class="line">        UserDetails user = userCache.getUserFromCache(username);</div><div class="line"> </div><div class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</div><div class="line">            user = delegate.loadUserByUsername(username);</div><div class="line">        &#125;</div><div class="line"> </div><div class="line">        Assert.notNull(user, <span class="string">"UserDetailsService "</span> + delegate + <span class="string">" returned null for username "</span> + username + <span class="string">". "</span> +</div><div class="line">                <span class="string">"This is an interface contract violation"</span>);</div><div class="line"> </div><div class="line">        userCache.putUserInCache(user);</div><div class="line"> </div><div class="line">        <span class="keyword">return</span> user;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&emsp;&emsp;我们可以看到当缓存中不存在对应的UserDetails时将使用引用的UserDetailsService类型的delegate进行加载。加载后再把它存放到Cache中并进行返回。除了NullUserCache之外，Spring Security还为我们提供了一个基于Ehcache的UserCache实现类，EhCacheBasedUserCache，其源码如下所示。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EhCacheBasedUserCache</span> <span class="keyword">implements</span> <span class="title">UserCache</span>, <span class="title">InitializingBean</span> </span>&#123;</div><div class="line"> </div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log logger = LogFactory.getLog(EhCacheBasedUserCache.class);</div><div class="line"> </div><div class="line">    <span class="keyword">private</span> Ehcache cache;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        Assert.notNull(cache, <span class="string">"cache mandatory"</span>);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> Ehcache <span class="title">getCache</span><span class="params">()</span> </span>&#123;</div><div class="line">        returncache;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">getUserFromCache</span><span class="params">(String username)</span> </span>&#123;</div><div class="line">        Element element = cache.get(username);</div><div class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">            logger.debug(<span class="string">"Cache hit: "</span> + (element != <span class="keyword">null</span>) + <span class="string">"; username: "</span> + username);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (element == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> (UserDetails) element.getValue();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putUserInCache</span><span class="params">(UserDetails user)</span> </span>&#123;</div><div class="line">        Element element = <span class="keyword">new</span> Element(user.getUsername(), user);</div><div class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">            logger.debug(<span class="string">"Cache put: "</span> + element.getKey());</div><div class="line">        &#125;</div><div class="line">        cache.put(element);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeUserFromCache</span><span class="params">(UserDetails user)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</div><div class="line">            logger.debug(<span class="string">"Cache remove: "</span> + user.getUsername());</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.removeUserFromCache(user.getUsername());</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeUserFromCache</span><span class="params">(String username)</span> </span>&#123;</div><div class="line">        cache.remove(username);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCache</span><span class="params">(Ehcache cache)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.cache = cache;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;从上述源码我们可以看到EhCacheBasedUserCache所引用的Ehcache是空的，所以，当我们需要对UserDetails进行缓存时，我们只需要定义一个Ehcache实例，然后把它注入给EhCacheBasedUserCache就可以了。接下来我们来看一下定义一个支持缓存UserDetails的CachingUserDetailsService的示例。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:authentication-manager</span> <span class="attr">alias</span>=<span class="string">"authenticationManager"</span>&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 使用可以缓存UserDetails的CachingUserDetailsService --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:authentication-provider</span></span></div><div class="line">     <span class="attr">user-service-ref</span>=<span class="string">"cachingUserDetailsService"</span> /&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">security:authentication-manager</span>&gt;</span></div><div class="line"><span class="comment">&lt;!-- 可以缓存UserDetails的UserDetailsService --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"cachingUserDetailsService"</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.config.authentication.CachingUserDetailsService"</span>&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 真正加载UserDetails的UserDetailsService --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"userDetailsService"</span>/&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 缓存UserDetails的UserCache --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"userCache"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.core.userdetails.cache.EhCacheBasedUserCache"</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- 用于真正缓存的Ehcache对象 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cache"</span> <span class="attr">ref</span>=<span class="string">"ehcache4UserDetails"</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="comment">&lt;!-- 将使用默认的CacheManager创建一个名为ehcache4UserDetails的Ehcache对象 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"ehcache4UserDetails"</span> <span class="attr">class</span>=<span class="string">"org.springframework.cache.ehcache.EhCacheFactoryBean"</span>/&gt;</span></div><div class="line"><span class="comment">&lt;!-- 从数据库加载UserDetails的UserDetailsService --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"userDetailsService"</span></span></div><div class="line">  <span class="attr">class</span>=<span class="string">"org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp; 在上面的配置中，我们通过EhcacheFactoryBean定义的Ehcache bean对象采用的是默认配置，其将使用默认的CacheManager，即直接通过CacheManager.getInstance()获取当前已经存在的CacheManager对象，如不存在则使用默认配置自动创建一个，当然这可以通过cacheManager属性指定我们需要使用的CacheManager，CacheManager可以通过EhCacheManagerFactoryBean进行定义。此外，如果没有指定对应缓存的名称，默认将使用beanName，在上述配置中即为ehcache4UserDetails，可以通过cacheName属性进行指定。此外，缓存的配置信息也都是使用的默认的。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://clq2owesome.github.io/2017/08/15/Spring/Security/配置七：缓存UserDetails/" data-id="cjei8qk7d009g6gblr14k67g9" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Spring/Security/配置一：配置文件" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/15/Spring/Security/配置一：配置文件/" class="article-date">
  <time datetime="2017-08-15T02:09:45.000Z" itemprop="datePublished">2017-08-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>►<a class="article-category-link" href="/categories/Spring/Security/">Security</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/15/Spring/Security/配置一：配置文件/">配置一：配置文件</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="配置文件（applicationContext-security-xml）"><a href="#配置文件（applicationContext-security-xml）" class="headerlink" title="配置文件（applicationContext-security.xml）"></a>配置文件（applicationContext-security.xml）</h2><p>首先我们为Spring Security专门建立一个Spring的配置文件，该文件就专门用来作为Spring Security的配置。使用Spring Security我们需要引入Spring Security的NameSpace。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">	<span class="attr">xmlns:security</span>=<span class="string">"http://www.springframework.org/schema/security"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></div><div class="line">	http://www.springframework.org/schema/beans/spring-beans-4.1.xsd</div><div class="line">	http://www.springframework.org/schema/jdbc</div><div class="line">	http://www.springframework.org/schema/jdbc/spring-jdbc-4.1.xsd</div><div class="line">	http://www.springframework.org/schema/security</div><div class="line">	http://www.springframework.org/schema/security/spring-security-4.0.xsd"&gt;</div></pre></td></tr></table></figure></p>
<p>Spring Security命名空间的引入可以简化我们的开发，它涵盖了大部分Spring Security常用的功能。它的设计是基于框架内大范围的依赖的，可以被划分为以下几块。</p>
<ul>
<li>Web/Http 安全：这是最复杂的部分。通过建立filter和相关的service bean来实现框架的认证机制。当访问受保护的URL时会将用户引入登录界面或者是错误提示界面。</li>
<li>业务对象或者方法的安全：控制方法访问权限的。</li>
<li>AuthenticationManager：处理来自于框架其他部分的认证请求。</li>
<li>AccessDecisionManager：为Web或方法的安全提供访问决策。会注册一个默认的，但是我们也可以通过普通bean注册的方式使用自定义的AccessDecisionManager。</li>
<li>AuthenticationProvider：AuthenticationManager是通过它来认证用户的。</li>
<li>UserDetailsService：跟AuthenticationProvider关系密切，用来获取用户信息的。</li>
</ul>
<p>引入了Spring Security的NameSpace之后我们就可以使用该命名空间下的元素来配置Spring Security了。首先我们来定义一个http元素，security只是我们使用命名空间的一个前缀。http元素是用于定义Web相关权限控制的。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:http</span> <span class="attr">auto-config</span>=<span class="string">"true"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">"/**"</span> <span class="attr">access</span>=<span class="string">"ROLE_USER"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">security:http</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>如上定义中，intercept-url定义了一个权限控制的规则。pattern属性表示我们将对哪些url进行权限控制，其也可以是一个正则表达式，如上的写法表示我们将对所有的URL进行权限控制；access属性表示在请求对应的URL时需要什么权限，默认配置时它应该是一个以逗号分隔的角色列表，请求的用户只需拥有其中的一个角色就能成功访问对应的URL。这里的“ROLE_USER”表示请求的用户应当具有ROLE<em>USER角色。“ROLE</em>”前缀是一个提示Spring使用基于角色的检查的标记。<br> 有了权限控制的规则了后，接下来我们需要定义一个AuthenticationManager用于认证。我们先来看如下定义：<br> <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"> <span class="tag">&lt;<span class="name">security:authentication-manager</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">security:authentication-provider</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">security:user-service</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">security:user</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">password</span>=<span class="string">"user"</span> <span class="attr">authorities</span>=<span class="string">"ROLE_USER"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">security:user</span> <span class="attr">name</span>=<span class="string">"admin"</span> <span class="attr">password</span>=<span class="string">"admin"</span> <span class="attr">authorities</span>=<span class="string">"ROLE_USER, ROLE_ADMIN"</span>/&gt;</span></div><div class="line">         <span class="tag">&lt;/<span class="name">security:user-service</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">security:authentication-provider</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">security:authentication-manager</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>  authentication-manager元素指定了一个AuthenticationManager，其需要一个AuthenticationProvider（对应authentication-provider元素）来进行真正的认证，默认情况下authentication-provider对应一个DaoAuthenticationProvider，其需要UserDetailsService（对应user-service元素）来获取用户信息UserDetails（对应user元素）。这里我们只是简单的使用user元素来定义用户，而实际应用中这些信息通常都是需要从数据库等地方获取的，这个将放到后续再讲。我们可以看到通过user元素我们可以指定user对应的用户名、密码和拥有的权限。user-service还支持通过properties文件来指定用户信息，如：<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;security:user-service properties=&quot;/WEB-INF/config/users.properties&quot;/&gt;</div><div class="line">其中属性文件应遵循如下格式：</div><div class="line">username=password,grantedAuthority[,grantedAuthority][,enabled|disabled]</div><div class="line">所以，对应上面的配置文件，我们的users.properties文件的内容应该如下所示：</div><div class="line">#username=password,grantedAuthority[,grantedAuthority][,enabled|disabled]</div><div class="line">user=user,ROLE_USER</div><div class="line">admin=admin,ROLE_USER,ROLE_ADMIN</div></pre></td></tr></table></figure></p>
<h2 id="在web-xml中的配置"><a href="#在web-xml中的配置" class="headerlink" title="在web.xml中的配置"></a>在web.xml中的配置</h2><p>  之后我们告诉Spring加载这个配置文件。通常，我们可以在web.xml文件中通过context-param把它指定为Spring的初始配置文件，也可以在对应Spring的初始配置文件中引入它。这里我们采用前者。<br>  <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>/WEB-INF/config/applicationContext.xml,/WEB-INF/config/spring-security.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></div><div class="line"></div><div class="line"> <span class="tag">&lt;<span class="name">listener</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>  Spring的配置文件是通过对应的ContextLoaderListener来加载和初始化的，上述代码中的applicationContext.xml文件就是对应的Spring的配置文件，如果没有可以不用配置。接下来我们还需要在web.xml中定义一个filter用来拦截需要交给Spring Security处理的请求，需要注意的是该filter一定要定义在其它如SpringMVC等拦截请求之前。这里我们将拦截所有的请求，具体做法如下所示：<br>  <figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>springSecurityFilterChain<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>springSecurityFilterChain<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>接下来可以启动我们的应用，然后在浏览器中访问我们的主页。你会看到如下页面。<br><img src="http://dl2.iteye.com/upload/attachment/0103/0351/ad5156ab-b922-3fd0-af21-12b7c01e717f.png" alt="image"><br>因为我们的spring-security.xml文件中配置好了所有的请求都需要“ROLE_USER”权限，所以当我们在请求主页的时候，Spring Security发现我们还没有登录，Spring会引导我们到登录界面。使用正确的用户名和密码（如上面配置的user/user或admin/admin）登录后，如果符合对应的权限我们就可以访问主页了，否则将出现403（禁止访问）界面。<br>可能你会奇怪，我们没有建立上面的登录页面，为什么Spring Security会跳到上面的登录页面呢？  这是我们设置http的auto-config=”true”时Spring Security自动为我们生成的。<br>当指定http元素的auto-config=”true”时，就相当于如下内容的简写。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:http</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:form-login</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:http-basic</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:logout</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">security:http</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这些元素负责建立表单登录、基本的认证和登出处理。它们都可以通过指定对应的属性来改变它们的行为。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://clq2owesome.github.io/2017/08/15/Spring/Security/配置一：配置文件/" data-id="cjei8qk7f009j6gblcurkg7d9" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Spring/Security/配置二十：整合Cas" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/15/Spring/Security/配置二十：整合Cas/" class="article-date">
  <time datetime="2017-08-15T02:09:45.000Z" itemprop="datePublished">2017-08-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>►<a class="article-category-link" href="/categories/Spring/Security/">Security</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/15/Spring/Security/配置二十：整合Cas/">配置二十：整合Cas</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&emsp;&emsp;众所周知，Cas是对单点登录的一种实现。本文假设读者已经了解了Cas的原理及其使用，这些内容在本文将不会讨论。Cas有Server端和Client端，Client端通常对应着我们自己的应用，Spring Security整合Cas指的就是在Spring Security应用中整合Cas Client，以达到使用Cas Server实现单点登录和登出的效果。本文旨在描述如何在Spring Security应用中使用Cas的单点登录。<br>&emsp;&emsp;首先需要将Spring Security对Cas支持的jar包加入到应用的类路径中。如果我们的应用使用Maven构造的，则可以在应用的pom.xml文件中加上如下依赖。    </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-cas<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.security.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
<p>一. <strong>配置登录认证</strong><br>&emsp;&emsp;加入了spring-security-cas-xxx.jar到Spring Security应用的classpath后，我们便可以开始配置我们的Spring Security应用使用Cas进行单点登录了。<br>1.1 <strong>配置AuthenticationEntryPoint</strong><br>&emsp;&emsp;首先需要做的是将应用的登录认证入口改为使用CasAuthenticationEntryPoint。所以首先我们需要配置一个CasAuthenticationEntryPoint对应的bean，然后指定需要进行登录认证时使用该AuthenticationEntryPoint。配置CasAuthenticationEntryPoint时需要指定一个ServiceProperties，该对象主要用来描述service（Cas概念）相关的属性，主要是指定在Cas Server认证成功后将要跳转的地址。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 指定登录入口为casEntryPoint --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">security:http</span>  <span class="attr">entry-point-ref</span>=<span class="string">"casEntryPoint"</span>&gt;</span></div><div class="line">  ...</div><div class="line"><span class="tag">&lt;/<span class="name">security:http</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- 认证的入口 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"casEntryPoint"</span></span></div><div class="line">  <span class="attr">class</span>=<span class="string">"org.springframework.security.cas.web.CasAuthenticationEntryPoint"</span>&gt;</div><div class="line">  <span class="comment">&lt;!-- Cas Server的登录地址 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"loginUrl"</span> <span class="attr">value</span>=<span class="string">"https://localhost:8443/cas/login"</span> /&gt;</span></div><div class="line">  <span class="comment">&lt;!-- service相关的属性 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceProperties"</span> <span class="attr">ref</span>=<span class="string">"serviceProperties"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- 指定service相关信息 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"serviceProperties"</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.cas.ServiceProperties"</span>&gt;</span></div><div class="line">  <span class="comment">&lt;!-- Cas Server认证成功后的跳转地址，这里要跳转到我们的Spring Security应用，之后会由CasAuthenticationFilter处理，默认处理地址为/j_spring_cas_security_check --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"service"</span></span></div><div class="line">     <span class="attr">value</span>=<span class="string">"http://localhost:8080/app/j_spring_cas_security_check"</span> /&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>1.2 <strong>配置CasAuthenticationFilter</strong><br>&emsp;&emsp;之后我们需要配置一个CasAuthenticationFilter，并将其放置在Filter链表中CAS_FILTER的位置，以处理Cas Server认证成功后的页面跳转，用以在Spring Security中进行认证。该Filter会将Cas Server传递过来的ticket（Cas概念）封装成一个Authentication（对应UsernamePasswordAuthenticationToken，其中ticket作为该Authentication的password），然后传递给AuthenticationManager进行认证。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;security:http entry-point-ref=&quot;casEntryPoint&quot;&gt;</div><div class="line">    ...</div><div class="line">  &lt;security:custom-filter ref=&quot;casFilter&quot; position=&quot;CAS_FILTER&quot;/&gt;</div><div class="line">  ...</div><div class="line">&lt;/security:http&gt;</div><div class="line"></div><div class="line">&lt;bean id=&quot;casFilter&quot;</div><div class="line">  class=&quot;org.springframework.security.cas.web.CasAuthenticationFilter&quot;&gt;</div><div class="line">  &lt;property name=&quot;authenticationManager&quot; ref=&quot;authenticationManager&quot; /&gt;</div><div class="line">  &lt;!-- 指定处理地址，不指定时默认将会是“/j_spring_cas_security_check” --&gt;</div><div class="line">  &lt;property name=&quot;filterProcessesUrl&quot; value=&quot;/j_spring_cas_security_check&quot;/&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure></p>
<p>1.3 <strong>配置AuthenticationManager</strong><br>&emsp;&emsp;CasAuthenticationFilter会将封装好的包含Cas Server传递过来的ticket的Authentication对象传递给AuthenticationManager进行认证。我们知道默认的AuthenticationManager实现类为ProviderManager，而ProviderManager中真正进行认证的是AuthenticationProvider。所以接下来我们要在AuthenticationManager中配置一个能够处理CasAuthenticationFilter传递过来的Authentication对象的AuthenticationProvider实现，CasAuthenticationProvider。CasAuthenticationProvider首先会利用TicketValidator（Cas概念）对Authentication中包含的ticket信息进行认证。认证通过后将利用持有的AuthenticationUserDetailsService根据认证通过后回传的Assertion对象中拥有的username加载用户对应的UserDetails，即主要是加载用户的相关权限信息GrantedAuthority。然后构造一个CasAuthenticationToken进行返回。之后的逻辑就是正常的Spring Security的逻辑了。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:authentication-manager</span> <span class="attr">alias</span>=<span class="string">"authenticationManager"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:authentication-provider</span> <span class="attr">ref</span>=<span class="string">"casAuthenticationProvider"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">security:authentication-manager</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"casAuthenticationProvider"</span></span></div><div class="line"><span class="attr">class</span>=<span class="string">"org.springframework.security.cas.authentication.CasAuthenticationProvider"</span>&gt;</div><div class="line">  <span class="comment">&lt;!-- 通过username来加载UserDetails --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"authenticationUserDetailsService"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.core.userdetails.UserDetailsByNameServiceWrapper"</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- 真正加载UserDetails的UserDetailsService实现 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"userDetailsService"</span> /&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceProperties"</span> <span class="attr">ref</span>=<span class="string">"serviceProperties"</span> /&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 配置TicketValidator在登录认证成功后验证ticket --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"ticketValidator"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.jasig.cas.client.validation.Cas20ServiceTicketValidator"</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- Cas Server访问地址的前缀，即根路径--&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">value</span>=<span class="string">"https://localhost:8443/cas"</span> /&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"key"</span> <span class="attr">value</span>=<span class="string">"key4CasAuthenticationProvider"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"userDetailsService"</span></span></div><div class="line">  <span class="attr">class</span>=<span class="string">"org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>经过以上三步配置以后，我们的Spring Security应用就已经跟Cas整合好了，可以在需要登录的时候通过Cas Server进行单点登录了。</p>
<p>二. <strong>单点登出</strong><br>&emsp;&emsp;Spring Security应用整合Cas Client配置单点登出功能实际和单独使用Cas Client配置单点登出功能一样，其根本都是通过配置一个SingleSignOutFilter响应Cas Server单点登出时的回调，配置一个SingleSignOutHttpSessionListener用于在Session过期时删除SingleSignOutFilter存放的对应信息。SingleSignOutFilter需要配置在Cas 的AuthenticationFilter之前，对于Spring Security应用而言，该Filter通常是配置在Spring Security的配置文件中，而且是配置在CAS_FILTER之前。所以我们可以在Spring Security的配置文件中进行如下配置。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:http</span> <span class="attr">entry-point-ref</span>=<span class="string">"casEntryPoint"</span>&gt;</span></div><div class="line">  <span class="comment">&lt;!-- SingleSignOutFilter放在CAS_FILTER之前 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:custom-filter</span> <span class="attr">ref</span>=<span class="string">"casLogoutFilter"</span> <span class="attr">before</span>=<span class="string">"CAS_FILTER"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:custom-filter</span> <span class="attr">ref</span>=<span class="string">"casFilter"</span> <span class="attr">position</span>=<span class="string">"CAS_FILTER"</span>/&gt;</span></div><div class="line">  ...</div><div class="line"><span class="tag">&lt;/<span class="name">security:http</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"casLogoutFilter"</span> <span class="attr">class</span>=<span class="string">"org.jasig.cas.client.session.SingleSignOutFilter"</span>/&gt;</span></div></pre></td></tr></table></figure></p>
<p>然后跟单独使用Cas Client一样，在web.xml文件中配置一个SingleSignOutHttpSessionListener。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;listener&gt;</div><div class="line">    &lt;listener-class&gt;org.jasig.cas.client.session.SingleSignOutHttpSessionListener&lt;/listener-class&gt;</div><div class="line">&lt;/listener&gt;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;经过以上配置在访问Cas Server的logout地址（如：<a href="https://localhost:8443/cas/logout）进行登出时，Cas" target="_blank" rel="external">https://localhost:8443/cas/logout）进行登出时，Cas</a> Server登出后将回调其中注册的每一个Service（Cas概念，即client应用），此时在client应用中配置好的SingleSignOutFilter将处理对应Client应用的登出操作。<br>&emsp;&emsp;虽然以上配置可以满足我们在Spring Security应用中的单点登出要求，但Cas官方文档和Spring Security官方文档都推荐我们在Cas Client应用进行登出操作时，不是直接访问Cas Server的logout，而是先登出本应用，然后告诉用户其当前登出的只是本应用，再提供一个对应Cas Server的链接，使其可以进行真正的单点登出。对此，Spring Security官方文档中给我们提供例子是提供两个LogoutFilter，一个是登出当前Spring Security应用，一个是登出Cas Server的。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:http</span> <span class="attr">entry-point-ref</span>=<span class="string">"casEntryPoint"</span>&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 请求登出Cas Server的过滤器，放在Spring Security的登出过滤器之前 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:custom-filter</span> <span class="attr">ref</span>=<span class="string">"requestCasLogoutFilter"</span> <span class="attr">before</span>=<span class="string">"LOGOUT_FILTER"</span>/&gt;</span></div><div class="line">  <span class="comment">&lt;!-- SingleSignOutFilter放在CAS_FILTER之前 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:custom-filter</span> <span class="attr">ref</span>=<span class="string">"casLogoutFilter"</span> <span class="attr">before</span>=<span class="string">"CAS_FILTER"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:custom-filter</span> <span class="attr">ref</span>=<span class="string">"casFilter"</span> <span class="attr">position</span>=<span class="string">"CAS_FILTER"</span>/&gt;</span></div><div class="line">  ...</div><div class="line"><span class="tag">&lt;/<span class="name">security:http</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"requestCasLogoutFilter"</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.web.authentication.logout.LogoutFilter"</span>&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 指定登出成功后需要跳转的地址，这里指向Cas Server的登出URL，以实现单点登出 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">"https://localhost:8443/cas/logout"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">constructor-arg</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></div><div class="line">   <span class="comment">&lt;!-- 该Filter需要处理的地址，默认是Spring Security的默认登出地址“/j_spring_security_logout”--&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"filterProcessesUrl"</span> <span class="attr">value</span>=<span class="string">"/j_spring_cas_security_logout"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>此外，Spring Security推荐我们在使用Cas Server的单点登出时一起使用CharacterEncodingFilter，以避免SingleSignOutFilter在获取参数时出现编码问题。</p>
<p>三. <strong>使用代理</strong><br>&emsp;&emsp;使用Cas Proxy时有两个主体，代理端和被代理端。而且我们知道代理端和被代理端针对Cas20ProxyReceivingTicketValidationFilter的配置是不一样的，虽然整合Cas的Spring Security应用不再使用Cas20ProxyReceivingTicketValidationFilter了，但其底层的核心机制是一样的。所以Cas整合Spring Security后的应用在作为代理端和被代理端时的配置也是不一样的。接下来将分开讲解Spring Security应用作为代理端和被代理端整合Cas后的配置。</p>
<p>3.1 <strong>代理端</strong><br>&emsp;&emsp;首先需要为CasAuthenticationFilter多指定两个参数，proxyReceptorUrl和proxyGrantingTicketStorage。proxyReceptorUrl用以指定Cas Server在回调代理端传递pgtId和pgtIou时回调地址相对于代理端的路径，如“/proxyCallback”，CasAuthenticationFilter会根据proxyReceptorUrl来确定一个请求是否来自Cas Server针对proxy的回调。如果是则需要接收Cas Server传递过来的pgtId和pgtIou，并将它们保存在持有的ProxyGrantingTicketStorage中。CasAuthenticationProvider之后会从ProxyGrantingTicketStorage中获取对应的pgtId，即proxy granting ticket，并将其保存在AttributePrincipal中，而AttributePrincipal又会保存到对应的Assertion中。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 配置ProxyGrantingTicketStorage，用以保存pgtId和pgtIou --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"proxyGrantingTicketStorage"</span> <span class="attr">class</span>=<span class="string">"org.jasig.cas.client.proxy.ProxyGrantingTicketStorageImpl"</span>/&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"casFilter"</span></span></div><div class="line">  <span class="attr">class</span>=<span class="string">"org.springframework.security.cas.web.CasAuthenticationFilter"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"authenticationManager"</span> <span class="attr">ref</span>=<span class="string">"authenticationManager"</span> /&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 指定处理地址，不指定时默认将会是“/j_spring_cas_security_check” --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"filterProcessesUrl"</span> <span class="attr">value</span>=<span class="string">"/j_spring_cas_security_check"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"proxyGrantingTicketStorage"</span> <span class="attr">ref</span>=<span class="string">"proxyGrantingTicketStorage"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"proxyReceptorUrl"</span> <span class="attr">value</span>=<span class="string">"/proxyCallback"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;其次是需要将CasAuthenticationProvider持有的TicketValidator由Cas20ServiceTicketValidator改成Cas20ProxyTicketValidator。其需要配置一个ProxyGrantingTicketStorage用来获取proxy granting ticket，即我们熟知的pgtId。在单独使用Cas Proxy时，Cas20ProxyReceivingTicketValidationFilter内部默认持有一个ProxyGrantingTicketStorage实现，其使用的Cas20ProxyTicketValidator也将使用该ProxyGrantingTicketStorage。整合Spring Security之后， Spring Security不使用Cas20ProxyReceivingTicketValidationFilter，而直接由CasAuthenticationFilter获取proxy granting ticket，由CasAuthenticationProvider对ticket进行校验。Cas20ProxyTicketValidator内部没默认的ProxyGrantingTicketStorage，所以在配置Cas20ProxyTicketValidator时我们需要给其指定一个ProxyGrantingTicketStorage实现。此外还需要为Cas20ProxyTicketValidator指定一个proxyCallbackUrl用以指定在Cas20ProxyTicketValidator通过Cas Server校验service ticket成功后将回调哪个地址以传递pgtId和pgtIou。proxyCallbackUrl默认情况下必须使用https协议，而应用的其它请求可以用非https协议。其它的配置和Cas20ServiceTicketValidator一样，Cas20ProxyTicketValidator的父类其实就是Cas20ServiceTicketValidator。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=&quot;casAuthenticationProvider&quot;</div><div class="line">   class=&quot;org.springframework.security.cas.authentication.CasAuthenticationProvider&quot;&gt;</div><div class="line">  &lt;!-- 通过username来加载UserDetails --&gt;</div><div class="line">  &lt;property name=&quot;authenticationUserDetailsService&quot;&gt;</div><div class="line">     &lt;bean class=&quot;org.springframework.security.core.userdetails.UserDetailsByNameServiceWrapper&quot;&gt;</div><div class="line">        &lt;!-- 真正加载UserDetails的UserDetailsService实现 --&gt;</div><div class="line">        &lt;constructor-arg ref=&quot;userDetailsService&quot; /&gt;</div><div class="line">     &lt;/bean&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  &lt;property name=&quot;serviceProperties&quot; ref=&quot;serviceProperties&quot; /&gt;</div><div class="line">  &lt;!-- 配置TicketValidator在登录认证成功后验证ticket --&gt;</div><div class="line">  &lt;property name=&quot;ticketValidator&quot;&gt;</div><div class="line">     &lt;bean class=&quot;org.jasig.cas.client.validation.Cas20ProxyTicketValidator&quot;&gt;</div><div class="line">        &lt;!-- Cas Server访问地址的前缀，即根路径--&gt;</div><div class="line">        &lt;constructor-arg index=&quot;0&quot; value=&quot;https://localhost:8443/cas&quot; /&gt;</div><div class="line">        &lt;!-- 指定Cas Server回调传递pgtId和pgtIou的地址，该地址必须使用https协议 --&gt;</div><div class="line">        &lt;property name=&quot;proxyCallbackUrl&quot; value=&quot;https://elim:8043/app/proxyCallback&quot;/&gt;</div><div class="line">        &lt;property name=&quot;proxyGrantingTicketStorage&quot; ref=&quot;proxyGrantingTicketStorage&quot;/&gt;</div><div class="line">     &lt;/bean&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  &lt;property name=&quot;key&quot; value=&quot;key4CasAuthenticationProvider&quot; /&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;经过以上步骤后我们整合Cas后的Spring Security应用就可以作为代理端使用Cas proxy访问其它被Cas保护的应用了，当然前提是其它被代理端能够接受我们应用的代理，了解Cas Proxy的人应该都知道这一点，在接下来的Spring Security应用整合Cas作为被代理端中也会讲到这部分内容。这里我们假设现在有一个应用app2能够接受我们应用的代理访问，那么在基于上述配置的应用中我们可以通过如下代码访问app2。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Controller</span></div><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/cas/test"</span>)</div><div class="line">publicclass CasTestController &#123;</div><div class="line"> </div><div class="line">   <span class="meta">@RequestMapping</span>(<span class="string">"/getData"</span>)</div><div class="line">   <span class="function">publicvoid <span class="title">getDataFromApp</span><span class="params">(PrintWriter writer)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">      <span class="comment">//1、从SecurityContextHolder获取到当前的Authentication对象，其是一个CasAuthenticationToken</span></div><div class="line">      CasAuthenticationToken cat = (CasAuthenticationToken)SecurityContextHolder.getContext().getAuthentication();</div><div class="line">      <span class="comment">//2、获取到AttributePrincipal对象</span></div><div class="line">      AttributePrincipal principal = cat.getAssertion().getPrincipal();</div><div class="line">      <span class="comment">//3、获取对应的proxy ticket</span></div><div class="line">      String proxyTicket = principal.getProxyTicketFor(<span class="string">"http://localhost:8081/app2/getData.jsp"</span>);</div><div class="line">      <span class="comment">//4、请求被代理应用时将获取到的proxy ticket以参数ticket进行传递</span></div><div class="line">      URL url = <span class="keyword">new</span> URL(<span class="string">"http://localhost:8081/app2/getData.jsp?ticket="</span> + URLEncoder.encode(proxyTicket, <span class="string">"UTF-8"</span>));</div><div class="line">      HttpURLConnection conn = (HttpURLConnection)url.openConnection();</div><div class="line">      BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(conn.getInputStream(), <span class="string">"UTF-8"</span>));</div><div class="line">      StringBuffer content = <span class="keyword">new</span> StringBuffer();</div><div class="line">      String line = <span class="keyword">null</span>;</div><div class="line">      <span class="keyword">while</span> ((line=br.readLine()) != <span class="keyword">null</span>) &#123;</div><div class="line">         content.append(line).append(<span class="string">"&lt;br/&gt;"</span>);</div><div class="line">      &#125;</div><div class="line">      writer.write(content.toString());</div><div class="line">   &#125;</div><div class="line">  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;需要注意的是通过AttributePrincipal的getProxyTicketFor()方法获取proxy ticket时，每调用一次都会获取一个全新的proxy ticket。用户可以根据自己的需要将获取到的proxy ticket按照指定的URL缓存起来，以避免每次都去针对同一个URL获取一个全新的proxy ticket。此外，如果在被代理端认证时根据proxy ticket缓存了Authentication的话也需要我们在代理端保证针对同一URL传递过去的proxy ticket是一样的，否则被代理端针对proxy ticket缓存Authentication的功能就没用了。  </p>
<p>3.2 <strong>被代理端</strong><br>&emsp;&emsp;Spring Security应用整合Cas使用Cas Proxy作为被代理端时主要需要进行三点修改。<br>&emsp;&emsp;第一点是通过ServiceProperties指定CasAuthenticationFilter的authenticateAllArtifacts为true，这样CasAuthenticationFilter将会尝试对所有ticket进行认证，而不是只认证来自filterProccessUrl指定地址的请求。这样代理端在请求被代理端的资源时将proxy ticket以参数ticket进行传递时，CasAuthenticationFilter才会让CasAuthenticationProvider对proxy ticket进行校验，这样我们的请求才有可能被CasAuthenticationProvider认证成功并请求到真正的资源。<br>&emsp;&emsp;第二点是指定CasAuthenticationFilter使用的AuthenticationDetailsSource为ServiceAuthenticationDetailsSource。CasAuthenticationFilter默认使用的是WebAuthenticationDetailsSource。ServiceAuthenticationDetailsSource将构建一个ServiceAuthenticationDetails对象作为当前Authentication的details对象。ServiceAuthenticationDetailsSource构建的ServiceAuthenticationDetails对象会将当前请求的地址构建为一个serviceUrl，通过其getServiceUrl()方法可以获取到该serviceUrl地址。之后该Authentication对象传递到CasAuthenticationProvider进行认证时就可以从Authentication的details中获取到对应的serviceUrl，并在通过Cas Server对代理端以参数ticket传递过来的proxy ticket进行验证时连同对应的serviceUrl一起传递过去。因为之前代理端申请proxy ticket时就是通过该serviceUrl进行申请的，Cas Server需要对于它们的配对来验证对应的proxy ticket是否有效。<br>&emsp;&emsp;第三点是将CasAuthenticationProvider的TicketValidator由Cas20ServiceTicketValidator改为Cas20ProxyTicketValidator，因为Cas Proxy被代理端需要调用Cas Server的proxyValidator对代理端传递过来的proxy ticket进行验证。此外需要通过acceptAnyProxy或allowedProxyChains指定将接受哪些代理。acceptAnyProxy用以指定是否接受所有的代理，可选值为true或false。allowedProxyChains则用以指定具体接受哪些代理，其对应的值是代理端在获取pgtId时提供给Cas Server的回调地址，如我们需要接受前面示例中代理端的代理，则我们的allowedProxyChains的值应该是“<a href="https://localhost:8043/app/proxyCallback”。如果需要接受多个代理端的代理，则在指定allowedProxyChains时多个代理端回调地址应各占一行。" target="_blank" rel="external">https://localhost:8043/app/proxyCallback”。如果需要接受多个代理端的代理，则在指定allowedProxyChains时多个代理端回调地址应各占一行。</a><br>&emsp;&emsp; 针对以上三点，我们的Spring Security应用整合Cas作为Cas Proxy的被代理端时需要对我们的配置进行如下改造。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 指定service相关信息 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"serviceProperties"</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.cas.ServiceProperties"</span>&gt;</span></div><div class="line">  <span class="comment">&lt;!-- Cas Server认证成功后的跳转地址，这里要跳转到我们的Spring Security应用，之后会由CasAuthenticationFilter处理，默认处理地址为/j_spring_cas_security_check --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"service"</span></span></div><div class="line">     <span class="attr">value</span>=<span class="string">"http://localhost:8083/app2/j_spring_cas_security_check"</span> /&gt;</div><div class="line">  <span class="comment">&lt;!-- 通过ServiceProperties指定CasAuthenticationFilter的authenticateAllArtifacts为true --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"authenticateAllArtifacts"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"casFilter"</span></span></div><div class="line">  <span class="attr">class</span>=<span class="string">"org.springframework.security.cas.web.CasAuthenticationFilter"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"authenticationManager"</span> <span class="attr">ref</span>=<span class="string">"authenticationManager"</span> /&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 指定处理地址，不指定时默认将会是“/j_spring_cas_security_check” --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"filterProcessesUrl"</span> <span class="attr">value</span>=<span class="string">"/j_spring_cas_security_check"</span> /&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 通过ServiceProperties指定CasAuthenticationFilter的authenticateAllArtifacts为true  --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceProperties"</span> <span class="attr">ref</span>=<span class="string">"serviceProperties"</span> /&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 指定使用的AuthenticationDetailsSource为ServiceAuthenticationDetailsSource --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"authenticationDetailsSource"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.cas.web.authentication.ServiceAuthenticationDetailsSource"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"casAuthenticationProvider"</span></span></div><div class="line"><span class="attr">class</span>=<span class="string">"org.springframework.security.cas.authentication.CasAuthenticationProvider"</span>&gt;</div><div class="line">  <span class="comment">&lt;!-- 通过username来加载UserDetails --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"authenticationUserDetailsService"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.core.userdetails.UserDetailsByNameServiceWrapper"</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- 真正加载UserDetails的UserDetailsService实现 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">"userDetailsService"</span> /&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"serviceProperties"</span> <span class="attr">ref</span>=<span class="string">"serviceProperties"</span> /&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 配置TicketValidator在登录认证成功后验证ticket --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"ticketValidator"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.jasig.cas.client.validation.Cas20ProxyTicketValidator"</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- Cas Server访问地址的前缀，即根路径--&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">"0"</span> <span class="attr">value</span>=<span class="string">"https://localhost:8443/cas"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"allowedProxyChains"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>https://localhost:8043/app/proxyCallback<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"key"</span> <span class="attr">value</span>=<span class="string">"key4CasAuthenticationProvider"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;此外，对于被代理端而言，代理端在对其进行访问时都被认为是无状态的。对于无状态的认证CasAuthenticationProvider将在认证成功后将对应的Authentication对象以proxy tickit为key存放到所持有的StatelessTicketCache中，然后在下次代理端访问时将优先根据代理端传递过来的proxy ticket从StatelessTicketCache中获取Authentication对象，如果存在则不再进行认证，否则将继续进行认证。CasAuthenticationProvider默认持有的StatelessTicketCache为NullStatelessTicketCache，其所有的实现都是空的。所以默认情况下，被代理端在被代理端访问时将每次都对代理端进行认证。如果用户不希望在被代理端每次都对代理端的请求进行认证，则可以为被代理端的CasAuthenticationProvider指定一个StatelessTicketCache。用户可以实现自己的StatelessTicketCache，并指定CasAuthenticationProvider使用的StatelessTicketCache为该StatelessTicketCache。不过也可以使用Spring Security为我们提供的EhCacheBasedTicketCache。EhCacheBasedTicketCache是基于Ehcache实现的一个StatelessTicketCache。以下是一个为CasAuthenticationProvider配置EhCacheBasedTicketCache的示例。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"casAuthenticationProvider"</span></span></div><div class="line">   <span class="attr">class</span>=<span class="string">"org.springframework.security.cas.authentication.CasAuthenticationProvider"</span>&gt;</div><div class="line">……</div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"statelessTicketCache"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.cas.authentication.EhCacheBasedTicketCache"</span>&gt;</span></div><div class="line">        <span class="comment">&lt;!-- Ehcache对象 --&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cache"</span> <span class="attr">ref</span>=<span class="string">"proxyTicketCache"</span>/&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">……</div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- 定义一个Ehcache --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"proxyTicketCache"</span> <span class="attr">class</span>=<span class="string">"org.springframework.cache.ehcache.EhCacheFactoryBean"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cacheName"</span> <span class="attr">value</span>=<span class="string">"proxyTicketCache"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"timeToLive"</span> <span class="attr">value</span>=<span class="string">"600"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;需要注意的是在代理端通过AttributePrincipal的getProxyTicketFor()方法获取到的proxy ticket每次都是不一样的，所以在被代理端通过StatelessTicketCache根据proxy ticket缓存认证对象Authentication时只有在同一proxy ticket能够请求多次的情况下才会有用，这也就要求我们在代理端同样能将proxy ticket缓存起来，以在请求同一地址时能使用相同的proxy ticket。    </p>
<p>3.3 <strong>既为代理端又为被代理端</strong><br>&emsp;&emsp;Cas Proxy的代理端和被代理端是相互独立的，所以一个Cas应用既可以作为代理端去访问其它Cas应用，也可以作为被代理端被其它应用访问。当Spring Security应用整合Cas后既想作为Cas Proxy的代理端访问其它Cas应用，也想作为被代理端被其它Cas应用访问时只需要将上述作为代理端的配置和作为被代理端的配置整到一起就行了。以下是一段示例代码。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">&lt;!-- 指定service相关信息 --&gt;</div><div class="line">&lt;bean id=&quot;serviceProperties&quot; class=&quot;org.springframework.security.cas.ServiceProperties&quot;&gt;</div><div class="line">&lt;!-- Cas Server认证成功后的跳转地址，这里要跳转到我们的Spring Security应用，之后会由CasAuthenticationFilter处理，默认处理地址为/j_spring_cas_security_check --&gt;</div><div class="line">&lt;property name=&quot;service&quot;</div><div class="line"> value=&quot;http://localhost:8080/app /j_spring_cas_security_check&quot; /&gt;</div><div class="line">&lt;property name=&quot;authenticateAllArtifacts&quot; value=&quot;true&quot;/&gt;</div><div class="line">&lt;/bean&gt;</div><div class="line"></div><div class="line">&lt;!-- 配置ProxyGrantingTicketStorage，用以保存pgtId和pgtIou --&gt;</div><div class="line">&lt;bean id=&quot;proxyGrantingTicketStorage&quot; class=&quot;org.jasig.cas.client.proxy.ProxyGrantingTicketStorageImpl&quot;/&gt;</div><div class="line"></div><div class="line">&lt;bean id=&quot;casFilter&quot;</div><div class="line">  class=&quot;org.springframework.security.cas.web.CasAuthenticationFilter&quot;&gt;</div><div class="line">  &lt;property name=&quot;authenticationManager&quot; ref=&quot;authenticationManager&quot; /&gt;</div><div class="line">  &lt;!-- 指定处理地址，不指定时默认将会是“/j_spring_cas_security_check” --&gt;</div><div class="line">  &lt;property name=&quot;filterProcessesUrl&quot; value=&quot;/j_spring_cas_security_check&quot;/&gt;</div><div class="line">  &lt;property name=&quot;proxyGrantingTicketStorage&quot; ref=&quot;proxyGrantingTicketStorage&quot;/&gt;</div><div class="line">  &lt;property name=&quot;proxyReceptorUrl&quot; value=&quot;/proxyCallback&quot;/&gt;</div><div class="line">  &lt;!-- 通过ServiceProperties指定CasAuthenticationFilter的authenticateAllArtifacts为true  --&gt;</div><div class="line">  &lt;property name=&quot;serviceProperties&quot; ref=&quot;serviceProperties&quot; /&gt;</div><div class="line">  &lt;!-- 指定使用的AuthenticationDetailsSource为ServiceAuthenticationDetailsSource --&gt;</div><div class="line">  &lt;property name=&quot;authenticationDetailsSource&quot;&gt;</div><div class="line">     &lt;bean class=&quot;org.springframework.security.cas.web.authentication.ServiceAuthenticationDetailsSource&quot; /&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">&lt;/bean&gt;</div><div class="line"></div><div class="line">&lt;bean id=&quot;casAuthenticationProvider&quot;</div><div class="line">class=&quot;org.springframework.security.cas.authentication.CasAuthenticationProvider&quot;&gt;</div><div class="line">  &lt;!-- 通过username来加载UserDetails --&gt;</div><div class="line">  &lt;property name=&quot;authenticationUserDetailsService&quot;&gt;</div><div class="line">     &lt;bean class=&quot;org.springframework.security.core.userdetails.UserDetailsByNameServiceWrapper&quot;&gt;</div><div class="line">        &lt;!-- 真正加载UserDetails的UserDetailsService实现 --&gt;</div><div class="line">        &lt;constructor-arg ref=&quot;userDetailsService&quot; /&gt;</div><div class="line">     &lt;/bean&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  &lt;property name=&quot;serviceProperties&quot; ref=&quot;serviceProperties&quot; /&gt;</div><div class="line">  &lt;!-- 配置TicketValidator在登录认证成功后验证ticket --&gt;</div><div class="line">  &lt;property name=&quot;ticketValidator&quot;&gt;</div><div class="line">     &lt;bean class=&quot;org.jasig.cas.client.validation.Cas20ProxyTicketValidator&quot;&gt;</div><div class="line">        &lt;!-- Cas Server访问地址的前缀，即根路径--&gt;</div><div class="line">        &lt;constructor-arg index=&quot;0&quot; value=&quot;https://localhost:8443/cas&quot; /&gt;</div><div class="line">        &lt;!-- 指定Cas Server回调传递pgtId和pgtIou的地址，该地址必须使用https协议 --&gt;</div><div class="line">        &lt;property name=&quot;proxyCallbackUrl&quot; value=&quot;https://elim:8043/app/proxyCallback&quot;/&gt;</div><div class="line">        &lt;property name=&quot;proxyGrantingTicketStorage&quot; ref=&quot;proxyGrantingTicketStorage&quot;/&gt;</div><div class="line">        &lt;!-- 作为被代理端时配置接收任何代理 --&gt;</div><div class="line">        &lt;property name=&quot;acceptAnyProxy&quot; value=&quot;true&quot;/&gt;</div><div class="line">     &lt;/bean&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  &lt;property name=&quot;key&quot; value=&quot;key4CasAuthenticationProvider&quot; /&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://clq2owesome.github.io/2017/08/15/Spring/Security/配置二十：整合Cas/" data-id="cjei8qk7g009l6gblt7ruyvxl" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Spring/Security/配置三：核心类介绍" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/15/Spring/Security/配置三：核心类介绍/" class="article-date">
  <time datetime="2017-08-15T02:09:45.000Z" itemprop="datePublished">2017-08-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>►<a class="article-category-link" href="/categories/Spring/Security/">Security</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/15/Spring/Security/配置三：核心类介绍/">配置三：核心类介绍</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h2><p> Authentication是一个接口，用来表示用户认证信息的，在用户登录认证之前相关信息会封装为一个Authentication具体实现类的对象，在登录认证成功之后又会生成一个信息更全面，包含用户权限等信息的Authentication对象，然后把它保存在SecurityContextHolder所持有的SecurityContext中，供后续的程序进行调用，如访问权限的鉴定等。</p>
<h2 id="SecurityContextHolder"><a href="#SecurityContextHolder" class="headerlink" title="SecurityContextHolder"></a>SecurityContextHolder</h2><p>&emsp;&emsp;SecurityContextHolder是用来保存SecurityContext的。SecurityContext中含有当前正在访问系统的用户的详细信息。默认情况下，SecurityContextHolder将使用ThreadLocal来保存SecurityContext，这也就意味着在处于同一线程中的方法中我们可以从ThreadLocal中获取到当前的SecurityContext。因为线程池的原因，如果我们每次在请求完成后都将ThreadLocal进行清除的话，那么我们把SecurityContext存放在ThreadLocal中还是比较安全的。这些工作Spring Security已经自动为我们做了，即在每一次request结束后都将清除当前线程的ThreadLocal。<br>&emsp;&emsp;SecurityContextHolder中定义了一系列的静态方法，而这些静态方法内部逻辑基本上都是通过SecurityContextHolder持有的SecurityContextHolderStrategy来实现的，如getContext()、setContext()、clearContext()等。而默认使用的strategy就是基于ThreadLocal的ThreadLocalSecurityContextHolderStrategy。另外，Spring Security还提供了两种类型的strategy实现，GlobalSecurityContextHolderStrategy和InheritableThreadLocalSecurityContextHolderStrategy，前者表示全局使用同一个SecurityContext，如C/S结构的客户端；后者使用InheritableThreadLocal来存放SecurityContext，即子线程可以使用父线程中存放的变量。<br>&emsp;&emsp;一般而言，我们使用默认的strategy就可以了，但是如果要改变默认的strategy，Spring Security为我们提供了两种方法，这两种方式都是通过改变strategyName来实现的。SecurityContextHolder中为三种不同类型的strategy分别命名为MODE_THREADLOCAL、MODE_INHERITABLETHREADLOCAL和MODE_GLOBAL。第一种方式是通过SecurityContextHolder的静态方法setStrategyName()来指定需要使用的strategy；第二种方式是通过系统属性进行指定，其中属性名默认为“spring.security.strategy”，属性值为对应strategy的名称。<br>&emsp;&emsp;Spring Security使用一个Authentication对象来描述当前用户的相关信息。SecurityContextHolder中持有的是当前用户的SecurityContext，而SecurityContext持有的是代表当前用户相关信息的Authentication的引用。这个Authentication对象不需要我们自己去创建，在与系统交互的过程中，Spring Security会自动为我们创建相应的Authentication对象，然后赋值给当前的SecurityContext。但是往往我们需要在程序中获取当前用户的相关信息，比如最常见的是获取当前登录用户的用户名。在程序的任何地方，通过如下方式我们可以获取到当前用户的用户名。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getCurrentUsername</span><span class="params">()</span> </span>&#123;</div><div class="line">  Object principal = SecurityContextHolder.getContext().getAuthentication().getPrincipal();</div><div class="line">  <span class="keyword">if</span> (principal <span class="keyword">instanceof</span> UserDetails) &#123;</div><div class="line">     <span class="keyword">return</span> ((UserDetails) principal).getUsername();</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (principal <span class="keyword">instanceof</span> Principal) &#123;</div><div class="line">     <span class="keyword">return</span> ((Principal) principal).getName();</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> String.valueOf(principal);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;通过Authentication.getPrincipal()可以获取到代表当前用户的信息，这个对象通常是UserDetails的实例。获取当前用户的用户名是一种比较常见的需求，关于上述代码其实Spring Security在Authentication中的实现类中已经为我们做了相关实现，所以获取当前用户的用户名最简单的方式应当如下。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> String <span class="title">getCurrentUsername</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> SecurityContextHolder.getContext().getAuthentication().getName();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;此外，调用SecurityContextHolder.getContext()获取SecurityContext时，如果对应的SecurityContext不存在，则Spring Security将为我们建立一个空的SecurityContext并进行返回。</p>
<h2 id="AuthenticationManager和AuthenticationProvider"><a href="#AuthenticationManager和AuthenticationProvider" class="headerlink" title="AuthenticationManager和AuthenticationProvider"></a>AuthenticationManager和AuthenticationProvider</h2><p>&emsp;&emsp;AuthenticationManager是一个用来处理认证（Authentication）请求的接口。在其中只定义了一个方法authenticate()，该方法只接收一个代表认证请求的Authentication对象作为参数，如果认证成功，则会返回一个封装了当前用户权限等信息的Authentication对象进行返回。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function">Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException</span>;</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;在Spring Security中，AuthenticationManager的默认实现是ProviderManager，而且它不直接自己处理认证请求，而是委托给其所配置的AuthenticationProvider列表，然后会依次使用每一个AuthenticationProvider进行认证，如果有一个AuthenticationProvider认证后的结果不为null，则表示该AuthenticationProvider已经认证成功，之后的AuthenticationProvider将不再继续认证。然后直接以该AuthenticationProvider的认证结果作为ProviderManager的认证结果。如果所有的AuthenticationProvider的认证结果都为null，则表示认证失败，将抛出一个ProviderNotFoundException。校验认证请求最常用的方法是根据请求的用户名加载对应的UserDetails，然后比对UserDetails的密码与认证请求的密码是否一致，一致则表示认证通过。Spring Security内部的DaoAuthenticationProvider就是使用的这种方式。其内部使用UserDetailsService来负责加载UserDetails，UserDetailsService将在下节讲解。在认证成功以后会使用加载的UserDetails来封装要返回的Authentication对象，加载的UserDetails对象是包含用户权限等信息的。认证成功返回的Authentication对象将会保存在当前的SecurityContext中。<br>&emsp;&emsp;当我们在使用NameSpace时， authentication-manager元素的使用会使Spring Security 在内部创建一个ProviderManager，然后可以通过authentication-provider元素往其中添加AuthenticationProvider。当定义authentication-provider元素时，如果没有通过ref属性指定关联哪个AuthenticationProvider，Spring Security默认就会使用DaoAuthenticationProvider。使用了NameSpace后我们就不要再声明ProviderManager了。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:authentication-manager</span> <span class="attr">alias</span>=<span class="string">"authenticationManager"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:authentication-provider</span></span></div><div class="line">     <span class="attr">user-service-ref</span>=<span class="string">"userDetailsService"</span>/&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">security:authentication-manager</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;如果我们没有使用NameSpace，那么我们就应该在ApplicationContext中声明一个ProviderManager。</p>
<h2 id="认证成功后清除凭证"><a href="#认证成功后清除凭证" class="headerlink" title="认证成功后清除凭证"></a>认证成功后清除凭证</h2><p>&emsp;&emsp;默认情况下，在认证成功后ProviderManager将清除返回的Authentication中的凭证信息，如密码。所以如果你在无状态的应用中将返回的Authentication信息缓存起来了，那么以后你再利用缓存的信息去认证将会失败，因为它已经不存在密码这样的凭证信息了。所以在使用缓存的时候你应该考虑到这个问题。一种解决办法是设置ProviderManager的eraseCredentialsAfterAuthentication 属性为false，或者想办法在缓存时将凭证信息一起缓存。</p>
<h2 id="UserDetailsService"><a href="#UserDetailsService" class="headerlink" title="UserDetailsService"></a>UserDetailsService</h2><p>&emsp;&emsp;通过Authentication.getPrincipal()的返回类型是Object，但很多情况下其返回的其实是一个UserDetails的实例。UserDetails是Spring Security中一个核心的接口。其中定义了一些可以获取用户名、密码、权限等与认证相关的信息的方法。Spring Security内部使用的UserDetails实现类大都是内置的User类，我们如果要使用UserDetails时也可以直接使用该类。在Spring Security内部很多地方需要使用用户信息的时候基本上都是使用的UserDetails，比如在登录认证的时候。登录认证的时候Spring Security会通过UserDetailsService的loadUserByUsername()方法获取对应的UserDetails进行认证，认证通过后会将该UserDetails赋给认证通过的Authentication的principal，然后再把该Authentication存入到SecurityContext中。之后如果需要使用用户信息的时候就是通过SecurityContextHolder获取存放在SecurityContext中的Authentication的principal。<br>&emsp;&emsp;通常我们需要在应用中获取当前用户的其它信息，如Email、电话等。这时存放在Authentication的principal中只包含有认证相关信息的UserDetails对象可能就不能满足我们的要求了。这时我们可以实现自己的UserDetails，在该实现类中我们可以定义一些获取用户其它信息的方法，这样将来我们就可以直接从当前SecurityContext的Authentication的principal中获取这些信息了。上文已经提到了UserDetails是通过UserDetailsService的loadUserByUsername()方法进行加载的。UserDetailsService也是一个接口，我们也需要实现自己的UserDetailsService来加载我们自定义的UserDetails信息。然后把它指定给AuthenticationProvider即可。如下是一个配置UserDetailsService的示例。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 用于认证的AuthenticationManager --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">security:authentication-manager</span> <span class="attr">alias</span>=<span class="string">"authenticationManager"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:authentication-provider</span></span></div><div class="line">     <span class="attr">user-service-ref</span>=<span class="string">"userDetailsService"</span> /&gt;</div><div class="line"><span class="tag">&lt;/<span class="name">security:authentication-manager</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"userDetailsService"</span></span></div><div class="line">  <span class="attr">class</span>=<span class="string">"org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;上述代码中我们使用的JdbcDaoImpl是Spring Security为我们提供的UserDetailsService的实现，另外Spring Security还为我们提供了UserDetailsService另外一个实现，InMemoryDaoImpl。<br>&emsp;&emsp;其作用是从数据库中加载UserDetails信息。其中已经定义好了加载相关信息的默认脚本，这些脚本也可以通过JdbcDaoImpl的相关属性进行指定。关于JdbcDaoImpl使用方式会在讲解AuthenticationProvider的时候做一个相对详细一点的介绍。</p>
<h2 id="JdbcDaoImpl"><a href="#JdbcDaoImpl" class="headerlink" title="JdbcDaoImpl"></a>JdbcDaoImpl</h2><p>&emsp;&emsp;JdbcDaoImpl允许我们从数据库来加载UserDetails，其底层使用的是Spring的JdbcTemplate进行操作，所以我们需要给其指定一个数据源。此外，我们需要通过usersByUsernameQuery属性指定通过username查询用户信息的SQL语句；通过authoritiesByUsernameQuery属性指定通过username查询用户所拥有的权限的SQL语句；如果我们通过设置JdbcDaoImpl的enableGroups为true启用了用户组权限的支持，则我们还需要通过groupAuthoritiesByUsernameQuery属性指定根据username查询用户组权限的SQL语句。当这些信息都没有指定时，将使用默认的SQL语句，默认的SQL语句如下所示。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">select username, password, enabled from users where username=? --根据username查询用户信息</div><div class="line">select username, authority from authorities where username=? --根据username查询用户权限信息</div><div class="line">select g.id, g.group_name, ga.authority from groups g, groups_members gm, groups_authorities ga where gm.username=? and g.id=ga.group_id and g.id=gm.group_id --根据username查询用户组权限</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;使用默认的SQL语句进行查询时意味着我们对应的数据库中应该有对应的表和表结构，Spring Security为我们提供的默认表的创建脚本如下。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function">create table <span class="title">users</span><span class="params">(</span></span></div><div class="line">      username varchar_ignorecase(<span class="number">50</span>) not <span class="keyword">null</span> primary key,</div><div class="line">      password <span class="title">varchar_ignorecase</span><span class="params">(<span class="number">50</span>)</span> not <span class="keyword">null</span>,</div><div class="line">      enabled <span class="keyword">boolean</span> not <span class="keyword">null</span>);</div><div class="line"> </div><div class="line"><span class="function">create table <span class="title">authorities</span> <span class="params">(</span></span></div><div class="line">      username varchar_ignorecase(<span class="number">50</span>) not <span class="keyword">null</span>,</div><div class="line">      authority <span class="title">varchar_ignorecase</span><span class="params">(<span class="number">50</span>)</span> not <span class="keyword">null</span>,</div><div class="line">      constraint fk_authorities_users foreign <span class="title">key</span><span class="params">(username)</span> references <span class="title">users</span><span class="params">(username)</span>);</div><div class="line">      <span class="function">create unique index ix_auth_username on <span class="title">authorities</span> <span class="params">(username,authority)</span></span>;</div><div class="line">     </div><div class="line"><span class="function">create table <span class="title">groups</span> <span class="params">(</span></span></div><div class="line">      id bigint generated by <span class="keyword">default</span> as identity(start with <span class="number">0</span>) primary key,</div><div class="line">      group_name <span class="title">varchar_ignorecase</span><span class="params">(<span class="number">50</span>)</span> notnull);</div><div class="line"> </div><div class="line"><span class="function">create table <span class="title">group_authorities</span> <span class="params">(</span></span></div><div class="line">      group_id bigint notnull,</div><div class="line">      authority varchar(<span class="number">50</span>) notnull,</div><div class="line">      constraint fk_group_authorities_group foreign <span class="title">key</span><span class="params">(group_id)</span> references <span class="title">groups</span><span class="params">(id)</span>);</div><div class="line"> </div><div class="line"><span class="function">create table <span class="title">group_members</span> <span class="params">(</span></span></div><div class="line">      id bigint generated by <span class="keyword">default</span> as identity(start with <span class="number">0</span>) primary key,</div><div class="line">      username <span class="title">varchar</span><span class="params">(<span class="number">50</span>)</span> notnull,</div><div class="line">      group_id bigint notnull,</div><div class="line">      constraint fk_group_members_group foreign <span class="title">key</span><span class="params">(group_id)</span> references <span class="title">groups</span><span class="params">(id)</span>);</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;此外，使用jdbc-user-service元素时在底层Spring Security默认使用的就是JdbcDaoImpl。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"> <span class="tag">&lt;<span class="name">security:authentication-manager</span> <span class="attr">alias</span>=<span class="string">"authenticationManager"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:authentication-provider</span>&gt;</span></div><div class="line">     <span class="comment">&lt;!-- 基于Jdbc的UserDetailsService实现，JdbcDaoImpl --&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">security:jdbc-user-service</span> <span class="attr">data-source-ref</span>=<span class="string">"dataSource"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">security:authentication-provider</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">security:authentication-manager</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="InMemoryDaoImpl"><a href="#InMemoryDaoImpl" class="headerlink" title="InMemoryDaoImpl"></a>InMemoryDaoImpl</h2><p>&emsp;&emsp;  InMemoryDaoImpl主要是测试用的，其只是简单的将用户信息保存在内存中。使用NameSpace时，使用user-service元素Spring Security底层使用的UserDetailsService就是InMemoryDaoImpl。此时，我们可以简单的使用user元素来定义一个UserDetails。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:user-service</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:user</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">password</span>=<span class="string">"user"</span> <span class="attr">authorities</span>=<span class="string">"ROLE_USER"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">security:user-service</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;<br>如上配置表示我们定义了一个用户user，其对应的密码为user，拥有ROLE_USER的权限。此外，user-service还支持通过properties文件来指定用户信息，如：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"> <span class="tag">&lt;<span class="name">security:user-service</span> <span class="attr">properties</span>=<span class="string">"/WEB-INF/config/users.properties"</span>/&gt;</span></div><div class="line">   其中属性文件应遵循如下格式：</div><div class="line">username=password,grantedAuthority[,grantedAuthority][,enabled|disabled]</div><div class="line">   所以，对应上面的配置文件，我们的users.properties文件的内容应该如下所示：</div><div class="line">#username=password,grantedAuthority[,grantedAuthority][,enabled|disabled]</div><div class="line">user=user,ROLE_USER</div></pre></td></tr></table></figure></p>
<h2 id="GrantedAuthority"><a href="#GrantedAuthority" class="headerlink" title="GrantedAuthority"></a>GrantedAuthority</h2><p>&emsp;&emsp; Authentication的getAuthorities()可以返回当前Authentication对象拥有的权限，即当前用户拥有的权限。其返回值是一个GrantedAuthority类型的数组，每一个GrantedAuthority对象代表赋予给当前用户的一种权限。GrantedAuthority是一个接口，其通常是通过UserDetailsService进行加载，然后赋予给UserDetails的。<br>&emsp;&emsp;GrantedAuthority中只定义了一个getAuthority()方法，该方法返回一个字符串，表示对应权限的字符串表示，如果对应权限不能用字符串表示，则应当返回null。<br>&emsp;&emsp;<br>Spring Security针对GrantedAuthority有一个简单实现SimpleGrantedAuthority。该类只是简单的接收一个表示权限的字符串。Spring Security内部的所有AuthenticationProvider都是使用SimpleGrantedAuthority来封装Authentication对象。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://clq2owesome.github.io/2017/08/15/Spring/Security/配置三：核心类介绍/" data-id="cjei8qk7i009o6gbl8oaffgoe" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Spring/Security/配置九：Filter" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/15/Spring/Security/配置九：Filter/" class="article-date">
  <time datetime="2017-08-15T02:09:45.000Z" itemprop="datePublished">2017-08-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>►<a class="article-category-link" href="/categories/Spring/Security/">Security</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/15/Spring/Security/配置九：Filter/">配置九：Filter</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>Spring Security的底层是通过一系列的Filter来管理的，每个Filter都有其自身的功能，而且各个Filter在功能上还有关联关系，所以它们的顺序也是非常重要的。</p>
</blockquote>
<p>一. <strong>Filter顺序</strong><br>Spring Security已经定义了一些Filter，不管实际应用中你用到了哪些，它们应当保持如下顺序。<br>（1）ChannelProcessingFilter，如果你访问的channel错了，那首先就会在channel之间进行跳转，如http变为https。<br>（2）SecurityContextPersistenceFilter，这样的话在一开始进行request的时候就可以在SecurityContextHolder中建立一个SecurityContext，然后在请求结束的时候，任何对SecurityContext的改变都可以被copy到HttpSession。<br>（3）ConcurrentSessionFilter，因为它需要使用SecurityContextHolder的功能，而且更新对应session的最后更新时间，以及通过SessionRegistry获取当前的SessionInformation以检查当前的session是否已经过期，过期则会调用LogoutHandler。<br>（4）认证处理机制，如UsernamePasswordAuthenticationFilter，CasAuthenticationFilter，BasicAuthenticationFilter等，以至于SecurityContextHolder可以被更新为包含一个有效的Authentication请求。<br>（5）SecurityContextHolderAwareRequestFilter，它将会把HttpServletRequest封装成一个继承自HttpServletRequestWrapper的SecurityContextHolderAwareRequestWrapper，同时使用SecurityContext实现了HttpServletRequest中与安全相关的方法。<br>（6）JaasApiIntegrationFilter，如果SecurityContextHolder中拥有的Authentication是一个JaasAuthenticationToken，那么该Filter将使用包含在JaasAuthenticationToken中的Subject继续执行FilterChain。<br>（7）RememberMeAuthenticationFilter，如果之前的认证处理机制没有更新SecurityContextHolder，并且用户请求包含了一个Remember-Me对应的cookie，那么一个对应的Authentication将会设给SecurityContextHolder。<br>（8）AnonymousAuthenticationFilter，如果之前的认证机制都没有更新SecurityContextHolder拥有的Authentication，那么一个AnonymousAuthenticationToken将会设给SecurityContextHolder。<br>（9）ExceptionTransactionFilter，用于处理在FilterChain范围内抛出的AccessDeniedException和AuthenticationException，并把它们转换为对应的Http错误码返回或者对应的页面。<br>（10）FilterSecurityInterceptor，保护Web URI，并且在访问被拒绝时抛出异常。  </p>
<p>二. <strong>添加Filter到FilterChain</strong><br>&emsp;&emsp;当我们在使用NameSpace时，Spring Security是会自动为我们建立对应的FilterChain以及其中的Filter。但有时我们可能需要添加我们自己的Filter到FilterChain，又或者是因为某些特性需要自己显示的定义Spring Security已经为我们提供好的Filter，然后再把它们添加到FilterChain。使用NameSpace时添加Filter到FilterChain是通过http元素下的custom-filter元素来定义的。定义custom-filter时需要我们通过ref属性指定其对应关联的是哪个Filter，此外还需要通过position、before或者after指定该Filter放置的位置。Spring Security对FilterChain中Filter顺序是有严格的规定的。Spring Security对那些内置的Filter都指定了一个别名，同时指定了它们的位置。我们在定义custom-filter的position、before和after时使用的值就是对应着这些别名所处的位置。如position=”CAS_FILTER”就表示将定义的Filter放在CAS_FILTER对应的那个位置，before=”CAS_FILTER”就表示将定义的Filter放在CAS_FILTER之前，after=”CAS_FILTER”就表示将定义的Filter放在CAS_FILTER之后。此外还有两个特殊的位置可以指定，FIRST和LAST，分别对应第一个和最后一个Filter，如你想把定义好的Filter放在最后，则可以使用after=”LAST”。<br>&emsp;&emsp;接下来我们来看一下Spring Security给我们定义好的FilterChain中Filter对应的位置顺序、它们的别名以及将触发自动添加到FilterChain的元素或属性定义。下面的定义是按顺序的。</p>
<table>
<thead>
<tr>
<th>别名</th>
<th>Filter类</th>
<th>对应元素或属性</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>CHANNEL_FILTER</td>
<td>ChannelProcessingFilter</td>
<td>http/intercept-url@requires-channel</td>
<td></td>
</tr>
<tr>
<td>SECURITY_CONTEXT_FILTER</td>
<td>SecurityContextPersistenceFilter</td>
<td>http</td>
<td></td>
</tr>
<tr>
<td>CONCURRENT_SESSION_FILTER</td>
<td>ConcurrentSessionFilter</td>
<td>http/session-management/concurrency-control</td>
<td></td>
</tr>
<tr>
<td>LOGOUT_FILTER</td>
<td>LogoutFilter</td>
<td>http/logout</td>
<td></td>
</tr>
<tr>
<td>X509_FILTER</td>
<td>X509AuthenticationFilter</td>
<td>http/x509</td>
<td></td>
</tr>
<tr>
<td>PRE_AUTH_FILTER</td>
<td>AstractPreAuthenticatedProcessingFilter 的子类</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>CAS_FILTER</td>
<td>CasAuthenticationFilter</td>
<td>无</td>
<td></td>
</tr>
<tr>
<td>FORM_LOGIN_FILTER</td>
<td>UsernamePasswordAuthenticationFilter</td>
<td>http/form-login</td>
<td></td>
</tr>
<tr>
<td>BASIC_AUTH_FILTER</td>
<td>BasicAuthenticationFilter</td>
<td>http/http-basic</td>
<td></td>
</tr>
<tr>
<td>SERVLET_API_SUPPORT_FILTER</td>
<td>SecurityContextHolderAwareRequestFilter</td>
<td>http@servlet-api-provision</td>
<td></td>
</tr>
<tr>
<td>JAAS_API_SUPPORT_FILTER</td>
<td>JaasApiIntegrationFilter</td>
<td>http@jaas-api-provision</td>
<td></td>
</tr>
<tr>
<td>REMEMBER_ME_FILTER</td>
<td>RememberMeAuthenticationFilter</td>
<td>http/remember-me</td>
<td></td>
</tr>
<tr>
<td>ANONYMOUS_FILTER</td>
<td>AnonymousAuthenticationFilter</td>
<td>http/anonymous</td>
<td></td>
</tr>
<tr>
<td>SESSION_MANAGEMENT_FILTER</td>
<td>SessionManagementFilter</td>
<td>http/session-management</td>
<td></td>
</tr>
<tr>
<td>EXCEPTION_TRANSLATION_FILTER</td>
<td>ExceptionTranslationFilter</td>
<td>http</td>
<td></td>
</tr>
<tr>
<td>FILTER_SECURITY_INTERCEPTOR</td>
<td>FilterSecurityInterceptor</td>
<td>http</td>
<td></td>
</tr>
<tr>
<td>SWITCH_USER_FILTER</td>
<td>SwitchUserFilter</td>
<td>无</td>
</tr>
</tbody>
</table>
<p>三. <strong>DelegatingFilterProxy</strong><br>&emsp;&emsp;可能你会觉得奇怪，我们在web应用中使用Spring Security时只在web.xml文件中定义了如下这样一个Filter，为什么你会说是一系列的Filter呢？<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>springSecurityFilterChain<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>springSecurityFilterChain<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;而且如果你不在web.xml文件声明要使用的Filter，那么Servlet容器将不会发现它们，它们又怎么发生作用呢？这就是上述配置中DelegatingFilterProxy的作用了。<br>&emsp;&emsp;DelegatingFilterProxy是Spring中定义的一个Filter实现类，其作用是代理真正的Filter实现类，也就是说在调用DelegatingFilterProxy的doFilter()方法时实际上调用的是其代理Filter的doFilter()方法。其代理Filter必须是一个Spring bean对象，所以使用DelegatingFilterProxy的好处就是其代理Filter类可以使用Spring的依赖注入机制方便自由的使用ApplicationContext中的bean。那么DelegatingFilterProxy如何知道其所代理的Filter是哪个呢？这是通过其自身的一个叫targetBeanName的属性来确定的，通过该名称，DelegatingFilterProxy可以从WebApplicationContext中获取指定的bean作为代理对象。该属性可以通过在web.xml中定义DelegatingFilterProxy时通过init-param来指定，如果未指定的话将默认取其在web.xml中声明时定义的名称。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>springSecurityFilterChain<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.DelegatingFilterProxy<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>springSecurityFilterChain<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;在上述配置中，DelegatingFilterProxy代理的就是名为SpringSecurityFilterChain的Filter。<br>&emsp;&emsp;需要注意的是被代理的Filter的初始化方法init()和销毁方法destroy()默认是不会被执行的。通过设置DelegatingFilterProxy的targetFilterLifecycle属性为true，可以使被代理Filter与DelegatingFilterProxy具有同样的生命周期。</p>
<p>四. <strong>FilterChainProxy</strong><br>&emsp;&emsp;Spring Security底层是通过一系列的Filter来工作的，每个Filter都有其各自的功能，而且各个Filter之间还有关联关系，所以它们的组合顺序也是非常重要的。<br>&emsp;&emsp;使用Spring Security时，DelegatingFilterProxy代理的就是一个FilterChainProxy。一个FilterChainProxy中可以包含有多个FilterChain，但是某个请求只会对应一个FilterChain，而一个FilterChain中又可以包含有多个Filter。当我们使用基于Spring Security的NameSpace进行配置时，系统会自动为我们注册一个名为springSecurityFilterChain类型为FilterChainProxy的bean（这也是为什么我们在使用SpringSecurity时需要在web.xml中声明一个name为springSecurityFilterChain类型为DelegatingFilterProxy的Filter了。），而且每一个http元素的定义都将拥有自己的FilterChain，而FilterChain中所拥有的Filter则会根据定义的服务自动增减。所以我们不需要显示的再定义这些Filter对应的bean了，除非你想实现自己的逻辑，又或者你想定义的某个属性NameSpace没有提供对应支持等。<br>&emsp;&emsp;Spring security允许我们在配置文件中配置多个http元素，以针对不同形式的URL使用不同的安全控制。Spring Security将会为每一个http元素创建对应的FilterChain，同时按照它们的声明顺序加入到FilterChainProxy。所以当我们同时定义多个http元素时要确保将更具有特性的URL配置在前。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:http</span> <span class="attr">pattern</span>=<span class="string">"/login*.jsp*"</span> <span class="attr">security</span>=<span class="string">"none"</span>/&gt;</span></div><div class="line"><span class="comment">&lt;!-- http元素的pattern属性指定当前的http对应的FilterChain将匹配哪些URL，如未指定将匹配所有的请求 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">security:http</span> <span class="attr">pattern</span>=<span class="string">"/admin/**"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">"/**"</span> <span class="attr">access</span>=<span class="string">"ROLE_ADMIN"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">security:http</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">security:http</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">"/**"</span> <span class="attr">access</span>=<span class="string">"ROLE_USER"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">security:http</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;需要注意的是http拥有一个匹配URL的pattern，未指定时表示匹配所有的请求，其下的子元素intercept-url也有一个匹配URL的pattern，该pattern是在http元素对应pattern基础上的，也就是说一个请求必须先满足http对应的pattern才有可能满足其下intercept-url对应的pattern。</p>
<p>五. <strong>Spring Security定义好的核心Filter</strong><br>&emsp;&emsp;通过前面的介绍我们知道Spring Security是通过Filter来工作的，为保证Spring Security的顺利运行，其内部实现了一系列的Filter。这其中有几个是在使用Spring Security的Web应用中必定会用到的。接下来我们来简要的介绍一下FilterSecurityInterceptor、ExceptionTranslationFilter、SecurityContextPersistenceFilter和UsernamePasswordAuthenticationFilter。在我们使用http元素时前三者会自动添加到对应的FilterChain中，当我们使用了form-login元素时UsernamePasswordAuthenticationFilter也会自动添加到FilterChain中。所以我们在利用custom-filter往FilterChain中添加自己定义的这些Filter时需要注意它们的位置。</p>
<p>六. <strong>FilterSecurityInterceptor</strong><br>&emsp;&emsp;FilterSecurityInterceptor是用于保护Http资源的，它需要一个AccessDecisionManager和一个AuthenticationManager的引用。它会从SecurityContextHolder获取Authentication，然后通过SecurityMetadataSource可以得知当前请求是否在请求受保护的资源。对于请求那些受保护的资源，如果Authentication.isAuthenticated()返回false或者FilterSecurityInterceptor的alwaysReauthenticate属性为true，那么将会使用其引用的AuthenticationManager再认证一次，认证之后再使用认证后的Authentication替换SecurityContextHolder中拥有的那个。然后就是利用AccessDecisionManager进行权限的检查。<br>&emsp;&emsp;我们在使用基于NameSpace的配置时所配置的intercept-url就会跟FilterChain内部的FilterSecurityInterceptor绑定。如果要自己定义FilterSecurityInterceptor对应的bean，那么该bean定义大致如下所示：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"filterSecurityInterceptor"</span></span></div><div class="line">   <span class="attr">class</span>=<span class="string">"org.springframework.security.web.access.intercept.FilterSecurityInterceptor"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"authenticationManager"</span> <span class="attr">ref</span>=<span class="string">"authenticationManager"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"accessDecisionManager"</span> <span class="attr">ref</span>=<span class="string">"accessDecisionManager"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"securityMetadataSource"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">security:filter-security-metadata-source</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">"/admin/**"</span> <span class="attr">access</span>=<span class="string">"ROLE_ADMIN"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">"/**"</span> <span class="attr">access</span>=<span class="string">"ROLE_USER,ROLE_ADMIN"</span> /&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">security:filter-security-metadata-source</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;filter-security-metadata-source用于配置其securityMetadataSource属性。intercept-url用于配置需要拦截的URL与对应的权限关系。</p>
<p>七. <strong>ExceptionTranslationFilter</strong><br>&emsp;&emsp;通过前面的介绍我们知道在Spring Security的Filter链表中ExceptionTranslationFilter就放在FilterSecurityInterceptor的前面。而ExceptionTranslationFilter是捕获来自FilterChain的异常，并对这些异常做处理。ExceptionTranslationFilter能够捕获来自FilterChain所有的异常，但是它只会处理两类异常，AuthenticationException和AccessDeniedException，其它的异常它会继续抛出。如果捕获到的是AuthenticationException，那么将会使用其对应的AuthenticationEntryPoint的commence()处理。如果捕获的异常是一个AccessDeniedException，那么将视当前访问的用户是否已经登录认证做不同的处理，如果未登录，则会使用关联的AuthenticationEntryPoint的commence()方法进行处理，否则将使用关联的AccessDeniedHandler的handle()方法进行处理。<br>&emsp;&emsp;AuthenticationEntryPoint是在用户没有登录时用于引导用户进行登录认证的，在实际应用中应根据具体的认证机制选择对应的AuthenticationEntryPoint。<br>&emsp;&emsp;AccessDeniedHandler用于在用户已经登录了，但是访问了其自身没有权限的资源时做出对应的处理。ExceptionTranslationFilter拥有的AccessDeniedHandler默认是AccessDeniedHandlerImpl，其会返回一个403错误码到客户端。我们可以通过显示的配置AccessDeniedHandlerImpl，同时给其指定一个errorPage使其可以返回对应的错误页面。当然我们也可以实现自己的AccessDeniedHandler。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"exceptionTranslationFilter"</span></span></div><div class="line">      <span class="attr">class</span>=<span class="string">"org.springframework.security.web.access.ExceptionTranslationFilter"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"authenticationEntryPoint"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"loginFormUrl"</span> <span class="attr">value</span>=<span class="string">"/login.jsp"</span> /&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"accessDeniedHandler"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.web.access.AccessDeniedHandlerImpl"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"errorPage"</span> <span class="attr">value</span>=<span class="string">"/access_denied.jsp"</span> /&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;在上述配置中我们指定了AccessDeniedHandler为AccessDeniedHandlerImpl，同时为其指定了errorPage，这样发生AccessDeniedException后将转到对应的errorPage上。指定了AuthenticationEntryPoint为使用表单登录的LoginUrlAuthenticationEntryPoint。此外，需要注意的是如果该filter是作为自定义filter加入到由NameSpace自动建立的FilterChain中时需把它放在内置的ExceptionTranslationFilter后面，否则异常都将被内置的ExceptionTranslationFilter所捕获。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">security:http</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:form-login</span> <span class="attr">login-page</span>=<span class="string">"/login.jsp"</span></span></div><div class="line">         <span class="attr">username-parameter</span>=<span class="string">"username"</span> <span class="attr">password-parameter</span>=<span class="string">"password"</span></div><div class="line">         <span class="attr">login-processing-url</span>=<span class="string">"/login.do"</span> /&gt;</div><div class="line">  <span class="comment">&lt;!-- 退出登录时删除session对应的cookie --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:logout</span> <span class="attr">delete-cookies</span>=<span class="string">"JSESSIONID"</span> /&gt;</span></div><div class="line">  <span class="comment">&lt;!-- 登录页面应当是不需要认证的 --&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">"/login*.jsp*"</span></span></div><div class="line">     <span class="attr">access</span>=<span class="string">"IS_AUTHENTICATED_ANONYMOUSLY"</span> /&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">"/**"</span> <span class="attr">access</span>=<span class="string">"ROLE_USER"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">security:custom-filter</span> <span class="attr">ref</span>=<span class="string">"exceptionTranslationFilter"</span> <span class="attr">after</span>=<span class="string">"EXCEPTION_TRANSLATION_FILTER"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">security:http</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;在捕获到AuthenticationException之后，调用AuthenticationEntryPoint的commence()方法引导用户登录之前，ExceptionTranslationFilter还做了一件事，那就是使用RequestCache将当前HttpServletRequest的信息保存起来，以至于用户成功登录后需要跳转到之前的页面时可以获取到这些信息，然后继续之前的请求，比如用户可能在未登录的情况下发表评论，待用户提交评论的时候就会将包含评论信息的当前请求保存起来，同时引导用户进行登录认证，待用户成功登录后再利用原来的request包含的信息继续之前的请求，即继续提交评论，所以待用户登录成功后我们通常看到的是用户成功提交了评论之后的页面。Spring Security默认使用的RequestCache是HttpSessionRequestCache，其会将HttpServletRequest相关信息封装为一个SavedRequest保存在HttpSession中。</p>
<p>八. <strong>SecurityContextPersistenceFilter</strong><br>&emsp;&emsp;SecurityContextPersistenceFilter会在请求开始时从配置好的SecurityContextRepository中获取SecurityContext，然后把它设置给SecurityContextHolder。在请求完成后将SecurityContextHolder持有的SecurityContext再保存到配置好的SecurityContextRepository，同时清除SecurityContextHolder所持有的SecurityContext。在使用NameSpace时，Spring  Security默认会给SecurityContextPersistenceFilter的SecurityContextRepository设置一个HttpSessionSecurityContextRepository，其会将SecurityContext保存在HttpSession中。此外HttpSessionSecurityContextRepository有一个很重要的属性allowSessionCreation，默认为true。这样需要把SecurityContext保存在session中时，如果不存在session，可以自动创建一个。也可以把它设置为false，这样在请求结束后如果没有可用的session就不会保存SecurityContext到session了。SecurityContextRepository还有一个空实现，NullSecurityContextRepository，如果在请求完成后不想保存SecurityContext也可以使用它。<br>&emsp;&emsp;这里再补充说明一点为什么SecurityContextPersistenceFilter在请求完成后需要清除SecurityContextHolder的SecurityContext。SecurityContextHolder在设置和保存SecurityContext都是使用的静态方法，具体操作是由其所持有的SecurityContextHolderStrategy完成的。默认使用的是基于线程变量的实现，即SecurityContext是存放在ThreadLocal里面的，这样各个独立的请求都将拥有自己的SecurityContext。在请求完成后清除SecurityContextHolder中的SucurityContext就是清除ThreadLocal，Servlet容器一般都有自己的线程池，这可以避免Servlet容器下一次分发线程时线程中还包含SecurityContext变量，从而引起不必要的错误。<br>&emsp;&emsp;下面是一个SecurityContextPersistenceFilter的简单配置。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"securityContextPersistenceFilter"</span></span></div><div class="line">   <span class="attr">class</span>=<span class="string">"org.springframework.security.web.context.SecurityContextPersistenceFilter"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">'securityContextRepository'</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">bean</span></span></div><div class="line">     <span class="attr">class</span>=<span class="string">'org.springframework.security.web.context.HttpSessionSecurityContextRepository'</span>&gt;</div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">'allowSessionCreation'</span> <span class="attr">value</span>=<span class="string">'false'</span> /&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>十. <strong>UsernamePasswordAuthenticationFilter</strong><br>&emsp;&emsp;UsernamePasswordAuthenticationFilter用于处理来自表单提交的认证。该表单必须提供对应的用户名和密码，对应的参数名默认为j_username和j_password。如果不想使用默认的参数名，可以通过UsernamePasswordAuthenticationFilter的usernameParameter和passwordParameter进行指定。表单的提交路径默认是“j_spring_security_check”，也可以通过UsernamePasswordAuthenticationFilter的filterProcessesUrl进行指定。通过属性postOnly可以指定只允许登录表单进行post请求，默认是true。其内部还有登录成功或失败后进行处理的AuthenticationSuccessHandler和AuthenticationFailureHandler，这些都可以根据需求做相关改变。此外，它还需要一个AuthenticationManager的引用进行认证，这个是没有默认配置的。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"authenticationFilter"</span></span></div><div class="line">   <span class="attr">class</span>=<span class="string">"org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter"</span>&gt;</div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"authenticationManager"</span> <span class="attr">ref</span>=<span class="string">"authenticationManager"</span> /&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"usernameParameter"</span> <span class="attr">value</span>=<span class="string">"username"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"passwordParameter"</span> <span class="attr">value</span>=<span class="string">"password"</span>/&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"filterProcessesUrl"</span> <span class="attr">value</span>=<span class="string">"/login.do"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;如果要在http元素定义中使用上述AuthenticationFilter定义，那么完整的配置应该类似于如下这样子。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">   <span class="attr">xmlns:security</span>=<span class="string">"http://www.springframework.org/schema/security"</span></div><div class="line">   <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">   <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></div><div class="line">          http://www.springframework.org/schema/beans/spring-beans-3.1.xsd</div><div class="line">          http://www.springframework.org/schema/security</div><div class="line">          http://www.springframework.org/schema/security/spring-security-3.1.xsd"&gt;</div><div class="line">   <span class="comment">&lt;!-- entry-point-ref指定登录入口 --&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">security:http</span> <span class="attr">entry-point-ref</span>=<span class="string">"authEntryPoint"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">security:logout</span> <span class="attr">delete-cookies</span>=<span class="string">"JSESSIONID"</span> /&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">"/login*.jsp*"</span></span></div><div class="line">         <span class="attr">access</span>=<span class="string">"IS_AUTHENTICATED_ANONYMOUSLY"</span> /&gt;</div><div class="line">      <span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">"/**"</span> <span class="attr">access</span>=<span class="string">"ROLE_USER"</span> /&gt;</span></div><div class="line">      <span class="comment">&lt;!-- 添加自己定义的AuthenticationFilter到FilterChain的FORM_LOGIN_FILTER位置 --&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">security:custom-filter</span> <span class="attr">ref</span>=<span class="string">"authenticationFilter"</span> <span class="attr">position</span>=<span class="string">"FORM_LOGIN_FILTER"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">security:http</span>&gt;</span></div><div class="line">   <span class="comment">&lt;!-- AuthenticationEntryPoint，引导用户进行登录 --&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"authEntryPoint"</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"loginFormUrl"</span> <span class="attr">value</span>=<span class="string">"/login.jsp"</span>/&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">   <span class="comment">&lt;!-- 认证过滤器 --&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"authenticationFilter"</span></span></div><div class="line">   <span class="attr">class</span>=<span class="string">"org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter"</span>&gt;</div><div class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"authenticationManager"</span> <span class="attr">ref</span>=<span class="string">"authenticationManager"</span> /&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"usernameParameter"</span> <span class="attr">value</span>=<span class="string">"username"</span>/&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"passwordParameter"</span> <span class="attr">value</span>=<span class="string">"password"</span>/&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"filterProcessesUrl"</span> <span class="attr">value</span>=<span class="string">"/login.do"</span> /&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">  </div><div class="line">   <span class="tag">&lt;<span class="name">security:authentication-manager</span> <span class="attr">alias</span>=<span class="string">"authenticationManager"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">security:authentication-provider</span></span></div><div class="line">         <span class="attr">user-service-ref</span>=<span class="string">"userDetailsService"</span>&gt;</div><div class="line">         <span class="tag">&lt;<span class="name">security:password-encoder</span> <span class="attr">hash</span>=<span class="string">"md5"</span></span></div><div class="line">            <span class="attr">base64</span>=<span class="string">"true"</span>&gt;</div><div class="line">            <span class="tag">&lt;<span class="name">security:salt-source</span> <span class="attr">user-property</span>=<span class="string">"username"</span> /&gt;</span></div><div class="line">         <span class="tag">&lt;/<span class="name">security:password-encoder</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">security:authentication-provider</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">security:authentication-manager</span>&gt;</span></div><div class="line"> </div><div class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"userDetailsService"</span></span></div><div class="line">      <span class="attr">class</span>=<span class="string">"org.springframework.security.core.userdetails.jdbc.JdbcDaoImpl"</span>&gt;</div><div class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"> </div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://clq2owesome.github.io/2017/08/15/Spring/Security/配置九：Filter/" data-id="cjei8qk7j009q6gblc7regyao" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/6/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" href="/page/8/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Eclipse/">Eclipse</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Github/">Github</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/Cookie/">Cookie</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/JAXB/">JAXB</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/JavaMail/">JavaMail</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/分布式/">分布式</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/加密解密／编码解码/">加密解密／编码解码</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/基础/">基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/数据类型/">数据类型</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/日记/">日记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/时间日期/">时间日期</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/线程/">线程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/网络NIO/">网络NIO</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/队列/">队列</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/集合/">集合</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Maven/">Maven</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/Application-Event/">Application Event</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/JPA/">JPA</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/Security/">Security</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/Spring-Boot/">Spring Boot</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/Spring-Session/">Spring Session</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/Task/">Task</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/spring-MVC/">spring MVC</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/spring-data-redis/">spring data redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/基础/">基础</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端技术相关/">前端技术相关</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/前端技术相关/forever/">forever</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端技术相关/javascript/">javascript</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库相关/">数据库相关</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/数据库相关/mysql/">mysql</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/服务器相关/">服务器相关</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/服务器相关/Hessian/">Hessian</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/服务器相关/Hudson-Jenkins/">Hudson & Jenkins</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/服务器相关/Memcached/">Memcached</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/服务器相关/Nginx/">Nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/服务器相关/Tomcat/">Tomcat</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/服务器相关/red5/">red5</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/服务器相关/redis/">redis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/服务器相关/resin/">resin</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/正则表达式/">正则表达式</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/03/08/正则表达式/正则表达式/">正则表达式</a>
          </li>
        
          <li>
            <a href="/2018/02/25/Java/集合/HashSet原理/">HashSet原理</a>
          </li>
        
          <li>
            <a href="/2018/02/25/Java/分布式/分布式事务/">分布式事务</a>
          </li>
        
          <li>
            <a href="/2018/02/25/Java/分布式/分布式锁/">分布式锁</a>
          </li>
        
          <li>
            <a href="/2018/02/25/Java/集合/几种常见的map/">几种常见的map</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 LeoChan<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>